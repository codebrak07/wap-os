<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WAP OS</title>
<link rel="icon" type="image/jpeg" href="2.jpeg">
<link rel="shortcut icon" type="image/jpeg" href="2.jpeg">
<link rel="apple-touch-icon" href="2.jpeg">
<style>
/* ============================================================
   DESIGN SYSTEM — CSS VARIABLES
   ============================================================ */
:root {
  /* spacing rhythm */
  --sp-1: 4px; --sp-2: 8px; --sp-3: 12px; --sp-4: 16px;
  --sp-5: 20px; --sp-6: 24px; --sp-8: 32px; --sp-10: 40px; --sp-12: 48px;

  /* typography */
  --font-mono: 'Courier New', Courier, monospace;
  --font-ui: 'Georgia', 'Times New Roman', serif;

  /* radius */
  --r-sm: 6px; --r-md: 10px; --r-lg: 16px; --r-xl: 24px;

  /* transitions */
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
  --dur: 220ms;
}

/* DARK THEME (default) */
[data-theme="dark"] {
  --bg-page:      #0d0f14;
  --bg-surface:   #13161d;
  --bg-card:      #1a1e28;
  --bg-code:      #0b0d12;
  --bg-accent:    #1e2535;

  --border:       #252a38;
  --border-focus: #4f9eff;

  --text-primary:  #e8ecf4;
  --text-secondary: #8b95ab;
  --text-muted:    #515d76;
  --text-code:     #cdd6f4;

  --accent-blue:  #4f9eff;
  --accent-green: #3dd68c;
  --accent-red:   #ff6b6b;
  --accent-amber: #f0a500;
  --accent-purple:#a78bfa;

  --old-bg:  #1a1218;
  --old-border: #ff6b6b;
  --new-bg:  #121a15;
  --new-border: #3dd68c;

  --note-bg:   #1a1700;
  --note-border:#f0a500;
  --expl-bg:   #0d1829;
  --expl-border:#4f9eff;

  --scrollbar-thumb: #2a3148;
  --scrollbar-track: #13161d;

  --header-grad: linear-gradient(135deg, #0b0e16 0%, #13161d 100%);
  --modal-overlay: rgba(5,7,12,0.96);
  --shadow-card: 0 4px 24px rgba(0,0,0,0.5);
  --shadow-modal: 0 24px 80px rgba(0,0,0,0.8);
}

/* LIGHT THEME */
[data-theme="light"] {
  --bg-page:      #f0f2f7;
  --bg-surface:   #ffffff;
  --bg-card:      #ffffff;
  --bg-code:      #1e2235;
  --bg-accent:    #f7f8fc;

  --border:       #dde1eb;
  --border-focus: #2563eb;

  --text-primary:  #111827;
  --text-secondary: #4b5563;
  --text-muted:    #9ca3af;
  --text-code:     #cdd6f4;

  --accent-blue:  #2563eb;
  --accent-green: #16a34a;
  --accent-red:   #dc2626;
  --accent-amber: #d97706;
  --accent-purple:#7c3aed;

  --old-bg:  #fff5f5;
  --old-border: #dc2626;
  --new-bg:  #f0fdf4;
  --new-border: #16a34a;

  --note-bg:   #fffbeb;
  --note-border:#d97706;
  --expl-bg:   #eff6ff;
  --expl-border:#2563eb;

  --scrollbar-thumb: #d1d5db;
  --scrollbar-track: #f3f4f6;

  --header-grad: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);
  --modal-overlay: rgba(0,0,0,0.75);
  --shadow-card: 0 2px 12px rgba(0,0,0,0.08);
  --shadow-modal: 0 16px 56px rgba(0,0,0,0.25);
}

/* ============================================================
   BASE RESET & GLOBALS
   ============================================================ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; font-size: 16px; overflow: hidden; }

body {
  font-family: var(--font-ui);
  background: var(--bg-page);
  color: var(--text-primary);
  line-height: 1.65;
  min-height: 100vh;
  transition: background var(--dur) var(--ease), color var(--dur) var(--ease);
  overflow-x: hidden;
}

/* Custom scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--scrollbar-track); }
::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-blue); }

/* ============================================================
   SCROLL PROGRESS BAR
   ============================================================ */
#scroll-progress {
  position: fixed;
  top: 0; left: 0;
  height: 3px;
  width: 0%;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
  z-index: 9999;
  transition: width 60ms linear;
}

/* ============================================================
   HEADER
   ============================================================ */
.site-header {
  background: var(--header-grad);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(12px);
}

.header-inner {
  max-width: 1320px;
  margin: 0 auto;
  padding: var(--sp-4) var(--sp-8);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--sp-4);
}

.header-brand {
  display: flex;
  flex-direction: column;
}

.header-brand h1 {
  font-size: 1.25rem;
  font-weight: 700;
  color: #fff;
  letter-spacing: -0.02em;
  line-height: 1.2;
}

.header-brand span {
  font-size: 0.72rem;
  color: rgba(255,255,255,0.55);
  margin-top: 2px;
  letter-spacing: 0.03em;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: var(--sp-3);
}

/* Theme toggle button */
.btn-theme {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.15);
  color: #fff;
  border-radius: var(--r-sm);
  padding: var(--sp-2) var(--sp-3);
  cursor: pointer;
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  gap: var(--sp-2);
  transition: background var(--dur) var(--ease), border var(--dur) var(--ease);
  white-space: nowrap;
}
.btn-theme:hover { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); }

/* Progress badge */
.progress-badge {
  font-size: 0.72rem;
  background: rgba(79,158,255,0.15);
  border: 1px solid rgba(79,158,255,0.3);
  color: var(--accent-blue);
  border-radius: 20px;
  padding: 3px 10px;
  white-space: nowrap;
}
[data-theme="light"] .progress-badge { color: var(--accent-blue); }

/* ============================================================
   HERO SECTION
   ============================================================ */
.hero {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: var(--sp-12) var(--sp-8) var(--sp-10);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.hero::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse 80% 60% at 50% -10%, rgba(79,158,255,0.08) 0%, transparent 70%);
  pointer-events: none;
}

.hero-eyebrow {
  display: inline-flex;
  align-items: center;
  gap: var(--sp-2);
  background: rgba(79,158,255,0.1);
  border: 1px solid rgba(79,158,255,0.2);
  color: var(--accent-blue);
  border-radius: 20px;
  padding: 4px 14px;
  font-size: 0.75rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: var(--sp-5);
}

.hero h2 {
  font-size: clamp(1.8rem, 4vw, 3rem);
  font-weight: 800;
  letter-spacing: -0.04em;
  line-height: 1.1;
  color: var(--text-primary);
  margin-bottom: var(--sp-4);
}

.hero h2 .hl { color: var(--accent-blue); }

.hero p {
  font-size: 1rem;
  color: var(--text-secondary);
  max-width: 540px;
  margin: 0 auto var(--sp-8);
}

/* Stats row */
.hero-stats {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--sp-8);
  flex-wrap: wrap;
}

.stat-item {
  text-align: center;
}

.stat-item .num {
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--text-primary);
  display: block;
  line-height: 1;
}

.stat-item .lbl {
  font-size: 0.72rem;
  color: var(--text-muted);
  letter-spacing: 0.06em;
  text-transform: uppercase;
  margin-top: 4px;
  display: block;
}

.stat-divider {
  width: 1px;
  height: 32px;
  background: var(--border);
}

/* ============================================================
   TOC SECTION
   ============================================================ */
.toc-section {
  max-width: 1320px;
  margin: 0 auto;
  padding: var(--sp-10) var(--sp-8);
}

.section-label {
  font-size: 0.72rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: var(--sp-5);
  display: flex;
  align-items: center;
  gap: var(--sp-3);
}

.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.toc-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: var(--sp-4);
}

.toc-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: var(--sp-5);
  transition: border-color var(--dur) var(--ease), box-shadow var(--dur) var(--ease), transform var(--dur) var(--ease);
}

.toc-card:hover {
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 1px var(--accent-blue), var(--shadow-card);
  transform: translateY(-2px);
}

.toc-card-label {
  font-size: 0.68rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--accent-blue);
  margin-bottom: var(--sp-3);
  display: flex;
  align-items: center;
  gap: var(--sp-2);
}

.toc-card-label .dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent-blue);
}

.toc-link {
  display: flex;
  align-items: center;
  gap: var(--sp-2);
  color: var(--text-secondary);
  text-decoration: none;
  padding: 5px 0;
  font-size: 0.875rem;
  border-radius: var(--r-sm);
  transition: color var(--dur) var(--ease);
  cursor: pointer;
}

.toc-link:hover { color: var(--text-primary); }

.toc-link .num {
  font-size: 0.68rem;
  color: var(--text-muted);
  min-width: 20px;
  font-family: var(--font-mono);
}

.toc-link:hover .num { color: var(--accent-blue); }

/* ============================================================
   MODAL SYSTEM
   ============================================================ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--modal-overlay);
  z-index: 1000;
  overflow-y: auto;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  animation: fadeIn 200ms var(--ease) forwards;
}

.modal-overlay.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

.modal-box {
  max-width: 1280px;
  margin: var(--sp-12) auto;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  box-shadow: var(--shadow-modal);
  overflow: hidden;
  animation: slideUp 280ms var(--ease) forwards;
}

@keyframes slideUp {
  from { transform: translateY(24px); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}

/* Modal header bar */
.modal-header {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: var(--sp-4) var(--sp-6);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 10;
}

.modal-crumb {
  font-size: 0.78rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: var(--sp-2);
}

.modal-crumb strong {
  color: var(--text-primary);
  font-weight: 600;
}

.modal-close-btn {
  background: var(--bg-accent);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: var(--r-sm);
  padding: var(--sp-2) var(--sp-4);
  cursor: pointer;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  gap: var(--sp-2);
  transition: all var(--dur) var(--ease);
}
.modal-close-btn:hover { background: var(--accent-red); border-color: var(--accent-red); color: #fff; }

/* Modal body */
.modal-body { padding: var(--sp-8); }

/* ============================================================
   COMPARISON LAYOUT (inside modal)
   ============================================================ */
.comparison {
  margin-bottom: var(--sp-8);
}

.topic-title {
  font-size: clamp(1.2rem, 2.5vw, 1.6rem);
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: var(--sp-6);
  padding-bottom: var(--sp-4);
  border-bottom: 1px solid var(--border);
  letter-spacing: -0.02em;
}

.comparison-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--sp-4);
}

@media (max-width: 780px) {
  .comparison-grid { grid-template-columns: 1fr; }
}

.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  overflow: hidden;
}

.panel-header {
  padding: var(--sp-3) var(--sp-5);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}

.panel-header h3 {
  font-size: 0.85rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: var(--sp-2);
}

.panel.panel-old { border-top: 2px solid var(--old-border); }
.panel.panel-old .panel-header h3 { color: var(--accent-red); }

.panel.panel-new { border-top: 2px solid var(--new-border); }
.panel.panel-new .panel-header h3 { color: var(--accent-green); }

/* Copy button */
.copy-btn {
  background: rgba(79,158,255,0.1);
  border: 1px solid rgba(79,158,255,0.2);
  color: var(--accent-blue);
  border-radius: var(--r-sm);
  padding: 3px 10px;
  font-size: 0.7rem;
  cursor: pointer;
  transition: all var(--dur) var(--ease);
  font-family: var(--font-mono);
}
.copy-btn:hover { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
.copy-btn.copied { background: var(--accent-green); border-color: var(--accent-green); color: #fff; }

/* Code blocks */
pre {
  background: var(--bg-code);
  padding: var(--sp-5);
  overflow-x: auto;
  font-family: var(--font-mono);
  font-size: 0.82rem;
  line-height: 1.7;
  white-space: pre;
  word-wrap: normal;
  margin: 0;
}

code {
  display: block;
  min-width: max-content;
}

/* Full-width panels (for topics with no left/right split) */
.panel-full {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  overflow: hidden;
  margin-bottom: var(--sp-4);
}

.panel-full .panel-header {
  padding: var(--sp-3) var(--sp-5);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.panel-full .panel-header h3 {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--accent-blue);
}

/* ============================================================
   NOTE & EXPLANATION BOXES
   ============================================================ */
.note, .explanation {
  padding: var(--sp-4) var(--sp-5);
  border-radius: var(--r-md);
  margin-top: var(--sp-3);
  font-size: 0.875rem;
  line-height: 1.65;
}

.note {
  background: var(--note-bg);
  border-left: 3px solid var(--note-border);
}

.note strong { color: var(--accent-amber); }

.explanation {
  background: var(--expl-bg);
  border-left: 3px solid var(--expl-border);
}

.explanation strong { color: var(--accent-blue); }

/* Insight row (2-column layout for Hinglish/English) */
.insight-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--sp-3);
  margin-top: var(--sp-3);
}

@media (max-width: 640px) {
  .insight-row { grid-template-columns: 1fr; }
}

.insight-box {
  padding: var(--sp-4);
  border-radius: var(--r-md);
  font-size: 0.84rem;
  line-height: 1.6;
}

.insight-box.hi {
  background: rgba(167,139,250,0.06);
  border: 1px solid rgba(167,139,250,0.15);
}

.insight-box.en {
  background: rgba(79,158,255,0.06);
  border: 1px solid rgba(79,158,255,0.15);
}

.insight-box .tag {
  font-size: 0.68rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: var(--sp-2);
  display: block;
  font-weight: 700;
}

.insight-box.hi .tag { color: var(--accent-purple); }
.insight-box.en .tag { color: var(--accent-blue); }

/* ============================================================
   MODAL NAVIGATION FOOTER
   ============================================================ */
.nav-footer {
  background: var(--bg-card);
  border-top: 1px solid var(--border);
  padding: var(--sp-6) var(--sp-8);
  margin-top: var(--sp-8);
  border-radius: 0 0 var(--r-xl) var(--r-xl);
}

.nav-footer-title {
  font-size: 0.72rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: var(--sp-4);
}

.nav-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: var(--sp-3);
}

.nav-btn {
  background: var(--bg-accent);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: var(--r-md);
  padding: var(--sp-3) var(--sp-5);
  cursor: pointer;
  font-size: 0.84rem;
  transition: all var(--dur) var(--ease);
  text-align: left;
}

.nav-btn:hover {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: #fff;
  transform: translateY(-1px);
}

.nav-btn .arrow { opacity: 0.5; margin-right: var(--sp-2); }

.nav-btn-back {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-muted);
  border-radius: var(--r-md);
  padding: var(--sp-3) var(--sp-5);
  cursor: pointer;
  font-size: 0.84rem;
  transition: all var(--dur) var(--ease);
  margin-top: var(--sp-4);
  display: inline-flex;
  align-items: center;
  gap: var(--sp-2);
}

.nav-btn-back:hover { color: var(--text-primary); border-color: var(--text-muted); }

/* ============================================================
   KEYBOARD SHORTCUT HINT
   ============================================================ */
.kbd-hint {
  font-size: 0.7rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: var(--sp-2);
  margin-top: var(--sp-3);
}

kbd {
  background: var(--bg-accent);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1px 6px;
  font-size: 0.68rem;
  font-family: var(--font-mono);
}

/* ============================================================
   SEARCH BAR
   ============================================================ */
.search-wrap {
  position: relative;
  max-width: 420px;
}

.search-input {
  width: 100%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: var(--sp-3) var(--sp-4) var(--sp-3) 36px;
  color: var(--text-primary);
  font-size: 0.875rem;
  font-family: inherit;
  transition: border-color var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
}

.search-input::placeholder { color: var(--text-muted); }

.search-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(79,158,255,0.12);
}

.search-icon {
  position: absolute;
  left: 11px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 0.9rem;
  pointer-events: none;
}

/* Search results dropdown */
.search-results {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  box-shadow: var(--shadow-card);
  z-index: 200;
  max-height: 280px;
  overflow-y: auto;
  display: none;
}

.search-results.open { display: block; }

.search-result-item {
  padding: var(--sp-3) var(--sp-4);
  cursor: pointer;
  font-size: 0.84rem;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: var(--sp-3);
  transition: background var(--dur) var(--ease);
}

.search-result-item:last-child { border-bottom: none; }
.search-result-item:hover { background: var(--bg-accent); color: var(--text-primary); }
.search-result-item .ri { font-size: 0.7rem; color: var(--text-muted); font-family: var(--font-mono); min-width: 24px; }

/* Hidden content div (topic HTML lives here, invisible) */
.content { display: none; }

/* ============================================================
   FOOTER
   ============================================================ */
.site-footer {
  border-top: 1px solid var(--border);
  padding: var(--sp-8);
  text-align: center;
  color: var(--text-muted);
  font-size: 0.82rem;
}

.site-footer strong { color: var(--text-secondary); }

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 640px) {
  .header-inner { padding: var(--sp-3) var(--sp-4); }
  .hero { padding: var(--sp-8) var(--sp-4); }
  .toc-section { padding: var(--sp-6) var(--sp-4); }
  .modal-body { padding: var(--sp-4); }
  .modal-box { margin: var(--sp-4); border-radius: var(--r-lg); }
  .hero-stats { gap: var(--sp-4); }
  .stat-divider { display: none; }
}

/* ============================================================
   REVEAL ANIMATION (IntersectionObserver)
   ============================================================ */
.reveal {
  opacity: 0;
  transform: translateY(12px);
  transition: opacity 400ms var(--ease), transform 400ms var(--ease);
}

.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ============================================================
   UPGRADE 1 — XP STREAK BAR + LEVEL SYSTEM
   Dopamine: visible mastery progression creates compulsion to fill bar
   ============================================================ */
.xp-bar-wrap {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 6px var(--sp-8);
  display: flex;
  align-items: center;
  gap: var(--sp-4);
}
.xp-label {
  font-size: 0.68rem;
  color: var(--text-muted);
  letter-spacing: 0.06em;
  text-transform: uppercase;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
}
.xp-level-badge {
  background: linear-gradient(135deg, var(--accent-amber), #ff8c00);
  color: #000;
  font-size: 0.62rem;
  font-weight: 800;
  padding: 2px 7px;
  border-radius: 20px;
  letter-spacing: 0.04em;
}
.xp-track {
  flex: 1;
  height: 5px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.xp-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
  border-radius: 3px;
  transition: width 600ms cubic-bezier(0.22, 1, 0.36, 1);
  width: 0%;
}
.xp-pts {
  font-size: 0.7rem;
  color: var(--accent-amber);
  font-family: var(--font-mono);
  white-space: nowrap;
  min-width: 52px;
  text-align: right;
}

/* ============================================================
   UPGRADE 2 — TOPIC COMPLETION CHECKMARKS ON TOC LINKS
   Zeigarnik: incomplete items draw attention, checks give closure
   ============================================================ */
.toc-link .chk {
  margin-left: auto;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 1.5px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.55rem;
  transition: all 200ms var(--ease);
  flex-shrink: 0;
  color: transparent;
}
.toc-link.done .chk {
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: #fff;
}
.toc-link.done {
  color: var(--text-primary);
}
.toc-link.done .num { color: var(--accent-green); }

/* Section completion badge */
.section-label .s-done {
  font-size: 0.65rem;
  background: rgba(61,214,140,0.12);
  border: 1px solid rgba(61,214,140,0.25);
  color: var(--accent-green);
  border-radius: 10px;
  padding: 1px 8px;
  margin-left: var(--sp-2);
  font-weight: 600;
}

/* ============================================================
   UPGRADE 3 — BURST CELEBRATION TOAST
   Variable reward: unexpected celebration triggers dopamine spike
   ============================================================ */
#toast-wrap {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 9000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}
.toast {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.84rem;
  color: var(--text-primary);
  box-shadow: var(--shadow-card);
  animation: toastIn 300ms var(--ease) forwards;
  pointer-events: auto;
  max-width: 300px;
}
.toast .t-icon { font-size: 1.2rem; flex-shrink: 0; }
.toast .t-msg { line-height: 1.4; }
.toast .t-msg strong { display: block; font-size: 0.78rem; color: var(--accent-blue); margin-bottom: 1px; }
.toast.t-out { animation: toastOut 300ms var(--ease) forwards; }
@keyframes toastIn {
  from { opacity:0; transform: translateX(32px) scale(0.94); }
  to   { opacity:1; transform: translateX(0)    scale(1);    }
}
@keyframes toastOut {
  from { opacity:1; transform: translateX(0)    scale(1);    }
  to   { opacity:0; transform: translateX(32px) scale(0.94); }
}

/* ============================================================
   UPGRADE 4 — MODAL TOPIC MINI PROGRESS STRIP
   Context: shows "topic 5 of 33" inside modal giving sense of journey
   ============================================================ */
.modal-progress-strip {
  height: 3px;
  background: var(--border);
  position: relative;
  overflow: hidden;
}
.modal-progress-fill {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
  transition: width 500ms cubic-bezier(0.22, 1, 0.36, 1);
}
.modal-topic-counter {
  font-size: 0.68rem;
  color: var(--text-muted);
  font-family: var(--font-mono);
  margin-left: auto;
  padding-right: var(--sp-2);
  white-space: nowrap;
}

/* ============================================================
   UPGRADE 5 — STREAK INDICATOR (day streak simulation)
   Habit loop: streak creates loss aversion ("don't break the chain")
   ============================================================ */
.streak-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  background: rgba(240,165,0,0.1);
  border: 1px solid rgba(240,165,0,0.2);
  color: var(--accent-amber);
  border-radius: 20px;
  padding: 3px 10px;
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.02em;
  cursor: default;
  transition: transform 200ms var(--ease);
}
.streak-pill:hover { transform: scale(1.05); }
.streak-fire { animation: fireWiggle 2s ease-in-out infinite; display: inline-block; }
@keyframes fireWiggle {
  0%,100% { transform: rotate(-4deg) scale(1); }
  50%      { transform: rotate(4deg) scale(1.1); }
}

/* ============================================================
   UPGRADE 6 — "RECOMMENDED NEXT" SMART PILL IN NAV FOOTER
   Authority: algorithmic-feeling nudge implies intelligence
   ============================================================ */
.rec-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 0.62rem;
  background: rgba(167,139,250,0.1);
  border: 1px solid rgba(167,139,250,0.25);
  color: var(--accent-purple);
  border-radius: 10px;
  padding: 2px 8px;
  margin-bottom: 4px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
}
.nav-btn.nav-btn-rec {
  border-color: rgba(167,139,250,0.4);
  position: relative;
}
.nav-btn.nav-btn-rec::before {
  content: '';
  position: absolute;
  inset: -1px;
  border-radius: inherit;
  background: linear-gradient(135deg, rgba(79,158,255,0.08), rgba(167,139,250,0.08));
  pointer-events: none;
}

/* ============================================================
   UPGRADE 7 — "YOU'VE LEARNED X%" MOTIVATIONAL HERO STAT
   Social proof illusion: showing % mastery makes progress tangible
   ============================================================ */
.mastery-ring-wrap {
  display: flex;
  align-items: center;
  gap: var(--sp-3);
}
.mastery-ring {
  width: 48px;
  height: 48px;
  flex-shrink: 0;
}
.mastery-ring circle {
  fill: none;
  stroke-width: 4;
  stroke-linecap: round;
}
.mastery-ring .ring-bg { stroke: var(--border); }
.mastery-ring .ring-fill {
  stroke: var(--accent-blue);
  stroke-dasharray: 113;
  stroke-dashoffset: 113;
  transform: rotate(-90deg);
  transform-origin: 50% 50%;
  transition: stroke-dashoffset 800ms cubic-bezier(0.22, 1, 0.36, 1);
}
.mastery-text { line-height: 1.3; }
.mastery-pct  { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); }
.mastery-sub  { font-size: 0.7rem; color: var(--text-muted); }

/* ============================================================
   UPGRADE 8 — TIMED "COME BACK" LAST SESSION RECALL
   Contextual memory: "You were studying X" creates belonging
   ============================================================ */
.recall-banner {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent-purple);
  border-radius: var(--r-md);
  padding: var(--sp-3) var(--sp-5);
  margin-bottom: var(--sp-5);
  display: none;
  align-items: center;
  gap: var(--sp-4);
  font-size: 0.84rem;
}
.recall-banner.show { display: flex; }
.recall-banner .rb-text { flex: 1; color: var(--text-secondary); }
.recall-banner .rb-text strong { color: var(--text-primary); }
.recall-banner .rb-resume {
  background: var(--accent-purple);
  color: #fff;
  border: none;
  border-radius: var(--r-sm);
  padding: 5px 14px;
  font-size: 0.78rem;
  cursor: pointer;
  font-weight: 600;
  transition: opacity 200ms;
  white-space: nowrap;
}
.recall-banner .rb-resume:hover { opacity: 0.85; }
.recall-banner .rb-dismiss {
  color: var(--text-muted);
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  padding: 0 4px;
  transition: color 200ms;
}
.recall-banner .rb-dismiss:hover { color: var(--text-primary); }

/* ============================================================
   UPGRADE 9 — CONFETTI BURST (CSS-only, zero DOM bloat)
   Milestone reward: section completion triggers delight
   ============================================================ */
.confetti-burst {
  position: fixed;
  top: 0; left: 50%;
  transform: translateX(-50%);
  pointer-events: none;
  z-index: 9998;
  display: flex;
  gap: 6px;
}
.confetti-burst span {
  width: 8px;
  height: 8px;
  border-radius: 2px;
  animation: confettiFall 900ms var(--ease) forwards;
  opacity: 0;
}
@keyframes confettiFall {
  0%   { opacity: 1; transform: translateY(0)   rotate(0deg);   }
  100% { opacity: 0; transform: translateY(260px) rotate(540deg); }
}

/* ============================================================
   V3 UPGRADE 1 — XP POP FLOAT (+N XP animation on topic open)
   Variable reward: seeing "+30 XP" float creates immediate dopamine
   ============================================================ */
.xp-pop {
  position: fixed;
  font-size: 0.82rem;
  font-weight: 800;
  font-family: var(--font-mono);
  color: var(--accent-amber);
  pointer-events: none;
  z-index: 9999;
  text-shadow: 0 0 12px rgba(240,165,0,0.5);
  animation: xpFloat 1100ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
}
@keyframes xpFloat {
  0%   { opacity: 0; transform: translateY(0)    scale(0.7); }
  20%  { opacity: 1; transform: translateY(-8px)  scale(1.2); }
  80%  { opacity: 1; transform: translateY(-32px) scale(1);   }
  100% { opacity: 0; transform: translateY(-48px) scale(0.9); }
}

/* ============================================================
   V3 UPGRADE 2 — LEVEL-UP FULLSCREEN FLASH
   Peak moment: level transitions feel earned and epic
   ============================================================ */
.levelup-flash {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9990;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: flashFade 1200ms var(--ease) forwards;
}
.levelup-flash::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, rgba(79,158,255,0.18) 0%, transparent 70%);
}
.levelup-inner {
  text-align: center;
  animation: levelPop 1200ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
}
.levelup-inner .lu-label {
  font-size: 0.72rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--accent-blue);
  margin-bottom: 6px;
}
.levelup-inner .lu-title {
  font-size: clamp(1.6rem, 5vw, 2.8rem);
  font-weight: 900;
  letter-spacing: -0.04em;
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1;
}
.levelup-inner .lu-sub {
  font-size: 0.84rem;
  color: var(--text-secondary);
  margin-top: 8px;
}
@keyframes flashFade {
  0%   { opacity: 0; }
  15%  { opacity: 1; }
  70%  { opacity: 1; }
  100% { opacity: 0; }
}
@keyframes levelPop {
  0%   { transform: scale(0.5); opacity: 0; }
  40%  { transform: scale(1.08); opacity: 1; }
  65%  { transform: scale(0.97); }
  80%  { transform: scale(1.02); }
  100% { transform: scale(1); opacity: 1; }
}

/* ============================================================
   V3 UPGRADE 3 — TIMED READING INDICATOR on modal
   Perceived value: "~2 min read" sets expectation, reduces exit anxiety
   ============================================================ */
.read-time-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 0.68rem;
  color: var(--text-muted);
  background: var(--bg-accent);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2px 10px;
  font-family: var(--font-mono);
}

/* ============================================================
   V3 UPGRADE 4 — AMBIENT GLOW on active card hover
   Perceived polish: subtle glow creates premium material feel
   ============================================================ */
.toc-card {
  position: relative;
}
.toc-card::after {
  content: '';
  position: absolute;
  inset: -1px;
  border-radius: var(--r-lg);
  opacity: 0;
  background: radial-gradient(ellipse at var(--mx, 50%) var(--my, 50%), rgba(79,158,255,0.12) 0%, transparent 65%);
  pointer-events: none;
  transition: opacity 300ms var(--ease);
  border: 1px solid transparent;
}
.toc-card:hover::after { opacity: 1; }

/* ============================================================
   V3 UPGRADE 5 — TOPIC "DIFFICULTY" MICRO-BADGE on TOC links
   Perceived intelligence: difficulty labeling creates curriculum authority
   ============================================================ */
.diff-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-left: 4px;
}
.diff-easy   { background: var(--accent-green); }
.diff-medium { background: var(--accent-amber); }
.diff-hard   { background: var(--accent-red);   }

/* ============================================================
   V3 UPGRADE 6 — FOCUS MODE: dim surrounding panels in modal
   Cognitive clarity: reducing visual noise improves concentration
   ============================================================ */
.comparison-grid:hover .panel {
  opacity: 0.7;
  transition: opacity 250ms var(--ease);
}
.comparison-grid:hover .panel:hover {
  opacity: 1;
  transform: translateY(-1px);
  box-shadow: var(--shadow-card);
  transition: opacity 150ms var(--ease), transform 150ms var(--ease), box-shadow 150ms var(--ease);
}

/* ============================================================
   V3 UPGRADE 7 — HERO ANIMATED COUNTER (count-up on load)
   Perceived activity: counting numbers feel like a live system
   ============================================================ */
.stat-item .num { display: inline-block; }

/* ============================================================
   V3 UPGRADE 8 — "LAST ACTIVE X TOPICS AGO" proximity hint on TOC
   Social proof illusion: creates sense of a curated learning path
   ============================================================ */
.toc-link.next-up {
  background: rgba(79,158,255,0.05);
  border-radius: var(--r-sm);
  padding-left: 6px;
  padding-right: 6px;
  margin-left: -6px;
  margin-right: -6px;
}
.toc-link.next-up .num { color: var(--accent-blue); }
.next-up-arrow {
  font-size: 0.62rem;
  color: var(--accent-blue);
  margin-left: 4px;
  animation: arrowPulse 1.5s ease-in-out infinite;
  flex-shrink: 0;
}
@keyframes arrowPulse {
  0%,100% { transform: translateX(0); opacity: 0.6; }
  50%      { transform: translateX(3px); opacity: 1; }
}

/* ============================================================
   V3 UPGRADE 9 — FLOATING ACTION BUTTON (continue learning)
   Momentum: always-visible CTA eliminates decision fatigue
   ============================================================ */
.fab {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  z-index: 800;
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
  color: #fff;
  border: none;
  border-radius: 50px;
  padding: 12px 24px;
  font-size: 0.875rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 8px 32px rgba(79,158,255,0.35);
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
  transition: transform 400ms cubic-bezier(0.22, 1, 0.36, 1), box-shadow 200ms var(--ease), opacity 400ms var(--ease);
  letter-spacing: -0.01em;
  opacity: 0;
}
.fab.visible {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}
.fab:hover {
  box-shadow: 0 12px 40px rgba(79,158,255,0.5);
  transform: translateX(-50%) translateY(-2px);
}
.fab .fab-arrow { font-size: 1rem; transition: transform 200ms var(--ease); }
.fab:hover .fab-arrow { transform: translateX(3px); }

/* ============================================================
   V4-1  TOPIC COMPLETION SCREEN — full-modal dopamine hit
   ============================================================ */
.completion-screen {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; text-align: center;
  padding: var(--sp-12) var(--sp-8); gap: var(--sp-5);
  animation: csFadeIn 350ms var(--ease) forwards;
}
@keyframes csFadeIn {
  from { opacity:0; transform:scale(0.96); }
  to   { opacity:1; transform:scale(1); }
}
.cs-icon { font-size: 3.2rem; animation: csBounce 600ms cubic-bezier(0.22, 1, 0.36, 1) forwards; }
@keyframes csBounce {
  0%   { transform:scale(0); }
  60%  { transform:scale(1.18); }
  80%  { transform:scale(0.94); }
  100% { transform:scale(1); }
}
.cs-title { font-size: clamp(1.4rem,3vw,2rem); font-weight:800; letter-spacing:-0.03em; color:var(--text-primary); }
.cs-sub { font-size:0.9rem; color:var(--text-secondary); max-width:320px; line-height:1.5; }
.cs-xp-badge {
  display:inline-flex; align-items:center; gap:6px;
  background:rgba(240,165,0,0.12); border:1px solid rgba(240,165,0,0.3);
  color:var(--accent-amber); border-radius:24px; padding:6px 18px;
  font-size:0.88rem; font-weight:700; font-family:var(--font-mono);
}
.cs-actions { display:flex; gap:var(--sp-3); flex-wrap:wrap; justify-content:center; margin-top:var(--sp-2); }
.cs-btn-next {
  background:linear-gradient(135deg,var(--accent-blue),var(--accent-purple));
  color:#fff; border:none; border-radius:var(--r-md); padding:11px 24px;
  font-size:0.9rem; font-weight:700; cursor:pointer;
  transition:transform 150ms var(--ease),box-shadow 150ms var(--ease);
  box-shadow:0 4px 20px rgba(79,158,255,0.3);
}
.cs-btn-next:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(79,158,255,0.45); }
.cs-btn-back {
  background:var(--bg-accent); border:1px solid var(--border); color:var(--text-secondary);
  border-radius:var(--r-md); padding:11px 20px; font-size:0.88rem; cursor:pointer;
  transition:border-color 150ms var(--ease),color 150ms var(--ease);
}
.cs-btn-back:hover { border-color:var(--text-muted); color:var(--text-primary); }
.cs-progress-line { display:flex; align-items:center; gap:var(--sp-3); font-size:0.75rem; color:var(--text-muted); }
.cs-progress-line .csp-bar { width:120px; height:4px; background:var(--border); border-radius:2px; overflow:hidden; }
.cs-progress-line .csp-fill {
  height:100%; background:linear-gradient(90deg,var(--accent-green),var(--accent-blue));
  border-radius:2px; transition:width 600ms cubic-bezier(0.22, 1, 0.36, 1);
}

/* ============================================================
   V4-2  MASTERY HEATMAP — 28-day activity grid
   ============================================================ */
.heatmap-wrap {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--r-lg); padding:var(--sp-5); margin-bottom:var(--sp-6);
}
.heatmap-title {
  font-size:0.72rem; letter-spacing:0.1em; text-transform:uppercase;
  color:var(--text-muted); margin-bottom:var(--sp-3);
  display:flex; align-items:center; gap:var(--sp-2);
}
.heatmap-grid { display:flex; gap:4px; flex-wrap:wrap; }
.hm-cell { width:14px; height:14px; border-radius:3px; background:var(--border); transition:transform 200ms var(--ease); cursor:default; }
.hm-cell:hover { transform:scale(1.35); }
.hm-cell.hm-1 { background:rgba(61,214,140,0.25); }
.hm-cell.hm-2 { background:rgba(61,214,140,0.5); }
.hm-cell.hm-3 { background:rgba(61,214,140,0.75); }
.hm-cell.hm-4 { background:var(--accent-green); box-shadow:0 0 6px rgba(61,214,140,0.4); }
.hm-cell.hm-today { outline:2px solid var(--accent-blue); outline-offset:1px; }

/* ============================================================
   V4-3  INSIGHT TICKER — scrolling tips at page bottom
   ============================================================ */
.insight-ticker {
  position:fixed; bottom:0; left:0; right:0; height:30px;
  background:var(--bg-card); border-top:1px solid var(--border);
  z-index:700; display:flex; align-items:center; overflow:hidden; pointer-events:none;
}
.insight-ticker-inner {
  display:flex; align-items:center; white-space:nowrap;
  animation:tickerScroll 40s linear infinite;
  font-size:0.72rem; color:var(--text-muted);
}
.insight-ticker-inner span { padding:0 48px; }
.insight-ticker-inner .ti-label {
  color:var(--accent-blue); font-weight:700; letter-spacing:0.06em;
  text-transform:uppercase; padding:0 12px 0 24px;
}
@keyframes tickerScroll {
  0%   { transform:translateX(0); }
  100% { transform:translateX(-50%); }
}

/* ============================================================
   V4-4  LINK SHIMMER on hover (unvisited topics)
   ============================================================ */
@keyframes shimmerSwipe {
  0%   { background-position:-200% center; }
  100% { background-position: 200% center; }
}
.toc-link:not(.done):hover {
  background:linear-gradient(90deg,transparent 0%,rgba(79,158,255,0.07) 45%,rgba(79,158,255,0.13) 50%,rgba(79,158,255,0.07) 55%,transparent 100%);
  background-size:200% auto;
  animation:shimmerSwipe 700ms linear forwards;
  border-radius:var(--r-sm);
}

/* ============================================================
   V4-5  DAILY GOAL RING — tiny ring next to streak
   ============================================================ */
.daily-goal-wrap { display:flex; align-items:center; gap:5px; cursor:default; }
.daily-ring { width:26px; height:26px; flex-shrink:0; }
.daily-ring circle { fill:none; stroke-width:3; stroke-linecap:round; }
.daily-ring .dr-bg { stroke:var(--border); }
.daily-ring .dr-fill {
  stroke:var(--accent-green); stroke-dasharray:63; stroke-dashoffset:63;
  transform:rotate(-90deg); transform-origin:50% 50%;
  transition:stroke-dashoffset 700ms cubic-bezier(0.22, 1, 0.36, 1);
}
.daily-goal-text { font-size:0.68rem; line-height:1.2; color:var(--text-muted); }
.daily-goal-text strong { color:var(--accent-green); display:block; font-size:0.72rem; }

/* ============================================================
   V4-6  PANEL HEARTBEAT on modal open
   ============================================================ */
@keyframes heartbeat {
  0%,100% { box-shadow:0 0 0 0   rgba(79,158,255,0);    }
  40%      { box-shadow:0 0 0 5px rgba(79,158,255,0.15); }
  70%      { box-shadow:0 0 0 2px rgba(79,158,255,0.07); }
}
.panel-new.pulse-once { animation:heartbeat 750ms var(--ease) 120ms forwards; }

/* ============================================================
   V4-7  SESSION COUNTER in header
   ============================================================ */
.session-stat { font-size:0.68rem; color:var(--text-muted); display:flex; align-items:center; gap:4px; white-space:nowrap; }
.session-stat .ss-num { font-weight:800; color:var(--accent-green); font-family:var(--font-mono); font-size:0.78rem; transition:color 300ms; }
.ss-delta { color:var(--accent-green); font-size:0.62rem; animation:ssFlash 700ms var(--ease) forwards; opacity:0; pointer-events:none; position:absolute; margin-top:-18px; margin-left:2px; }
@keyframes ssFlash {
  0%   { opacity:0; transform:translateY(4px);  }
  40%  { opacity:1; transform:translateY(-3px); }
  100% { opacity:0; transform:translateY(-8px); }
}

/* ============================================================
   PREMIUM REFINEMENT LAYER — Apple-grade elevation pass
   Overrides noise, lifts signal. Subtraction is luxury.
   ============================================================ */

/* — Core easing & timing discipline — */
:root {
  --ease: cubic-bezier(0.22, 1, 0.36, 1);
  --dur: 300ms;
  --dur-fast: 180ms;
  --dur-slow: 500ms;

  --font-ui: -apple-system, 'SF Pro Display', 'Helvetica Neue', sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', 'Courier New', monospace;

  --r-sm: 7px;
  --r-md: 12px;
  --r-lg: 18px;
  --r-xl: 26px;

  /* refined spacing — more air */
  --sp-1: 4px; --sp-2: 8px; --sp-3: 14px; --sp-4: 20px;
  --sp-5: 28px; --sp-6: 36px; --sp-8: 48px; --sp-10: 64px; --sp-12: 80px;
}

/* — Richer dark surface palette — */
[data-theme="dark"] {
  --bg-page:      #080a0f;
  --bg-surface:   #0d1018;
  --bg-card:      #111520;
  --bg-code:      #080b12;
  --bg-accent:    #171c2a;

  --border:       #1e2336;
  --border-focus: #4f9eff;

  --text-primary:  #dde4f0;
  --text-secondary: #6e7a93;
  --text-muted:    #3a4459;

  --accent-blue:   #4f9eff;
  --accent-green:  #2ec07a;
  --accent-red:    #e05555;
  --accent-amber:  #d4920a;
  --accent-purple: #8b72e8;

  --shadow-card:  0 1px 3px rgba(0,0,0,0.4), 0 8px 32px rgba(0,0,0,0.3);
  --shadow-modal: 0 32px 96px rgba(0,0,0,0.72), 0 2px 8px rgba(0,0,0,0.5);

  --header-grad:  linear-gradient(180deg, #0a0d14 0%, #0d1018 100%);
  --modal-overlay: rgba(4,6,10,0.94);
}

/* — Scroll progress: single accent, no rainbow — */
#scroll-progress {
  height: 1px;
  background: var(--accent-blue);
  opacity: 0.7;
}

/* — Header: refined, minimal — */
.site-header {
  background: rgba(8, 10, 15, 0.88);
  border-bottom: 1px solid rgba(255,255,255,0.05);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
}

.header-inner {
  padding: 14px var(--sp-8);
}

.header-brand h1 {
  font-size: 1.05rem;
  font-weight: 600;
  letter-spacing: -0.03em;
  color: rgba(255,255,255,0.92);
}

.header-brand span {
  font-size: 0.68rem;
  color: rgba(255,255,255,0.32);
  letter-spacing: 0.04em;
}

/* Remove emoji from header in favor of clean type */
.header-brand h1::before { content: none; }

.btn-theme {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 8px;
  font-size: 0.78rem;
  padding: 6px 12px;
  letter-spacing: 0.01em;
  transition: background var(--dur-fast) var(--ease), border-color var(--dur-fast) var(--ease);
}
.btn-theme:hover {
  background: rgba(255,255,255,0.1);
  border-color: rgba(255,255,255,0.15);
}

.progress-badge {
  font-size: 0.68rem;
  background: transparent;
  border: 1px solid rgba(79,158,255,0.2);
  color: rgba(79,158,255,0.7);
  border-radius: 6px;
  padding: 4px 10px;
  letter-spacing: 0.04em;
}

/* — XP bar: quieter, more architectural — */
.xp-bar-wrap {
  padding: 8px var(--sp-8);
  background: var(--bg-surface);
  border-bottom: 1px solid rgba(255,255,255,0.04);
  gap: var(--sp-4);
}

.xp-level-badge {
  background: rgba(212,146,10,0.12);
  color: var(--accent-amber);
  font-size: 0.6rem;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 5px;
  letter-spacing: 0.06em;
  border: 1px solid rgba(212,146,10,0.2);
}

.xp-track {
  height: 2px;
  background: rgba(255,255,255,0.06);
  border-radius: 2px;
}

.xp-fill {
  background: var(--accent-blue);
  border-radius: 2px;
  transition: width var(--dur-slow) var(--ease);
}

.xp-pts {
  font-size: 0.65rem;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

.xp-label {
  font-size: 0.62rem;
  color: var(--text-muted);
  gap: 6px;
  letter-spacing: 0.08em;
}

/* — Streak pill: quieter — */
.streak-pill {
  background: transparent;
  border: 1px solid rgba(212,146,10,0.15);
  color: rgba(212,146,10,0.65);
  font-size: 0.68rem;
  font-weight: 500;
  padding: 4px 10px;
  border-radius: 6px;
  transition: none;
}
.streak-pill:hover { transform: none; }

.streak-fire {
  animation: none;
  display: inline-block;
  font-size: 0.75em;
}

/* — Hero: cinematic — */
.hero {
  background: var(--bg-surface);
  border-bottom: 1px solid rgba(255,255,255,0.04);
  padding: 100px var(--sp-8) 80px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.hero::before {
  background: radial-gradient(ellipse 70% 55% at 50% -5%, rgba(79,158,255,0.055) 0%, transparent 68%);
}

.hero::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse 40% 30% at 80% 110%, rgba(139,114,232,0.03) 0%, transparent 60%);
  pointer-events: none;
}

.hero-eyebrow {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--text-muted);
  border-radius: 6px;
  padding: 5px 16px;
  font-size: 0.68rem;
  letter-spacing: 0.12em;
  margin-bottom: 32px;
}

.hero h2 {
  font-size: clamp(2.6rem, 6vw, 4.8rem);
  font-weight: 700;
  letter-spacing: -0.045em;
  line-height: 1.02;
  color: var(--text-primary);
  margin-bottom: 24px;
}

.hero h2 .hl {
  color: rgba(255,255,255,0.95);
  font-weight: 700;
}

[data-theme="dark"] .hero h2 .hl {
  background: linear-gradient(135deg, #ffffff 0%, rgba(79,158,255,0.9) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero p {
  font-size: 1.05rem;
  color: var(--text-secondary);
  max-width: 460px;
  margin: 0 auto 56px;
  line-height: 1.7;
  letter-spacing: 0.005em;
}

/* — Hero stats: architectural — */
.hero-stats {
  gap: 48px;
}

.stat-item .num {
  font-size: 1.8rem;
  font-weight: 700;
  letter-spacing: -0.04em;
  color: var(--text-primary);
}

.stat-item .lbl {
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  margin-top: 5px;
}

.stat-divider {
  width: 1px;
  height: 28px;
  background: rgba(255,255,255,0.06);
}

/* Mastery ring: quieter stroke */
.mastery-ring .ring-fill {
  stroke: var(--accent-blue);
  transition: stroke-dashoffset var(--dur-slow) var(--ease);
  opacity: 0.75;
}

.mastery-pct {
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: -0.03em;
}

.mastery-sub {
  font-size: 0.62rem;
  color: var(--text-muted);
  letter-spacing: 0.06em;
}

/* — TOC section — */
.toc-section {
  padding: var(--sp-10) var(--sp-8) var(--sp-12);
}

.section-label {
  font-size: 0.65rem;
  letter-spacing: 0.15em;
  color: var(--text-muted);
  margin-bottom: var(--sp-5);
  font-weight: 500;
}

.section-label::after {
  background: rgba(255,255,255,0.05);
}

/* — TOC cards: elevated surfaces — */
.toc-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 24px;
  transition: border-color var(--dur-fast) var(--ease),
              box-shadow var(--dur-fast) var(--ease),
              transform var(--dur-fast) var(--ease);
  position: relative;
}

.toc-card:hover {
  border-color: rgba(79,158,255,0.3);
  box-shadow: 0 0 0 1px rgba(79,158,255,0.12),
              0 8px 40px rgba(0,0,0,0.4),
              0 2px 8px rgba(0,0,0,0.3);
  transform: translateY(-3px);
}

/* Quieter ambient glow */
.toc-card::after {
  background: radial-gradient(ellipse at var(--mx, 50%) var(--my, 50%), rgba(79,158,255,0.07) 0%, transparent 65%);
  transition: opacity var(--dur) var(--ease);
}

.toc-card-label {
  font-size: 0.62rem;
  letter-spacing: 0.13em;
  color: var(--text-muted);
  margin-bottom: 16px;
  font-weight: 500;
}

.toc-card-label .dot {
  width: 5px;
  height: 5px;
  background: rgba(79,158,255,0.5);
}

.toc-link {
  color: var(--text-secondary);
  padding: 7px 0;
  font-size: 0.84rem;
  letter-spacing: -0.005em;
  transition: color var(--dur-fast) var(--ease);
}

.toc-link:hover { color: var(--text-primary); }

.toc-link .num {
  font-size: 0.62rem;
  color: var(--text-muted);
  min-width: 22px;
  font-family: var(--font-mono);
  letter-spacing: 0.03em;
  opacity: 0.6;
}

/* Shimmer: subtler */
.toc-link:not(.done):hover {
  background: rgba(79,158,255,0.04);
  animation: none;
  border-radius: 6px;
  padding-left: 6px;
  padding-right: 6px;
  margin-left: -6px;
  margin-right: -6px;
}

/* Completion marks: quieter */
.toc-link .chk {
  width: 13px;
  height: 13px;
  border: 1px solid rgba(255,255,255,0.1);
  font-size: 0.5rem;
  transition: all var(--dur-fast) var(--ease);
}

.toc-link.done .chk {
  background: rgba(46,192,122,0.15);
  border-color: rgba(46,192,122,0.35);
  color: var(--accent-green);
}

.toc-link.done .num { color: rgba(46,192,122,0.5); }

/* Section complete badge */
.section-label .s-done {
  background: transparent;
  border: 1px solid rgba(46,192,122,0.2);
  color: rgba(46,192,122,0.55);
  border-radius: 5px;
  font-size: 0.62rem;
  padding: 2px 8px;
}

/* Difficulty dots: quieter */
.diff-dot { opacity: 0.5; }
.diff-easy   { background: var(--accent-green); }
.diff-medium { background: var(--accent-amber); }
.diff-hard   { background: var(--accent-red); }

/* Next-up highlight: subtle */
.toc-link.next-up {
  background: rgba(79,158,255,0.04);
}

.next-up-arrow {
  animation: none;
  opacity: 0.5;
  font-size: 0.55rem;
}

/* — Heatmap: architectural — */
.heatmap-wrap {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 20px 24px;
  margin-bottom: 32px;
}

.heatmap-title {
  font-size: 0.62rem;
  letter-spacing: 0.12em;
  color: var(--text-muted);
  margin-bottom: 12px;
  font-weight: 500;
}

.hm-cell {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  background: rgba(255,255,255,0.04);
  transition: transform var(--dur-fast) var(--ease);
}

.hm-cell:hover { transform: scale(1.3); }

.hm-cell.hm-1 { background: rgba(46,192,122,0.18); }
.hm-cell.hm-2 { background: rgba(46,192,122,0.38); }
.hm-cell.hm-3 { background: rgba(46,192,122,0.62); }
.hm-cell.hm-4 { background: rgba(46,192,122,0.85); box-shadow: none; }
.hm-cell.hm-today { outline: 1px solid rgba(79,158,255,0.4); outline-offset: 1px; }

/* — Recall banner: editorial — */
.recall-banner {
  background: rgba(139,114,232,0.04);
  border: 1px solid rgba(139,114,232,0.12);
  border-left: 2px solid rgba(139,114,232,0.4);
  border-radius: var(--r-md);
  padding: 16px 20px;
  margin-bottom: 24px;
  font-size: 0.84rem;
  gap: var(--sp-4);
}

.recall-banner .rb-resume {
  background: rgba(139,114,232,0.12);
  color: var(--accent-purple);
  border: 1px solid rgba(139,114,232,0.25);
  border-radius: 7px;
  padding: 6px 14px;
  font-size: 0.78rem;
  font-weight: 500;
  cursor: pointer;
  transition: background var(--dur-fast) var(--ease);
}
.recall-banner .rb-resume:hover { background: rgba(139,114,232,0.2); }

/* — Modal system: refined — */
.modal-overlay {
  backdrop-filter: blur(16px) saturate(160%);
  animation: fadeIn var(--dur-fast) var(--ease) forwards;
}

.modal-box {
  margin: 48px auto;
  border-radius: var(--r-xl);
  border: 1px solid rgba(255,255,255,0.07);
  box-shadow: var(--shadow-modal);
  animation: slideUp 400ms var(--ease) forwards;
}

@keyframes slideUp {
  from { transform: translateY(20px) scale(0.99); opacity: 0; }
  to   { transform: translateY(0)    scale(1);    opacity: 1; }
}

.modal-header {
  background: rgba(8,10,15,0.6);
  border-bottom: 1px solid rgba(255,255,255,0.05);
  backdrop-filter: blur(20px);
  padding: 16px 28px;
}

.modal-close-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--text-muted);
  border-radius: 7px;
  font-size: 0.76rem;
  padding: 6px 14px;
  transition: all var(--dur-fast) var(--ease);
}

.modal-close-btn:hover {
  background: rgba(224,85,85,0.12);
  border-color: rgba(224,85,85,0.3);
  color: var(--accent-red);
}

.modal-body { padding: 40px 48px; }

/* Progress strip: single color */
.modal-progress-fill {
  background: var(--accent-blue);
  opacity: 0.6;
  transition: width var(--dur-slow) var(--ease);
}

/* — Panels inside modal — */
.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
}

.panel.panel-old { border-top: 1px solid rgba(224,85,85,0.4); }
.panel.panel-new { border-top: 1px solid rgba(46,192,122,0.4); }
.panel.panel-old .panel-header h3 { color: rgba(224,85,85,0.75); }
.panel.panel-new .panel-header h3 { color: rgba(46,192,122,0.75); }

/* Focus mode: very subtle */
.comparison-grid:hover .panel { opacity: 0.82; }
.comparison-grid:hover .panel:hover {
  opacity: 1;
  transform: translateY(-1px);
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
}

/* Panel heartbeat: removed visual noise */
.panel-new.pulse-once { animation: none; }

/* — Topic title — */
.topic-title {
  font-size: clamp(1.1rem, 2.2vw, 1.5rem);
  font-weight: 600;
  letter-spacing: -0.03em;
  margin-bottom: 28px;
  padding-bottom: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  color: var(--text-primary);
}

/* — Code blocks — */
pre {
  font-size: 0.8rem;
  line-height: 1.75;
  background: var(--bg-code);
  padding: 20px 24px;
}

/* — Copy button — */
.copy-btn {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--text-muted);
  border-radius: 5px;
  font-size: 0.65rem;
  padding: 3px 10px;
  transition: all var(--dur-fast) var(--ease);
}

.copy-btn:hover {
  background: rgba(79,158,255,0.1);
  border-color: rgba(79,158,255,0.3);
  color: var(--accent-blue);
}

.copy-btn.copied {
  background: rgba(46,192,122,0.1);
  border-color: rgba(46,192,122,0.3);
  color: var(--accent-green);
}

/* — Note/explanation boxes — */
.note, .explanation {
  border-radius: var(--r-sm);
  padding: 16px 20px;
  font-size: 0.86rem;
  line-height: 1.7;
}

.note { border-left: 2px solid rgba(212,146,10,0.5); background: rgba(212,146,10,0.04); }
.explanation { border-left: 2px solid rgba(79,158,255,0.4); background: rgba(79,158,255,0.04); }

/* — Insight boxes — */
.insight-box.hi { background: rgba(139,114,232,0.04); border-color: rgba(139,114,232,0.1); }
.insight-box.en { background: rgba(79,158,255,0.04);  border-color: rgba(79,158,255,0.1); }

/* — Toast: minimal — */
.toast {
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r-md);
  padding: 12px 18px;
  font-size: 0.82rem;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  max-width: 280px;
  animation: toastIn 350ms var(--ease) forwards;
}

.toast .t-icon { font-size: 1rem; }

.toast .t-msg strong {
  color: var(--text-secondary);
  font-size: 0.74rem;
  font-weight: 500;
  letter-spacing: 0.02em;
}

@keyframes toastIn {
  from { opacity:0; transform: translateY(12px) scale(0.97); }
  to   { opacity:1; transform: translateY(0)     scale(1);   }
}

@keyframes toastOut {
  from { opacity:1; transform: translateY(0) scale(1); }
  to   { opacity:0; transform: translateY(8px) scale(0.97); }
}

/* — XP pop: subtle — */
.xp-pop {
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--accent-amber);
  text-shadow: none;
  animation: xpFloat 900ms var(--ease) forwards;
}

@keyframes xpFloat {
  0%   { opacity: 0; transform: translateY(0) scale(0.8); }
  25%  { opacity: 1; transform: translateY(-10px) scale(1); }
  80%  { opacity: 0.7; transform: translateY(-28px) scale(1); }
  100% { opacity: 0; transform: translateY(-38px) scale(0.95); }
}

/* — Level-up flash: cinematic not garish — */
.levelup-flash::before {
  background: radial-gradient(ellipse at center, rgba(79,158,255,0.1) 0%, transparent 65%);
}

.levelup-inner {
  animation: levelPop 900ms var(--ease) forwards;
}

@keyframes levelPop {
  0%   { transform: scale(0.88); opacity: 0; }
  45%  { transform: scale(1.02); opacity: 1; }
  70%  { transform: scale(0.99); }
  100% { transform: scale(1); opacity: 1; }
}

.levelup-inner .lu-title {
  font-size: clamp(1.5rem, 4.5vw, 2.4rem);
  font-weight: 700;
  letter-spacing: -0.04em;
  background: linear-gradient(135deg, #ffffff 30%, rgba(79,158,255,0.85) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* — FAB: single-color, precise — */
.fab {
  background: var(--accent-blue);
  background: linear-gradient(135deg, #3d8fe8, #4f9eff);
  box-shadow: 0 4px 24px rgba(79,158,255,0.22), 0 1px 4px rgba(0,0,0,0.3);
  border-radius: 48px;
  padding: 11px 22px;
  font-size: 0.84rem;
  font-weight: 500;
  letter-spacing: -0.01em;
  transition: transform var(--dur-fast) var(--ease), box-shadow var(--dur-fast) var(--ease), opacity var(--dur) var(--ease);
}

.fab.visible {
  transform: translateX(-50%) translateY(0);
  opacity: 0.92;
}

.fab:hover {
  box-shadow: 0 8px 32px rgba(79,158,255,0.35), 0 1px 4px rgba(0,0,0,0.3);
  transform: translateX(-50%) translateY(-2px);
  opacity: 1;
}

/* — Completion screen — */
.completion-screen {
  padding: 72px var(--sp-8);
  gap: 20px;
  animation: csFadeIn 400ms var(--ease) forwards;
}

@keyframes csFadeIn {
  from { opacity:0; transform: translateY(12px); }
  to   { opacity:1; transform: translateY(0); }
}

.cs-icon {
  font-size: 2.6rem;
  animation: csIconIn 500ms var(--ease) forwards;
}

@keyframes csIconIn {
  0%   { transform: scale(0.7); opacity: 0; }
  60%  { transform: scale(1.06); opacity: 1; }
  100% { transform: scale(1); }
}

.cs-title {
  font-size: clamp(1.3rem, 2.5vw, 1.8rem);
  font-weight: 700;
  letter-spacing: -0.04em;
}

.cs-xp-badge {
  background: rgba(212,146,10,0.08);
  border: 1px solid rgba(212,146,10,0.2);
  color: var(--accent-amber);
  border-radius: 8px;
  padding: 7px 18px;
  font-size: 0.85rem;
  font-weight: 600;
}

.cs-btn-next {
  background: var(--accent-blue);
  box-shadow: 0 2px 16px rgba(79,158,255,0.2);
  border-radius: var(--r-md);
  padding: 11px 24px;
  font-size: 0.88rem;
  font-weight: 500;
  transition: transform var(--dur-fast) var(--ease), box-shadow var(--dur-fast) var(--ease);
}

.cs-btn-next:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 24px rgba(79,158,255,0.3);
}

.cs-progress-line .csp-fill {
  background: var(--accent-green);
  opacity: 0.7;
  transition: width var(--dur-slow) var(--ease);
}

/* — Nav footer — */
.nav-footer {
  background: rgba(8,10,15,0.6);
  border-top: 1px solid rgba(255,255,255,0.05);
  backdrop-filter: blur(16px);
  padding: 24px 40px;
}

.nav-footer-title {
  font-size: 0.62rem;
  letter-spacing: 0.15em;
  color: var(--text-muted);
  margin-bottom: 16px;
  font-weight: 500;
}

.nav-btn {
  background: var(--bg-accent);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 12px 18px;
  font-size: 0.82rem;
  color: var(--text-secondary);
  transition: all var(--dur-fast) var(--ease);
}

.nav-btn:hover {
  background: rgba(79,158,255,0.08);
  border-color: rgba(79,158,255,0.25);
  color: var(--text-primary);
  transform: translateY(-1px);
}

.nav-btn.nav-btn-rec::before { display: none; }

.rec-badge {
  background: transparent;
  border: 1px solid rgba(139,114,232,0.2);
  color: rgba(139,114,232,0.6);
  border-radius: 5px;
  font-size: 0.58rem;
  padding: 2px 7px;
  letter-spacing: 0.08em;
}

/* — Daily goal ring: quieter — */
.daily-ring .dr-fill {
  stroke: rgba(46,192,122,0.6);
  transition: stroke-dashoffset var(--dur-slow) var(--ease);
}

.daily-goal-text { font-size: 0.62rem; color: var(--text-muted); }
.daily-goal-text strong { color: rgba(46,192,122,0.6); font-size: 0.68rem; }

/* — Session stat — */
.session-stat { font-size: 0.65rem; color: var(--text-muted); }
.session-stat .ss-num { color: var(--text-secondary); font-size: 0.72rem; font-weight: 600; }

/* — Insight ticker: minimal — */
.insight-ticker {
  background: rgba(8,10,15,0.9);
  border-top: 1px solid rgba(255,255,255,0.04);
  height: 28px;
}

.insight-ticker-inner {
  font-size: 0.68rem;
  color: var(--text-muted);
  animation: tickerScroll 60s linear infinite;
  letter-spacing: 0.02em;
}

.insight-ticker-inner .ti-label {
  color: var(--text-muted);
  font-weight: 500;
  letter-spacing: 0.1em;
}

/* — Search — */
.search-input {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  font-size: 0.875rem;
  padding: 11px 14px 11px 36px;
  color: var(--text-primary);
  transition: border-color var(--dur-fast) var(--ease), box-shadow var(--dur-fast) var(--ease);
}

.search-input:focus {
  border-color: rgba(79,158,255,0.35);
  box-shadow: 0 0 0 3px rgba(79,158,255,0.08);
}

.search-results {
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  background: var(--bg-card);
  box-shadow: 0 12px 48px rgba(0,0,0,0.4);
}

/* — Read time badge — */
.read-time-badge {
  font-size: 0.65rem;
  color: var(--text-muted);
  background: transparent;
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 5px;
  padding: 3px 10px;
  font-family: var(--font-mono);
  letter-spacing: 0.04em;
}

/* — Reveal: longer, smoother — */
.reveal {
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 550ms var(--ease), transform 550ms var(--ease);
}

/* — Scrollbar: finer — */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

/* — Footer — */
.site-footer {
  padding: 40px var(--sp-8);
  font-size: 0.78rem;
  border-top: 1px solid rgba(255,255,255,0.04);
  color: var(--text-muted);
}

/* — Keyboard — */
kbd {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 5px;
  font-size: 0.65rem;
}

/* — Light theme refinements — */
[data-theme="light"] .hero h2 .hl {
  color: var(--accent-blue);
  -webkit-text-fill-color: var(--accent-blue);
  background: none;
}

[data-theme="light"] .toc-card:hover {
  box-shadow: 0 4px 24px rgba(37,99,235,0.1), 0 1px 4px rgba(0,0,0,0.06);
}

[data-theme="light"] .modal-box {
  border: 1px solid rgba(0,0,0,0.1);
}

[data-theme="light"] .site-header {
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(20px);
}

[data-theme="light"] .xp-bar-wrap {
  background: var(--bg-surface);
}

[data-theme="light"] .fab {
  box-shadow: 0 4px 20px rgba(37,99,235,0.25), 0 1px 4px rgba(0,0,0,0.12);
}

/* — Confetti: keep functionality, quieter palette — */
.confetti-burst span {
  width: 6px;
  height: 6px;
  border-radius: 1px;
  animation: confettiFall 1000ms var(--ease) forwards;
}

/* — Arrow pulse: off — */
@keyframes arrowPulse {
  0%,100% { transform: translateX(0); opacity: 0.4; }
  50%      { transform: translateX(2px); opacity: 0.6; }
}

/* ============================================================
   AUTHORITY LAYER v2 — Architectural dominance pass.
   Confidence restored. Presence elevated. Nothing removed.
   ============================================================ */

:root {
  --ease: cubic-bezier(0.22, 1, 0.36, 1);
  --dur:      320ms;
  --dur-fast: 200ms;
  --dur-slow: 560ms;

  --font-ui:   -apple-system, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', ui-monospace, monospace;

  --r-sm:  8px;
  --r-md:  14px;
  --r-lg:  20px;
  --r-xl:  28px;

  --sp-1:  4px;
  --sp-2:  10px;
  --sp-3:  16px;
  --sp-4:  24px;
  --sp-5:  34px;
  --sp-6:  44px;
  --sp-8:  56px;
  --sp-10: 76px;
  --sp-12: 96px;
}

[data-theme="dark"] {
  --bg-page:     #060810;
  --bg-surface:  #0b0e18;
  --bg-card:     #0f1320;
  --bg-code:     #070910;
  --bg-accent:   #141928;

  --border:      #1a2030;

  --text-primary:   #e4ecf9;
  --text-secondary: #5d6a84;
  --text-muted:     #323d54;

  --accent-blue:   #5aa3ff;
  --accent-green:  #28b870;
  --accent-red:    #d94f4f;
  --accent-amber:  #c98a08;
  --accent-purple: #7d65db;

  --shadow-sm:   0 1px 2px rgba(0,0,0,0.5);
  --shadow-card: 0 2px 4px rgba(0,0,0,0.5), 0 8px 24px rgba(0,0,0,0.38), 0 24px 64px rgba(0,0,0,0.2);
  --shadow-modal:0 2px 8px rgba(0,0,0,0.6), 0 24px 64px rgba(0,0,0,0.65), 0 64px 128px rgba(0,0,0,0.45);

  --header-grad:   linear-gradient(180deg, rgba(6,8,16,0.98) 0%, rgba(11,14,24,0.95) 100%);
  --modal-overlay: rgba(3,5,9,0.96);
}

[data-theme="light"] {
  --bg-page:    #eef0f5;
  --bg-surface: #ffffff;
  --bg-card:    #ffffff;
  --shadow-card:  0 1px 3px rgba(0,0,0,0.07), 0 6px 20px rgba(0,0,0,0.06), 0 16px 48px rgba(0,0,0,0.04);
  --shadow-modal: 0 8px 32px rgba(0,0,0,0.14), 0 32px 80px rgba(0,0,0,0.1);
  --border: #d8dce8;
}

/* ── SCROLL PROGRESS ───────── */
#scroll-progress { height: 2px; background: var(--accent-blue); opacity: 0.85; }

/* ── HEADER ────────────────── */
.site-header {
  background: rgba(6,8,16,0.92);
  border-bottom: 1px solid rgba(255,255,255,0.055);
  backdrop-filter: blur(24px) saturate(200%);
  -webkit-backdrop-filter: blur(24px) saturate(200%);
}
[data-theme="light"] .site-header {
  background: rgba(255,255,255,0.92);
  border-bottom: 1px solid rgba(0,0,0,0.08);
}
.header-inner { padding: 16px 56px; max-width: 1440px; }
.header-brand h1 { font-size: 1rem; font-weight: 590; letter-spacing: -0.025em; color: rgba(255,255,255,0.9); }
.header-brand span { font-size: 0.66rem; color: rgba(255,255,255,0.28); letter-spacing: 0.06em; text-transform: uppercase; margin-top: 3px; }
[data-theme="light"] .header-brand h1 { color: #111827; }
[data-theme="light"] .header-brand span { color: rgba(0,0,0,0.38); }

.btn-theme {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 8px; color: rgba(255,255,255,0.75);
  font-size: 0.77rem; padding: 7px 13px; letter-spacing: 0.01em; gap: 6px;
  transition: background var(--dur-fast) var(--ease), border-color var(--dur-fast) var(--ease);
}
.btn-theme:hover { background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.14); }
[data-theme="light"] .btn-theme { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.1); color: rgba(0,0,0,0.6); }

.progress-badge {
  font-size: 0.64rem; background: transparent;
  border: 1px solid rgba(90,163,255,0.18); color: rgba(90,163,255,0.6);
  border-radius: 6px; padding: 5px 11px; letter-spacing: 0.05em;
}

/* ── XP BAR ────────────────── */
.xp-bar-wrap { padding: 7px 56px; background: var(--bg-surface); border-bottom: 1px solid rgba(255,255,255,0.04); gap: 20px; }
.xp-track  { height: 2px; background: rgba(255,255,255,0.07); border-radius: 2px; }
.xp-fill   { height: 2px; background: var(--accent-blue); opacity: 0.8; border-radius: 2px; transition: width var(--dur-slow) var(--ease); }
.xp-label  { font-size: 0.62rem; color: var(--text-muted); letter-spacing: 0.08em; gap: 6px; }
.xp-pts    { font-size: 0.64rem; color: var(--text-muted); font-family: var(--font-mono); letter-spacing: 0.04em; min-width: 56px; }
.xp-level-badge {
  font-size: 0.58rem; font-weight: 650; letter-spacing: 0.1em; text-transform: uppercase;
  background: rgba(90,163,255,0.08); border: 1px solid rgba(90,163,255,0.2);
  color: var(--accent-blue); border-radius: 5px; padding: 2px 8px;
}

/* ── STREAK ────────────────── */
.streak-pill {
  background: transparent; border: 1px solid rgba(201,138,8,0.18);
  color: rgba(201,138,8,0.6); font-size: 0.66rem; font-weight: 500;
  padding: 5px 12px; border-radius: 7px; letter-spacing: 0.03em;
  transition: border-color var(--dur-fast) var(--ease), color var(--dur-fast) var(--ease);
}
.streak-pill:hover { transform: none; border-color: rgba(201,138,8,0.32); color: rgba(201,138,8,0.85); }
.streak-fire { animation: none; opacity: 0.75; }

/* ── HERO — CINEMATIC ──────── */
.hero {
  background: var(--bg-surface);
  border-bottom: 1px solid rgba(255,255,255,0.04);
  padding: 120px 56px 96px;
  text-align: center; position: relative; overflow: hidden;
}
.hero::before {
  content: '';
  position: absolute; inset: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 65% 50% at 50% -8%, rgba(90,163,255,0.07) 0%, transparent 65%),
    radial-gradient(ellipse 30% 25% at 75% 105%, rgba(125,101,219,0.04) 0%, transparent 55%);
}
.hero::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0; height: 1px; pointer-events: none;
  background: linear-gradient(90deg, transparent, rgba(90,163,255,0.15) 40%, rgba(90,163,255,0.15) 60%, transparent);
}

.hero-eyebrow {
  display: inline-flex; align-items: center; gap: 8px;
  background: transparent; border: 1px solid rgba(255,255,255,0.1);
  color: var(--text-muted); border-radius: 7px; padding: 6px 18px;
  font-size: 0.66rem; letter-spacing: 0.14em; text-transform: uppercase;
  margin-bottom: 40px; font-weight: 500;
}
[data-theme="light"] .hero-eyebrow { border-color: rgba(0,0,0,0.12); color: rgba(0,0,0,0.38); }

.hero h2 {
  font-size: clamp(2.8rem, 6.5vw, 5rem);
  font-weight: 700; letter-spacing: -0.05em; line-height: 1.0;
  color: var(--text-primary); margin-bottom: 28px;
}
[data-theme="dark"] .hero h2 .hl {
  background: linear-gradient(145deg, #ffffff 10%, rgba(90,163,255,0.88) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
[data-theme="light"] .hero h2 .hl { color: var(--accent-blue); -webkit-text-fill-color: var(--accent-blue); background: none; }

.hero p {
  font-size: 1.1rem; color: var(--text-secondary);
  max-width: 480px; margin: 0 auto 64px;
  line-height: 1.72; letter-spacing: 0.005em; font-weight: 400;
}

.hero-stats { gap: 56px; flex-wrap: wrap; }
.stat-item .num { font-size: 2rem; font-weight: 680; letter-spacing: -0.05em; color: var(--text-primary); line-height: 1; }
.stat-item .lbl { font-size: 0.62rem; letter-spacing: 0.13em; text-transform: uppercase; color: var(--text-muted); margin-top: 7px; font-weight: 500; }
.stat-divider   { width: 1px; height: 32px; background: rgba(255,255,255,0.06); }

.mastery-ring .ring-fill { stroke: var(--accent-blue); stroke-dasharray: 113; stroke-dashoffset: 113; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset var(--dur-slow) var(--ease); opacity: 0.8; }
.mastery-ring-wrap { gap: 14px; }
.mastery-pct { font-size: 1.05rem; font-weight: 680; letter-spacing: -0.04em; color: var(--text-primary); }
.mastery-sub { font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); margin-top: 3px; }

/* ── TOC ───────────────────── */
.toc-section { max-width: 1440px; padding: var(--sp-10) 56px var(--sp-12); }
.toc-grid { gap: 16px; }
.section-label { font-size: 0.62rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 24px; font-weight: 600; }
.section-label::after { background: var(--border); opacity: 0.5; }
.section-label .s-done { background: transparent; border: 1px solid rgba(40,184,112,0.22); color: rgba(40,184,112,0.52); border-radius: 5px; font-size: 0.6rem; padding: 2px 9px; font-weight: 500; letter-spacing: 0.06em; }

.toc-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--r-lg); padding: 28px 26px;
  transition: border-color var(--dur-fast) var(--ease), box-shadow var(--dur-fast) var(--ease), transform var(--dur-fast) var(--ease);
  position: relative; will-change: transform;
  box-shadow: var(--shadow-sm);
}
.toc-card:hover {
  border-color: rgba(90,163,255,0.28);
  box-shadow: 0 0 0 1px rgba(90,163,255,0.1), 0 4px 16px rgba(0,0,0,0.5), 0 16px 48px rgba(0,0,0,0.36);
  transform: translateY(-4px);
}
.toc-card::after {
  background: radial-gradient(ellipse at var(--mx,50%) var(--my,50%), rgba(90,163,255,0.065) 0%, transparent 62%);
  transition: opacity 350ms var(--ease);
}
.toc-card-label { font-size: 0.6rem; letter-spacing: 0.16em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 18px; font-weight: 600; }
.toc-card-label .dot { width: 4px; height: 4px; background: rgba(90,163,255,0.45); border-radius: 50%; flex-shrink: 0; }

.toc-link { color: var(--text-secondary); padding: 8px 0; font-size: 0.85rem; letter-spacing: -0.01em; line-height: 1.35; transition: color var(--dur-fast) var(--ease); }
.toc-link:hover { color: var(--text-primary); }
.toc-link .num { font-size: 0.6rem; color: var(--text-muted); min-width: 24px; font-family: var(--font-mono); letter-spacing: 0.04em; opacity: 0.55; }
.toc-link:hover .num { opacity: 0.9; color: var(--accent-blue); }
.toc-link:not(.done):hover { background: rgba(90,163,255,0.035); animation: none; border-radius: 7px; padding-left: 8px; padding-right: 8px; margin-left: -8px; margin-right: -8px; }
.toc-link .chk { width: 14px; height: 14px; border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; font-size: 0.48rem; transition: all var(--dur-fast) var(--ease); flex-shrink: 0; color: transparent; }
.toc-link.done .chk { background: rgba(40,184,112,0.16); border-color: rgba(40,184,112,0.38); color: var(--accent-green); }
.toc-link.done { color: var(--text-secondary); }
.toc-link.done .num { color: rgba(40,184,112,0.45); opacity: 1; }

.diff-dot { opacity: 0.45; width: 4px; height: 4px; }

.toc-link.next-up { background: rgba(90,163,255,0.045); border-radius: 7px; padding-left: 8px; padding-right: 8px; margin-left: -8px; margin-right: -8px; }
.next-up-arrow { animation: none; opacity: 0.38; font-size: 0.5rem; }

/* ── HEATMAP ───────────────── */
.heatmap-wrap { background: transparent; border: 1px solid var(--border); border-radius: var(--r-lg); padding: 22px 28px; margin-bottom: 36px; box-shadow: var(--shadow-sm); }
.heatmap-title { font-size: 0.6rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 14px; font-weight: 600; }
.heatmap-grid  { gap: 5px; }
.hm-cell { width: 13px; height: 13px; border-radius: 2px; background: rgba(255,255,255,0.04); transition: transform var(--dur-fast) var(--ease), opacity var(--dur-fast) var(--ease); }
.hm-cell:hover { transform: scale(1.25); }
.hm-cell.hm-1  { background: rgba(40,184,112,0.16); }
.hm-cell.hm-2  { background: rgba(40,184,112,0.36); }
.hm-cell.hm-3  { background: rgba(40,184,112,0.6); }
.hm-cell.hm-4  { background: rgba(40,184,112,0.84); box-shadow: none; }
.hm-cell.hm-today { outline: 1px solid rgba(90,163,255,0.45); outline-offset: 1px; }

/* ── RECALL BANNER ─────────── */
.recall-banner { background: rgba(125,101,219,0.04); border: 1px solid rgba(125,101,219,0.12); border-left: 2px solid rgba(125,101,219,0.38); border-radius: var(--r-md); padding: 18px 22px; margin-bottom: 28px; font-size: 0.83rem; gap: 20px; }
.recall-banner .rb-text { color: var(--text-secondary); line-height: 1.55; }
.recall-banner .rb-text strong { color: var(--text-primary); font-weight: 580; }
.recall-banner .rb-resume { background: rgba(125,101,219,0.1); color: var(--accent-purple); border: 1px solid rgba(125,101,219,0.22); border-radius: 8px; padding: 7px 16px; font-size: 0.78rem; font-weight: 520; cursor: pointer; letter-spacing: 0.01em; transition: background var(--dur-fast) var(--ease), border-color var(--dur-fast) var(--ease); }
.recall-banner .rb-resume:hover { background: rgba(125,101,219,0.18); border-color: rgba(125,101,219,0.35); }

/* ── MODAL ─────────────────── */
.modal-overlay { backdrop-filter: blur(20px) saturate(160%); -webkit-backdrop-filter: blur(20px) saturate(160%); animation: fadeIn var(--dur-fast) var(--ease) forwards; }
.modal-box { max-width: 1360px; margin: 44px auto; background: var(--bg-surface); border: 1px solid rgba(255,255,255,0.07); border-radius: var(--r-xl); box-shadow: var(--shadow-modal); overflow: hidden; animation: modalEnter 440ms var(--ease) forwards; }
@keyframes modalEnter {
  from { transform: translateY(18px) scale(0.992); opacity: 0; }
  to   { transform: translateY(0) scale(1); opacity: 1; }
}
[data-theme="light"] .modal-box { border: 1px solid rgba(0,0,0,0.1); }
.modal-header { background: rgba(6,8,16,0.7); border-bottom: 1px solid rgba(255,255,255,0.055); backdrop-filter: blur(24px); padding: 18px 32px; }
[data-theme="light"] .modal-header { background: rgba(255,255,255,0.85); border-bottom: 1px solid rgba(0,0,0,0.07); }
.modal-crumb { font-size: 0.75rem; }
.modal-crumb strong { font-weight: 580; letter-spacing: -0.01em; }
.modal-close-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); color: var(--text-muted); border-radius: 8px; font-size: 0.74rem; padding: 7px 16px; letter-spacing: 0.02em; transition: background var(--dur-fast) var(--ease), border-color var(--dur-fast) var(--ease), color var(--dur-fast) var(--ease); }
.modal-close-btn:hover { background: rgba(217,79,79,0.1); border-color: rgba(217,79,79,0.28); color: var(--accent-red); }
.modal-body { padding: 44px 56px 56px; }
.modal-progress-strip { height: 1px; background: rgba(255,255,255,0.05); }
.modal-progress-fill { background: var(--accent-blue); opacity: 0.55; transition: width var(--dur-slow) var(--ease); }
.modal-topic-counter { font-size: 0.65rem; color: var(--text-muted); font-family: var(--font-mono); letter-spacing: 0.04em; }

/* ── PANELS ────────────────── */
.panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-md); box-shadow: var(--shadow-sm); }
.panel.panel-old { border-top: 1px solid rgba(217,79,79,0.38); }
.panel.panel-new { border-top: 1px solid rgba(40,184,112,0.38); }
.panel.panel-old .panel-header h3 { color: rgba(217,79,79,0.72); }
.panel.panel-new .panel-header h3 { color: rgba(40,184,112,0.72); }
.comparison-grid:hover .panel { opacity: 0.78; transition: opacity 280ms var(--ease); }
.comparison-grid:hover .panel:hover { opacity: 1; transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.35), 0 12px 40px rgba(0,0,0,0.2); transition: opacity 180ms var(--ease), transform 180ms var(--ease), box-shadow 180ms var(--ease); }
.panel-new.pulse-once { animation: none; }

.topic-title { font-size: clamp(1.15rem,2.4vw,1.65rem); font-weight: 660; letter-spacing: -0.035em; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 1.22; }

pre { font-size: 0.79rem; line-height: 1.78; background: var(--bg-code); padding: 22px 26px; }

.copy-btn { background: transparent; border: 1px solid rgba(255,255,255,0.08); color: var(--text-muted); border-radius: 5px; font-size: 0.62rem; padding: 3px 10px; letter-spacing: 0.04em; transition: background var(--dur-fast) var(--ease), border-color var(--dur-fast) var(--ease), color var(--dur-fast) var(--ease); }
.copy-btn:hover { background: rgba(90,163,255,0.09); border-color: rgba(90,163,255,0.28); color: var(--accent-blue); }
.copy-btn.copied { background: rgba(40,184,112,0.09); border-color: rgba(40,184,112,0.28); color: var(--accent-green); }

/* ── NOTES ─────────────────── */
.note, .explanation { border-radius: 9px; padding: 18px 22px; font-size: 0.875rem; line-height: 1.72; margin-top: 16px; }
.note        { border-left: 2px solid rgba(201,138,8,0.45);  background: rgba(201,138,8,0.04); }
.explanation { border-left: 2px solid rgba(90,163,255,0.38); background: rgba(90,163,255,0.04); }
.note strong { color: var(--accent-amber); font-weight: 580; }
.explanation strong { color: var(--accent-blue); font-weight: 580; }

.insight-box.hi { background: rgba(125,101,219,0.04); border-color: rgba(125,101,219,0.1); }
.insight-box.en { background: rgba(90,163,255,0.04);  border-color: rgba(90,163,255,0.1); }
.insight-box .tag { font-size: 0.6rem; letter-spacing: 0.12em; }

/* ── NAV FOOTER ────────────── */
.nav-footer { background: rgba(6,8,16,0.65); border-top: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(16px); padding: 28px 44px; }
[data-theme="light"] .nav-footer { background: rgba(238,240,245,0.8); border-top: 1px solid rgba(0,0,0,0.06); }
.nav-footer-title { font-size: 0.6rem; letter-spacing: 0.16em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 18px; font-weight: 600; }
.nav-btn { background: var(--bg-accent); border: 1px solid var(--border); border-radius: var(--r-md); padding: 13px 20px; font-size: 0.83rem; color: var(--text-secondary); letter-spacing: -0.01em; transition: background var(--dur-fast) var(--ease), border-color var(--dur-fast) var(--ease), color var(--dur-fast) var(--ease), transform var(--dur-fast) var(--ease); }
.nav-btn:hover { background: rgba(90,163,255,0.07); border-color: rgba(90,163,255,0.22); color: var(--text-primary); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.25); }
.nav-btn.nav-btn-rec { border-color: rgba(125,101,219,0.22); background: rgba(125,101,219,0.04); }
.nav-btn.nav-btn-rec::before { display: none; }
.rec-badge { background: transparent; border: 1px solid rgba(125,101,219,0.2); color: rgba(125,101,219,0.55); border-radius: 5px; font-size: 0.56rem; padding: 2px 8px; letter-spacing: 0.1em; font-weight: 600; }
.nav-btn-back { background: transparent; border: 1px solid rgba(255,255,255,0.07); color: var(--text-muted); border-radius: var(--r-md); padding: 12px 20px; font-size: 0.83rem; transition: color var(--dur-fast) var(--ease), border-color var(--dur-fast) var(--ease); }
.nav-btn-back:hover { color: var(--text-secondary); border-color: rgba(255,255,255,0.14); }

/* ── TOAST ─────────────────── */
.toast { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--r-md); padding: 13px 20px; font-size: 0.81rem; box-shadow: 0 8px 32px rgba(0,0,0,0.55), 0 2px 8px rgba(0,0,0,0.4); max-width: 272px; animation: toastIn 360ms var(--ease) forwards; }
.toast .t-icon { font-size: 0.95rem; opacity: 0.85; }
.toast .t-msg strong { color: var(--text-secondary); font-size: 0.72rem; font-weight: 560; letter-spacing: 0.02em; display: block; margin-bottom: 2px; }
@keyframes toastIn  { from { opacity:0; transform:translateY(10px) scale(0.97); } to { opacity:1; transform:translateY(0) scale(1); } }
@keyframes toastOut { from { opacity:1; transform:translateY(0) scale(1); } to { opacity:0; transform:translateY(6px) scale(0.97); } }

/* ── XP POP ────────────────── */
.xp-pop { font-size: 0.8rem; font-weight: 700; color: var(--accent-amber); text-shadow: none; font-family: var(--font-mono); letter-spacing: 0.03em; animation: xpFloat 1000ms var(--ease) forwards; }
@keyframes xpFloat {
  0%  { opacity:0; transform:translateY(2px) scale(0.82); }
  22% { opacity:1; transform:translateY(-12px) scale(1.05); }
  75% { opacity:0.8; transform:translateY(-32px) scale(1); }
  100%{ opacity:0; transform:translateY(-44px) scale(0.96); }
}

/* ── LEVEL UP ──────────────── */
.levelup-flash { animation: flashFade 1400ms var(--ease) forwards; }
.levelup-flash::before { background: radial-gradient(ellipse at center, rgba(90,163,255,0.09) 0%, transparent 62%); }
.levelup-inner { animation: levelEnter 1000ms var(--ease) forwards; }
.levelup-inner .lu-label { font-size: 0.65rem; letter-spacing: 0.22em; color: var(--text-muted); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }
.levelup-inner .lu-title { font-size: clamp(1.6rem,5vw,2.6rem); font-weight: 720; letter-spacing: -0.05em; background: linear-gradient(145deg,#ffffff 25%,rgba(90,163,255,0.82) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; line-height:1; }
.levelup-inner .lu-sub { font-size: 0.84rem; color: var(--text-secondary); margin-top: 12px; letter-spacing: 0.005em; }
@keyframes levelEnter {
  0%   { transform:scale(0.9); opacity:0; }
  42%  { transform:scale(1.01); opacity:1; }
  70%  { transform:scale(0.995); }
  100% { transform:scale(1); opacity:1; }
}

/* ── FAB ───────────────────── */
.fab { background: var(--accent-blue); box-shadow: 0 2px 16px rgba(90,163,255,0.2), 0 1px 4px rgba(0,0,0,0.35); border-radius: 56px; padding: 12px 24px; font-size: 0.84rem; font-weight: 520; letter-spacing: -0.01em; opacity: 0; transition: transform 440ms var(--ease), box-shadow var(--dur-fast) var(--ease), opacity 440ms var(--ease); }
.fab.visible { transform: translateX(-50%) translateY(0); opacity: 0.95; }
.fab:hover   { box-shadow: 0 6px 28px rgba(90,163,255,0.32), 0 2px 8px rgba(0,0,0,0.4); transform: translateX(-50%) translateY(-2px); opacity: 1; }
.fab .fab-arrow { transition: transform var(--dur-fast) var(--ease); }
.fab:hover .fab-arrow { transform: translateX(3px); }

/* ── COMPLETION SCREEN ──────── */
.completion-screen { padding: 80px 56px; gap: 22px; animation: completionIn 480ms var(--ease) forwards; }
@keyframes completionIn { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
.cs-icon { font-size: 2.8rem; animation: iconLand 520ms var(--ease) forwards; }
@keyframes iconLand { 0%{transform:scale(0.72) translateY(8px);opacity:0} 55%{transform:scale(1.04) translateY(-2px);opacity:1} 100%{transform:scale(1) translateY(0);opacity:1} }
.cs-title { font-size: clamp(1.35rem,2.8vw,1.9rem); font-weight: 700; letter-spacing: -0.04em; line-height: 1.1; }
.cs-sub   { font-size: 0.9rem; color: var(--text-secondary); max-width: 300px; line-height: 1.6; }
.cs-xp-badge { background: rgba(201,138,8,0.07); border: 1px solid rgba(201,138,8,0.18); color: var(--accent-amber); border-radius: 9px; padding: 8px 20px; font-size: 0.86rem; font-weight: 640; font-family: var(--font-mono); letter-spacing: 0.04em; }
.cs-btn-next { background: var(--accent-blue); border: none; border-radius: var(--r-md); padding: 12px 26px; font-size: 0.89rem; font-weight: 530; cursor: pointer; letter-spacing: -0.01em; box-shadow: 0 2px 14px rgba(90,163,255,0.22); transition: transform var(--dur-fast) var(--ease), box-shadow var(--dur-fast) var(--ease); }
.cs-btn-next:hover { transform: translateY(-2px); box-shadow: 0 5px 24px rgba(90,163,255,0.32); }
.cs-btn-back { background: var(--bg-accent); border: 1px solid var(--border); color: var(--text-secondary); border-radius: var(--r-md); padding: 12px 22px; font-size: 0.86rem; cursor: pointer; transition: border-color var(--dur-fast) var(--ease), color var(--dur-fast) var(--ease); }
.cs-btn-back:hover { border-color: rgba(255,255,255,0.14); color: var(--text-primary); }
.cs-progress-line .csp-bar { height: 3px; border-radius: 2px; background: var(--border); }
.cs-progress-line .csp-fill { height: 3px; background: var(--accent-green); opacity: 0.65; border-radius: 2px; transition: width var(--dur-slow) var(--ease); }

/* ── DAILY GOAL ────────────── */
.daily-ring .dr-fill { stroke: rgba(40,184,112,0.55); transition: stroke-dashoffset var(--dur-slow) var(--ease); }
.daily-goal-text { font-size: 0.6rem; color: var(--text-muted); line-height: 1.3; }
.daily-goal-text strong { color: rgba(40,184,112,0.6); font-size: 0.66rem; display: block; }

/* ── SESSION STAT ──────────── */
.session-stat { font-size: 0.62rem; color: var(--text-muted); gap: 5px; }
.session-stat .ss-num { font-weight: 660; color: var(--text-secondary); font-size: 0.72rem; font-family: var(--font-mono); transition: color 360ms var(--ease); }

/* ── TICKER ────────────────── */
.insight-ticker { background: rgba(6,8,16,0.92); border-top: 1px solid rgba(255,255,255,0.04); height: 28px; }
.insight-ticker-inner { font-size: 0.67rem; color: var(--text-muted); animation: tickerScroll 64s linear infinite; letter-spacing: 0.03em; }
.insight-ticker-inner .ti-label { color: rgba(255,255,255,0.22); font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; }

/* ── SEARCH ────────────────── */
.search-wrap { max-width: 440px; }
.search-input { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-md); font-size: 0.875rem; padding: 12px 16px 12px 38px; color: var(--text-primary); font-family: var(--font-ui); transition: border-color var(--dur-fast) var(--ease), box-shadow var(--dur-fast) var(--ease); }
.search-input::placeholder { color: var(--text-muted); }
.search-input:focus { outline: none; border-color: rgba(90,163,255,0.32); box-shadow: 0 0 0 3px rgba(90,163,255,0.07); }
.search-results { border: 1px solid var(--border); border-radius: var(--r-md); background: var(--bg-card); box-shadow: 0 12px 48px rgba(0,0,0,0.45), 0 4px 16px rgba(0,0,0,0.3); max-height: 300px; }
.search-result-item { padding: 11px 16px; font-size: 0.83rem; transition: background var(--dur-fast) var(--ease); }
.search-result-item:hover { background: var(--bg-accent); }

/* ── MISC ──────────────────── */
.read-time-badge { font-size: 0.62rem; color: var(--text-muted); background: transparent; border: 1px solid rgba(255,255,255,0.07); border-radius: 5px; padding: 3px 11px; font-family: var(--font-mono); letter-spacing: 0.06em; }
kbd { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 5px; padding: 2px 7px; font-size: 0.63rem; font-family: var(--font-mono); letter-spacing: 0.03em; }
.reveal { opacity: 0; transform: translateY(10px); transition: opacity 600ms var(--ease), transform 600ms var(--ease); }
.reveal.visible { opacity: 1; transform: translateY(0); }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.18); }
.site-footer { padding: 44px 56px; font-size: 0.77rem; border-top: 1px solid rgba(255,255,255,0.04); color: var(--text-muted); letter-spacing: 0.01em; }
.site-footer strong { color: var(--text-secondary); font-weight: 520; }
body { font-family: var(--font-ui); background: var(--bg-page); color: var(--text-primary); line-height: 1.66; }
.panel-full { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--r-md); box-shadow: var(--shadow-sm); }
.panel-full .panel-header h3 { font-size: 0.82rem; font-weight: 580; color: var(--accent-blue); letter-spacing: -0.01em; }
.comparison { margin-bottom: var(--sp-8); }
.confetti-burst span { width: 5px; height: 5px; border-radius: 1px; animation: confettiFall 1100ms var(--ease) forwards; }
@keyframes confettiFall { 0%{opacity:1;transform:translateY(0) rotate(0deg)} 100%{opacity:0;transform:translateY(280px) rotate(480deg)} }

@media (max-width: 640px) {
  .header-inner { padding: 14px 20px; }
  .hero         { padding: 72px 20px 64px; }
  .toc-section  { padding: 48px 20px 64px; }
  .modal-body   { padding: 24px 20px; }
  .modal-box    { margin: 16px; border-radius: var(--r-lg); }
  .nav-footer   { padding: 24px 20px; }
  .site-footer  { padding: 36px 20px; }
  .xp-bar-wrap  { padding: 7px 20px; }
  .hero h2      { font-size: clamp(2.2rem,10vw,3.2rem); letter-spacing: -0.04em; }
  .hero-stats   { gap: 32px; }
}

/* ============================================================
   V3 — CINEMATIC × DASHBOARD
   Operational authority. Architectural dominance.
   No decoration. No templates. Pure system confidence.
   ============================================================ */

/* ── FOUNDATION RECALIBRATION ────────────────────────────── */
:root {
  --ease:      cubic-bezier(0.22, 1, 0.36, 1);
  --dur-micro: 140ms;
  --dur-fast:  220ms;
  --dur:       340ms;
  --dur-slow:  580ms;
  --dur-scene: 720ms;

  --font-ui:      -apple-system, 'SF Pro Text', 'Helvetica Neue', system-ui, sans-serif;
  --font-display: -apple-system, 'SF Pro Display', 'Helvetica Neue', system-ui, sans-serif;
  --font-mono:    'SF Mono', 'Fira Code', ui-monospace, 'Courier New', monospace;

  /* Geometric precision */
  --r-xs:  5px;
  --r-sm:  8px;
  --r-md:  12px;
  --r-lg:  18px;
  --r-xl:  24px;
  --r-2xl: 32px;

  /* Spatial system — 8pt grid, expanded for premium breathing */
  --gap-xs:  8px;
  --gap-sm:  16px;
  --gap-md:  24px;
  --gap-lg:  40px;
  --gap-xl:  64px;
  --gap-2xl: 96px;
  --gap-3xl: 128px;

  /* Layout bounds */
  --max-w:       1440px;
  --col-padding: clamp(24px, 4vw, 64px);
}

/* ── DARK MODE SURFACE SYSTEM ────────────────────────────── */
[data-theme="dark"] {
  /* True deep: cinematic not gray */
  --bg-page:    #04060c;
  --bg-surface: #080b14;
  --bg-card:    #0c1020;
  --bg-raised:  #101526;
  --bg-code:    #060810;
  --bg-accent:  #121829;
  --bg-hover:   rgba(255,255,255,0.028);

  /* Surgical borders */
  --border:         rgba(255,255,255,0.07);
  --border-strong:  rgba(255,255,255,0.11);
  --border-focus:   rgba(90,163,255,0.5);
  --border-subtle:  rgba(255,255,255,0.038);

  /* Text hierarchy — 4 levels */
  --text-primary:   #e8f0fd;
  --text-secondary: #4e5d78;
  --text-tertiary:  #2d3a52;
  --text-muted:     #1e2840;

  /* Single dominant accent — electric blue */
  --accent:        #5aa3ff;
  --accent-dim:    rgba(90,163,255,0.12);
  --accent-glow:   rgba(90,163,255,0.06);

  /* Semantic — restrained */
  --accent-blue:   #5aa3ff;
  --accent-green:  #25b36b;
  --accent-red:    #cc4a4a;
  --accent-amber:  #b87f08;
  --accent-purple: #6f5bcc;

  /* Elevation shadow stack */
  --elev-0: none;
  --elev-1: 0 1px 2px rgba(0,0,0,0.55);
  --elev-2: 0 1px 3px rgba(0,0,0,0.5),
            0 6px 20px rgba(0,0,0,0.36),
            0 20px 56px rgba(0,0,0,0.22);
  --elev-3: 0 2px 6px rgba(0,0,0,0.6),
            0 16px 48px rgba(0,0,0,0.55),
            0 48px 96px rgba(0,0,0,0.42);

  --shadow-sm:    var(--elev-1);
  --shadow-card:  var(--elev-2);
  --shadow-modal: var(--elev-3);

  --modal-overlay: rgba(2,4,8,0.97);
  --header-grad:   rgba(4,6,12,0.96);
}

/* ── LIGHT MODE ──────────────────────────────────────────── */
[data-theme="light"] {
  --bg-page:    #f0f2f8;
  --bg-surface: #fafbff;
  --bg-card:    #ffffff;
  --bg-raised:  #ffffff;
  --bg-accent:  #f4f6fc;
  --bg-hover:   rgba(0,0,0,0.025);

  --border:        rgba(0,0,0,0.08);
  --border-strong: rgba(0,0,0,0.13);
  --border-subtle: rgba(0,0,0,0.04);

  --text-primary:   #0d1117;
  --text-secondary: #4a5568;
  --text-tertiary:  #8a94a8;
  --text-muted:     #b0bac9;

  --accent:        #2563eb;
  --accent-dim:    rgba(37,99,235,0.08);
  --accent-glow:   rgba(37,99,235,0.04);

  --accent-blue:   #2563eb;
  --accent-green:  #16a34a;
  --accent-red:    #dc2626;
  --accent-amber:  #d97706;
  --accent-purple: #6d28d9;

  --elev-1: 0 1px 2px rgba(0,0,0,0.06);
  --elev-2: 0 1px 3px rgba(0,0,0,0.06),
            0 4px 16px rgba(0,0,0,0.05),
            0 12px 40px rgba(0,0,0,0.04);
  --elev-3: 0 4px 16px rgba(0,0,0,0.1),
            0 20px 60px rgba(0,0,0,0.08);

  --shadow-sm:    var(--elev-1);
  --shadow-card:  var(--elev-2);
  --shadow-modal: var(--elev-3);

  --modal-overlay: rgba(0,0,0,0.72);
}

/* ── BASE ────────────────────────────────────────────────── */
html { font-size: 16px; scroll-behavior: smooth; }

body {
  font-family: var(--font-ui);
  background: var(--bg-page);
  color: var(--text-primary);
  line-height: 1.62;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

/* ── SCROLL PROGRESS ─────────────────────────────────────── */
#scroll-progress {
  height: 1px;
  background: var(--accent);
  opacity: 0.7;
  transition: width 50ms linear;
}

/* ── HEADER — operational control bar ───────────────────── */
.site-header {
  background: var(--header-grad);
  border-bottom: 1px solid var(--border-subtle);
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(28px) saturate(180%);
  -webkit-backdrop-filter: blur(28px) saturate(180%);
}

[data-theme="light"] .site-header {
  background: rgba(250,251,255,0.94);
  border-bottom: 1px solid var(--border);
}

.header-inner {
  max-width: var(--max-w);
  margin: 0 auto;
  padding: 0 var(--col-padding);
  height: 54px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
}

.header-brand h1 {
  font-family: var(--font-display);
  font-size: 0.92rem;
  font-weight: 560;
  letter-spacing: -0.02em;
  color: rgba(255,255,255,0.88);
  line-height: 1;
}

[data-theme="light"] .header-brand h1 { color: var(--text-primary); }

.header-brand span {
  font-size: 0.62rem;
  color: var(--text-tertiary);
  letter-spacing: 0.07em;
  text-transform: uppercase;
  margin-top: 4px;
  display: block;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.btn-theme {
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  color: var(--text-secondary);
  font-size: 0.74rem;
  padding: 6px 12px;
  letter-spacing: 0.015em;
  gap: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  white-space: nowrap;
  transition: background var(--dur-micro) var(--ease),
              border-color var(--dur-micro) var(--ease),
              color var(--dur-micro) var(--ease);
}
.btn-theme:hover {
  background: var(--bg-hover);
  border-color: var(--border-strong);
  color: var(--text-primary);
}

.progress-badge {
  font-size: 0.62rem;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: var(--r-xs);
  padding: 4px 10px;
  letter-spacing: 0.06em;
  font-family: var(--font-mono);
  white-space: nowrap;
}

/* ── XP BAR — precision instrument ──────────────────────── */
.xp-bar-wrap {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border-subtle);
  padding: 0 var(--col-padding);
  max-width: 100%;
  height: 32px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.xp-label {
  font-size: 0.58rem;
  font-family: var(--font-mono);
  color: var(--text-tertiary);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 7px;
}

.xp-level-badge {
  font-size: 0.56rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  background: var(--accent-dim);
  border: 1px solid rgba(90,163,255,0.18);
  color: var(--accent);
  border-radius: 4px;
  padding: 1px 7px;
}

.xp-track {
  flex: 1;
  height: 1px;
  background: var(--border);
  border-radius: 1px;
  overflow: visible;
  position: relative;
}

.xp-fill {
  height: 1px;
  background: var(--accent);
  border-radius: 1px;
  transition: width var(--dur-slow) var(--ease);
  position: relative;
}

/* Precision cursor on XP fill edge */
.xp-fill::after {
  content: '';
  position: absolute;
  right: -1px;
  top: -2px;
  width: 1px;
  height: 5px;
  background: var(--accent);
  border-radius: 1px;
  opacity: 0.8;
}

.xp-pts {
  font-size: 0.6rem;
  color: var(--text-tertiary);
  font-family: var(--font-mono);
  white-space: nowrap;
  letter-spacing: 0.05em;
  min-width: 52px;
  text-align: right;
}

/* ── STREAK + GOAL ───────────────────────────────────────── */
.streak-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 4px 10px;
  font-size: 0.62rem;
  font-weight: 500;
  letter-spacing: 0.04em;
  cursor: default;
  transition: border-color var(--dur-micro) var(--ease),
              color var(--dur-micro) var(--ease);
}

.streak-pill:hover {
  transform: none;
  border-color: rgba(180,130,0,0.28);
  color: rgba(180,130,0,0.7);
}

.streak-fire { animation: none; opacity: 0.6; font-style: normal; }

.session-stat {
  font-size: 0.6rem;
  color: var(--text-tertiary);
  font-family: var(--font-mono);
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}

.session-stat .ss-num {
  font-weight: 700;
  color: var(--text-secondary);
  font-size: 0.7rem;
  transition: color var(--dur) var(--ease);
}

.daily-goal-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: default;
}

.daily-ring .dr-fill {
  stroke: rgba(37,179,107,0.55);
  transition: stroke-dashoffset var(--dur-slow) var(--ease);
}

.daily-goal-text { font-size: 0.58rem; line-height: 1.3; color: var(--text-tertiary); }
.daily-goal-text strong { color: rgba(37,179,107,0.6); font-size: 0.64rem; display: block; }

/* ── HERO — CINEMATIC COMMAND CENTER ────────────────────── */
.hero {
  position: relative;
  overflow: hidden;
  background: var(--bg-surface);
  padding: clamp(80px, 10vw, 140px) var(--col-padding) clamp(64px, 8vw, 112px);
  text-align: center;
  border-bottom: 1px solid var(--border-subtle);
}

/* Scene lighting: three-layer atmospheric depth */
.hero::before {
  content: '';
  position: absolute;
  inset: 0;
  pointer-events: none;
  background:
    /* Primary: top-center bloom */
    radial-gradient(ellipse 72% 56% at 50% -10%, rgba(90,163,255,0.082) 0%, transparent 62%),
    /* Secondary: bottom-right warmth */
    radial-gradient(ellipse 38% 30% at 82% 110%, rgba(111,91,204,0.045) 0%, transparent 55%),
    /* Tertiary: ambient bottom-left */
    radial-gradient(ellipse 28% 22% at 14% 100%, rgba(37,179,107,0.022) 0%, transparent 50%);
  z-index: 0;
}

/* Hairline architectural rule at hero bottom */
.hero::after {
  content: '';
  position: absolute;
  bottom: 0; left: var(--col-padding); right: var(--col-padding);
  height: 1px;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(90,163,255,0.18) 30%,
    rgba(90,163,255,0.18) 70%,
    transparent 100%
  );
  z-index: 1;
}

.hero > * { position: relative; z-index: 2; }

/* Eyebrow: editorial classification tag */
.hero-eyebrow {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: transparent;
  border: 1px solid var(--border-strong);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 6px 16px;
  font-size: 0.64rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  font-weight: 500;
  font-family: var(--font-mono);
  margin-bottom: 44px;
}

[data-theme="light"] .hero-eyebrow { border-color: rgba(0,0,0,0.14); color: rgba(0,0,0,0.4); }

/* Dominant headline — product launch caliber */
.hero h2 {
  font-family: var(--font-display);
  font-size: clamp(3rem, 7vw, 4.75rem);
  font-weight: 680;
  letter-spacing: -0.055em;
  line-height: 0.96;
  color: var(--text-primary);
  margin-bottom: 32px;
}

/* Gradient highlight on accent word */
[data-theme="dark"] .hero h2 .hl {
  background: linear-gradient(
    162deg,
    rgba(255,255,255,0.98) 0%,
    rgba(140,188,255,0.92) 55%,
    rgba(90,163,255,0.82) 100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

[data-theme="light"] .hero h2 .hl {
  color: var(--accent-blue);
  -webkit-text-fill-color: var(--accent-blue);
}

/* Subtitle: restrained, precise */
.hero p {
  font-family: var(--font-ui);
  font-size: 1.05rem;
  color: var(--text-secondary);
  max-width: 440px;
  margin: 0 auto 72px;
  line-height: 1.68;
  letter-spacing: 0.008em;
  font-weight: 380;
}

/* ── HERO STAT ROW — operational dashboard metrics ───────── */
.hero-stats {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 48px;
  flex-wrap: wrap;
}

.stat-item {
  text-align: center;
  min-width: 56px;
}

.stat-item .num {
  display: block;
  font-family: var(--font-display);
  font-size: 2.1rem;
  font-weight: 660;
  letter-spacing: -0.055em;
  color: var(--text-primary);
  line-height: 1;
}

.stat-item .lbl {
  display: block;
  font-size: 0.58rem;
  font-family: var(--font-mono);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-top: 8px;
  font-weight: 500;
}

.stat-divider {
  width: 1px;
  height: 36px;
  background: var(--border);
  flex-shrink: 0;
}

/* Mastery ring: precision instrument */
.mastery-ring-wrap { gap: 14px; align-items: center; }
.mastery-ring { width: 44px; height: 44px; flex-shrink: 0; }
.mastery-ring circle { fill: none; stroke-width: 3; stroke-linecap: butt; }
.mastery-ring .ring-bg { stroke: var(--border); }
.mastery-ring .ring-fill {
  stroke: var(--accent);
  stroke-dasharray: 113;
  stroke-dashoffset: 113;
  transform: rotate(-90deg);
  transform-origin: 50% 50%;
  transition: stroke-dashoffset var(--dur-slow) var(--ease);
  opacity: 0.75;
}
.mastery-text { line-height: 1.3; text-align: left; }
.mastery-pct {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 660;
  letter-spacing: -0.04em;
  color: var(--text-primary);
}
.mastery-sub {
  font-size: 0.56rem;
  font-family: var(--font-mono);
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-top: 4px;
}

/* ── TOC SECTION — DASHBOARD MODE ────────────────────────── */
.toc-section {
  max-width: var(--max-w);
  margin: 0 auto;
  padding: var(--gap-xl) var(--col-padding) var(--gap-3xl);
}

/* Section labels: editorial classification */
.section-label {
  font-size: 0.58rem;
  font-family: var(--font-mono);
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 16px;
}

.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.section-label .s-done {
  background: transparent;
  border: 1px solid rgba(37,179,107,0.2);
  color: rgba(37,179,107,0.5);
  border-radius: 4px;
  font-size: 0.56rem;
  padding: 2px 8px;
  font-weight: 600;
  letter-spacing: 0.08em;
}

/* ── TOC GRID — modular card system ──────────────────────── */
.toc-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 12px;
}

.toc-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 26px 24px 22px;
  position: relative;
  transition:
    border-color   var(--dur-fast) var(--ease),
    box-shadow     var(--dur-fast) var(--ease),
    transform      var(--dur-fast) var(--ease),
    background     var(--dur-fast) var(--ease);
  will-change: transform, box-shadow;
  overflow: hidden;
  box-shadow: var(--elev-1);
}

/* Inset top highlight — surface realism */
.toc-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255,255,255,0.06) 50%,
    transparent 100%
  );
  pointer-events: none;
}

.toc-card:hover {
  border-color: rgba(90,163,255,0.22);
  box-shadow:
    0 0 0 1px rgba(90,163,255,0.08),
    0 4px 12px rgba(0,0,0,0.45),
    0 14px 40px rgba(0,0,0,0.32),
    0 32px 64px rgba(0,0,0,0.18);
  transform: translateY(-4px);
  background: var(--bg-raised);
}

/* Ambient hover glow — cursor tracking */
.toc-card::after {
  content: '';
  position: absolute;
  inset: -1px;
  border-radius: var(--r-lg);
  opacity: 0;
  background: radial-gradient(
    ellipse at var(--mx, 50%) var(--my, 50%),
    rgba(90,163,255,0.055) 0%,
    transparent 58%
  );
  pointer-events: none;
  transition: opacity 380ms var(--ease);
}
.toc-card:hover::after { opacity: 1; }

/* Card section label */
.toc-card-label {
  font-size: 0.56rem;
  font-family: var(--font-mono);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 7px;
}

.toc-card-label .dot {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--accent);
  opacity: 0.4;
  flex-shrink: 0;
}

/* ── TOC LINKS — list items ──────────────────────────────── */
.toc-link {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
  text-decoration: none;
  padding: 7px 0;
  font-family: var(--font-ui);
  font-size: 0.84rem;
  letter-spacing: -0.01em;
  line-height: 1.3;
  border-radius: 0;
  transition: color var(--dur-micro) var(--ease);
  cursor: pointer;
}

.toc-link:hover { color: var(--text-primary); }

.toc-link .num {
  font-size: 0.58rem;
  font-family: var(--font-mono);
  color: var(--text-tertiary);
  min-width: 22px;
  letter-spacing: 0.04em;
  flex-shrink: 0;
  transition: color var(--dur-micro) var(--ease);
}

.toc-link:hover .num { color: var(--accent); }

.toc-link:not(.done):hover {
  background: transparent;
  animation: none;
  padding-left: 0;
  padding-right: 0;
  margin-left: 0;
  margin-right: 0;
}

/* Completion indicator */
.toc-link .chk {
  width: 13px;
  height: 13px;
  border-radius: 50%;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.46rem;
  color: transparent;
  flex-shrink: 0;
  margin-left: auto;
  transition: background var(--dur-fast) var(--ease),
              border-color var(--dur-fast) var(--ease),
              color var(--dur-fast) var(--ease);
}

.toc-link.done .chk {
  background: rgba(37,179,107,0.14);
  border-color: rgba(37,179,107,0.32);
  color: var(--accent-green);
}

.toc-link.done { color: var(--text-secondary); }
.toc-link.done .num { color: rgba(37,179,107,0.4); }

/* Difficulty indicators */
.diff-dot { width: 4px; height: 4px; border-radius: 50%; flex-shrink: 0; opacity: 0.4; margin-left: 3px; }
.diff-easy   { background: var(--accent-green); }
.diff-medium { background: var(--accent-amber); }
.diff-hard   { background: var(--accent-red); }

/* Next-up: single clean highlight */
.toc-link.next-up {
  color: var(--text-primary);
  background: transparent;
  border-radius: 0;
  padding-left: 0;
  padding-right: 0;
  margin-left: 0;
  margin-right: 0;
}
.toc-link.next-up .num { color: var(--accent); opacity: 1; }
.next-up-arrow { font-size: 0.5rem; color: var(--accent); opacity: 0.5; flex-shrink: 0; animation: none; margin-left: 2px; }

/* ── HEATMAP — operational activity grid ─────────────────── */
.heatmap-wrap {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 20px 24px;
  margin-bottom: 32px;
  box-shadow: var(--elev-1);
}

.heatmap-title {
  font-size: 0.56rem;
  font-family: var(--font-mono);
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.heatmap-grid { display: flex; gap: 4px; flex-wrap: wrap; }

.hm-cell {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  background: var(--border);
  transition: transform var(--dur-micro) var(--ease);
  cursor: default;
}

.hm-cell:hover { transform: scale(1.22); }
.hm-cell.hm-1  { background: rgba(37,179,107,0.18); }
.hm-cell.hm-2  { background: rgba(37,179,107,0.38); }
.hm-cell.hm-3  { background: rgba(37,179,107,0.62); }
.hm-cell.hm-4  { background: rgba(37,179,107,0.86); }
.hm-cell.hm-today { outline: 1px solid rgba(90,163,255,0.48); outline-offset: 1px; }

/* ── RECALL BANNER ───────────────────────────────────────── */
.recall-banner {
  background: transparent;
  border: 1px solid var(--border);
  border-left: 2px solid rgba(111,91,204,0.36);
  border-radius: var(--r-md);
  padding: 16px 20px;
  margin-bottom: 28px;
  font-size: 0.83rem;
  gap: 20px;
  display: none;
  align-items: center;
}

.recall-banner.show { display: flex; }
.recall-banner .rb-text { color: var(--text-secondary); line-height: 1.5; flex: 1; }
.recall-banner .rb-text strong { color: var(--text-primary); font-weight: 560; }

.recall-banner .rb-resume {
  background: transparent;
  color: var(--accent-purple);
  border: 1px solid rgba(111,91,204,0.24);
  border-radius: var(--r-xs);
  padding: 6px 14px;
  font-size: 0.76rem;
  font-weight: 520;
  cursor: pointer;
  letter-spacing: 0.01em;
  white-space: nowrap;
  transition: background var(--dur-micro) var(--ease),
              border-color var(--dur-micro) var(--ease);
}

.recall-banner .rb-resume:hover {
  background: rgba(111,91,204,0.1);
  border-color: rgba(111,91,204,0.38);
}

.recall-banner .rb-dismiss {
  color: var(--text-tertiary);
  background: none;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
  padding: 0 4px;
  line-height: 1;
  transition: color var(--dur-micro) var(--ease);
}

.recall-banner .rb-dismiss:hover { color: var(--text-secondary); }

/* ── SEARCH BAR ──────────────────────────────────────────── */
.search-wrap {
  position: relative;
  max-width: 420px;
  margin-bottom: 28px;
}

.search-input {
  width: 100%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 11px 14px 11px 36px;
  color: var(--text-primary);
  font-family: var(--font-ui);
  font-size: 0.875rem;
  line-height: 1;
  transition: border-color var(--dur-fast) var(--ease),
              box-shadow var(--dur-fast) var(--ease);
}

.search-input::placeholder { color: var(--text-tertiary); }

.search-input:focus {
  outline: none;
  border-color: rgba(90,163,255,0.35);
  box-shadow: 0 0 0 3px rgba(90,163,255,0.07);
}

.search-results {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--bg-raised);
  border: 1px solid var(--border-strong);
  border-radius: var(--r-md);
  box-shadow: var(--elev-3);
  z-index: 200;
  max-height: 300px;
  overflow-y: auto;
  display: none;
}

.search-results.open { display: block; }

.search-result-item {
  padding: 10px 14px;
  cursor: pointer;
  font-size: 0.83rem;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background var(--dur-micro) var(--ease),
              color var(--dur-micro) var(--ease);
}

.search-result-item:last-child { border-bottom: none; }
.search-result-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.search-result-item .ri { font-size: 0.58rem; color: var(--text-tertiary); font-family: var(--font-mono); min-width: 22px; }

/* ── MODAL SYSTEM ────────────────────────────────────────── */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--modal-overlay);
  z-index: 1000;
  overflow-y: auto;
  backdrop-filter: blur(24px) saturate(140%);
  -webkit-backdrop-filter: blur(24px) saturate(140%);
  animation: fadeIn var(--dur-fast) var(--ease) forwards;
}

.modal-overlay.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

.modal-box {
  max-width: 1320px;
  margin: 40px auto;
  background: var(--bg-surface);
  border: 1px solid var(--border-strong);
  border-radius: var(--r-2xl);
  box-shadow: var(--shadow-modal);
  overflow: hidden;
  animation: sceneIn var(--dur-scene) var(--ease) forwards;
}

@keyframes sceneIn {
  from { transform: translateY(20px) scale(0.993); opacity: 0; }
  to   { transform: translateY(0)    scale(1);     opacity: 1; }
}

.modal-progress-strip {
  height: 1px;
  background: var(--border-subtle);
  position: relative;
  overflow: hidden;
}

.modal-progress-fill {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  background: var(--accent);
  opacity: 0.5;
  transition: width var(--dur-slow) var(--ease);
}

.modal-header {
  background: rgba(4, 6, 12, 0.72);
  border-bottom: 1px solid var(--border-subtle);
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 10;
  backdrop-filter: blur(20px);
}

[data-theme="light"] .modal-header {
  background: rgba(255,255,255,0.9);
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(20px);
}

.modal-crumb {
  font-size: 0.72rem;
  font-family: var(--font-mono);
  color: var(--text-tertiary);
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: 0.02em;
}

.modal-crumb strong {
  color: var(--text-primary);
  font-weight: 560;
}

.modal-topic-counter {
  font-size: 0.62rem;
  color: var(--text-tertiary);
  font-family: var(--font-mono);
  margin-left: auto;
  padding-right: 8px;
  white-space: nowrap;
  letter-spacing: 0.06em;
}

.modal-close-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 6px 14px;
  cursor: pointer;
  font-size: 0.72rem;
  display: flex;
  align-items: center;
  gap: 6px;
  letter-spacing: 0.02em;
  transition: background var(--dur-micro) var(--ease),
              border-color var(--dur-micro) var(--ease),
              color var(--dur-micro) var(--ease);
}

.modal-close-btn:hover {
  background: rgba(204,74,74,0.08);
  border-color: rgba(204,74,74,0.28);
  color: var(--accent-red);
}

/* ── MODAL BODY ──────────────────────────────────────────── */
.modal-body {
  padding: 44px clamp(24px, 4vw, 56px) 56px;
}

/* ── TOPIC TITLE ─────────────────────────────────────────── */
.topic-title {
  font-family: var(--font-display);
  font-size: clamp(1.2rem, 2.5vw, 1.7rem);
  font-weight: 640;
  letter-spacing: -0.04em;
  color: var(--text-primary);
  margin-bottom: 36px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--border-subtle);
  line-height: 1.18;
}

/* ── COMPARISON PANELS ───────────────────────────────────── */
.comparison { margin-bottom: 60px; }

.comparison-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

@media (max-width: 780px) {
  .comparison-grid { grid-template-columns: 1fr; }
}

.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  overflow: hidden;
  box-shadow: var(--elev-1);
}

.panel.panel-old { border-top: 1px solid rgba(204,74,74,0.36); }
.panel.panel-new { border-top: 1px solid rgba(37,179,107,0.36); }
.panel.panel-old .panel-header h3 { color: rgba(204,74,74,0.68); }
.panel.panel-new .panel-header h3 { color: rgba(37,179,107,0.68); }

/* Focus mode: surgical dimming */
.comparison-grid:hover .panel {
  opacity: 0.72;
  transition: opacity 260ms var(--ease);
}
.comparison-grid:hover .panel:hover {
  opacity: 1;
  transform: translateY(-2px);
  box-shadow: var(--elev-2);
  transition: opacity 160ms var(--ease),
              transform 160ms var(--ease),
              box-shadow 160ms var(--ease);
}

.panel-header {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border-subtle);
}

.panel-header h3 {
  font-size: 0.74rem;
  font-weight: 580;
  font-family: var(--font-mono);
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: 0.02em;
}

/* ── CODE BLOCKS ─────────────────────────────────────────── */
pre {
  background: var(--bg-code);
  padding: 20px 22px;
  overflow-x: auto;
  font-family: var(--font-mono);
  font-size: 0.78rem;
  line-height: 1.78;
  white-space: pre;
  word-wrap: normal;
  margin: 0;
}

code {
  display: block;
  min-width: max-content;
}

/* ── COPY BUTTON ─────────────────────────────────────────── */
.copy-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 2px 9px;
  font-size: 0.6rem;
  font-family: var(--font-mono);
  cursor: pointer;
  letter-spacing: 0.04em;
  transition: background var(--dur-micro) var(--ease),
              border-color var(--dur-micro) var(--ease),
              color var(--dur-micro) var(--ease);
}

.copy-btn:hover {
  background: var(--accent-dim);
  border-color: rgba(90,163,255,0.28);
  color: var(--accent);
}

.copy-btn.copied {
  background: rgba(37,179,107,0.08);
  border-color: rgba(37,179,107,0.28);
  color: var(--accent-green);
}

/* ── FULL-WIDTH PANEL ────────────────────────────────────── */
.panel-full {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  overflow: hidden;
  margin-bottom: 16px;
  box-shadow: var(--elev-1);
}

.panel-full .panel-header {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.panel-full .panel-header h3 {
  font-size: 0.74rem;
  font-weight: 580;
  font-family: var(--font-mono);
  color: var(--accent);
  letter-spacing: 0.02em;
}

/* ── NOTES & EXPLANATIONS ────────────────────────────────── */
.note, .explanation {
  padding: 16px 20px;
  border-radius: var(--r-sm);
  margin-top: 14px;
  font-size: 0.875rem;
  line-height: 1.68;
}

.note {
  background: rgba(185,127,8,0.04);
  border-left: 2px solid rgba(185,127,8,0.42);
}
.note strong { color: var(--accent-amber); font-weight: 560; }

.explanation {
  background: rgba(90,163,255,0.04);
  border-left: 2px solid rgba(90,163,255,0.35);
}
.explanation strong { color: var(--accent-blue); font-weight: 560; }

/* ── INSIGHT BOXES ───────────────────────────────────────── */
.insight-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 14px;
}

@media (max-width: 640px) { .insight-row { grid-template-columns: 1fr; } }

.insight-box {
  padding: 14px 16px;
  border-radius: var(--r-sm);
  font-size: 0.84rem;
  line-height: 1.6;
}

.insight-box.hi {
  background: rgba(111,91,204,0.04);
  border: 1px solid rgba(111,91,204,0.1);
}

.insight-box.en {
  background: rgba(90,163,255,0.04);
  border: 1px solid rgba(90,163,255,0.1);
}

.insight-box .tag {
  font-size: 0.56rem;
  font-family: var(--font-mono);
  letter-spacing: 0.14em;
  text-transform: uppercase;
  margin-bottom: 8px;
  display: block;
  font-weight: 700;
}

.insight-box.hi .tag { color: var(--accent-purple); }
.insight-box.en .tag { color: var(--accent-blue); }

/* ── NAV FOOTER ──────────────────────────────────────────── */
.nav-footer {
  background: rgba(4, 6, 12, 0.6);
  border-top: 1px solid var(--border-subtle);
  padding: 28px 40px;
  margin-top: 48px;
  border-radius: 0 0 var(--r-2xl) var(--r-2xl);
  backdrop-filter: blur(16px);
}

[data-theme="light"] .nav-footer {
  background: rgba(240,242,248,0.8);
  border-top: 1px solid var(--border);
}

.nav-footer-title {
  font-size: 0.56rem;
  font-family: var(--font-mono);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 16px;
  font-weight: 600;
}

.nav-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.nav-btn {
  background: var(--bg-accent);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: var(--r-sm);
  padding: 10px 18px;
  cursor: pointer;
  font-size: 0.81rem;
  font-family: var(--font-ui);
  letter-spacing: -0.01em;
  text-align: left;
  transition: background var(--dur-micro) var(--ease),
              border-color var(--dur-micro) var(--ease),
              color var(--dur-micro) var(--ease),
              transform var(--dur-micro) var(--ease),
              box-shadow var(--dur-micro) var(--ease);
}

.nav-btn:hover {
  background: var(--accent-dim);
  border-color: rgba(90,163,255,0.22);
  color: var(--text-primary);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
}

.nav-btn .arrow { opacity: 0.4; margin-right: 6px; }

.nav-btn.nav-btn-rec {
  border-color: rgba(111,91,204,0.2);
  background: rgba(111,91,204,0.04);
}

.nav-btn.nav-btn-rec::before { display: none; }

.rec-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.54rem;
  font-family: var(--font-mono);
  background: transparent;
  border: 1px solid rgba(111,91,204,0.2);
  color: rgba(111,91,204,0.52);
  border-radius: 4px;
  padding: 2px 7px;
  margin-bottom: 5px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

.nav-btn-back {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-sm);
  padding: 10px 18px;
  cursor: pointer;
  font-size: 0.81rem;
  transition: color var(--dur-micro) var(--ease),
              border-color var(--dur-micro) var(--ease);
  margin-top: 16px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.nav-btn-back:hover {
  color: var(--text-secondary);
  border-color: var(--border-strong);
}

/* ── KEYBOARD HINT ───────────────────────────────────────── */
.kbd-hint {
  font-size: 0.62rem;
  color: var(--text-tertiary);
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 14px;
}

kbd {
  background: var(--bg-accent);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 7px;
  font-size: 0.6rem;
  font-family: var(--font-mono);
  letter-spacing: 0.03em;
  color: var(--text-secondary);
}

/* ── READ TIME BADGE ─────────────────────────────────────── */
.read-time-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 0.6rem;
  font-family: var(--font-mono);
  color: var(--text-tertiary);
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 3px 10px;
  letter-spacing: 0.07em;
}

/* ── TOAST SYSTEM ────────────────────────────────────────── */
#toast-wrap {
  position: fixed;
  bottom: 28px;
  right: 28px;
  z-index: 9000;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}

.toast {
  background: var(--bg-raised);
  border: 1px solid var(--border-strong);
  border-radius: var(--r-md);
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.82rem;
  font-family: var(--font-ui);
  color: var(--text-primary);
  box-shadow: var(--elev-3);
  animation: toastIn 380ms var(--ease) forwards;
  pointer-events: auto;
  max-width: 268px;
}

.toast .t-icon { font-size: 0.92rem; flex-shrink: 0; opacity: 0.8; }
.toast .t-msg { line-height: 1.4; }
.toast .t-msg strong {
  display: block;
  font-size: 0.7rem;
  font-family: var(--font-mono);
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 2px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.toast.t-out { animation: toastOut 300ms var(--ease) forwards; }

@keyframes toastIn {
  from { opacity: 0; transform: translateY(10px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes toastOut {
  from { opacity: 1; transform: translateY(0) scale(1); }
  to   { opacity: 0; transform: translateY(8px) scale(0.97); }
}

/* ── XP POP FLOAT ────────────────────────────────────────── */
.xp-pop {
  position: fixed;
  font-size: 0.76rem;
  font-weight: 700;
  font-family: var(--font-mono);
  color: var(--accent-amber);
  pointer-events: none;
  z-index: 9999;
  letter-spacing: 0.04em;
  animation: xpFloat 1100ms var(--ease) forwards;
}

@keyframes xpFloat {
  0%  { opacity: 0; transform: translateY(4px) scale(0.82); }
  18% { opacity: 1; transform: translateY(-14px) scale(1.04); }
  72% { opacity: 0.75; transform: translateY(-34px) scale(1); }
  100%{ opacity: 0; transform: translateY(-46px) scale(0.96); }
}

/* ── LEVEL-UP FLASH ──────────────────────────────────────── */
.levelup-flash {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9990;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: flashFade 1500ms var(--ease) forwards;
}

.levelup-flash::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(
    ellipse at center,
    rgba(90,163,255,0.08) 0%,
    transparent 60%
  );
}

.levelup-inner {
  text-align: center;
  position: relative;
  animation: levelEnter 1000ms var(--ease) forwards;
}

.levelup-inner .lu-label {
  font-size: 0.6rem;
  font-family: var(--font-mono);
  letter-spacing: 0.24em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 12px;
  font-weight: 600;
}

.levelup-inner .lu-title {
  font-family: var(--font-display);
  font-size: clamp(1.6rem, 5vw, 2.6rem);
  font-weight: 700;
  letter-spacing: -0.05em;
  background: linear-gradient(150deg, #ffffff 20%, rgba(90,163,255,0.85) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 0.95;
}

.levelup-inner .lu-sub {
  font-size: 0.84rem;
  color: var(--text-secondary);
  margin-top: 14px;
  letter-spacing: 0.005em;
}

@keyframes flashFade {
  0%  { opacity: 0; }
  12% { opacity: 1; }
  72% { opacity: 1; }
  100%{ opacity: 0; }
}

@keyframes levelEnter {
  0%   { transform: scale(0.88); opacity: 0; }
  40%  { transform: scale(1.01); opacity: 1; }
  68%  { transform: scale(0.997); }
  100% { transform: scale(1); opacity: 1; }
}

/* ── FAB ─────────────────────────────────────────────────── */
.fab {
  position: fixed;
  bottom: 32px;
  left: 50%;
  transform: translateX(-50%) translateY(72px);
  z-index: 800;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 60px;
  padding: 12px 24px;
  font-size: 0.84rem;
  font-family: var(--font-ui);
  font-weight: 500;
  cursor: pointer;
  letter-spacing: -0.01em;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
  opacity: 0;
  box-shadow: 0 2px 12px rgba(90,163,255,0.22),
              0 6px 28px rgba(90,163,255,0.14),
              0 1px 4px rgba(0,0,0,0.4);
  transition: transform 480ms var(--ease),
              opacity 480ms var(--ease),
              box-shadow var(--dur-fast) var(--ease);
}

.fab.visible {
  transform: translateX(-50%) translateY(0);
  opacity: 0.92;
}

.fab:hover {
  transform: translateX(-50%) translateY(-3px);
  opacity: 1;
  box-shadow: 0 4px 20px rgba(90,163,255,0.32),
              0 10px 40px rgba(90,163,255,0.2),
              0 2px 6px rgba(0,0,0,0.4);
}

.fab .fab-arrow { font-size: 0.9rem; transition: transform var(--dur-fast) var(--ease); }
.fab:hover .fab-arrow { transform: translateX(3px); }

/* ── COMPLETION SCREEN ───────────────────────────────────── */
.completion-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 80px 48px;
  gap: 20px;
  animation: completionIn 500ms var(--ease) forwards;
}

@keyframes completionIn {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}

.cs-icon {
  font-size: 2.6rem;
  animation: iconLand 540ms var(--ease) forwards;
}

@keyframes iconLand {
  0%  { transform: scale(0.68) translateY(10px); opacity: 0; }
  52% { transform: scale(1.05) translateY(-2px); opacity: 1; }
  100%{ transform: scale(1) translateY(0); opacity: 1; }
}

.cs-title {
  font-family: var(--font-display);
  font-size: clamp(1.35rem, 3vw, 1.9rem);
  font-weight: 680;
  letter-spacing: -0.045em;
  color: var(--text-primary);
  line-height: 1.08;
}

.cs-sub {
  font-size: 0.9rem;
  color: var(--text-secondary);
  max-width: 290px;
  line-height: 1.58;
}

.cs-xp-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(185,127,8,0.07);
  border: 1px solid rgba(185,127,8,0.18);
  color: var(--accent-amber);
  border-radius: var(--r-sm);
  padding: 7px 18px;
  font-size: 0.84rem;
  font-weight: 660;
  font-family: var(--font-mono);
  letter-spacing: 0.05em;
}

.cs-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 8px;
}

.cs-btn-next {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--r-md);
  padding: 12px 26px;
  font-size: 0.89rem;
  font-weight: 500;
  font-family: var(--font-ui);
  cursor: pointer;
  letter-spacing: -0.01em;
  box-shadow: 0 2px 12px rgba(90,163,255,0.22),
              0 1px 3px rgba(0,0,0,0.3);
  transition: transform var(--dur-fast) var(--ease),
              box-shadow var(--dur-fast) var(--ease);
}

.cs-btn-next:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(90,163,255,0.32),
              0 2px 6px rgba(0,0,0,0.35);
}

.cs-btn-back {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: var(--r-md);
  padding: 12px 20px;
  font-size: 0.86rem;
  font-family: var(--font-ui);
  cursor: pointer;
  transition: border-color var(--dur-micro) var(--ease),
              color var(--dur-micro) var(--ease);
}

.cs-btn-back:hover {
  border-color: var(--border-strong);
  color: var(--text-primary);
}

.cs-progress-line {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.72rem;
  font-family: var(--font-mono);
  color: var(--text-tertiary);
  letter-spacing: 0.04em;
}

.cs-progress-line .csp-bar {
  width: 100px;
  height: 2px;
  background: var(--border);
  border-radius: 1px;
  overflow: hidden;
}

.cs-progress-line .csp-fill {
  height: 2px;
  background: var(--accent-green);
  opacity: 0.65;
  border-radius: 1px;
  transition: width var(--dur-slow) var(--ease);
}

/* ── INSIGHT TICKER ──────────────────────────────────────── */
.insight-ticker {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 28px;
  background: rgba(4,6,12,0.94);
  border-top: 1px solid var(--border-subtle);
  z-index: 700;
  display: flex;
  align-items: center;
  overflow: hidden;
  pointer-events: none;
  backdrop-filter: blur(12px);
}

.insight-ticker-inner {
  display: flex;
  align-items: center;
  white-space: nowrap;
  animation: tickerScroll 64s linear infinite;
  font-size: 0.64rem;
  font-family: var(--font-mono);
  color: var(--text-tertiary);
  letter-spacing: 0.04em;
}

.insight-ticker-inner span { padding: 0 48px; }

.insight-ticker-inner .ti-label {
  color: rgba(255,255,255,0.2);
  font-weight: 700;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  padding: 0 12px 0 24px;
}

/* ── REVEAL ANIMATION ────────────────────────────────────── */
.reveal {
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 640ms var(--ease), transform 640ms var(--ease);
}

.reveal.visible { opacity: 1; transform: translateY(0); }

/* ── SCROLLBAR ───────────────────────────────────────────── */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

/* ── FOOTER ──────────────────────────────────────────────── */
.site-footer {
  border-top: 1px solid var(--border-subtle);
  padding: 40px var(--col-padding);
  text-align: center;
  color: var(--text-tertiary);
  font-size: 0.74rem;
  font-family: var(--font-mono);
  letter-spacing: 0.04em;
}

.site-footer strong { color: var(--text-secondary); font-weight: 560; }

/* ── RESPONSIVE ──────────────────────────────────────────── */
@media (max-width: 900px) {
  .header-actions { gap: 8px; }
  .session-stat   { display: none; }
}

@media (max-width: 640px) {
  .header-inner  { height: 48px; padding: 0 20px; }
  .xp-bar-wrap   { padding: 0 20px; }
  .hero          { padding: 72px 20px 60px; }
  .toc-section   { padding: 48px 20px 64px; }
  .modal-body    { padding: 24px 20px 36px; }
  .modal-box     { margin: 12px; border-radius: var(--r-xl); }
  .modal-header  { padding: 14px 20px; }
  .nav-footer    { padding: 22px 20px; }
  .site-footer   { padding: 32px 20px; }
  .hero h2       { font-size: clamp(2.4rem, 11vw, 3.4rem); letter-spacing: -0.045em; }
  .hero p        { font-size: 1rem; margin-bottom: 52px; }
  .hero-stats    { gap: 28px; }
  .stat-divider  { display: none; }
  .completion-screen { padding: 56px 24px; }
}


/* ============================================================
   ENTERPRISE CALIBRATION — v4
   Motion discipline. Accent authority. Interaction restraint.
   System-level. Not SaaS. Not gamified.
   ============================================================ */

/* ── 1. PURGE ALL NON-SYSTEM EASING ─────────────────────────
   cubic-bezier(0.34,1.56,...) = spring/overshoot = consumer
   cubic-bezier(0.22,1,0.36,1) = decelerate = enterprise     */

.xp-fill {
  transition: width 540ms cubic-bezier(0.22, 1, 0.36, 1);
}
.modal-progress-fill {
  transition: width 520ms cubic-bezier(0.22, 1, 0.36, 1);
}
.mastery-ring .ring-fill {
  transition: stroke-dashoffset 600ms cubic-bezier(0.22, 1, 0.36, 1);
}
.daily-ring .dr-fill {
  transition: stroke-dashoffset 560ms cubic-bezier(0.22, 1, 0.36, 1);
}
.fab {
  transition:
    transform  500ms cubic-bezier(0.22, 1, 0.36, 1),
    opacity    500ms cubic-bezier(0.22, 1, 0.36, 1),
    box-shadow 220ms cubic-bezier(0.22, 1, 0.36, 1);
}
.cs-progress-line .csp-fill {
  transition: width 520ms cubic-bezier(0.22, 1, 0.36, 1);
}

/* ── 2. KILL INFINITE AMBIENT ANIMATIONS ─────────────────── */

.streak-fire {
  animation: none !important;
  display: inline-block;
  opacity: 0.6;
}
.next-up-arrow {
  animation: none !important;
  opacity: 0.32;
}
.toc-link:not(.done):hover {
  background: transparent;
  animation: none !important;
  padding-left: 0;
  padding-right: 0;
  margin-left: 0;
  margin-right: 0;
}
.panel-new.pulse-once {
  animation: none !important;
}

/* ── 3. REWRITE PLAYFUL KEYFRAMES → PHYSICAL ─────────────── */

.cs-icon {
  animation: csIconLand 480ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
}
@keyframes csIconLand {
  from { transform: scale(0.8) translateY(8px); opacity: 0; }
  to   { transform: scale(1)   translateY(0);   opacity: 1; }
}

.levelup-inner {
  animation: luReveal 760ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
}
@keyframes luReveal {
  from { transform: translateY(10px) scale(0.97); opacity: 0; }
  to   { transform: translateY(0)    scale(1);    opacity: 1; }
}

.xp-pop {
  animation: xpRise 880ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
}
@keyframes xpRise {
  0%   { opacity: 0;   transform: translateY(0); }
  16%  { opacity: 1;   transform: translateY(-10px); }
  78%  { opacity: 0.5; transform: translateY(-30px); }
  100% { opacity: 0;   transform: translateY(-38px); }
}

.modal-box {
  animation: modalDrop 440ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
}
@keyframes modalDrop {
  from { transform: translateY(14px) scale(0.996); opacity: 0; }
  to   { transform: translateY(0)    scale(1);     opacity: 1; }
}

/* ── 4. ACCENT AUTHORITY ─────────────────────────────────── */

#scroll-progress {
  background: var(--accent, #5aa3ff);
  opacity: 0.72;
}
.xp-fill {
  background: var(--accent, #5aa3ff);
  opacity: 0.72;
}
.modal-progress-fill {
  background: var(--accent, #5aa3ff);
  opacity: 0.42;
}
.fab {
  background: #4990ed;
}
.fab:hover {
  background: #5aa3ff;
}
.cs-btn-next {
  background: #4990ed;
  box-shadow: 0 2px 10px rgba(73, 144, 237, 0.22), 0 1px 3px rgba(0,0,0,0.3);
}
.cs-btn-next:hover {
  background: #5aa3ff;
  box-shadow: 0 4px 18px rgba(73, 144, 237, 0.3), 0 2px 5px rgba(0,0,0,0.35);
  transform: translateY(-2px);
}
.levelup-inner .lu-title {
  background: linear-gradient(150deg, #ffffff 20%, rgba(90,163,255,0.86) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
[data-theme="dark"] .hero h2 .hl {
  background: linear-gradient(155deg,
    rgba(255,255,255,0.97) 0%,
    rgba(130,182,255,0.9) 55%,
    rgba(90,163,255,0.82) 100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.nav-btn.nav-btn-rec {
  border-color: rgba(111,91,204,0.14);
  background: rgba(111,91,204,0.03);
}
.rec-badge {
  border-color: rgba(111,91,204,0.14);
  color: rgba(111,91,204,0.4);
}

/* ── 5. INTERACTION RESTRAINT ────────────────────────────── */

.levelup-flash::before {
  background: radial-gradient(
    ellipse 50% 42% at center,
    rgba(90,163,255,0.065) 0%,
    transparent 62%
  );
}
@keyframes flashFade {
  0%  { opacity: 0; }
  10% { opacity: 1; }
  72% { opacity: 1; }
  100%{ opacity: 0; }
}

.confetti-burst span {
  width: 4px;
  height: 4px;
  border-radius: 1px;
  animation: confettiDrift 780ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
  opacity: 0;
}
@keyframes confettiDrift {
  0%   { opacity: 0.65; transform: translateY(0) rotate(0deg); }
  100% { opacity: 0;    transform: translateY(180px) rotate(330deg); }
}

.toc-card::after {
  background: radial-gradient(
    ellipse at var(--mx, 50%) var(--my, 50%),
    rgba(90,163,255,0.038) 0%,
    transparent 52%
  );
}

.hero::before {
  background: radial-gradient(
    ellipse 66% 48% at 50% -8%,
    rgba(90,163,255,0.062) 0%,
    transparent 60%
  );
}

.xp-pop {
  font-size: 0.7rem;
  font-weight: 600;
  text-shadow: none;
  color: rgba(185,127,8,0.8);
}

.toast .t-msg strong {
  color: var(--text-secondary, #5d6a84);
  text-transform: none;
  letter-spacing: 0.01em;
  font-family: var(--font-ui, system-ui);
  font-size: 0.74rem;
}

/* ── 6. FOCUS MODE: SUBTLER ──────────────────────────────── */

.comparison-grid:hover .panel {
  opacity: 0.83;
  transition: opacity 240ms cubic-bezier(0.22, 1, 0.36, 1);
}
.comparison-grid:hover .panel:hover {
  opacity: 1;
  transition:
    opacity    160ms cubic-bezier(0.22, 1, 0.36, 1),
    transform  160ms cubic-bezier(0.22, 1, 0.36, 1),
    box-shadow 160ms cubic-bezier(0.22, 1, 0.36, 1);
}

/* ── 7. TICKER: SLOWER, INFORMATIONAL ────────────────────── */

.insight-ticker-inner {
  animation: tickerScroll 80s linear infinite;
}

/* ── 8. REVEAL: TRANSLATE-ONLY, NO SCALE ─────────────────── */

.reveal {
  opacity: 0;
  transform: translateY(7px);
  transition:
    opacity   540ms cubic-bezier(0.22, 1, 0.36, 1),
    transform 540ms cubic-bezier(0.22, 1, 0.36, 1);
}
.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ── 9. STREAK PILL: DATA, NOT CTA ──────────────────────── */

.streak-pill {
  cursor: default;
  pointer-events: none;
}

/* ── 10. SECTION DONE BADGE: QUIETER ─────────────────────── */

.section-label .s-done {
  border-color: rgba(37,179,107,0.16);
  color: rgba(37,179,107,0.42);
}



/* === MAX-MODE FINAL LAYER === */
/* ============================================================
   MAX-MODE — Final Quality Ceiling Pass
   Architecturally intentional. Enterprise premium.
   Calm authority. Focused. Mature.
   ============================================================ */

/* ── DESIGN TOKEN FOUNDATION ─────────────────────────────────
   Single source of truth. All values derived.
   8pt grid. One accent. Four text levels. Three surfaces.
   ─────────────────────────────────────────────────────────── */
:root {
  /* Motion — one curve, three durations */
  --ease:        cubic-bezier(0.22, 1, 0.36, 1);
  --t-micro:     120ms;
  --t-fast:      200ms;
  --t-base:      320ms;
  --t-slow:      500ms;
  --t-scene:     640ms;

  /* Typography — system stack, display separate */
  --font-display: -apple-system, 'SF Pro Display', 'Helvetica Neue', system-ui, sans-serif;
  --font-text:    -apple-system, 'SF Pro Text',    'Helvetica Neue', system-ui, sans-serif;
  --font-mono:    'SF Mono', 'Fira Code', ui-monospace, 'Cascadia Code', monospace;

  /* Scale — major third (1.25) */
  --text-xs:   0.64rem;   /* 10.24px — labels, meta */
  --text-sm:   0.8rem;    /* 12.8px  — secondary */
  --text-base: 0.9375rem; /* 15px    — body */
  --text-md:   1.05rem;   /* 16.8px  — lead */
  --text-lg:   1.25rem;   /* 20px */
  --text-xl:   1.5625rem; /* 25px */
  --text-2xl:  1.953rem;  /* 31px */
  --text-3xl:  2.441rem;  /* 39px */

  /* Radius — geometric */
  --r-xs:  4px;
  --r-sm:  8px;
  --r-md:  12px;
  --r-lg:  18px;
  --r-xl:  24px;
  --r-2xl: 32px;

  /* Layout */
  --max-w:     1440px;
  --pad-x:     clamp(20px, 4.5vw, 64px);
  --pad-hero:  clamp(80px, 11vw, 144px);
}

/* ── DARK SURFACE SYSTEM ─────────────────────────────────────
   Four distinct planes. True depth without decoration.
   Separation through value, not shadow intensity.
   ─────────────────────────────────────────────────────────── */
[data-theme="dark"] {
  /* Backgrounds — stepped value, not hue-shifted */
  --bg-base:    #030508;   /* page ground */
  --bg-surface: #080b14;   /* primary surface */
  --bg-card:    #0d1120;   /* raised card */
  --bg-elevated:#121828;   /* modal / sheet */
  --bg-code:    #060810;   /* code block */
  --bg-inset:   #0a0e1a;   /* sunken / input */
  --bg-hover:   rgba(255,255,255, 0.026);

  /* Borders — four levels of opacity */
  --border-faint:  rgba(255,255,255, 0.042);
  --border:        rgba(255,255,255, 0.074);
  --border-strong: rgba(255,255,255, 0.11);
  --border-accent: rgba(74,148,240,  0.36);

  /* Text — four semantic levels */
  --text-primary:   #e6eeff;  /* 4.5:1+ on bg-card  */
  --text-secondary: #5a6880;  /* passive info        */
  --text-tertiary:  #303d54;  /* labels, metadata    */
  --text-muted:     #1e2840;  /* purely decorative   */

  /* Accent — one electric blue */
  --accent:        #4a94f0;
  --accent-bright: #68aeff;
  --accent-dim:    rgba(74,148,240, 0.1);
  --accent-glow:   rgba(74,148,240, 0.055);

  /* Semantic — WCAG AA restrained */
  --accent-blue:   #4a94f0;
  --accent-green:  #22a86a;
  --accent-red:    #c44242;
  --accent-amber:  #b07a08;
  --accent-purple: #6852c8;

  /* Elevation — compound shadow stack */
  --shadow-1: 0 1px 2px rgba(0,0,0,0.52);
  --shadow-2: 0 1px 3px rgba(0,0,0,0.5),
              0 6px 18px rgba(0,0,0,0.34),
              0 18px 48px rgba(0,0,0,0.2);
  --shadow-3: 0 2px 8px rgba(0,0,0,0.56),
              0 16px 48px rgba(0,0,0,0.52),
              0 48px 96px rgba(0,0,0,0.38);

  /* Legacy aliases — keep existing JS from breaking */
  --bg-page:      var(--bg-base);
  --bg-accent:    var(--bg-elevated);
  --border-focus: var(--accent);
  --shadow-card:  var(--shadow-2);
  --shadow-modal: var(--shadow-3);
  --modal-overlay: rgba(2,3,8,0.97);
  --scrollbar-thumb: rgba(255,255,255,0.1);
  --scrollbar-track: transparent;
}

/* ── LIGHT SURFACE SYSTEM ────────────────────────────────────
   Clean, high-contrast. Not washed-out.
   ─────────────────────────────────────────────────────────── */
[data-theme="light"] {
  --bg-base:    #edf0f7;
  --bg-surface: #f8f9fc;
  --bg-card:    #ffffff;
  --bg-elevated:#ffffff;
  --bg-code:    #1c2338;
  --bg-inset:   #f2f4f9;
  --bg-hover:   rgba(0,0,0,0.026);

  --border-faint:  rgba(0,0,0,0.042);
  --border:        rgba(0,0,0,0.09);
  --border-strong: rgba(0,0,0,0.15);
  --border-accent: rgba(37,99,235,0.36);

  --text-primary:   #0d1117;
  --text-secondary: #4b5568;
  --text-tertiary:  #8a96aa;
  --text-muted:     #b4bcc8;

  --accent:        #1e6fdf;
  --accent-bright: #2d85f5;
  --accent-dim:    rgba(30,111,223,0.08);
  --accent-glow:   rgba(30,111,223,0.04);

  --accent-blue:   #1e6fdf;
  --accent-green:  #14a35a;
  --accent-red:    #c0302e;
  --accent-amber:  #b86808;
  --accent-purple: #5e3dc4;

  --shadow-1: 0 1px 2px rgba(0,0,0,0.06);
  --shadow-2: 0 1px 3px rgba(0,0,0,0.06),
              0 4px 14px rgba(0,0,0,0.05),
              0 10px 32px rgba(0,0,0,0.04);
  --shadow-3: 0 4px 16px rgba(0,0,0,0.1),
              0 20px 56px rgba(0,0,0,0.08);

  --bg-page:     var(--bg-base);
  --bg-accent:   var(--bg-inset);
  --border-focus:var(--accent);
  --shadow-card: var(--shadow-2);
  --shadow-modal:var(--shadow-3);
  --modal-overlay: rgba(5,8,20,0.72);
  --scrollbar-thumb: rgba(0,0,0,0.18);
  --scrollbar-track: transparent;
}

/* ── GLOBAL BASE ─────────────────────────────────────────────
   Rendering precision. Font smoothing. Stable layout.
   ─────────────────────────────────────────────────────────── */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
  text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
}

body {
  font-family: var(--font-text);
  background: var(--bg-base);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  /* Prevent theme-swap FOUC */
  transition: background-color 240ms var(--ease),
              color           240ms var(--ease);
}

/* ── SCROLLBAR ───────────────────────────────────────────────
   Minimal presence. Does not fight content.
   ─────────────────────────────────────────────────────────── */
::-webkit-scrollbar              { width: 3px; height: 3px; }
::-webkit-scrollbar-track        { background: transparent; }
::-webkit-scrollbar-thumb        { background: var(--scrollbar-thumb); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover  { background: rgba(255,255,255,0.2); }

/* ── FOCUS SYSTEM — WCAG 2.4.11 ─────────────────────────────
   Visible. Consistent. Never clipped.
   ─────────────────────────────────────────────────────────── */
:focus { outline: none; }

:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 3px;
  border-radius: var(--r-xs);
}

/* Contained elements need tighter offset */
button:focus-visible,
a:focus-visible,
input:focus-visible,
[role="button"]:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* ── REDUCED MOTION — WCAG 2.3.3 ────────────────────────────
   Full compliance. No animation except opacity fades.
   ─────────────────────────────────────────────────────────── */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration:        0.01ms !important;
    animation-iteration-count: 1      !important;
    transition-duration:       0.01ms !important;
    scroll-behavior:           auto   !important;
  }

  .reveal {
    opacity: 1;
    transform: none;
    transition: none;
  }

  .fab,
  .modal-box,
  .toast,
  .xp-pop,
  .levelup-flash,
  .confetti-burst {
    animation: none !important;
    transition: none !important;
  }
}

/* ── SCROLL PROGRESS ─────────────────────────────────────────
   Instrument, not decoration.
   ─────────────────────────────────────────────────────────── */
#scroll-progress {
  position: fixed;
  top: 0; left: 0;
  height: 1px;
  background: var(--accent);
  opacity: 0.65;
  z-index: 9999;
  transition: width 40ms linear;
  will-change: width;
}

/* ── SITE HEADER ─────────────────────────────────────────────
   Persistent control bar. 52px. Glass surface.
   Not decorative. Contains only operational info.
   ─────────────────────────────────────────────────────────── */
.site-header {
  position: sticky;
  top: 0;
  z-index: 100;
  height: 52px;
  background: rgba(3, 5, 8, 0.92);
  border-bottom: 1px solid var(--border-faint);
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  /* Contain paint */
  contain: layout style paint;
}

[data-theme="light"] .site-header {
  background: rgba(248, 249, 252, 0.94);
  border-bottom: 1px solid var(--border);
}

.header-inner {
  max-width: var(--max-w);
  margin: 0 auto;
  padding: 0 var(--pad-x);
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}

/* Brand — word mark only, no icon dependency */
.header-brand h1 {
  font-family: var(--font-display);
  font-size: var(--text-sm);
  font-weight: 550;
  letter-spacing: -0.02em;
  color: rgba(255,255,255,0.86);
  line-height: 1;
  white-space: nowrap;
}

[data-theme="light"] .header-brand h1 { color: var(--text-primary); }

.header-brand span {
  display: block;
  font-size: var(--text-xs);
  font-family: var(--font-mono);
  color: var(--text-tertiary);
  letter-spacing: 0.07em;
  text-transform: uppercase;
  margin-top: 3px;
  font-weight: 500;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Theme toggle — minimal, functional */
.btn-theme {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--r-xs);
  color: var(--text-secondary);
  font-family: var(--font-text);
  font-size: var(--text-xs);
  padding: 5px 10px;
  cursor: pointer;
  letter-spacing: 0.02em;
  white-space: nowrap;
  transition: background  var(--t-micro) var(--ease),
              border-color var(--t-micro) var(--ease),
              color        var(--t-micro) var(--ease);
}

.btn-theme:hover {
  background: var(--bg-hover);
  border-color: var(--border-strong);
  color: var(--text-primary);
}

/* Progress badge — telemetry, not a CTA */
.progress-badge {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 500;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 4px 9px;
  letter-spacing: 0.06em;
  white-space: nowrap;
  pointer-events: none;
}

/* ── XP BAR — precision instrument ──────────────────────────
   Removed from header. Lives below as a dedicated strip.
   Height: 28px. Contains: level, track, value.
   ─────────────────────────────────────────────────────────── */
.xp-bar-wrap {
  height: 28px;
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border-faint);
  padding: 0 var(--pad-x);
  display: flex;
  align-items: center;
  gap: 14px;
  contain: layout style;
}

.xp-label {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 600;
  color: var(--text-tertiary);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 7px;
}

.xp-level-badge {
  font-size: 0.58rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  background: var(--accent-dim);
  border: 1px solid rgba(74,148,240,0.16);
  color: var(--accent);
  border-radius: var(--r-xs);
  padding: 1px 6px;
}

.xp-track {
  flex: 1;
  height: 1px;
  background: var(--border);
  border-radius: 1px;
  position: relative;
  overflow: visible;
}

.xp-fill {
  position: absolute;
  left: 0; top: 0;
  height: 1px;
  background: var(--accent);
  opacity: 0.68;
  border-radius: 1px;
  transition: width 520ms var(--ease);
  will-change: width;
}

/* Cursor tick mark at fill edge */
.xp-fill::after {
  content: '';
  position: absolute;
  right: -1px;
  top: -2px;
  width: 1px;
  height: 5px;
  background: var(--accent);
  opacity: 0.75;
  border-radius: 1px;
}

.xp-pts {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  letter-spacing: 0.05em;
  min-width: 54px;
  text-align: right;
  white-space: nowrap;
}

/* ── HEADER WIDGETS — informational only ─────────────────────
   Not interactive CTAs. Static data display.
   ─────────────────────────────────────────────────────────── */
.streak-pill {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 4px 9px;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  letter-spacing: 0.04em;
  white-space: nowrap;
  cursor: default;
  pointer-events: none;
}

.streak-fire {
  animation: none !important;
  font-style: normal;
  opacity: 0.55;
}

.session-stat {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  display: flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
}

.session-stat .ss-num {
  font-weight: 700;
  color: var(--text-secondary);
  font-size: var(--text-sm);
  transition: color var(--t-base) var(--ease);
}

.daily-goal-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: default;
}

.daily-ring { width: 22px; height: 22px; flex-shrink: 0; }
.daily-ring circle { fill: none; stroke-width: 2.5; stroke-linecap: butt; }
.daily-ring .dr-bg   { stroke: var(--border); }
.daily-ring .dr-fill {
  stroke: var(--accent-green);
  opacity: 0.55;
  stroke-dasharray: 50.3; /* 2π × 8 */
  stroke-dashoffset: 50.3;
  transform: rotate(-90deg);
  transform-origin: 50% 50%;
  transition: stroke-dashoffset 540ms var(--ease);
}

.daily-goal-text {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  line-height: 1.3;
}

.daily-goal-text strong {
  display: block;
  color: var(--accent-green);
  opacity: 0.62;
  font-size: 0.66rem;
}

/* ── HERO — CINEMATIC AUTHORITY ──────────────────────────────
   Product launch caliber. One read. One message.
   Breathing room is the design element.
   ─────────────────────────────────────────────────────────── */
.hero {
  position: relative;
  overflow: hidden;
  background: var(--bg-surface);
  padding: var(--pad-hero) var(--pad-x) calc(var(--pad-hero) * 0.8);
  text-align: center;
  border-bottom: 1px solid var(--border-faint);
  /* Isolate paint layer */
  contain: layout style;
}

/* Single atmospheric layer — presence without noise */
.hero::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(
    ellipse 70% 50% at 50% -10%,
    rgba(74, 148, 240, 0.07) 0%,
    transparent 62%
  );
  pointer-events: none;
  z-index: 0;
}

/* Hairline architectural separator */
.hero::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: var(--pad-x);
  right: var(--pad-x);
  height: 1px;
  background: linear-gradient(
    90deg,
    transparent       0%,
    var(--border)     25%,
    var(--border)     75%,
    transparent       100%
  );
  z-index: 1;
  pointer-events: none;
}

.hero > * { position: relative; z-index: 2; }

/* Eyebrow — classification, not marketing */
.hero-eyebrow {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 5px 14px;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 500;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  margin-bottom: 40px;
  /* Contains emoji — make it consistent */
  line-height: 1;
}

[data-theme="light"] .hero-eyebrow {
  border-color: var(--border);
  color: var(--text-tertiary);
}

/* Primary headline — dominant, unambiguous */
.hero h2 {
  font-family: var(--font-display);
  font-size: clamp(2.6rem, 6.5vw, 4.8rem);
  font-weight: 680;
  letter-spacing: -0.052em;
  line-height: 0.97;
  color: var(--text-primary);
  margin-bottom: 28px;
  /* GPU layer for smooth repaint */
  will-change: auto;
}

/* Accent word: gradient text, white to blue */
[data-theme="dark"] .hero h2 .hl {
  background: linear-gradient(
    152deg,
    rgba(255,255,255,0.97)  0%,
    rgba(132,186,255,0.92) 52%,
    rgba(74,148,240,0.86)  100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

[data-theme="light"] .hero h2 .hl {
  color: var(--accent);
  -webkit-text-fill-color: var(--accent);
}

/* Lead — restrained, measured */
.hero p {
  font-family: var(--font-text);
  font-size: var(--text-md);
  color: var(--text-secondary);
  max-width: 420px;
  margin: 0 auto 68px;
  line-height: 1.66;
  letter-spacing: 0.006em;
  font-weight: 380;
}

/* ── HERO STATS — operational dashboard ──────────────────────
   Pure data. No decoration. Values do the work.
   ─────────────────────────────────────────────────────────── */
.hero-stats {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 52px;
  flex-wrap: wrap;
}

.stat-item { text-align: center; }

.stat-item .num {
  display: block;
  font-family: var(--font-display);
  font-size: var(--text-2xl);
  font-weight: 660;
  letter-spacing: -0.055em;
  color: var(--text-primary);
  line-height: 1;
}

.stat-item .lbl {
  display: block;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 500;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-top: 8px;
}

.stat-divider {
  width: 1px;
  height: 32px;
  background: var(--border);
  flex-shrink: 0;
}

/* Mastery ring */
.mastery-ring-wrap { gap: 14px; display: flex; align-items: center; }
.mastery-ring      { width: 44px; height: 44px; flex-shrink: 0; }
.mastery-ring circle { fill: none; stroke-width: 3; stroke-linecap: butt; }
.mastery-ring .ring-bg   { stroke: var(--border); }
.mastery-ring .ring-fill {
  stroke: var(--accent);
  stroke-dasharray: 113;
  stroke-dashoffset: 113;
  transform: rotate(-90deg);
  transform-origin: 50% 50%;
  transition: stroke-dashoffset 580ms var(--ease);
  opacity: 0.7;
}

.mastery-text { line-height: 1.3; text-align: left; }

.mastery-pct {
  font-family: var(--font-display);
  font-size: var(--text-lg);
  font-weight: 660;
  letter-spacing: -0.04em;
  color: var(--text-primary);
  display: block;
}

.mastery-sub {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-top: 4px;
  display: block;
}

/* ── MAIN / TOC SECTION ──────────────────────────────────────
   Dashboard mode. Deliberate grid. Spatial hierarchy.
   ─────────────────────────────────────────────────────────── */
.toc-section {
  max-width: var(--max-w);
  margin: 0 auto;
  padding: 68px var(--pad-x) 112px;
}

/* Section dividers — editorial classification */
.section-label {
  display: flex;
  align-items: center;
  gap: 16px;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 600;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 18px;
}

.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.section-label .s-done {
  font-size: 0.58rem;
  font-weight: 600;
  letter-spacing: 0.08em;
  background: transparent;
  border: 1px solid rgba(34,168,106,0.16);
  color: rgba(34,168,106,0.44);
  border-radius: var(--r-xs);
  padding: 2px 8px;
}

/* Heatmap — operational activity view */
.heatmap-wrap {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 18px 22px;
  margin-bottom: 28px;
  box-shadow: var(--shadow-1);
}

.heatmap-title {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 600;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.heatmap-grid { display: flex; gap: 4px; flex-wrap: wrap; }

.hm-cell {
  width: 11px;
  height: 11px;
  border-radius: 2px;
  background: var(--border);
  transition: transform var(--t-micro) var(--ease);
  cursor: default;
}

.hm-cell:hover        { transform: scale(1.2); }
.hm-cell.hm-1         { background: rgba(34,168,106,0.17); }
.hm-cell.hm-2         { background: rgba(34,168,106,0.37); }
.hm-cell.hm-3         { background: rgba(34,168,106,0.62); }
.hm-cell.hm-4         { background: rgba(34,168,106,0.85); }
.hm-cell.hm-today     { outline: 1px solid rgba(74,148,240,0.45); outline-offset: 1px; }

/* Recall banner — contextual continuation, not marketing */
.recall-banner {
  display: none;
  align-items: center;
  gap: 18px;
  background: transparent;
  border: 1px solid var(--border);
  border-left: 2px solid rgba(104,82,200,0.34);
  border-radius: var(--r-md);
  padding: 14px 18px;
  margin-bottom: 24px;
  font-size: var(--text-sm);
}

.recall-banner.show { display: flex; }

.recall-banner .rb-text {
  flex: 1;
  color: var(--text-secondary);
  line-height: 1.5;
}

.recall-banner .rb-text strong {
  color: var(--text-primary);
  font-weight: 560;
}

.recall-banner .rb-resume {
  background: transparent;
  border: 1px solid rgba(104,82,200,0.22);
  color: var(--accent-purple);
  border-radius: var(--r-xs);
  padding: 5px 13px;
  font-size: var(--text-xs);
  font-weight: 520;
  cursor: pointer;
  white-space: nowrap;
  letter-spacing: 0.01em;
  transition: background  var(--t-micro) var(--ease),
              border-color var(--t-micro) var(--ease);
}

.recall-banner .rb-resume:hover {
  background: rgba(104,82,200,0.08);
  border-color: rgba(104,82,200,0.35);
}

.recall-banner .rb-dismiss {
  background: none;
  border: none;
  color: var(--text-tertiary);
  cursor: pointer;
  font-size: 0.9rem;
  line-height: 1;
  padding: 0 3px;
  transition: color var(--t-micro) var(--ease);
}

.recall-banner .rb-dismiss:hover { color: var(--text-secondary); }

/* Search — functional, minimal chrome */
.search-wrap {
  position: relative;
  max-width: 400px;
  margin-bottom: 24px;
}

.search-icon {
  position: absolute;
  left: 11px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-tertiary);
  font-size: 0.85rem;
  pointer-events: none;
  line-height: 1;
}

.search-input {
  width: 100%;
  background: var(--bg-inset);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 10px 14px 10px 34px;
  color: var(--text-primary);
  font-family: var(--font-text);
  font-size: var(--text-base);
  line-height: 1;
  transition: border-color var(--t-fast) var(--ease),
              box-shadow   var(--t-fast) var(--ease);
}

.search-input::placeholder {
  color: var(--text-tertiary);
  font-size: var(--text-sm);
}

.search-input:focus {
  outline: none;
  border-color: rgba(74,148,240,0.38);
  box-shadow: 0 0 0 3px rgba(74,148,240,0.08);
}

.search-results {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--bg-elevated);
  border: 1px solid var(--border-strong);
  border-radius: var(--r-md);
  box-shadow: var(--shadow-3);
  z-index: 200;
  max-height: 280px;
  overflow-y: auto;
  display: none;
}

.search-results.open { display: block; }

.search-result-item {
  padding: 10px 13px;
  cursor: pointer;
  font-size: var(--text-sm);
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border-faint);
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background var(--t-micro) var(--ease),
              color       var(--t-micro) var(--ease);
}

.search-result-item:last-child { border-bottom: none; }
.search-result-item:hover      { background: var(--bg-hover); color: var(--text-primary); }
.search-result-item .ri        { font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-tertiary); min-width: 20px; letter-spacing: 0.04em; }

/* ── TOC CARDS — module container ────────────────────────────
   Elevation through shadow, not border weight.
   Internal rhythm via link spacing, not dividers.
   ─────────────────────────────────────────────────────────── */
.toc-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(276px, 1fr));
  gap: 10px;
}

.toc-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 24px 22px 20px;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-1);
  will-change: transform;
  transition: border-color  var(--t-fast) var(--ease),
              box-shadow     var(--t-fast) var(--ease),
              transform      var(--t-fast) var(--ease);
}

/* Surface highlight — top edge light refraction */
.toc-card::before {
  content: '';
  position: absolute;
  top: 0; left: 16px; right: 16px;
  height: 1px;
  background: linear-gradient(
    90deg,
    transparent                   0%,
    rgba(255,255,255,0.055)       50%,
    transparent                   100%
  );
  pointer-events: none;
}

/* Cursor-tracked ambient — very subtle */
.toc-card::after {
  content: '';
  position: absolute;
  inset: -1px;
  border-radius: var(--r-lg);
  opacity: 0;
  background: radial-gradient(
    ellipse at var(--mx, 50%) var(--my, 50%),
    rgba(74,148,240, 0.038) 0%,
    transparent 54%
  );
  pointer-events: none;
  transition: opacity 400ms var(--ease);
}

.toc-card:hover {
  border-color: rgba(74,148,240,0.2);
  box-shadow:
    0 0 0 1px rgba(74,148,240,0.07),
    0 4px 14px rgba(0,0,0,0.42),
    0 14px 40px rgba(0,0,0,0.28);
  transform: translateY(-3px);
}

.toc-card:hover::after { opacity: 1; }

/* Card header — module classification */
.toc-card-label {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 600;
  letter-spacing: 0.17em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 7px;
}

.toc-card-label .dot {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--accent);
  opacity: 0.38;
  flex-shrink: 0;
}

/* ── TOC LINKS — list items ──────────────────────────────────
   Clean hierarchy. Number + title + status.
   No padding-shift hover tricks — confusing for screen readers.
   ─────────────────────────────────────────────────────────── */
.toc-link {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
  text-decoration: none;
  padding: 7px 0;
  font-family: var(--font-text);
  font-size: var(--text-sm);
  letter-spacing: -0.008em;
  line-height: 1.3;
  border-radius: 0;
  cursor: pointer;
  transition: color var(--t-micro) var(--ease);
}

.toc-link:hover { color: var(--text-primary); }

.toc-link .num {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  min-width: 22px;
  letter-spacing: 0.04em;
  flex-shrink: 0;
  opacity: 0.55;
  transition: color    var(--t-micro) var(--ease),
              opacity  var(--t-micro) var(--ease);
}

.toc-link:hover .num { color: var(--accent); opacity: 0.85; }

/* Preserve layout — no padding shift */
.toc-link:not(.done):hover {
  background: transparent;
  animation: none !important;
  padding-left: 0;
  padding-right: 0;
  margin-left: 0;
  margin-right: 0;
}

/* Completion mark */
.toc-link .chk {
  width: 13px;
  height: 13px;
  border-radius: 50%;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.44rem;
  color: transparent;
  flex-shrink: 0;
  margin-left: auto;
  transition: background    var(--t-fast) var(--ease),
              border-color  var(--t-fast) var(--ease),
              color         var(--t-fast) var(--ease);
}

.toc-link.done .chk {
  background: rgba(34,168,106,0.14);
  border-color: rgba(34,168,106,0.3);
  color: var(--accent-green);
}

.toc-link.done { color: var(--text-secondary); }
.toc-link.done .num { color: rgba(34,168,106,0.4); opacity: 1; }

/* Difficulty signal — structural, not decorative */
.diff-dot {
  width: 3px;
  height: 3px;
  border-radius: 50%;
  flex-shrink: 0;
  opacity: 0.38;
  margin-left: 2px;
}

.diff-easy   { background: var(--accent-green); }
.diff-medium { background: var(--accent-amber); }
.diff-hard   { background: var(--accent-red); }

/* Next-up indicator */
.toc-link.next-up { color: var(--text-primary); }
.toc-link.next-up .num { color: var(--accent); opacity: 0.9; }
.next-up-arrow { font-size: 0.48rem; color: var(--accent); opacity: 0.35; flex-shrink: 0; animation: none !important; }

/* Keyboard hint */
.kbd-hint {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 28px;
}

kbd {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--r-xs);
  padding: 2px 7px;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  letter-spacing: 0.04em;
  color: var(--text-secondary);
}

/* ── MODAL SYSTEM ────────────────────────────────────────────
   Full-screen overlay. Deep focus. Content foreground.
   ─────────────────────────────────────────────────────────── */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--modal-overlay);
  z-index: 1000;
  overflow-y: auto;
  backdrop-filter: blur(22px) saturate(140%);
  -webkit-backdrop-filter: blur(22px) saturate(140%);
  animation: fadeIn var(--t-fast) var(--ease) forwards;
}

.modal-overlay.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

.modal-box {
  max-width: 1320px;
  margin: 40px auto;
  background: var(--bg-surface);
  border: 1px solid var(--border-strong);
  border-radius: var(--r-2xl);
  box-shadow: var(--shadow-3);
  overflow: hidden;
  animation: modalDrop var(--t-scene) var(--ease) forwards;
}

@keyframes modalDrop {
  from { transform: translateY(16px) scale(0.995); opacity: 0; }
  to   { transform: translateY(0) scale(1); opacity: 1; }
}

[data-theme="light"] .modal-box {
  border: 1px solid var(--border);
}

/* Modal progress strip */
.modal-progress-strip {
  height: 1px;
  background: var(--border-faint);
  position: relative;
  overflow: hidden;
}

.modal-progress-fill {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  background: var(--accent);
  opacity: 0.45;
  transition: width 500ms var(--ease);
}

/* Modal header — sticky control bar */
.modal-header {
  background: rgba(3,5,8,0.75);
  border-bottom: 1px solid var(--border-faint);
  padding: 15px 30px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 10;
  backdrop-filter: blur(20px);
  gap: 16px;
}

[data-theme="light"] .modal-header {
  background: rgba(248,249,252,0.92);
  border-bottom: 1px solid var(--border);
}

.modal-crumb {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: 0.03em;
}

.modal-crumb strong {
  color: var(--text-primary);
  font-weight: 560;
  font-family: var(--font-text);
  font-size: var(--text-sm);
  letter-spacing: -0.01em;
}

.modal-topic-counter {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  letter-spacing: 0.07em;
  margin-left: auto;
  padding-right: 8px;
  white-space: nowrap;
}

/* Read time */
.read-time-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--r-xs);
  padding: 3px 9px;
  letter-spacing: 0.06em;
  white-space: nowrap;
}

/* Close button */
.modal-close-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 5px 13px;
  cursor: pointer;
  font-family: var(--font-text);
  font-size: var(--text-xs);
  display: flex;
  align-items: center;
  gap: 5px;
  letter-spacing: 0.02em;
  white-space: nowrap;
  transition: background    var(--t-micro) var(--ease),
              border-color  var(--t-micro) var(--ease),
              color         var(--t-micro) var(--ease);
}

.modal-close-btn:hover {
  background: rgba(196,66,66,0.08);
  border-color: rgba(196,66,66,0.26);
  color: var(--accent-red);
}

/* Modal body */
.modal-body {
  padding: 40px clamp(20px, 4.5vw, 52px) 52px;
}

/* ── TOPIC TITLE ─────────────────────────────────────────────
   Clear. Unambiguous. Dominant over comparison panels.
   ─────────────────────────────────────────────────────────── */
.topic-title {
  font-family: var(--font-display);
  font-size: clamp(1.15rem, 2.3vw, 1.65rem);
  font-weight: 630;
  letter-spacing: -0.038em;
  color: var(--text-primary);
  line-height: 1.18;
  margin-bottom: 32px;
  padding-bottom: 22px;
  border-bottom: 1px solid var(--border-faint);
}

/* ── CODE COMPARISON PANELS ──────────────────────────────────
   Primary content area. Maximum readability.
   Old/New: semantic, not stylistic.
   ─────────────────────────────────────────────────────────── */
.comparison { margin-bottom: 56px; }

.comparison-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

@media (max-width: 780px) {
  .comparison-grid { grid-template-columns: 1fr; }
}

.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  overflow: hidden;
  box-shadow: var(--shadow-1);
}

/* Semantic distinction — top edge only, minimal */
.panel.panel-old { border-top: 1px solid rgba(196,66,66,0.34); }
.panel.panel-new { border-top: 1px solid rgba(34,168,106,0.34); }
.panel.panel-old .panel-header h3 { color: rgba(196,66,66,0.65); }
.panel.panel-new .panel-header h3 { color: rgba(34,168,106,0.65); }
.panel-new.pulse-once { animation: none !important; }

/* Focus dimming — surgical concentration tool */
.comparison-grid:hover .panel {
  opacity: 0.8;
  transition: opacity 240ms var(--ease);
}

.comparison-grid:hover .panel:hover {
  opacity: 1;
  box-shadow: var(--shadow-2);
  transition: opacity   160ms var(--ease),
              box-shadow 160ms var(--ease);
}

.panel-header {
  padding: 9px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border-faint);
}

.panel-header h3 {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 7px;
  letter-spacing: 0.04em;
}

/* Full-width panel */
.panel-full {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  overflow: hidden;
  margin-bottom: 14px;
  box-shadow: var(--shadow-1);
}

.panel-full .panel-header {
  padding: 9px 14px;
  border-bottom: 1px solid var(--border-faint);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.panel-full .panel-header h3 {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 0.04em;
}

/* ── CODE BLOCKS ─────────────────────────────────────────────
   Maximum readability. Consistent line rhythm.
   ─────────────────────────────────────────────────────────── */
pre {
  background: var(--bg-code);
  padding: 18px 20px;
  overflow-x: auto;
  font-family: var(--font-mono);
  font-size: 0.78rem;
  line-height: 1.76;
  white-space: pre;
  word-wrap: normal;
  margin: 0;
  /* Improve readability at small sizes */
  -webkit-font-smoothing: auto;
}

code { display: block; min-width: max-content; }

/* Copy button */
.copy-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-xs);
  padding: 2px 8px;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  cursor: pointer;
  letter-spacing: 0.04em;
  transition: background    var(--t-micro) var(--ease),
              border-color  var(--t-micro) var(--ease),
              color         var(--t-micro) var(--ease);
}

.copy-btn:hover {
  background: var(--accent-dim);
  border-color: rgba(74,148,240,0.26);
  color: var(--accent);
}

.copy-btn.copied {
  background: rgba(34,168,106,0.08);
  border-color: rgba(34,168,106,0.25);
  color: var(--accent-green);
}

/* ── NOTES & EXPLANATIONS ────────────────────────────────────
   Typographic callouts. High signal-to-noise.
   ─────────────────────────────────────────────────────────── */
.note, .explanation {
  padding: 14px 18px;
  border-radius: var(--r-sm);
  margin-top: 12px;
  font-size: var(--text-sm);
  line-height: 1.68;
}

.note {
  background: rgba(176,122,8,0.04);
  border-left: 2px solid rgba(176,122,8,0.4);
}

.explanation {
  background: rgba(74,148,240,0.04);
  border-left: 2px solid rgba(74,148,240,0.32);
}

.note strong        { color: var(--accent-amber); font-weight: 560; }
.explanation strong { color: var(--accent-blue);  font-weight: 560; }

/* Insight rows */
.insight-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}

@media (max-width: 640px) { .insight-row { grid-template-columns: 1fr; } }

.insight-box {
  padding: 13px 15px;
  border-radius: var(--r-sm);
  font-size: var(--text-sm);
  line-height: 1.62;
}

.insight-box.hi {
  background: rgba(104,82,200,0.04);
  border: 1px solid rgba(104,82,200,0.09);
}

.insight-box.en {
  background: rgba(74,148,240,0.04);
  border: 1px solid rgba(74,148,240,0.09);
}

.insight-box .tag {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  letter-spacing: 0.14em;
  text-transform: uppercase;
  font-weight: 700;
  margin-bottom: 7px;
  display: block;
}

.insight-box.hi .tag { color: var(--accent-purple); }
.insight-box.en .tag { color: var(--accent-blue); }

/* ── MODAL NAVIGATION FOOTER ─────────────────────────────────
   Secondary zone. Subdued. Full topic list for orientation.
   ─────────────────────────────────────────────────────────── */
.nav-footer {
  background: rgba(3,5,8,0.65);
  border-top: 1px solid var(--border-faint);
  padding: 26px 38px;
  margin-top: 44px;
  border-radius: 0 0 var(--r-2xl) var(--r-2xl);
  backdrop-filter: blur(14px);
}

[data-theme="light"] .nav-footer {
  background: rgba(240,242,248,0.78);
  border-top: 1px solid var(--border);
}

.nav-footer-title {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 600;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 14px;
}

.nav-buttons { display: flex; flex-wrap: wrap; gap: 7px; }

.nav-btn {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: var(--r-sm);
  padding: 9px 16px;
  cursor: pointer;
  font-family: var(--font-text);
  font-size: var(--text-sm);
  letter-spacing: -0.01em;
  text-align: left;
  transition: background    var(--t-micro) var(--ease),
              border-color  var(--t-micro) var(--ease),
              color         var(--t-micro) var(--ease),
              transform     var(--t-micro) var(--ease);
}

.nav-btn:hover {
  background: var(--accent-dim);
  border-color: rgba(74,148,240,0.2);
  color: var(--text-primary);
  transform: translateY(-1px);
}

.nav-btn .arrow { opacity: 0.38; margin-right: 5px; }

.nav-btn.nav-btn-rec {
  border-color: rgba(104,82,200,0.15);
  background: rgba(104,82,200,0.03);
}

.nav-btn.nav-btn-rec::before { display: none; }

.rec-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-family: var(--font-mono);
  font-size: 0.56rem;
  font-weight: 600;
  background: transparent;
  border: 1px solid rgba(104,82,200,0.16);
  color: rgba(104,82,200,0.42);
  border-radius: var(--r-xs);
  padding: 1px 6px;
  margin-bottom: 4px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

.nav-btn-back {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-tertiary);
  border-radius: var(--r-sm);
  padding: 9px 16px;
  cursor: pointer;
  font-family: var(--font-text);
  font-size: var(--text-sm);
  margin-top: 14px;
  display: inline-flex;
  align-items: center;
  gap: 7px;
  transition: color        var(--t-micro) var(--ease),
              border-color var(--t-micro) var(--ease);
}

.nav-btn-back:hover { color: var(--text-secondary); border-color: var(--border-strong); }

/* ── TOAST SYSTEM ────────────────────────────────────────────
   System feedback. Not celebration. Not clutter.
   Brief. Precise. Disappears.
   ─────────────────────────────────────────────────────────── */
#toast-wrap {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 9000;
  display: flex;
  flex-direction: column;
  gap: 7px;
  pointer-events: none;
}

.toast {
  background: var(--bg-elevated);
  border: 1px solid var(--border-strong);
  border-radius: var(--r-md);
  padding: 11px 16px;
  display: flex;
  align-items: center;
  gap: 9px;
  font-family: var(--font-text);
  font-size: var(--text-sm);
  color: var(--text-primary);
  box-shadow: var(--shadow-3);
  animation: toastIn 360ms var(--ease) forwards;
  pointer-events: auto;
  max-width: 260px;
  line-height: 1.4;
}

.toast .t-icon {
  font-size: 0.9rem;
  flex-shrink: 0;
  opacity: 0.75;
}

.toast .t-msg { flex: 1; }

.toast .t-msg strong {
  display: block;
  font-family: var(--font-text);
  font-size: var(--text-xs);
  font-weight: 560;
  color: var(--text-secondary);
  margin-bottom: 2px;
  letter-spacing: 0.01em;
}

.toast.t-out { animation: toastOut 280ms var(--ease) forwards; }

@keyframes toastIn {
  from { opacity: 0; transform: translateY(8px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes toastOut {
  from { opacity: 1; transform: translateY(0) scale(1); }
  to   { opacity: 0; transform: translateY(6px) scale(0.97); }
}

/* ── XP POP FLOAT ────────────────────────────────────────────
   Minimal. Gone in under a second. Not a party.
   ─────────────────────────────────────────────────────────── */
.xp-pop {
  position: fixed;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 700;
  color: rgba(176,122,8,0.78);
  text-shadow: none;
  pointer-events: none;
  z-index: 9999;
  letter-spacing: 0.06em;
  animation: xpRise 860ms var(--ease) forwards;
}

@keyframes xpRise {
  0%   { opacity: 0; transform: translateY(0); }
  18%  { opacity: 1; transform: translateY(-10px); }
  76%  { opacity: 0.5; transform: translateY(-28px); }
  100% { opacity: 0; transform: translateY(-36px); }
}

/* ── LEVEL-UP FLASH ──────────────────────────────────────────
   A quiet acknowledgment. One beat. Then gone.
   ─────────────────────────────────────────────────────────── */
.levelup-flash {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9990;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: flashFade 1400ms var(--ease) forwards;
}

@keyframes flashFade {
  0%   { opacity: 0; }
  10%  { opacity: 1; }
  72%  { opacity: 1; }
  100% { opacity: 0; }
}

.levelup-flash::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(
    ellipse 48% 40% at center,
    rgba(74,148,240,0.065) 0%,
    transparent 62%
  );
}

.levelup-inner {
  position: relative;
  text-align: center;
  animation: luReveal 700ms var(--ease) forwards;
}

@keyframes luReveal {
  from { transform: translateY(10px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}

.levelup-inner .lu-label {
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  font-weight: 600;
  letter-spacing: 0.24em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: 12px;
}

.levelup-inner .lu-title {
  font-family: var(--font-display);
  font-size: clamp(1.6rem, 5vw, 2.6rem);
  font-weight: 700;
  letter-spacing: -0.05em;
  background: linear-gradient(150deg, #ffffff 22%, rgba(74,148,240,0.88) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 0.96;
}

.levelup-inner .lu-sub {
  font-size: var(--text-base);
  color: var(--text-secondary);
  margin-top: 13px;
  letter-spacing: 0.004em;
}

/* ── CONFETTI — minimal acknowledgment ───────────────────────
   4px particles. 720ms. Not a party. A nod.
   ─────────────────────────────────────────────────────────── */
.confetti-burst {
  position: fixed;
  top: 0; left: 50%;
  transform: translateX(-50%);
  pointer-events: none;
  z-index: 9998;
  display: flex;
  gap: 5px;
}

.confetti-burst span {
  width: 4px;
  height: 4px;
  border-radius: 1px;
  animation: confettiDrift 720ms var(--ease) forwards;
  opacity: 0;
}

@keyframes confettiDrift {
  0%   { opacity: 0.6; transform: translateY(0) rotate(0deg); }
  100% { opacity: 0;   transform: translateY(160px) rotate(300deg); }
}

/* ── FAB — continue learning ─────────────────────────────────
   Appears after first topic. Disappears in modal.
   Single dominant action. No gradient.
   ─────────────────────────────────────────────────────────── */
.fab {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(64px);
  z-index: 800;
  background: var(--accent);
  color: #ffffff;
  border: none;
  border-radius: 56px;
  padding: 11px 22px;
  font-family: var(--font-text);
  font-size: var(--text-sm);
  font-weight: 500;
  cursor: pointer;
  letter-spacing: -0.01em;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 7px;
  opacity: 0;
  box-shadow:
    0 2px 10px rgba(74,148,240,0.2),
    0 1px 4px rgba(0,0,0,0.38);
  transition:
    transform    480ms var(--ease),
    opacity      480ms var(--ease),
    box-shadow   var(--t-fast) var(--ease);
  will-change: transform, opacity;
}

.fab.visible {
  transform: translateX(-50%) translateY(0);
  opacity: 0.92;
}

.fab:hover {
  transform: translateX(-50%) translateY(-3px);
  opacity: 1;
  box-shadow:
    0 4px 20px rgba(74,148,240,0.28),
    0 2px 6px rgba(0,0,0,0.4);
}

.fab .fab-arrow {
  font-size: 0.88rem;
  transition: transform var(--t-fast) var(--ease);
}

.fab:hover .fab-arrow { transform: translateX(3px); }

/* ── COMPLETION SCREEN ───────────────────────────────────────
   Milestone moment. Clean. Brief. Action-forward.
   ─────────────────────────────────────────────────────────── */
.completion-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 72px 40px;
  gap: 18px;
  animation: completionIn 460ms var(--ease) forwards;
}

@keyframes completionIn {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

.cs-icon {
  font-size: 2.4rem;
  animation: csIconLand 460ms var(--ease) forwards;
}

@keyframes csIconLand {
  from { transform: scale(0.78) translateY(8px); opacity: 0; }
  to   { transform: scale(1) translateY(0); opacity: 1; }
}

.cs-title {
  font-family: var(--font-display);
  font-size: clamp(1.3rem, 2.8vw, 1.85rem);
  font-weight: 660;
  letter-spacing: -0.042em;
  color: var(--text-primary);
  line-height: 1.08;
}

.cs-sub {
  font-size: var(--text-sm);
  color: var(--text-secondary);
  max-width: 280px;
  line-height: 1.58;
}

.cs-xp-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(176,122,8,0.07);
  border: 1px solid rgba(176,122,8,0.17);
  color: var(--accent-amber);
  border-radius: var(--r-sm);
  padding: 6px 16px;
  font-family: var(--font-mono);
  font-size: var(--text-sm);
  font-weight: 650;
  letter-spacing: 0.05em;
}

.cs-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 6px;
}

/* Primary action */
.cs-btn-next {
  background: var(--accent);
  color: #ffffff;
  border: none;
  border-radius: var(--r-md);
  padding: 11px 24px;
  font-family: var(--font-text);
  font-size: var(--text-base);
  font-weight: 500;
  cursor: pointer;
  letter-spacing: -0.01em;
  box-shadow:
    0 2px 10px rgba(74,148,240,0.2),
    0 1px 3px rgba(0,0,0,0.3);
  transition: transform    var(--t-fast) var(--ease),
              box-shadow   var(--t-fast) var(--ease);
}

.cs-btn-next:hover {
  transform: translateY(-2px);
  box-shadow:
    0 4px 18px rgba(74,148,240,0.28),
    0 2px 5px rgba(0,0,0,0.35);
}

/* Secondary action */
.cs-btn-back {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: var(--r-md);
  padding: 11px 20px;
  font-family: var(--font-text);
  font-size: var(--text-sm);
  cursor: pointer;
  transition: border-color var(--t-micro) var(--ease),
              color        var(--t-micro) var(--ease);
}

.cs-btn-back:hover {
  border-color: var(--border-strong);
  color: var(--text-primary);
}

/* Progress indicator */
.cs-progress-line {
  display: flex;
  align-items: center;
  gap: 11px;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  letter-spacing: 0.05em;
}

.cs-progress-line .csp-bar {
  width: 96px;
  height: 2px;
  background: var(--border);
  border-radius: 1px;
  overflow: hidden;
}

.cs-progress-line .csp-fill {
  height: 2px;
  background: var(--accent-green);
  opacity: 0.62;
  border-radius: 1px;
  transition: width 500ms var(--ease);
}

/* ── INSIGHT TICKER ──────────────────────────────────────────
   Information feed. Not entertainment. Slow enough to read.
   ─────────────────────────────────────────────────────────── */
.insight-ticker {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 26px;
  background: rgba(3,5,8,0.94);
  border-top: 1px solid var(--border-faint);
  z-index: 700;
  display: flex;
  align-items: center;
  overflow: hidden;
  pointer-events: none;
  backdrop-filter: blur(12px);
}

.insight-ticker-inner {
  display: flex;
  align-items: center;
  white-space: nowrap;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  letter-spacing: 0.04em;
  animation: tickerScroll 90s linear infinite;
}

.insight-ticker-inner span { padding: 0 52px; }

.insight-ticker-inner .ti-label {
  font-weight: 700;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.18);
  padding: 0 12px 0 24px;
}

@keyframes tickerScroll {
  0%   { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

/* ── REVEAL — intersection observer ─────────────────────────
   Translate only. Clean. Reads as loaded, not animated.
   ─────────────────────────────────────────────────────────── */
.reveal {
  opacity: 0;
  transform: translateY(6px);
  transition: opacity   520ms var(--ease),
              transform 520ms var(--ease);
}

.reveal.visible { opacity: 1; transform: translateY(0); }

/* ── SITE FOOTER ─────────────────────────────────────────────
   Credits preserved. Typography matches system.
   ─────────────────────────────────────────────────────────── */
.site-footer {
  border-top: 1px solid var(--border-faint);
  padding: 36px var(--pad-x);
  text-align: center;
  font-family: var(--font-mono);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  letter-spacing: 0.04em;
  line-height: 1.8;
}

.site-footer strong {
  color: var(--text-secondary);
  font-weight: 560;
}

/* ── RESPONSIVE ──────────────────────────────────────────────
   Layout adapts. System remains consistent.
   ─────────────────────────────────────────────────────────── */
@media (max-width: 1024px) {
  :root { --pad-x: clamp(20px, 3.5vw, 48px); }
}

@media (max-width: 768px) {
  .header-inner { gap: 10px; }
  .session-stat { display: none; }
  .daily-goal-wrap { display: none; }
  .comparison-grid { gap: 8px; }
}

@media (max-width: 640px) {
  :root {
    --pad-x:    20px;
    --pad-hero: 64px;
  }

  .site-header   { height: 48px; }
  .toc-section   { padding: 44px var(--pad-x) 80px; }
  .modal-body    { padding: 22px 18px 40px; }
  .modal-box     { margin: 10px; border-radius: var(--r-xl); }
  .modal-header  { padding: 13px 18px; }
  .nav-footer    { padding: 20px 18px; border-radius: 0 0 var(--r-xl) var(--r-xl); }
  .site-footer   { padding: 28px var(--pad-x); }

  .hero h2       { font-size: clamp(2.3rem, 11vw, 3.4rem); letter-spacing: -0.046em; }
  .hero p        { font-size: var(--text-base); margin-bottom: 48px; }
  .hero-stats    { gap: 24px; }
  .stat-divider  { display: none; }
  .hero-eyebrow  { margin-bottom: 32px; }

  .completion-screen { padding: 52px 20px; }
  .toc-grid      { gap: 8px; }

  #toast-wrap    { bottom: 34px; right: 14px; left: 14px; }
  .toast         { max-width: 100%; }
}

/* ── HIGH CONTRAST MODE ──────────────────────────────────────
   Respect OS setting. Force strong borders.
   ─────────────────────────────────────────────────────────── */
@media (forced-colors: active) {
  .toc-card, .panel, .panel-full, .modal-box {
    border: 2px solid ButtonText;
  }

  .xp-fill, .modal-progress-fill, .csp-fill {
    forced-color-adjust: none;
    background: Highlight;
  }

  .cs-btn-next, .fab {
    forced-color-adjust: none;
    background: Highlight;
    color: HighlightText;
    border: 2px solid Highlight;
  }
}


/* === DOUBLE-PASS CEILING === */
/* ============================================================
   DOUBLE-PASS FINAL — System Ceiling
   Cascade override layer. Precision only.
   ============================================================ */

/* ── MOTION SYSTEM LOCK ──────────────────────────────────────
   Single curve. All declarations unified.
   Kill remaining spring/ease-in-out curves via !important
   on the selectors that carried them through previous layers.
   ─────────────────────────────────────────────────────────── */

/* All transitions site-wide normalized */
*, *::before, *::after {
  transition-timing-function: cubic-bezier(0.22, 1, 0.36, 1);
}

/* Infinite animations still alive in layer 1 — silence them */
.streak-fire,
.next-up-arrow,
.panel-new.pulse-once,
.toc-link:not(.done):hover {
  animation: none !important;
  transition: none !important;
}

/* tickerScroll survives but at disciplined speed */
.insight-ticker-inner {
  animation: tickerScroll 96s linear infinite !important;
  -webkit-animation: tickerScroll 96s linear infinite !important;
}

/* ── DUPLICATE RESOLUTION — FINAL AUTHORITY VALUES ──────────
   These selectors appear 6-7x in the cascade.
   This layer is the definitive last word.
   ─────────────────────────────────────────────────────────── */

/* Scroll progress — 1px, accent, no stacked shadow */
#scroll-progress {
  position: fixed !important;
  top: 0; left: 0;
  height: 1px !important;
  background: #4a94f0 !important;
  opacity: 0.62 !important;
  z-index: 9999;
  box-shadow: none !important;
  transition: width 50ms linear !important;
  will-change: width;
}

/* XP fill — single value, no shadow */
.xp-fill {
  height: 1px !important;
  background: #4a94f0 !important;
  opacity: 0.65 !important;
  box-shadow: none !important;
  transition: width 520ms cubic-bezier(0.22, 1, 0.36, 1) !important;
}

.xp-fill::after {
  content: '';
  position: absolute;
  right: -1px; top: -2px;
  width: 1px; height: 5px;
  background: #4a94f0;
  opacity: 0.7;
  border-radius: 1px;
}

/* Hero atmospheric — single layer, definitive */
.hero::before {
  background: radial-gradient(
    ellipse 68% 48% at 50% -8%,
    rgba(74, 148, 240, 0.066) 0%,
    transparent 60%
  ) !important;
}

/* TOC card — clean hover, no stacked shadows */
.toc-card {
  box-shadow: 0 1px 2px rgba(0,0,0,0.45) !important;
  transition:
    border-color   220ms cubic-bezier(0.22, 1, 0.36, 1),
    box-shadow     220ms cubic-bezier(0.22, 1, 0.36, 1),
    transform      220ms cubic-bezier(0.22, 1, 0.36, 1) !important;
}

.toc-card:hover {
  border-color: rgba(74, 148, 240, 0.18) !important;
  box-shadow:
    0 4px 14px rgba(0,0,0,0.38),
    0 12px 36px rgba(0,0,0,0.22) !important;
  transform: translateY(-3px) !important;
}

.toc-card::after {
  background: radial-gradient(
    ellipse at var(--mx, 50%) var(--my, 50%),
    rgba(74, 148, 240, 0.032) 0%,
    transparent 52%
  ) !important;
}

/* Modal box — clean single-layer shadow */
.modal-box {
  box-shadow:
    0 2px 6px rgba(0,0,0,0.52),
    0 20px 56px rgba(0,0,0,0.44) !important;
  animation: modalDrop 480ms cubic-bezier(0.22, 1, 0.36, 1) forwards !important;
}

@keyframes modalDrop {
  from { transform: translateY(14px) scale(0.996); opacity: 0; }
  to   { transform: translateY(0)    scale(1);     opacity: 1; }
}

/* Modal progress */
.modal-progress-fill {
  background: #4a94f0 !important;
  opacity: 0.4 !important;
  box-shadow: none !important;
  transition: width 500ms cubic-bezier(0.22, 1, 0.36, 1) !important;
}

/* Reveal — definitive */
.reveal {
  opacity: 0 !important;
  transform: translateY(6px) !important;
  transition:
    opacity   500ms cubic-bezier(0.22, 1, 0.36, 1),
    transform 500ms cubic-bezier(0.22, 1, 0.36, 1) !important;
}
.reveal.visible {
  opacity: 1 !important;
  transform: translateY(0) !important;
}

/* XP pop — final */
.xp-pop {
  font-size: 0.68rem !important;
  font-weight: 600 !important;
  color: rgba(176, 122, 8, 0.75) !important;
  text-shadow: none !important;
  box-shadow: none !important;
  animation: xpRiseFinal 840ms cubic-bezier(0.22, 1, 0.36, 1) forwards !important;
}

@keyframes xpRiseFinal {
  0%   { opacity: 0;   transform: translateY(0); }
  16%  { opacity: 0.9; transform: translateY(-9px); }
  78%  { opacity: 0.4; transform: translateY(-26px); }
  100% { opacity: 0;   transform: translateY(-34px); }
}

/* FAB — definitive */
.fab {
  background: #4a94f0 !important;
  box-shadow:
    0 2px 8px rgba(74, 148, 240, 0.18),
    0 1px 3px rgba(0, 0, 0, 0.36) !important;
  transition:
    transform  480ms cubic-bezier(0.22, 1, 0.36, 1),
    opacity    480ms cubic-bezier(0.22, 1, 0.36, 1),
    box-shadow 200ms cubic-bezier(0.22, 1, 0.36, 1) !important;
}

.fab.visible {
  transform: translateX(-50%) translateY(0) !important;
  opacity: 0.9 !important;
}

.fab:hover {
  background: #5aa3ff !important;
  transform: translateX(-50%) translateY(-2px) !important;
  opacity: 1 !important;
  box-shadow:
    0 4px 16px rgba(74, 148, 240, 0.24),
    0 2px 5px rgba(0, 0, 0, 0.38) !important;
}

/* ── FONT WEIGHT SYSTEM — 5 values only ─────────────────────
   380 (body light), 450 (body), 560 (medium), 640 (semibold), 700 (bold)
   Collapse the 19-value chaos to 5 semantic stops.
   ─────────────────────────────────────────────────────────── */

/* Reduce all mid-range chaos toward clean stops */
.header-brand h1         { font-weight: 560 !important; }
.header-brand span        { font-weight: 450 !important; }
.xp-level-badge           { font-weight: 700 !important; }
.xp-label                 { font-weight: 560 !important; }
.streak-pill              { font-weight: 450 !important; }
.section-label            { font-weight: 640 !important; }
.toc-card-label           { font-weight: 640 !important; }
.toc-link                 { font-weight: 450 !important; }
.toc-link .num            { font-weight: 450 !important; }
.toc-link.done            { font-weight: 450 !important; }
.modal-crumb              { font-weight: 450 !important; }
.modal-crumb strong       { font-weight: 560 !important; }
.panel-header h3          { font-weight: 640 !important; }
.panel-full .panel-header h3 { font-weight: 640 !important; }
.topic-title              { font-weight: 640 !important; }
.nav-footer-title         { font-weight: 640 !important; }
.nav-btn                  { font-weight: 450 !important; }
.cs-btn-next              { font-weight: 500 !important; }
.cs-btn-back              { font-weight: 450 !important; }
.cs-xp-badge              { font-weight: 640 !important; }
.cs-title                 { font-weight: 640 !important; }
.toast .t-msg strong      { font-weight: 560 !important; }
.heatmap-title            { font-weight: 640 !important; }
.mastery-pct              { font-weight: 640 !important; }
.stat-item .num           { font-weight: 640 !important; }
.levelup-inner .lu-title  { font-weight: 700 !important; }
.hero h2                  { font-weight: 680 !important; }
.recall-banner .rb-text strong { font-weight: 560 !important; }

/* ── SHADOW REDUCTION — 20-30% intensity reduction ──────────
   Achieve authority through proportion, not effect weight.
   ─────────────────────────────────────────────────────────── */

/* Panels — minimal presence only */
.panel, .panel-full {
  box-shadow: 0 1px 2px rgba(0,0,0,0.38) !important;
}

/* Heatmap wrap */
.heatmap-wrap {
  box-shadow: 0 1px 2px rgba(0,0,0,0.36) !important;
}

/* Search results dropdown */
.search-results {
  box-shadow:
    0 4px 16px rgba(0,0,0,0.38),
    0 1px 4px rgba(0,0,0,0.28) !important;
}

/* Toast */
.toast {
  box-shadow:
    0 4px 20px rgba(0,0,0,0.42),
    0 1px 4px rgba(0,0,0,0.32) !important;
}

/* CS next button */
.cs-btn-next {
  background: #4a94f0 !important;
  box-shadow: 0 2px 8px rgba(74,148,240,0.18) !important;
}

.cs-btn-next:hover {
  background: #5aa3ff !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 14px rgba(74,148,240,0.24) !important;
}

/* ── ACCENT COMPETITION ELIMINATION ─────────────────────────
   Purple and green survive only as semantic state.
   Opacity pulled back so they don't compete with #4a94f0.
   ─────────────────────────────────────────────────────────── */

/* Recall banner — purple accent subdued */
.recall-banner {
  border-left-color: rgba(104, 82, 200, 0.28) !important;
}

.recall-banner .rb-resume {
  border-color: rgba(104, 82, 200, 0.18) !important;
  color: rgba(104, 82, 200, 0.72) !important;
}

.recall-banner .rb-resume:hover {
  background: rgba(104, 82, 200, 0.06) !important;
  border-color: rgba(104, 82, 200, 0.28) !important;
}

/* Nav rec badge — further quieted */
.nav-btn.nav-btn-rec {
  border-color: rgba(104, 82, 200, 0.12) !important;
  background: rgba(104, 82, 200, 0.025) !important;
}

.rec-badge {
  border-color: rgba(104, 82, 200, 0.14) !important;
  color: rgba(104, 82, 200, 0.38) !important;
}

/* Section done — green semantic, quieted */
.section-label .s-done {
  border-color: rgba(34, 168, 106, 0.15) !important;
  color: rgba(34, 168, 106, 0.42) !important;
}

/* Completion progress fill */
.csp-fill {
  background: rgba(34, 168, 106, 0.62) !important;
  opacity: 1 !important;
  box-shadow: none !important;
}

/* Mastery ring */
.mastery-ring .ring-fill {
  opacity: 0.65 !important;
  stroke: #4a94f0 !important;
}

/* Daily ring — green semantic, not competing */
.daily-ring .dr-fill {
  opacity: 0.48 !important;
}

/* Done checkmarks */
.toc-link.done .chk {
  background: rgba(34, 168, 106, 0.11) !important;
  border-color: rgba(34, 168, 106, 0.26) !important;
}

/* Panel top borders — semantic */
.panel.panel-old { border-top-color: rgba(196, 66, 66, 0.28) !important; }
.panel.panel-new { border-top-color: rgba(34, 168, 106, 0.28) !important; }
.panel.panel-old .panel-header h3 { color: rgba(196, 66, 66, 0.58) !important; }
.panel.panel-new .panel-header h3 { color: rgba(34, 168, 106, 0.58) !important; }

/* ── HERO GRADIENT TEXT — precise ─────────────────────────── */
[data-theme="dark"] .hero h2 .hl {
  background: linear-gradient(
    150deg,
    rgba(255, 255, 255, 0.96) 0%,
    rgba(140, 190, 255, 0.90) 48%,
    rgba(74,  148, 240, 0.84) 100%
  ) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  background-clip: text !important;
}

/* Level-up title — same palette */
.levelup-inner .lu-title {
  background: linear-gradient(
    150deg,
    rgba(255, 255, 255, 0.96) 18%,
    rgba(74,  148, 240, 0.86) 100%
  ) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  background-clip: text !important;
}

/* ── LINK HOVER — zero amplification ────────────────────────
   Color shift only. No translate. No shadow. No scale.
   ─────────────────────────────────────────────────────────── */

.toc-link:hover {
  transform: none !important;
  box-shadow: none !important;
}

.nav-btn:hover {
  transform: none !important;
  box-shadow: none !important;
}

.nav-btn-back:hover {
  transform: none !important;
}

.copy-btn:hover {
  transform: none !important;
}

.btn-theme:hover {
  transform: none !important;
}

/* ── COMPLETION SCREEN — calm, proportional ──────────────────
   No scaling cs-icon. Clean fade-up.
   ─────────────────────────────────────────────────────────── */

.cs-icon {
  animation: csIconFade 420ms cubic-bezier(0.22, 1, 0.36, 1) forwards !important;
}

@keyframes csIconFade {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ── CONFETTI — quietest possible ────────────────────────────
   3px particles. 600ms. 50% peak opacity.
   ─────────────────────────────────────────────────────────── */

.confetti-burst span {
  width: 3px !important;
  height: 3px !important;
  animation: confettiFinal 600ms cubic-bezier(0.22, 1, 0.36, 1) forwards !important;
}

@keyframes confettiFinal {
  0%   { opacity: 0.5; transform: translateY(0) rotate(0deg); }
  100% { opacity: 0;   transform: translateY(140px) rotate(280deg); }
}

/* ── LEVELUP — quieter flash ─────────────────────────────────  */
.levelup-flash::before {
  background: radial-gradient(
    ellipse 44% 38% at center,
    rgba(74, 148, 240, 0.055) 0%,
    transparent 60%
  ) !important;
}

@keyframes flashFade {
  0%   { opacity: 0; }
  12%  { opacity: 1; }
  70%  { opacity: 1; }
  100% { opacity: 0; }
}

/* ── FOCUS-VISIBLE — unified system ─────────────────────────
   Definitive declaration. 2px blue. 3px offset.
   ─────────────────────────────────────────────────────────── */

:focus { outline: none; }

:focus-visible {
  outline: 2px solid #4a94f0 !important;
  outline-offset: 3px !important;
  border-radius: 4px !important;
}

button:focus-visible,
a:focus-visible,
input:focus-visible {
  outline: 2px solid #4a94f0 !important;
  outline-offset: 2px !important;
}

/* ── REDUCED MOTION — complete coverage ─────────────────────
   Overwrites all layers.
   ─────────────────────────────────────────────────────────── */

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration:        0.01ms !important;
    animation-iteration-count: 1      !important;
    transition-duration:       0.01ms !important;
    scroll-behavior:           auto   !important;
  }

  .reveal, .reveal.visible {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
  }

  .fab, .modal-box, .toast, .xp-pop, .levelup-flash,
  .confetti-burst, .cs-icon, .levelup-inner {
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
  }

  .fab.visible {
    transform: translateX(-50%) !important;
    opacity: 0.9 !important;
  }
}

/* ── SPACING NORMALIZATION ───────────────────────────────────
   Remove <br> dependency. Section spacing via margin.
   Normalize inconsistent padding.
   ─────────────────────────────────────────────────────────── */

/* Between toc-grid sections — use margin, not <br> */
.toc-section > br {
  display: none !important;
}

.toc-section .reveal + br + .section-label,
.toc-section .section-label + .reveal ~ .section-label {
  margin-top: 0;
}

/* Deliberate vertical rhythm between sections */
.toc-section > .section-label { margin-top: 40px; }
.toc-section > .section-label:first-of-type { margin-top: 0; }
.toc-section > .reveal        { margin-bottom: 0; }

/* ── SCROLLBAR — thinner, less visible ───────────────────────  */
::-webkit-scrollbar { width: 3px !important; height: 3px !important; }
::-webkit-scrollbar-track { background: transparent !important; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08) !important; border-radius: 3px !important; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15) !important; }

/* ── PERFORMANCE — layout containment ────────────────────────
   Restrict paint and layout recalculation to key containers.
   ─────────────────────────────────────────────────────────── */

.toc-card        { contain: layout style; }
.heatmap-wrap    { contain: layout style; }
.panel           { contain: layout style; }
.modal-header    { contain: layout style; }
#toast-wrap      { contain: layout style; }

/* GPU promote only elements that animate transform/opacity */
.fab, .modal-box, .toast, .xp-pop {
  will-change: transform, opacity;
}

/* Remove will-change from static elements */
.toc-card,
.panel,
.heatmap-wrap,
.toc-link,
.copy-btn {
  will-change: auto !important;
}

/* ── DARK THEME FINAL SURFACE AUTHORITY ──────────────────────
   Definitive token values.
   ─────────────────────────────────────────────────────────── */
[data-theme="dark"] {
  --bg-base:       #030508;
  --bg-surface:    #070a12;
  --bg-card:       #0c1020;
  --bg-elevated:   #111828;
  --bg-code:       #050709;
  --bg-inset:      #090c18;
  --bg-hover:      rgba(255,255,255,0.024);

  --border-faint:  rgba(255,255,255,0.038);
  --border:        rgba(255,255,255,0.07);
  --border-strong: rgba(255,255,255,0.10);

  --text-primary:   #e4ecfc;
  --text-secondary: #56657e;
  --text-tertiary:  #2e3b52;
  --text-muted:     #1c2538;

  --accent:        #4a94f0;
  --accent-dim:    rgba(74,148,240,0.09);
  --accent-glow:   rgba(74,148,240,0.048);

  --shadow-1: 0 1px 2px rgba(0,0,0,0.48);
  --shadow-2: 0 1px 3px rgba(0,0,0,0.44), 0 5px 16px rgba(0,0,0,0.30), 0 14px 40px rgba(0,0,0,0.18);
  --shadow-3: 0 2px 6px rgba(0,0,0,0.50), 0 14px 42px rgba(0,0,0,0.42), 0 40px 80px rgba(0,0,0,0.32);

  --shadow-card:  var(--shadow-2);
  --shadow-modal: var(--shadow-3);
  --modal-overlay: rgba(2,3,8,0.97);

  /* Legacy aliases */
  --bg-page:   var(--bg-base);
  --bg-accent: var(--bg-elevated);
}

[data-theme="light"] {
  --bg-base:    #eceff6;
  --bg-surface: #f6f8fc;
  --bg-card:    #ffffff;
  --bg-elevated:#ffffff;
  --bg-inset:   #f0f3f9;
  --bg-hover:   rgba(0,0,0,0.022);

  --border-faint:  rgba(0,0,0,0.038);
  --border:        rgba(0,0,0,0.085);
  --border-strong: rgba(0,0,0,0.13);

  --text-primary:   #0c1016;
  --text-secondary: #485060;
  --text-tertiary:  #8896a8;
  --text-muted:     #b0bbc8;

  --accent:        #1d6fe8;
  --accent-dim:    rgba(29,111,232,0.07);

  --shadow-1: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-2: 0 1px 3px rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.04), 0 10px 28px rgba(0,0,0,0.03);
  --shadow-3: 0 4px 14px rgba(0,0,0,0.09), 0 16px 48px rgba(0,0,0,0.07);

  --shadow-card:  var(--shadow-2);
  --shadow-modal: var(--shadow-3);

  --bg-page:   var(--bg-base);
  --bg-accent: var(--bg-inset);
}

/* ── BODY TRANSITION — theme swap only ───────────────────────  */
body {
  transition: background-color 220ms cubic-bezier(0.22, 1, 0.36, 1),
              color            220ms cubic-bezier(0.22, 1, 0.36, 1) !important;
}

/* ── INSIGHT TICKER ANCHOR ───────────────────────────────────  */
.insight-ticker {
  background: rgba(2, 4, 8, 0.95) !important;
  border-top: 1px solid var(--border-faint) !important;
}

.insight-ticker-inner .ti-label {
  color: rgba(255,255,255,0.16) !important;
}

/* ── HIGH CONTRAST ───────────────────────────────────────────  */
@media (forced-colors: active) {
  .toc-card, .panel, .panel-full, .modal-box, .toast {
    border: 2px solid ButtonText;
    box-shadow: none !important;
  }

  .xp-fill, .modal-progress-fill, .csp-fill {
    forced-color-adjust: none;
    background: Highlight !important;
  }

  .cs-btn-next, .fab {
    forced-color-adjust: none;
    background: Highlight !important;
    color: HighlightText !important;
  }

  .toc-link.done .chk {
    forced-color-adjust: none;
    background: Highlight !important;
    border-color: Highlight !important;
  }
}


</style>
<style>

/* ============================================================
   WAP OS — THREE-PANEL LAYOUT SYSTEM
   ============================================================ */

/* Override body to allow three-panel layout */
body {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* WAP OS Top Bar */
.wapos-topbar {
  flex-shrink: 0;
  height: 52px;
  background: rgba(3,5,8,0.97);
  border-bottom: 1px solid rgba(255,255,255,0.07);
  backdrop-filter: blur(24px) saturate(160%);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  gap: 16px;
  z-index: 200;
  position: relative;
  overflow: visible;
}

[data-theme="light"] .wapos-topbar {
  background: rgba(248,249,252,0.97);
  border-bottom: 1px solid rgba(0,0,0,0.1);
}

.wapos-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.wapos-logo {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  object-fit: cover;
  border: 1px solid rgba(255,255,255,0.12);
}

[data-theme="light"] .wapos-logo {
  border-color: rgba(0,0,0,0.1);
}

.wapos-name {
  font-family: var(--font-mono, monospace);
  font-size: 0.82rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  color: rgba(255,255,255,0.9);
  text-transform: uppercase;
}

[data-theme="light"] .wapos-name {
  color: var(--text-primary, #0d1117);
}

.wapos-divider {
  width: 1px;
  height: 20px;
  background: rgba(255,255,255,0.08);
  flex-shrink: 0;
}

[data-theme="light"] .wapos-divider {
  background: rgba(0,0,0,0.1);
}

.wapos-topbar-center {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 12px;
  overflow: hidden;
}

.wapos-topbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

/* Main three-panel workspace */
.wapos-workspace {
  flex: 1;
  display: flex;
  overflow: hidden;
  position: relative;
}

/* LEFT SIDEBAR */
.wapos-sidebar {
  width: 280px;
  flex-shrink: 0;
  background: var(--bg-surface, #080b14);
  border-right: 1px solid rgba(255,255,255,0.06);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width 300ms cubic-bezier(0.22,1,0.36,1),
              opacity 300ms cubic-bezier(0.22,1,0.36,1);
  position: relative;
  z-index: 10;
}

[data-theme="light"] .wapos-sidebar {
  background: #f8f9fc;
  border-right: 1px solid rgba(0,0,0,0.08);
}

.wapos-sidebar.collapsed {
  width: 0;
  opacity: 0;
  overflow: hidden;
}

/* Sidebar header */
.sidebar-header {
  padding: 16px 16px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  flex-shrink: 0;
}

[data-theme="light"] .sidebar-header {
  border-bottom: 1px solid rgba(0,0,0,0.07);
}

/* Sidebar search */
.sidebar-search-wrap {
  padding: 10px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  flex-shrink: 0;
}

[data-theme="light"] .sidebar-search-wrap {
  border-bottom: 1px solid rgba(0,0,0,0.06);
}

.sidebar-search-input {
  width: 100%;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 8px;
  padding: 8px 12px 8px 32px;
  color: var(--text-primary, #e4ecfc);
  font-family: var(--font-mono, monospace);
  font-size: 0.75rem;
  letter-spacing: 0.02em;
  outline: none;
  transition: border-color 150ms, background 150ms;
}

[data-theme="light"] .sidebar-search-input {
  background: rgba(0,0,0,0.04);
  border-color: rgba(0,0,0,0.1);
  color: var(--text-primary, #0c1016);
}

.sidebar-search-input::placeholder {
  color: rgba(255,255,255,0.2);
}

[data-theme="light"] .sidebar-search-input::placeholder {
  color: rgba(0,0,0,0.3);
}

.sidebar-search-input:focus {
  border-color: rgba(74,148,240,0.4);
  background: rgba(74,148,240,0.05);
}

.sidebar-search-wrap {
  position: relative;
}

.sidebar-search-icon {
  position: absolute;
  left: 26px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.7rem;
  opacity: 0.35;
  pointer-events: none;
}

/* Sidebar nav list */
.sidebar-nav {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 8px 0;
  overscroll-behavior: contain;
}

.sidebar-section-title {
  padding: 12px 16px 4px;
  font-size: 0.58rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.22);
  font-family: var(--font-mono, monospace);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}

[data-theme="light"] .sidebar-section-title {
  color: rgba(0,0,0,0.3);
}

.sidebar-section-title::after {
  content: '';
  flex: 1;
  height: 1px;
  background: rgba(255,255,255,0.05);
}

[data-theme="light"] .sidebar-section-title::after {
  background: rgba(0,0,0,0.06);
}

.sidebar-topic-link {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 16px;
  cursor: pointer;
  font-size: 0.78rem;
  color: rgba(255,255,255,0.45);
  transition: background 120ms, color 120ms;
  border-radius: 0;
  text-decoration: none;
  font-family: var(--font-mono, monospace);
  letter-spacing: -0.01em;
  border-left: 2px solid transparent;
}

[data-theme="light"] .sidebar-topic-link {
  color: rgba(0,0,0,0.5);
}

.sidebar-topic-link:hover {
  background: rgba(255,255,255,0.04);
  color: rgba(255,255,255,0.75);
}

[data-theme="light"] .sidebar-topic-link:hover {
  background: rgba(0,0,0,0.04);
  color: rgba(0,0,0,0.75);
}

.sidebar-topic-link.active {
  background: rgba(74,148,240,0.08);
  color: var(--accent, #4a94f0);
  border-left-color: var(--accent, #4a94f0);
}

.sidebar-topic-link.done-item {
  color: rgba(34,168,106,0.55);
}

[data-theme="light"] .sidebar-topic-link.done-item {
  color: rgba(34,168,106,0.65);
}

.sidebar-topic-link.done-item .stl-num {
  color: rgba(34,168,106,0.4);
}

.stl-num {
  font-size: 0.58rem;
  opacity: 0.4;
  min-width: 20px;
  flex-shrink: 0;
}

.stl-check {
  margin-left: auto;
  font-size: 0.55rem;
  opacity: 0;
  transition: opacity 150ms;
  flex-shrink: 0;
}

.sidebar-topic-link.done-item .stl-check {
  opacity: 0.6;
  color: var(--accent-green, #22a86a);
}

/* Sidebar footer/stats */
.sidebar-footer {
  padding: 12px 14px;
  border-top: 1px solid rgba(255,255,255,0.05);
  flex-shrink: 0;
}

[data-theme="light"] .sidebar-footer {
  border-top: 1px solid rgba(0,0,0,0.07);
}

.sidebar-progress-label {
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.25);
  margin-bottom: 6px;
  font-family: var(--font-mono, monospace);
}

[data-theme="light"] .sidebar-progress-label {
  color: rgba(0,0,0,0.3);
}

.sidebar-progress-bar {
  height: 2px;
  background: rgba(255,255,255,0.07);
  border-radius: 1px;
  overflow: hidden;
  margin-bottom: 6px;
}

[data-theme="light"] .sidebar-progress-bar {
  background: rgba(0,0,0,0.08);
}

.sidebar-progress-fill {
  height: 100%;
  background: var(--accent, #4a94f0);
  border-radius: 1px;
  transition: width 500ms cubic-bezier(0.22,1,0.36,1);
  width: 0%;
}

/* CENTER CONTENT PANEL */
.wapos-center {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
  background: var(--bg-base, #030508);
  min-width: 0;
}

[data-theme="light"] .wapos-center {
  background: #eceff6;
}

/* RIGHT UTILITY PANEL */
.wapos-right {
  width: 240px;
  flex-shrink: 0;
  background: var(--bg-surface, #080b14);
  border-left: 1px solid rgba(255,255,255,0.06);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

[data-theme="light"] .wapos-right {
  background: #f8f9fc;
  border-left: 1px solid rgba(0,0,0,0.08);
}

.wapos-right.hidden {
  display: none;
}

.right-panel-header {
  padding: 14px 16px 10px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  flex-shrink: 0;
  font-size: 0.6rem;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.25);
  font-family: var(--font-mono, monospace);
  font-weight: 600;
}

[data-theme="light"] .right-panel-header {
  border-bottom: 1px solid rgba(0,0,0,0.07);
  color: rgba(0,0,0,0.3);
}

.right-panel-section {
  padding: 14px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  flex-shrink: 0;
}

[data-theme="light"] .right-panel-section {
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.rp-label {
  font-size: 0.58rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.22);
  margin-bottom: 8px;
  font-family: var(--font-mono, monospace);
}

[data-theme="light"] .rp-label {
  color: rgba(0,0,0,0.28);
}

/* Reading progress */
.rp-reading-progress {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.rp-prog-bar {
  height: 2px;
  background: rgba(255,255,255,0.07);
  border-radius: 1px;
  overflow: hidden;
}

[data-theme="light"] .rp-prog-bar {
  background: rgba(0,0,0,0.08);
}

.rp-prog-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent, #4a94f0), var(--accent-green, #22a86a));
  border-radius: 1px;
  transition: width 200ms;
  width: 0%;
}

.rp-prog-text {
  font-family: var(--font-mono, monospace);
  font-size: 0.65rem;
  color: rgba(255,255,255,0.35);
}

[data-theme="light"] .rp-prog-text {
  color: rgba(0,0,0,0.4);
}

/* Est reading time */
.rp-stat-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
}

.rp-stat-label {
  font-size: 0.68rem;
  color: rgba(255,255,255,0.35);
}

[data-theme="light"] .rp-stat-label {
  color: rgba(0,0,0,0.4);
}

.rp-stat-val {
  font-family: var(--font-mono, monospace);
  font-size: 0.68rem;
  color: var(--accent, #4a94f0);
  font-weight: 600;
}

/* Quick jump links */
/* Mark complete toggle */
.rp-complete-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  cursor: pointer;
}

.rp-toggle-switch {
  width: 32px;
  height: 17px;
  background: rgba(255,255,255,0.08);
  border-radius: 999px;
  position: relative;
  transition: background 200ms;
  flex-shrink: 0;
  border: 1px solid rgba(255,255,255,0.1);
}

[data-theme="light"] .rp-toggle-switch {
  background: rgba(0,0,0,0.08);
  border-color: rgba(0,0,0,0.12);
}

.rp-toggle-switch.on {
  background: var(--accent-green, #22a86a);
  border-color: var(--accent-green, #22a86a);
}

.rp-toggle-thumb {
  position: absolute;
  width: 11px;
  height: 11px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: left 200ms;
}

.rp-toggle-switch.on .rp-toggle-thumb {
  left: 17px;
}

.rp-toggle-label {
  font-size: 0.72rem;
  color: rgba(255,255,255,0.45);
}

[data-theme="light"] .rp-toggle-label {
  color: rgba(0,0,0,0.5);
}

/* Notes section */
.rp-notes-area {
  width: 100%;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 8px;
  padding: 8px 10px;
  color: rgba(255,255,255,0.55);
  font-family: var(--font-mono, monospace);
  font-size: 0.7rem;
  line-height: 1.5;
  resize: none;
  height: 90px;
  outline: none;
  transition: border-color 150ms, background 150ms;
}

[data-theme="light"] .rp-notes-area {
  background: rgba(0,0,0,0.03);
  border-color: rgba(0,0,0,0.1);
  color: rgba(0,0,0,0.6);
}

.rp-notes-area::placeholder {
  color: rgba(255,255,255,0.2);
}

[data-theme="light"] .rp-notes-area::placeholder {
  color: rgba(0,0,0,0.25);
}

.rp-notes-area:focus {
  border-color: rgba(74,148,240,0.3);
  background: rgba(74,148,240,0.03);
}

/* Back to top button */
.rp-back-top {
  display: flex;
  align-items: center;
  gap: 6px;
  background: transparent;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 7px;
  padding: 7px 12px;
  color: rgba(255,255,255,0.4);
  cursor: pointer;
  font-size: 0.7rem;
  font-family: var(--font-mono, monospace);
  transition: background 150ms, color 150ms;
  width: 100%;
  justify-content: center;
}

[data-theme="light"] .rp-back-top {
  border-color: rgba(0,0,0,0.1);
  color: rgba(0,0,0,0.45);
}

.rp-back-top:hover {
  background: rgba(74,148,240,0.08);
  color: var(--accent, #4a94f0);
  border-color: rgba(74,148,240,0.2);
}

/* Sidebar toggle button */
.sidebar-toggle-btn {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 6px;
  color: rgba(255,255,255,0.4);
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 0.75rem;
  flex-shrink: 0;
  transition: background 150ms, color 150ms;
}

[data-theme="light"] .sidebar-toggle-btn {
  border-color: rgba(0,0,0,0.1);
  color: rgba(0,0,0,0.45);
}

.sidebar-toggle-btn:hover {
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.7);
}

[data-theme="light"] .sidebar-toggle-btn:hover {
  background: rgba(0,0,0,0.05);
  color: rgba(0,0,0,0.7);
}

/* Override site-header to be hidden - we use our own topbar */
.site-header { display: none !important; }
.xp-bar-wrap { display: none !important; }
/* The original hero stays visible in center panel */

/* Keyboard hint bar inside center */
.kbd-hint {
  font-family: var(--font-mono, monospace);
  font-size: 0.68rem;
  color: rgba(255,255,255,0.2);
  padding: 6px 0;
}

[data-theme="light"] .kbd-hint {
  color: rgba(0,0,0,0.25);
}

/* Make the wapos-xp bar visible in topbar */
.wapos-xp-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
}

.wapos-xp-label {
  font-size: 0.58rem;
  letter-spacing: 0.08em;
  font-family: var(--font-mono, monospace);
  color: rgba(255,255,255,0.25);
  white-space: nowrap;
}

[data-theme="light"] .wapos-xp-label {
  color: rgba(0,0,0,0.3);
}

.wapos-xp-track {
  flex: 1;
  height: 2px;
  background: rgba(255,255,255,0.07);
  border-radius: 1px;
  overflow: hidden;
  max-width: 120px;
}

[data-theme="light"] .wapos-xp-track {
  background: rgba(0,0,0,0.08);
}

.wapos-xp-fill {
  height: 100%;
  background: var(--accent, #4a94f0);
  border-radius: 1px;
  transition: width 500ms cubic-bezier(0.22,1,0.36,1);
  width: 0%;
}

.wapos-xp-pts {
  font-family: var(--font-mono, monospace);
  font-size: 0.6rem;
  color: rgba(255,255,255,0.25);
  white-space: nowrap;
}

[data-theme="light"] .wapos-xp-pts {
  color: rgba(0,0,0,0.3);
}

/* Responsive */
@media (max-width: 1100px) {
  .wapos-right { display: none; }
}

@media (max-width: 768px) {
  .wapos-sidebar { 
    position: absolute;
    left: 0; top: 0; bottom: 0;
    z-index: 50;
    box-shadow: 8px 0 32px rgba(0,0,0,0.5);
  }
  .wapos-sidebar.collapsed {
    transform: translateX(-100%);
    width: 280px;
    opacity: 1;
  }
}

/* Right panel scrollable area */
.right-panel-body {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* ── HEATMAP SUPPRESSED ─── */
.heatmap-wrap, #heatmap-wrap { display: none !important; }

/* ── SCROLL LOCK REINFORCEMENT ─── */
html, body { overflow: hidden !important; max-height: 100vh !important; }
/* ── REMOVED: old overscroll (center now overflow:hidden) ── */
.modal-overlay { overscroll-behavior: contain; }

/* ── STREAK: DATA ONLY ─── */
.streak-fire { display: none !important; }
.streak-pill { pointer-events: none !important; cursor: default !important; }

/* ============================================================
   HERO SEARCH — primary repositioned search bar
   ============================================================ */
.hero-search-wrap {
  width: 100%;
  max-width: 480px !important;
  position: relative;
}

/* Hide duplicate middle TOC navigation — sidebar is the single navigation source */
.toc-section { display: none !important; }

/* ============================================================
   MASTERY STATES — viewed (white) vs mastered (green)
   ============================================================ */
.toc-link.viewed:not(.mastered) .chk {
  background: rgba(255,255,255,0.05) !important;
  border-color: rgba(255,255,255,0.38) !important;
  color: rgba(255,255,255,0.5) !important;
}
.toc-link.viewed:not(.mastered) { color: var(--text-secondary); }
.toc-link.viewed:not(.mastered) .num { color: rgba(210,218,232,0.45) !important; }
.toc-link.mastered .chk {
  background: rgba(40,184,112,0.16) !important;
  border-color: rgba(40,184,112,0.48) !important;
  color: var(--accent-green, #3dd68c) !important;
}
.toc-link.mastered { color: var(--text-secondary); }
.toc-link.mastered .num { color: rgba(40,184,112,0.52) !important; }
.sidebar-topic-link.mastered-item .stl-check { color: var(--accent-green, #3dd68c) !important; }
.sidebar-topic-link.viewed-item:not(.mastered-item) .stl-check { color: rgba(220,225,235,0.45) !important; }

/* ============================================================
   VALIDATION OVERLAY — mastery quiz
   ============================================================ */
#mastery-overlay {
  position: fixed; inset: 0;
  background: rgba(5,7,14,0.87);
  backdrop-filter: blur(7px);
  -webkit-backdrop-filter: blur(7px);
  z-index: 10000;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 200ms cubic-bezier(0.4,0,0.2,1);
}
#mastery-overlay.active { opacity: 1; pointer-events: auto; }
.mastery-dialog {
  background: var(--bg-surface, #13161d);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 14px;
  width: min(520px, calc(100vw - 40px));
  padding: 32px 32px 28px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.7);
  animation: dialogIn 230ms cubic-bezier(0.22,1,0.36,1) forwards;
}
@keyframes dialogIn {
  from { transform: translateY(12px) scale(0.97); opacity:0; }
  to   { transform: none; opacity:1; }
}
.mq-label {
  font-family: var(--font-mono, monospace); font-size: 0.58rem;
  letter-spacing: 0.16em; text-transform: uppercase;
  color: rgba(255,255,255,0.22); margin-bottom: 12px;
}
.mq-topic-ref {
  font-family: var(--font-mono, monospace); font-size: 0.7rem;
  color: rgba(255,255,255,0.28); margin-bottom: 18px; letter-spacing: 0.02em;
}
.mq-question {
  font-size: 1rem; font-weight: 620; color: var(--text-primary, #e8ecf4);
  line-height: 1.58; margin-bottom: 22px; letter-spacing: -0.01em;
}
.mq-choices { display: flex; flex-direction: column; gap: 8px; margin-bottom: 22px; }
.mq-choice {
  background: rgba(255,255,255,0.025); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 8px; padding: 11px 15px; font-size: 0.87rem;
  color: var(--text-secondary, #8b95ab); cursor: pointer; text-align: left;
  transition: border-color 130ms, background 130ms, color 130ms;
  font-family: var(--font-ui, Georgia, serif); line-height: 1.45; width: 100%;
}
.mq-choice:hover:not(:disabled) {
  border-color: rgba(79,158,255,0.28); background: rgba(79,158,255,0.05);
  color: var(--text-primary, #e8ecf4);
}
.mq-choice.selected { border-color: rgba(79,158,255,0.48); background: rgba(79,158,255,0.08); color: var(--text-primary,#e8ecf4); }
.mq-choice.correct  { border-color: rgba(61,214,140,0.52)!important; background: rgba(61,214,140,0.07)!important; color: var(--accent-green,#3dd68c)!important; }
.mq-choice.wrong    { border-color: rgba(255,107,107,0.38)!important; background: rgba(255,107,107,0.05)!important; color: rgba(255,110,110,0.75)!important; }
.mq-choice:disabled { cursor: default; }
.mq-submit {
  width: 100%; background: rgba(79,158,255,0.1); border: 1px solid rgba(79,158,255,0.26);
  color: var(--accent-blue, #4f9eff); border-radius: 8px; padding: 12px;
  font-size: 0.87rem; font-weight: 600; cursor: pointer; letter-spacing: 0.01em;
  transition: background 130ms, border-color 130ms; margin-bottom: 0;
}
.mq-submit:hover:not(:disabled) { background: rgba(79,158,255,0.18); border-color: rgba(79,158,255,0.42); }
.mq-submit:disabled { opacity: 0.38; cursor: default; }
.mq-result {
  margin-top: 16px; padding: 13px 16px; border-radius: 8px;
  font-size: 0.83rem; line-height: 1.55; display: none;
}
.mq-result.show { display: block; }
.mq-result.correct-r { background: rgba(61,214,140,0.06); border: 1px solid rgba(61,214,140,0.18); color: var(--accent-green,#3dd68c); }
.mq-result.wrong-r   { background: rgba(255,107,107,0.05); border: 1px solid rgba(255,107,107,0.16); color: rgba(255,125,125,0.85); }
.mq-quote { margin-top: 9px; font-size: 0.75rem; font-style: italic; opacity: 0.65; font-family: var(--font-mono,monospace); }
.mq-actions { margin-top: 16px; display: flex; gap: 10px; }
.mq-btn-dismiss {
  flex:1; background: transparent; border: 1px solid rgba(255,255,255,0.07);
  color: var(--text-secondary,#8b95ab); border-radius:8px; padding:10px;
  font-size:0.8rem; cursor:pointer; transition:border-color 130ms,color 130ms;
}
.mq-btn-dismiss:hover { border-color:rgba(255,255,255,0.18); color:var(--text-primary,#e8ecf4); }
.mq-btn-retry {
  flex:1; background:transparent; border:1px solid rgba(255,107,107,0.18);
  color:rgba(255,125,125,0.65); border-radius:8px; padding:10px;
  font-size:0.8rem; cursor:pointer; transition:border-color 130ms,color 130ms;
}
.mq-btn-retry:hover { border-color:rgba(255,107,107,0.38); color:rgba(255,140,140,0.9); }

/* XP smooth increment on mastery */
@keyframes xpMasteryNum {
  0%  { color: var(--text-tertiary,rgba(255,255,255,0.25)); transform:scale(1); }
  45% { color: var(--accent-green,#3dd68c); transform:scale(1.11); }
  100%{ color: var(--text-tertiary,rgba(255,255,255,0.25)); transform:scale(1); }
}
@keyframes xpMasteryBar {
  0%  { filter: none; opacity:0.68; }
  50% { filter: brightness(1.45) drop-shadow(0 0 4px rgba(61,214,140,0.35)); opacity:1; }
  100%{ filter: none; opacity:0.68; }
}
.xp-pts.mastery-earn, .wapos-xp-pts.mastery-earn { animation: xpMasteryNum 800ms ease forwards; display:inline-block; }
.xp-fill.mastery-earn, .wapos-xp-fill.mastery-earn { animation: xpMasteryBar 800ms ease forwards; }

/* XP bar glow pulse on earn */
@keyframes xpGlow {
  0%   { box-shadow: 0 0 0 0 rgba(74,148,240,0); }
  40%  { box-shadow: 0 0 0 3px rgba(74,148,240,0.18); }
  100% { box-shadow: 0 0 0 0 rgba(74,148,240,0); }
}

@keyframes xpFillPulse {
  0%   { opacity: 0.68; }
  50%  { opacity: 1; filter: brightness(1.35); }
  100% { opacity: 0.68; filter: brightness(1); }
}

.xp-fill.earned {
  animation: xpFillPulse 600ms ease forwards;
}

.wapos-xp-fill.earned {
  animation: xpFillPulse 600ms ease forwards;
}

.xp-track.earned, .wapos-xp-track.earned {
  animation: xpGlow 600ms ease forwards;
}

/* XP pts number flash */
@keyframes xpNumFlash {
  0%   { color: var(--text-tertiary); }
  40%  { color: var(--accent-amber, #f0a500); transform: scale(1.1); }
  100% { color: var(--text-tertiary); transform: scale(1); }
}

.xp-pts.earned, .wapos-xp-pts.earned {
  animation: xpNumFlash 700ms ease forwards;
  display: inline-block;
}

/* XP level badge bump */
@keyframes levelBump {
  0%   { transform: scale(1); }
  45%  { transform: scale(1.15); box-shadow: 0 0 8px rgba(74,148,240,0.35); }
  100% { transform: scale(1); box-shadow: none; }
}

.xp-level-badge.earned {
  animation: levelBump 500ms ease forwards;
}

/* Mastery ring glow on progress */
@keyframes ringGlow {
  0%   { filter: drop-shadow(0 0 0px rgba(74,148,240,0)); }
  50%  { filter: drop-shadow(0 0 6px rgba(74,148,240,0.5)); }
  100% { filter: drop-shadow(0 0 0px rgba(74,148,240,0)); }
}

.mastery-ring.earned {
  animation: ringGlow 700ms ease forwards;
}

/* ============================================================
   TOPBAR SEARCH — center nav search
   ============================================================ */
.wapos-topbar-center {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: visible !important;
  position: relative;
}
.topbar-search-container {
  position: relative;
  width: min(480px, 100%);
}
.topbar-search-wrap {
  position: relative;
  display: flex;
  align-items: center;
}
.topbar-search-icon {
  position: absolute;
  left: 12px;
  font-size: 0.95rem;
  color: rgba(255,255,255,0.3);
  pointer-events: none;
  z-index: 1;
  font-style: normal;
}
[data-theme="light"] .topbar-search-icon { color: rgba(0,0,0,0.3); }
.topbar-search-input {
  width: 100%;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 8px 48px 8px 34px;
  color: var(--text-primary, #e8ecf4);
  font-family: var(--font-mono, monospace);
  font-size: 0.8rem;
  letter-spacing: 0.02em;
  outline: none;
  transition: border-color 150ms, background 150ms, box-shadow 150ms;
}
[data-theme="light"] .topbar-search-input {
  background: rgba(0,0,0,0.05);
  border-color: rgba(0,0,0,0.12);
  color: var(--text-primary, #111827);
}
.topbar-search-input::placeholder { color: rgba(255,255,255,0.22); }
[data-theme="light"] .topbar-search-input::placeholder { color: rgba(0,0,0,0.3); }
.topbar-search-input:focus {
  border-color: rgba(74,148,240,0.45);
  background: rgba(74,148,240,0.05);
  box-shadow: 0 0 0 3px rgba(74,148,240,0.08);
}
[data-theme="light"] .topbar-search-input:focus {
  background: rgba(37,99,235,0.04);
  border-color: rgba(37,99,235,0.35);
}
.topbar-search-kbd {
  position: absolute;
  right: 10px;
  font-size: 0.58rem;
  font-family: var(--font-mono, monospace);
  color: rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  padding: 2px 6px;
  letter-spacing: 0.04em;
  pointer-events: none;
  transition: opacity 150ms;
}
.topbar-search-input:focus ~ .topbar-search-kbd { opacity: 0; }
[data-theme="light"] .topbar-search-kbd {
  color: rgba(0,0,0,0.3);
  background: rgba(0,0,0,0.05);
  border-color: rgba(0,0,0,0.1);
}

/* ============================================================
   DISCOVERY DROPDOWN
   ============================================================ */
.topbar-discovery {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  right: 0;
  background: var(--bg-surface, #13161d);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  box-shadow: 0 16px 48px rgba(0,0,0,0.6);
  z-index: 9999;
  overflow: hidden;
  display: none;
  max-height: 420px;
  overflow-y: auto;
}
[data-theme="light"] .topbar-discovery {
  background: #fff;
  border-color: rgba(0,0,0,0.1);
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}
.topbar-discovery.open { display: block; }
.td-search-results .search-result-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 14px;
  cursor: pointer;
  font-size: 0.82rem;
  color: var(--text-secondary, #8b95ab);
  transition: background 120ms;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
[data-theme="light"] .td-search-results .search-result-item { border-color: rgba(0,0,0,0.05); color: #4b5563; }
.td-search-results .search-result-item:hover {
  background: rgba(74,148,240,0.07);
  color: var(--text-primary, #e8ecf4);
}
.td-label {
  padding: 10px 14px 6px;
  font-size: 0.56rem;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.22);
  font-family: var(--font-mono, monospace);
  font-weight: 600;
}
[data-theme="light"] .td-label { color: rgba(0,0,0,0.35); }
.td-section-btn {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 14px;
  background: transparent;
  border: none;
  cursor: pointer;
  text-align: left;
  transition: background 120ms;
  border-radius: 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.td-section-btn:hover { background: rgba(74,148,240,0.06); }
[data-theme="light"] .td-section-btn:hover { background: rgba(37,99,235,0.05); }
.td-section-btn.active { background: rgba(74,148,240,0.08); }
.td-s-num {
  font-family: var(--font-mono, monospace);
  font-size: 0.6rem;
  color: rgba(255,255,255,0.28);
  letter-spacing: 0.06em;
  min-width: 22px;
}
[data-theme="light"] .td-s-num { color: rgba(0,0,0,0.35); }
.td-s-name {
  flex: 1;
  font-size: 0.82rem;
  color: var(--text-secondary, #8b95ab);
  font-family: var(--font-mono, monospace);
  letter-spacing: 0.01em;
}
[data-theme="light"] .td-s-name { color: #374151; }
.td-section-btn:hover .td-s-name { color: var(--text-primary, #e8ecf4); }
[data-theme="light"] .td-section-btn:hover .td-s-name { color: #111827; }
.td-s-count {
  font-size: 0.6rem;
  font-family: var(--font-mono, monospace);
  color: rgba(255,255,255,0.18);
  letter-spacing: 0.04em;
}
[data-theme="light"] .td-s-count { color: rgba(0,0,0,0.3); }
.td-topics-panel {
  border-top: 1px solid rgba(255,255,255,0.06);
  padding: 4px 0;
}
[data-theme="light"] .td-topics-panel { border-color: rgba(0,0,0,0.07); }
.td-section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px 6px;
}
.td-back-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  color: red;
  font-size: 0.75rem;
  padding: 2px 6px;
  border-radius: 4px;
  transition: color 120ms;
}
.td-back-btn:hover { color: var(--text-primary, #e8ecf4); }
[data-theme="light"] .td-back-btn { color: rgba(0,0,0,0.4); }
.td-section-title-sm {
  font-size: 0.7rem;
  font-family: var(--font-mono, monospace);
  color: rgba(255,255,255,0.4);
  letter-spacing: 0.04em;
}
[data-theme="light"] .td-section-title-sm { color: rgba(0,0,0,0.5); }
.td-topic-btn {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 14px;
  background: transparent;
  border: none;
  cursor: pointer;
  text-align: left;
  transition: background 110ms;
  border-bottom: 1px solid rgba(255,255,255,0.02);
}
.td-topic-btn:hover { background: rgba(74,148,240,0.07); }
[data-theme="light"] .td-topic-btn:hover { background: rgba(37,99,235,0.05); }
.td-t-num {
  font-family: var(--font-mono, monospace);
  font-size: 0.6rem;
  color: rgba(255,255,255,0.25);
  letter-spacing: 0.04em;
  min-width: 22px;
}
[data-theme="light"] .td-t-num { color: rgba(0,0,0,0.35); }
.td-t-name {
  flex: 1;
  font-size: 0.8rem;
  color: var(--text-secondary, #8b95ab);
  font-family: var(--font-mono, monospace);
}
.td-topic-btn:hover .td-t-name { color: var(--text-primary, #e8ecf4); }
[data-theme="light"] .td-t-name { color: #374151; }
[data-theme="light"] .td-topic-btn:hover .td-t-name { color: #111827; }
.td-t-state {
  font-size: 0.58rem;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: var(--font-mono, monospace);
  letter-spacing: 0.04em;
}
.td-t-state.mastered { background: rgba(61,214,140,0.1); color: var(--accent-green, #3dd68c); }
.td-t-state.viewed { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.35); }
[data-theme="light"] .td-t-state.viewed { color: rgba(0,0,0,0.35); background: rgba(0,0,0,0.05); }

/* ============================================================
   IMPORTANT TOPICS SIDEBAR
   ============================================================ */
.sidebar-nav { padding: 6px 0 !important; }
.imp-empty-state {
  padding: 32px 20px;
  text-align: center;
}
.imp-empty-icon {
  font-size: 1.4rem;
  opacity: 0.22;
  margin-bottom: 10px;
}
.imp-empty-text {
  font-size: 0.75rem;
  color: rgba(255,255,255,0.3);
  font-family: var(--font-mono, monospace);
  margin-bottom: 6px;
  letter-spacing: 0.02em;
}
.imp-empty-sub {
  font-size: 0.66rem;
  color: rgba(255,255,255,0.16);
  font-family: var(--font-mono, monospace);
  line-height: 1.5;
  letter-spacing: 0.01em;
}
[data-theme="light"] .imp-empty-text { color: rgba(0,0,0,0.4); }
[data-theme="light"] .imp-empty-sub { color: rgba(0,0,0,0.25); }
.imp-topic-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  transition: background 110ms;
  user-select: none;
}
.imp-topic-item:hover { background: rgba(74,148,240,0.06); }
[data-theme="light"] .imp-topic-item:hover { background: rgba(37,99,235,0.05); }
.imp-t-star {
  color: rgba(240,165,0,0.75);
  font-size: 0.75rem;
  flex-shrink: 0;
  opacity: 0.8;
}
.imp-t-num {
  font-family: var(--font-mono, monospace);
  font-size: 0.6rem;
  color: rgba(255,255,255,0.25);
  letter-spacing: 0.04em;
  flex-shrink: 0;
}
[data-theme="light"] .imp-t-num { color: rgba(0,0,0,0.35); }
.imp-t-name {
  flex: 1;
  font-size: 0.76rem;
  color: var(--text-secondary, #8b95ab);
  font-family: var(--font-mono, monospace);
  letter-spacing: 0.01em;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
[data-theme="light"] .imp-t-name { color: #374151; }
.imp-topic-item:hover .imp-t-name { color: var(--text-primary, #e8ecf4); }
[data-theme="light"] .imp-topic-item:hover .imp-t-name { color: #111827; }
.imp-t-remove {
  background: transparent;
  border: none;
  cursor: pointer;
  color: rgba(255,255,255,0.18);
  font-size: 0.7rem;
  padding: 2px 4px;
  border-radius: 4px;
  transition: color 110ms;
  flex-shrink: 0;
}
.imp-t-remove:hover { color: rgba(255,107,107,0.7); }
/* Star button in modal header */
/* === NEW ADDITION START === */
@keyframes _star-pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(240,165,0,0); }
  50%       { box-shadow: 0 0 8px 2px rgba(240,165,0,0.22); }
}
/* === NEW ADDITION END === */
.modal-star-btn {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 6px;
  /* === NEW ADDITION START === */
  padding: 6px 12px;
  font-size: 0.9rem;
  /* === NEW ADDITION END === */
  cursor: pointer;
  color: rgba(255,255,255,0.35);
  transition: all 140ms;
  display: flex;
  align-items: center;
  gap: 5px;
  letter-spacing: 0.02em;
  font-family: var(--font-mono, monospace);
}
/* === NEW ADDITION START === */
.modal-star-btn:hover { border-color: rgba(240,165,0,0.35); color: rgba(240,165,0,0.8); transform: scale(1.07); }
.modal-star-btn.starred {
  border-color: rgba(240,165,0,0.5);
  color: rgba(240,165,0,0.95);
  background: rgba(240,165,0,0.08);
  box-shadow: 0 0 10px 1px rgba(240,165,0,0.18);
  animation: _star-pulse 2.4s ease-in-out infinite;
}
/* === NEW ADDITION END === */
[data-theme="light"] .modal-star-btn { color: rgba(0,0,0,0.4); border-color: rgba(0,0,0,0.1); }
[data-theme="light"] .modal-star-btn.starred { color: #d97706; border-color: rgba(217,119,6,0.4); }

/* ============================================================
   SIDEBAR PROGRESS LABEL UPDATE
   ============================================================ */
#sb-prog-label { font-size: 0.72rem; }

/* ============================================================
   FAB / TICKER REMOVED — hide any residual
   ============================================================ */
.fab, .insight-ticker { display: none !important; }

/* ============================================================
   SMOOTH DISCOVERY DROPDOWN ANIMATIONS
   ============================================================ */
.topbar-discovery {
  opacity: 0;
  transform: translateY(-6px);
  transition: opacity 200ms cubic-bezier(0.4,0,0.2,1),
              transform 200ms cubic-bezier(0.4,0,0.2,1),
              display 0s 200ms;
  pointer-events: none;
}
.topbar-discovery.open {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
  display: block;
  transition: opacity 200ms cubic-bezier(0.4,0,0.2,1),
              transform 200ms cubic-bezier(0.4,0,0.2,1);
}

/* Section → Topics panel: smooth reveal */
.td-topics-panel {
  animation: tdPanelIn 200ms cubic-bezier(0.4,0,0.2,1) forwards;
}
@keyframes tdPanelIn {
  from { opacity: 0; transform: translateY(-4px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Search result items: staggered reveal feel */
.search-result-item, .td-topic-btn, .td-section-btn {
  transition: background 140ms cubic-bezier(0.4,0,0.2,1),
              color 140ms cubic-bezier(0.4,0,0.2,1);
}

/* Section list fade when replaced by topics */
.td-section-list {
  transition: opacity 180ms cubic-bezier(0.4,0,0.2,1);
}

/* ============================================================
   NAV LOCK VISUAL CUE
   ============================================================ */
.nav-locked-hint {
  font-size: 0.7rem;
  color: rgba(255,165,0,0.65);
  font-family: var(--font-mono, monospace);
  text-align: center;
  padding: 6px 12px;
  letter-spacing: 0.02em;
  animation: lockHintPulse 1.8s ease-in-out infinite;
}
@keyframes lockHintPulse {
  0%, 100% { opacity: 0.65; }
  50%       { opacity: 1; }
}

/* ============================================================
   MODAL OVERLAY — smooth open animation
   ============================================================ */
.modal-overlay {
  transition: opacity 200ms cubic-bezier(0.4,0,0.2,1);
}
.modal-overlay.active {
  animation: modalOverlayIn 220ms cubic-bezier(0.4,0,0.2,1) forwards;
}
@keyframes modalOverlayIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}
.modal-box {
  animation: modalBoxIn 240ms cubic-bezier(0.22,1,0.36,1) forwards;
}
@keyframes modalBoxIn {
  from { transform: scale(0.97) translateY(8px); opacity: 0; }
  to   { transform: scale(1) translateY(0); opacity: 1; }
}
/* ============================================================
   VALIDATION LOCK — shake animation and focus ring
   ============================================================ */
@keyframes vlShake {
  0%   { transform: translateX(0); }
  15%  { transform: translateX(-4px); }
  30%  { transform: translateX(4px); }
  45%  { transform: translateX(-3px); }
  60%  { transform: translateX(3px); }
  75%  { transform: translateX(-2px); }
  90%  { transform: translateX(2px); }
  100% { transform: translateX(0); }
}
.vl-shake {
  animation: vlShake 320ms cubic-bezier(0.36,0.07,0.19,0.97) both !important;
}
/* Pulse border when locked and overlay reopens */
@keyframes vlLockPulse {
  0%,100% { border-color: rgba(255,107,107,0.25); }
  50%     { border-color: rgba(255,107,107,0.55); box-shadow: 0 0 0 4px rgba(255,107,107,0.07); }
}
.mastery-dialog.lock-active {
  animation: vlLockPulse 900ms ease-in-out 1;
}


/* ============================================================
   V2 UPGRADE: CREATIVE HIGH-ENERGY ANIMATIONS & VALIDATION
   ============================================================ */

/* --- Validation Modal bounce entrance --- */
@keyframes masteryDialogIn {
  0%   { transform: translateY(24px) scale(0.94); opacity:0; }
  60%  { transform: translateY(-4px) scale(1.02); opacity:1; }
  80%  { transform: translateY(2px) scale(0.99); }
  100% { transform: translateY(0) scale(1); opacity:1; }
}
.mastery-dialog {
  animation: masteryDialogIn 280ms cubic-bezier(.34,1.56,.64,1) forwards !important;
}

/* --- Correct answer: scale pop + glow --- */
@keyframes correctPop {
  0%   { transform: scale(1); box-shadow: none; }
  40%  { transform: scale(1.06); box-shadow: 0 0 0 6px rgba(61,214,140,0.22), 0 0 20px rgba(61,214,140,0.18); }
  70%  { transform: scale(0.98); }
  100% { transform: scale(1); box-shadow: none; }
}
.mq-result.correct-r {
  animation: correctPop 480ms cubic-bezier(.34,1.56,.64,1) forwards;
}

/* Particle dots on correct answer */
@keyframes particleFade {
  0%   { opacity:0.9; transform: translateY(0) scale(1); }
  100% { opacity:0; transform: translateY(-28px) scale(0.4); }
}
.mq-particle {
  position: absolute;
  width: 5px; height: 5px;
  border-radius: 50%;
  pointer-events: none;
  animation: particleFade 620ms ease forwards;
  z-index: 99999;
}

/* --- Wrong answer: elastic shake with red pulse --- */
@keyframes wrongShake {
  0%   { transform: translateX(0); border-color: rgba(255,107,107,0.38); }
  12%  { transform: translateX(-6px); border-color: rgba(255,107,107,0.75); box-shadow: 0 0 0 3px rgba(255,107,107,0.15); }
  25%  { transform: translateX(6px); }
  37%  { transform: translateX(-4px); }
  50%  { transform: translateX(4px); }
  63%  { transform: translateX(-2px); }
  75%  { transform: translateX(2px); }
  87%  { transform: translateX(-1px); }
  100% { transform: translateX(0); border-color: rgba(255,107,107,0.38); box-shadow: none; }
}
.mq-choice.wrong-shake {
  animation: wrongShake 420ms cubic-bezier(.36,.07,.19,.97) both !important;
}

/* Wrong answer: mq-result pulse border */
@keyframes wrongResultPulse {
  0%,100% { border-color: rgba(255,107,107,0.16); }
  40%      { border-color: rgba(255,107,107,0.55); box-shadow: 0 0 0 4px rgba(255,107,107,0.09); }
}
.mq-result.wrong-r.show {
  animation: wrongResultPulse 700ms ease forwards;
}

/* --- Blocked navigation: mini sidebar shake --- */
@keyframes navBlockShake {
  0%   { transform: translateX(0); }
  20%  { transform: translateX(-4px); }
  40%  { transform: translateX(4px); }
  60%  { transform: translateX(-3px); }
  80%  { transform: translateX(2px); }
  100% { transform: translateX(0); }
}
.nav-block-shake {
  animation: navBlockShake 300ms cubic-bezier(.36,.07,.19,.97) both !important;
}

/* --- Search dropdown: staggered cascade --- */
@keyframes dropItemIn {
  from { opacity: 0; transform: translateY(-5px); }
  to   { opacity: 1; transform: translateY(0); }
}
.td-section-btn, .td-topic-btn, .search-result-item {
  animation: dropItemIn 180ms ease forwards;
  opacity: 0;
}
.td-section-btn:nth-child(1) { animation-delay: 20ms; }
.td-section-btn:nth-child(2) { animation-delay: 50ms; }
.td-section-btn:nth-child(3) { animation-delay: 80ms; }
.td-section-btn:nth-child(4) { animation-delay: 110ms; }
.td-section-btn:nth-child(5) { animation-delay: 140ms; }

/* Topic buttons staggered */
.td-topic-btn:nth-child(1) { animation-delay: 10ms; }
.td-topic-btn:nth-child(2) { animation-delay: 30ms; }
.td-topic-btn:nth-child(3) { animation-delay: 50ms; }
.td-topic-btn:nth-child(4) { animation-delay: 70ms; }
.td-topic-btn:nth-child(5) { animation-delay: 90ms; }
.td-topic-btn:nth-child(6) { animation-delay: 110ms; }
.td-topic-btn:nth-child(7) { animation-delay: 130ms; }
.td-topic-btn:nth-child(8) { animation-delay: 150ms; }
.td-topic-btn:nth-child(9) { animation-delay: 170ms; }
.td-topic-btn:nth-child(10) { animation-delay: 190ms; }
.td-topic-btn:nth-child(11) { animation-delay: 210ms; }
.td-topic-btn:nth-child(12) { animation-delay: 230ms; }
.td-topic-btn:nth-child(13) { animation-delay: 250ms; }

/* --- Topic opening: content slide-up bounce --- */
@keyframes modalContentIn {
  0%   { opacity:0; transform: translateY(14px) scale(0.98); }
  55%  { opacity:1; transform: translateY(-3px) scale(1.005); }
  80%  { transform: translateY(1px); }
  100% { opacity:1; transform: translateY(0) scale(1); }
}
.modal-body-anim {
  animation: modalContentIn 260ms cubic-bezier(.34,1.56,.64,1) forwards;
}

/* --- Star toggle animation --- */
@keyframes starPop {
  0%   { transform: scale(1) rotate(0deg); }
  30%  { transform: scale(1.35) rotate(12deg); }
  55%  { transform: scale(0.9) rotate(-4deg); }
  75%  { transform: scale(1.12) rotate(2deg); }
  100% { transform: scale(1) rotate(0deg); }
}
@keyframes starGlow {
  0%   { box-shadow: none; }
  40%  { box-shadow: 0 0 0 5px rgba(240,165,0,0.22), 0 0 14px rgba(240,165,0,0.14); }
  100% { box-shadow: none; }
}
.modal-star-btn.star-anim {
  animation: starPop 400ms cubic-bezier(.34,1.56,.64,1) forwards,
             starGlow 500ms ease forwards;
}

/* XP pop bounce */
@keyframes xpPopBounce {
  0%   { transform: translateY(0) scale(0.8); opacity:0; }
  35%  { transform: translateY(-18px) scale(1.15); opacity:1; }
  65%  { transform: translateY(-22px) scale(0.96); opacity:1; }
  100% { transform: translateY(-30px) scale(1); opacity:0; }
}
.xp-pop {
  animation: xpPopBounce 1100ms cubic-bezier(.34,1.56,.64,1) forwards !important;
}

/* Mastery ring: earn glow bounce */
@keyframes ringEarnPulse {
  0%   { filter: drop-shadow(0 0 0px rgba(61,214,140,0)); }
  35%  { filter: drop-shadow(0 0 10px rgba(61,214,140,0.7)); }
  65%  { filter: drop-shadow(0 0 5px rgba(61,214,140,0.35)); }
  100% { filter: drop-shadow(0 0 0px rgba(61,214,140,0)); }
}

/* Close btn disabled state visual */
#modal-close-btn.locked {
  opacity: 0.3 !important;
  cursor: not-allowed !important;
  pointer-events: none;
}
/* But still intercept click via JS */

/* Lock indicator badge above mastery dialog */
.mq-lock-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: rgba(255,165,0,0.08);
  border: 1px solid rgba(255,165,0,0.22);
  border-radius: 5px;
  padding: 4px 9px;
  font-size: 0.62rem;
  font-family: var(--font-mono, monospace);
  letter-spacing: 0.06em;
  color: rgba(255,165,0,0.75);
  margin-bottom: 14px;
  animation: lockHintPulse 2s ease-in-out infinite;
}

/* Multi-question: question counter */
.mq-q-counter {
  font-family: var(--font-mono, monospace);
  font-size: 0.58rem;
  color: rgba(255,255,255,0.18);
  letter-spacing: 0.08em;
  margin-bottom: 8px;
}

/* Submit btn: success state */
.mq-submit.success-state {
  background: rgba(61,214,140,0.12) !important;
  border-color: rgba(61,214,140,0.4) !important;
  color: var(--accent-green, #3dd68c) !important;
}

/* TOC link: next-up highlight */
.toc-link.next-up {
  box-shadow: inset 2px 0 0 rgba(79,158,255,0.6);
}

/* Modal body: prevent reflow flash */
#modal-body { will-change: transform, opacity; }

/* Smooth mastery overlay appear */
#mastery-overlay {
  transition: opacity 180ms cubic-bezier(0.4,0,0.2,1) !important;
}

/* Section button: active state with accent glow */
.td-section-btn.active {
  background: rgba(74,148,240,0.1) !important;
  border-color: rgba(74,148,240,0.3) !important;
  color: var(--accent-blue, #4f9eff) !important;
}

/* Sidebar IMP topic: hover + open animation */
@keyframes impItemIn {
  from { opacity:0; transform: translateX(-8px); }
  to   { opacity:1; transform: translateX(0); }
}
.imp-topic-item {
  animation: impItemIn 200ms ease forwards;
}

/* Wrong answer: shake mq-submit too */
@keyframes submitShake {
  0%,100% { transform: translateX(0); }
  20% { transform: translateX(-3px); }
  40% { transform: translateX(3px); }
  60% { transform: translateX(-2px); }
  80% { transform: translateX(2px); }
}
.mq-submit.wrong-shake {
  animation: submitShake 350ms ease !important;
}

/* ================================================================
   JS COMPILER — SIDEBAR PREVIEW CARD
   ================================================================ */
.rp-compiler-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 14px 14px;
}

.rp-compiler-card {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 18px 16px 14px;
  background: var(--bg-card, #1a1e28);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: var(--r-md, 10px);
  cursor: pointer;
  transition: transform 200ms cubic-bezier(0.22,1,0.36,1),
              box-shadow 200ms cubic-bezier(0.22,1,0.36,1),
              border-color 200ms cubic-bezier(0.22,1,0.36,1);
  outline: none;
  flex: 1;
}
.rp-compiler-card:hover,
.rp-compiler-card:focus-visible {
  transform: translateY(-2px);
  box-shadow: 0 8px 28px rgba(0,0,0,0.45);
  border-color: rgba(255,255,255,0.1);
}
[data-theme="light"] .rp-compiler-card {
  background: #f5f6fa;
  border-color: rgba(0,0,0,0.07);
}
[data-theme="light"] .rp-compiler-card:hover,
[data-theme="light"] .rp-compiler-card:focus-visible {
  box-shadow: 0 8px 28px rgba(0,0,0,0.1);
  border-color: rgba(0,0,0,0.12);
}

.rp-compiler-label {
  font-family: var(--font-mono, monospace);
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.28);
  font-weight: 600;
}
[data-theme="light"] .rp-compiler-label { color: rgba(0,0,0,0.32); }

.rp-compiler-preview {
  background: #000000;
  border-radius: 6px;
  padding: 13px 14px;
  font-family: var(--font-mono, 'Courier New', monospace);
  font-size: 0.72rem;
  line-height: 1.6;
  white-space: nowrap;
  overflow: hidden;
  flex: 1;
  display: flex;
  align-items: center;
  min-height: 52px;
}
[data-theme="light"] .rp-compiler-preview { background: #0d0f14; }

/* Syntax tokens */
.rpc-obj   { color: #cdd6f4; }
.rpc-dot   { color: rgba(205,214,244,0.35); }
.rpc-fn    { color: #89b4fa; }
.rpc-paren { color: rgba(205,214,244,0.45); }
.rpc-str   { color: #a6e3a1; }
.rpc-semi  { color: rgba(205,214,244,0.25); }

.rp-compiler-hint {
  font-family: var(--font-mono, monospace);
  font-size: 0.6rem;
  color: rgba(255,255,255,0.18);
  letter-spacing: 0.04em;
  text-align: right;
  align-self: flex-end;
}
[data-theme="light"] .rp-compiler-hint { color: rgba(0,0,0,0.22); }

/* ================================================================
   JS COMPILER — FULLSCREEN OVERLAY
   ================================================================ */
#jsc-overlay {
  position: fixed;
  inset: 0;
  z-index: 8500;
  background: #0b0d12;
  display: none;
  flex-direction: column;
  opacity: 0;
  transform: translateY(12px);
  transition: opacity 220ms cubic-bezier(0.22,1,0.36,1),
              transform 220ms cubic-bezier(0.22,1,0.36,1);
}
#jsc-overlay.jsc-visible {
  opacity: 1;
  transform: translateY(0);
}

.jsc-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  height: 48px;
  background: #0d0f14;
  border-bottom: 1px solid rgba(255,255,255,0.055);
  flex-shrink: 0;
  gap: 12px;
}
.jsc-bar-left {
  display: flex;
  align-items: center;
  gap: 14px;
}
.jsc-bar-title {
  font-family: var(--font-mono, monospace);
  font-size: 0.7rem;
  letter-spacing: 0.06em;
  color: rgba(255,255,255,0.3);
}
.jsc-btn-close {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.38);
  border-radius: 6px;
  padding: 5px 12px;
  font-size: 0.68rem;
  font-family: var(--font-mono, monospace);
  cursor: pointer;
  letter-spacing: 0.02em;
  line-height: 1;
  transition: background 140ms ease, border-color 140ms ease, color 140ms ease;
}
.jsc-btn-close:hover {
  background: rgba(255,107,107,0.08);
  border-color: rgba(255,107,107,0.22);
  color: var(--accent-red, #ff6b6b);
}
.jsc-bar-right {
  display: flex;
  align-items: center;
  gap: 8px;
}
.jsc-btn-clear {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.07);
  color: rgba(255,255,255,0.28);
  border-radius: 6px;
  padding: 5px 12px;
  font-size: 0.68rem;
  font-family: var(--font-mono, monospace);
  cursor: pointer;
  letter-spacing: 0.02em;
  line-height: 1;
  transition: background 140ms ease, color 140ms ease;
}
.jsc-btn-clear:hover {
  background: rgba(255,255,255,0.05);
  color: rgba(255,255,255,0.5);
}
.jsc-btn-run {
  background: var(--accent-blue, #4f9eff);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 16px;
  font-size: 0.72rem;
  font-family: var(--font-mono, monospace);
  font-weight: 600;
  cursor: pointer;
  letter-spacing: 0.04em;
  line-height: 1;
  transition: opacity 140ms ease, transform 100ms ease;
}
.jsc-btn-run:hover  { opacity: 0.86; }
.jsc-btn-run:active { transform: scale(0.97); }

.jsc-workspace {
  display: flex;
  flex: 1;
  overflow: hidden;
  min-height: 0;
}
.jsc-editor-pane {
  flex: 0 0 65%;
  display: flex;
  flex-direction: column;
  border-right: 1px solid rgba(255,255,255,0.05);
  min-width: 0;
}
.jsc-output-pane {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #000000;
  min-width: 0;
}
.jsc-pane-label {
  padding: 6px 18px;
  font-family: var(--font-mono, monospace);
  font-size: 0.57rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.18);
  background: #0d0f14;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  flex-shrink: 0;
}
.jsc-output-pane .jsc-pane-label {
  background: #050507;
}
/* MODIFIED: #jsc-editor is now a Monaco container div */
#jsc-editor {
  flex: 1;
  min-height: 0;
  overflow: hidden;
  background: #000000;
}
#jsc-output {
  flex: 1;
  overflow-y: auto;
  padding: 18px 20px;
  font-family: var(--font-mono, 'Courier New', monospace);
  font-size: 0.83rem;
  line-height: 1.7;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.jsc-line { display: block; word-break: break-all; white-space: pre-wrap; }
.jsc-line-log   { color: #cdd6f4; }
.jsc-line-warn  { color: #f0a500; }
.jsc-line-error { color: #ff6b6b; }
.jsc-line-empty { color: rgba(255,255,255,0.14); font-style: italic; font-size: 0.78rem; }
.jsc-separator  { height: 1px; background: rgba(255,255,255,0.05); margin: 5px 0; flex-shrink: 0; }

@media (max-width: 720px) {
  .jsc-workspace { flex-direction: column; }
  .jsc-editor-pane { flex: 0 0 52%; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.05); }
}

/* ── Command Palette (Cmd+Shift+P) ──────────────────────────── */
#wap-palette-overlay {
  position: fixed; inset: 0; z-index: 9800;
  background: rgba(5,7,12,0.82);
  backdrop-filter: blur(6px);
  display: none; align-items: flex-start; justify-content: center;
  padding-top: 14vh;
}
#wap-palette-overlay.wap-palette-open { display: flex; }
#wap-palette {
  width: min(580px, 92vw);
  background: #13161d;
  border: 1px solid #252a38;
  border-radius: 10px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.85);
  overflow: hidden;
  display: flex; flex-direction: column;
  animation: paletteDrop 160ms cubic-bezier(0.22,1,0.36,1);
}
@keyframes paletteDrop {
  from { opacity:0; transform:translateY(-10px) scale(0.98); }
  to   { opacity:1; transform:translateY(0)     scale(1); }
}
#wap-palette-input {
  width: 100%; border: none; outline: none;
  background: transparent;
  color: #e8ecf4; font-family: var(--font-mono, monospace);
  font-size: 0.9rem; padding: 16px 20px;
  border-bottom: 1px solid #252a38;
  caret-color: #4f9eff;
}
#wap-palette-list {
  list-style: none; margin: 0; padding: 6px 0;
  max-height: 320px; overflow-y: auto;
}
.wap-palette-item {
  display: flex; align-items: center; gap: 14px;
  padding: 9px 20px; cursor: pointer;
  font-family: var(--font-mono, monospace); font-size: 0.78rem;
  color: #8b95ab;
  transition: background 80ms ease;
}
.wap-palette-item:hover,
.wap-palette-item.wap-palette-active {
  background: #1e2535; color: #e8ecf4;
}
.wap-palette-item-icon { font-size: 0.85rem; flex-shrink: 0; width: 18px; text-align:center; }
.wap-palette-item-label { flex: 1; }
.wap-palette-item-kbd {
  font-size: 0.65rem; color: #515d76;
  background: #0d0f14; border: 1px solid #252a38;
  border-radius: 4px; padding: 2px 7px;
}
#wap-palette-empty {
  padding: 18px 20px; color: #515d76;
  font-family: var(--font-mono, monospace); font-size: 0.78rem;
}

/* ── Runtime status badge ─────────────────────────────────── */
.wap-runtime-badge {
  display: inline-flex; align-items: center; gap: 6px;
  font-family: var(--font-mono, monospace); font-size: 0.62rem;
  letter-spacing: 0.04em; padding: 3px 10px;
  border-radius: 4px; opacity: 0;
  transition: opacity 200ms ease;
}
.wap-runtime-badge.visible { opacity: 1; }
.wap-runtime-badge.success { background:#0d1f12; color:#3dd68c; border:1px solid #1d4a2a; }
.wap-runtime-badge.error   { background:#1f0d0d; color:#ff6b6b; border:1px solid #4a1d1d; }
.wap-runtime-badge.running { background:#0d1525; color:#4f9eff; border:1px solid #1d3455; }

/* ── Runtime status row (timer + state) in output pane ──── */
.wap-runtime-status {
  display: flex; align-items: center; gap: 10px;
  padding: 7px 18px 6px;
  font-family: var(--font-mono, monospace); font-size: 0.68rem;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  flex-shrink: 0; background: #050507;
}
.wap-rs-dot {
  width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
  transition: background 200ms ease;
}
.wap-rs-dot.idle    { background: #2a3148; }
.wap-rs-dot.running { background: #4f9eff; animation: wapPulse 900ms infinite; }
.wap-rs-dot.success { background: #3dd68c; }
.wap-rs-dot.error   { background: #ff6b6b; }
@keyframes wapPulse {
  0%,100% { opacity:1; } 50% { opacity:0.3; }
}
.wap-rs-label {
  color: #515d76; flex: 1; letter-spacing: 0.04em;
  transition: color 200ms ease;
}
.wap-rs-label.running { color: #4f9eff; }
.wap-rs-label.success { color: #3dd68c; }
.wap-rs-label.error   { color: #ff6b6b; }
.wap-rs-time {
  color: #2a3148; font-size: 0.63rem; letter-spacing: 0.02em;
  transition: color 200ms ease; min-width: 44px; text-align: right;
}
.wap-rs-time.active { color: #8b95ab; }

/* ── Error block in output ───────────────────────────────── */
.jsc-error-block {
  display: flex; flex-direction: column; gap: 2px;
  background: rgba(255,107,107,0.06);
  border: 1px solid rgba(255,107,107,0.18);
  border-left: 3px solid #ff6b6b;
  border-radius: 6px; padding: 10px 14px;
  margin: 4px 0;
}
.jsc-error-block .err-type {
  color: #ff6b6b; font-size: 0.72rem; font-weight: 600;
  letter-spacing: 0.02em; font-family: var(--font-mono, monospace);
}
.jsc-error-block .err-msg {
  color: #e8c8c8; font-size: 0.8rem;
  font-family: var(--font-mono, monospace); word-break: break-all;
}
.jsc-error-block .err-line {
  color: #515d76; font-size: 0.67rem; margin-top: 2px;
  font-family: var(--font-mono, monospace);
}

/* ── Fetch API teaching section ──────────────────────────── */
.fetch-section {
  margin-top: var(--sp-8);
  border: 1px solid #252a38;
  border-radius: var(--r-lg);
  overflow: hidden;
}
.fetch-section-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px;
  background: #13161d;
  cursor: pointer; user-select: none;
  border-bottom: 1px solid transparent;
  transition: background 140ms ease, border-color 140ms ease;
}
.fetch-section-header:hover { background: #1a1e28; }
.fetch-section-header.open  { border-bottom-color: #252a38; }
.fetch-section-title {
  font-family: var(--font-mono, monospace);
  font-size: 0.78rem; font-weight: 600;
  color: #e8ecf4; display: flex; align-items: center; gap: 10px;
  letter-spacing: 0.02em;
}
.fetch-section-title .fetch-badge {
  background: #1e2535; color: #4f9eff;
  border: 1px solid #252a38; border-radius: 4px;
  padding: 1px 7px; font-size: 0.62rem; letter-spacing: 0.05em;
}
.fetch-chevron {
  color: #515d76; font-size: 0.72rem;
  transition: transform 200ms ease;
}
.fetch-chevron.open { transform: rotate(180deg); }
.fetch-body {
  display: none; padding: 0;
  background: #0d0f14;
}
.fetch-body.open { display: block; }
.fetch-lang-tabs {
  display: flex; border-bottom: 1px solid #252a38;
}
.fetch-tab {
  padding: 8px 18px; font-size: 0.72rem; cursor: pointer;
  font-family: var(--font-mono, monospace);
  color: #515d76; border-bottom: 2px solid transparent;
  transition: color 140ms, border-color 140ms;
  user-select: none;
}
.fetch-tab.active { color: #4f9eff; border-bottom-color: #4f9eff; }
.fetch-tab-content { display: none; padding: 18px 20px; }
.fetch-tab-content.active { display: block; }
.fetch-tab-content pre {
  background: #0b0d12; border: 1px solid #1a1e28;
  border-radius: 8px; padding: 16px 18px;
  font-family: var(--font-mono, monospace); font-size: 0.77rem;
  line-height: 1.7; overflow-x: auto; margin: 0 0 14px;
  color: #cdd6f4;
}
.fetch-tab-content .fetch-note {
  background: #0d1829; border: 1px solid #1d3455;
  border-left: 3px solid #4f9eff;
  border-radius: 6px; padding: 12px 16px;
  font-size: 0.78rem; color: #8b95ab; line-height: 1.6;
  margin-top: 14px;
}
.fetch-runnable {
  padding: 18px 20px; border-top: 1px solid #252a38;
  background: #0b0d12;
}
.fetch-runnable-label {
  font-family: var(--font-mono, monospace);
  font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase;
  color: #515d76; margin-bottom: 10px;
}
.fetch-runnable pre {
  background: #000; border: 1px solid #1a1e28; border-radius: 8px;
  padding: 14px 18px; font-family: var(--font-mono, monospace);
  font-size: 0.77rem; line-height: 1.7; overflow-x: auto;
  color: #cdd6f4; margin: 0 0 12px;
}
.fetch-try-btn {
  display: inline-flex; align-items: center; gap: 7px;
  background: #4f9eff; color: #fff; border: none;
  border-radius: 6px; padding: 7px 16px; cursor: pointer;
  font-family: var(--font-mono, monospace); font-size: 0.72rem;
  font-weight: 600; letter-spacing: 0.04em;
  transition: opacity 140ms, transform 100ms;
}
.fetch-try-btn:hover  { opacity: 0.86; }
.fetch-try-btn:active { transform: scale(0.97); }

/* ── Monaco hint decoration ───────────────────────────────── */
.wap-hint-line { background: rgba(240,165,0,0.04); }
.wap-error-line { background: rgba(255,107,107,0.06);
  border-left: 2px solid #ff6b6b; }
.wap-info-line  { background: rgba(79,158,255,0.04);
  border-left: 2px solid #4f9eff44; }

/* ── Topic Search overlay (Cmd+K) ────────────────────────── */
#wap-search-overlay {
  position: fixed; inset: 0; z-index: 9700;
  background: rgba(5,7,12,0.82); backdrop-filter: blur(6px);
  display: none; align-items: flex-start; justify-content: center;
  padding-top: 12vh;
}
#wap-search-overlay.wap-search-open { display: flex; }
#wap-search-box {
  width: min(540px, 92vw);
  background: #13161d; border: 1px solid #252a38;
  border-radius: 10px; box-shadow: 0 24px 80px rgba(0,0,0,0.85);
  overflow: hidden; display: flex; flex-direction: column;
  animation: paletteDrop 160ms cubic-bezier(0.22,1,0.36,1);
}
#wap-search-input {
  width: 100%; border: none; outline: none; background: transparent;
  color: #e8ecf4; font-family: var(--font-mono, monospace);
  font-size: 0.9rem; padding: 16px 20px;
  border-bottom: 1px solid #252a38; caret-color: #4f9eff;
}
#wap-search-results {
  list-style: none; margin: 0; padding: 6px 0;
  max-height: 300px; overflow-y: auto;
}
.wap-search-item {
  display: flex; align-items: center; gap: 12px;
  padding: 9px 20px; cursor: pointer;
  font-size: 0.82rem; color: #8b95ab;
  transition: background 80ms;
}
.wap-search-item:hover, .wap-search-item.active { background:#1e2535; color:#e8ecf4; }
.wap-search-num {
  font-family: var(--font-mono, monospace); font-size: 0.65rem;
  color: #515d76; min-width: 28px;
}

/* ═══════════════════════════════════════════════════════════════
   IN-OVERLAY FETCH API TEACHING PANEL
   All rules are scoped to #jsc-overlay so they cannot bleed into
   the main-page .fetch-section component.
   Class names follow the spec exactly:
     .fetch-section  .fetch-header  .fetch-body  .fetch-chevron
   Tab classes (.fetch-tab, .fetch-tab-content) inherit the
   existing global rules and need no overrides.
   ═══════════════════════════════════════════════════════════════ */

/* ── Outer wrapper ─────────────────────────────────────────────
   flex-shrink:0  → never squishes; .jsc-workspace (flex:1) gives
   up space to accommodate it.
   Override the global margin-top / border-radius from .fetch-section
   so it sits flush against the workspace bottom edge.            */
#jsc-overlay .fetch-section {
  flex-shrink: 0;
  margin-top: 0;
  border: none;
  border-top: 1px solid rgba(255,255,255,0.06);
  border-radius: 0;
  overflow: visible;         /* body handles its own clipping     */
  background: var(--bg-surface, #13161d);
}

/* ── Header row ────────────────────────────────────────────────
   44 px tall; always visible regardless of open/closed state.   */
#jsc-overlay .fetch-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 44px;
  padding: 0 20px;
  cursor: pointer;
  user-select: none;
  background: var(--bg-surface, #13161d);
  transition: background 140ms ease;
}
#jsc-overlay .fetch-header:hover  { background: var(--bg-accent, #1e2535); }
#jsc-overlay .fetch-header:focus-visible {
  outline: 2px solid var(--accent-blue, #4f9eff);
  outline-offset: -2px;
}

/* Title text */
#jsc-overlay .fetch-header-title {
  display: flex;
  align-items: center;
  gap: 9px;
  font-family: var(--font-mono, monospace);
  font-size: 0.72rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  color: var(--text-primary, #e8ecf4);
}

/* "fetch" label pill */
#jsc-overlay .fetch-header-badge {
  font-family: var(--font-mono, monospace);
  font-size: 0.57rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 2px 6px;
  border-radius: 3px;
  color: var(--accent-blue, #4f9eff);
  background: rgba(79,158,255,0.10);
  border: 1px solid rgba(79,158,255,0.20);
}

/* Chevron — rotation driven by .open class added by JS */
#jsc-overlay .fetch-chevron {
  font-size: 0.6rem;
  color: var(--text-muted, #515d76);
  line-height: 1;
  flex-shrink: 0;
  transition: transform 280ms cubic-bezier(0.4, 0, 0.2, 1),
              color     140ms ease;
}
#jsc-overlay .fetch-chevron.open {
  transform: rotate(180deg);
  color: var(--accent-blue, #4f9eff);
}

/* ── Collapsible body ──────────────────────────────────────────
   Override global `.fetch-body { display:none }` so that
   max-height drives visibility instead (enables CSS transition). */
#jsc-overlay .fetch-body {
  display: block !important;          /* always in flow            */
  max-height: 0;
  overflow: hidden;
  background: var(--bg-code, #0d0f14);
  transition: max-height 300ms cubic-bezier(0.4, 0, 0.2, 1);
}
#jsc-overlay .fetch-body.open {
  max-height: 430px;                  /* cap; body is scrollable   */
}

/* ── Scrollable inner wrapper ──────────────────────────────────
   Prevents the body from overflowing its max-height cap when
   content is tall on small screens.                              */
#jsc-overlay .fetch-body-inner {
  overflow-y: auto;
  max-height: 430px;
}

/* ── Tab content panes (scoped) ────────────────────────────────
   Global .fetch-tab-content styles already handle display:none /
   display:block switching. We only need to tune the <pre> look
   for the dark overlay background.                              */
#jsc-overlay .fetch-tab-content pre {
  background: #0a0c10;
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: var(--r-sm, 6px);
  padding: 13px 15px;
  font-family: var(--font-mono, monospace);
  font-size: 0.71rem;
  line-height: 1.68;
  color: var(--text-code, #cdd6f4);
  overflow-x: auto;
  white-space: pre;
  margin: 0 0 10px;
}

/* Explanation note card */
#jsc-overlay .fetch-note {
  padding: 10px 13px;
  margin-bottom: 14px;
  background: rgba(79,158,255,0.04);
  border: 1px solid rgba(79,158,255,0.14);
  border-left: 3px solid var(--accent-blue, #4f9eff);
  border-radius: var(--r-sm, 6px);
  font-family: var(--font-ui, serif);
  font-size: 0.74rem;
  line-height: 1.57;
  color: var(--text-secondary, #8b95ab);
}
#jsc-overlay .fetch-note code {
  font-family: var(--font-mono, monospace);
  font-size: 0.87em;
  color: var(--accent-blue, #4f9eff);
  background: rgba(79,158,255,0.08);
  border-radius: 3px;
  padding: 0 3px;
}
#jsc-overlay .fetch-note em { font-style: italic; color: var(--text-primary, #e8ecf4); }

/* ── Runnable example block ──────────────────────────────────── */
#jsc-overlay .fetch-runnable {
  padding: 12px 16px 14px;
  border-top: 1px solid rgba(255,255,255,0.05);
  background: #000;
}
#jsc-overlay .fetch-runnable-label {
  font-family: var(--font-mono, monospace);
  font-size: 0.58rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-muted, #515d76);
  margin-bottom: 8px;
}
#jsc-overlay .fetch-runnable pre {
  margin: 0 0 10px;
  padding: 12px 14px;
  background: #000;
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: var(--r-sm, 6px);
  font-family: var(--font-mono, monospace);
  font-size: 0.71rem;
  line-height: 1.68;
  color: var(--text-code, #cdd6f4);
  overflow-x: auto;
  white-space: pre;
}

/* "Run in Editor" CTA */
#jsc-overlay .fetch-run-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: var(--accent-blue, #4f9eff);
  color: #fff;
  border: none;
  border-radius: var(--r-sm, 6px);
  font-family: var(--font-mono, monospace);
  font-size: 0.68rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  cursor: pointer;
  transition: opacity 140ms ease, transform 100ms ease;
}
#jsc-overlay .fetch-run-btn:hover  { opacity: 0.84; }
#jsc-overlay .fetch-run-btn:active { transform: scale(0.97); }

/* === NEW ADDITION START === */
/* Understanding Flow Popup */
#uf-backdrop {
  position: fixed; inset: 0;
  background: rgba(5,7,12,0.82);
  z-index: 9000;
  display: flex; align-items: center; justify-content: center;
  padding: 16px;
  opacity: 0; pointer-events: none;
  transition: opacity 200ms ease;
}
#uf-backdrop.uf-visible { opacity: 1; pointer-events: all; }
#uf-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-modal);
  padding: 28px 28px 24px;
  max-width: 480px; width: 100%;
  max-height: 88vh; overflow-y: auto;
}
#uf-box h3 {
  font-size: 1.05rem; font-weight: 700;
  color: var(--text-primary); margin-bottom: 18px;
  text-align: center;
}
.uf-btn-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.uf-btn {
  background: var(--bg-accent); border: 1px solid var(--border);
  color: var(--text-primary); border-radius: var(--r-sm);
  padding: 8px 20px; cursor: pointer; font-size: 0.88rem;
  font-family: var(--font-ui); transition: background 150ms, border-color 150ms;
}
.uf-btn:hover { background: var(--border); border-color: var(--accent-blue); color: var(--accent-blue); }
.uf-btn.primary { background: var(--accent-blue); border-color: var(--accent-blue); color: #fff; }
.uf-btn.primary:hover { opacity: 0.88; }
.uf-btn.danger { background: transparent; border-color: var(--accent-red); color: var(--accent-red); }
.uf-btn.danger:hover { background: rgba(255,107,107,0.1); }
.uf-q-block { margin-bottom: 18px; }
.uf-q-text {
  font-size: 0.9rem; color: var(--text-primary); margin-bottom: 10px;
  font-weight: 600; line-height: 1.5;
}
.uf-q-num { color: var(--accent-blue); margin-right: 4px; }
.uf-choices { display: flex; flex-direction: column; gap: 6px; }
.uf-choice {
  background: var(--bg-accent); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 8px 12px; cursor: pointer;
  font-size: 0.84rem; color: var(--text-secondary);
  text-align: left; font-family: var(--font-ui);
  transition: background 120ms, border-color 120ms, color 120ms;
}
.uf-choice:hover:not(:disabled) { border-color: var(--accent-blue); color: var(--text-primary); background: var(--bg-card); }
.uf-choice.correct-ans { border-color: var(--accent-green) !important; color: var(--accent-green) !important; background: rgba(61,214,140,0.08) !important; }
.uf-choice.wrong-ans   { border-color: var(--accent-red)   !important; color: var(--accent-red)   !important; background: rgba(255,107,107,0.06) !important; }
.uf-choice:disabled { cursor: default; }
.uf-score {
  text-align: center; font-size: 1rem; font-weight: 700;
  color: var(--text-primary); margin: 14px 0 6px;
}
.uf-score .uf-score-good { color: var(--accent-green); }
.uf-score .uf-score-bad  { color: var(--accent-amber); }
.uf-msg { text-align: center; font-size: 0.84rem; color: var(--text-secondary); margin-bottom: 16px; }
.uf-divider { border: none; border-top: 1px solid var(--border); margin: 14px 0; }
/* === NEW ADDITION END === */

/* === NEW ADDITION START === */

/* ── Profile Card (sidebar top) ─────────────────────────────── */
.profile-card {
  display: flex;
  align-items: center;
  gap: 11px;
  padding: 14px 16px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  cursor: pointer;
  transition: background 160ms ease;
  flex-shrink: 0;
  position: relative;
}
.profile-card:hover { background: rgba(255,255,255,0.03); }
[data-theme="light"] .profile-card:hover { background: rgba(0,0,0,0.03); }
[data-theme="light"] .profile-card { border-bottom: 1px solid rgba(0,0,0,0.06); }

.profile-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid rgba(240,165,0,0.35);
  flex-shrink: 0;
  box-shadow: 0 0 0 2px rgba(240,165,0,0.12);
}
.profile-info { flex: 1; min-width: 0; }
.profile-username {
  font-size: 0.82rem;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.01em;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.profile-level-txt {
  font-size: 0.66rem;
  color: var(--accent-amber);
  font-family: var(--font-mono);
  letter-spacing: 0.05em;
  margin-top: 2px;
}
.profile-mini-bar-wrap {
  height: 3px;
  background: rgba(255,255,255,0.07);
  border-radius: 2px;
  margin-top: 5px;
  overflow: hidden;
}
[data-theme="light"] .profile-mini-bar-wrap { background: rgba(0,0,0,0.08); }
.profile-mini-bar {
  height: 100%;
  border-radius: 2px;
  background: linear-gradient(90deg, var(--accent-amber), #ffcd5a);
  transition: width 500ms cubic-bezier(0.4,0,0.2,1);
  width: 0%;
}

/* ── Profile Modal ───────────────────────────────────────────── */
#profile-modal-backdrop {
  position: fixed; inset: 0;
  background: rgba(5,7,12,0.86);
  z-index: 9100;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
  opacity: 0; pointer-events: none;
  transition: opacity 240ms ease;
}
#profile-modal-backdrop.pm-visible { opacity: 1; pointer-events: all; }
#profile-modal-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  box-shadow: 0 28px 80px rgba(0,0,0,0.7);
  padding: 36px 32px 32px;
  max-width: 360px; width: 100%;
  text-align: center;
  position: relative;
  transform: translateY(12px) scale(0.97);
  transition: transform 280ms cubic-bezier(0.22,1,0.36,1), opacity 240ms ease;
  opacity: 0;
}
#profile-modal-backdrop.pm-visible #profile-modal-box {
  transform: translateY(0) scale(1);
  opacity: 1;
}
.pm-close {
  position: absolute; top: 14px; right: 14px;
  background: transparent; border: 1px solid var(--border);
  color: var(--text-muted); border-radius: 6px;
  padding: 4px 9px; cursor: pointer; font-size: 0.78rem;
  transition: background 150ms, color 150ms;
}
.pm-close:hover { background: rgba(255,107,107,0.1); color: var(--accent-red); border-color: rgba(255,107,107,0.3); }
.pm-avatar-large {
  width: 86px; height: 86px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(240,165,0,0.5);
  box-shadow: 0 0 0 5px rgba(240,165,0,0.1), 0 8px 28px rgba(0,0,0,0.45);
  margin: 0 auto 14px;
  display: block;
}
.pm-username {
  font-size: 1.15rem; font-weight: 800;
  color: var(--text-primary);
  letter-spacing: -0.02em;
  margin-bottom: 4px;
}
.pm-level-badge {
  display: inline-block;
  font-size: 0.7rem;
  font-family: var(--font-mono);
  color: var(--accent-amber);
  background: rgba(240,165,0,0.1);
  border: 1px solid rgba(240,165,0,0.25);
  border-radius: 20px;
  padding: 3px 10px;
  letter-spacing: 0.06em;
  margin-bottom: 22px;
}
.pm-xp-label {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-bottom: 8px;
}
.pm-xp-text {
  font-size: 0.75rem; font-family: var(--font-mono);
  color: var(--text-secondary); letter-spacing: 0.04em;
}
.pm-xp-pct {
  font-size: 0.72rem; font-family: var(--font-mono);
  color: var(--accent-amber); font-weight: 700;
}
.pm-xp-track {
  height: 8px;
  background: rgba(255,255,255,0.07);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 9px;
}
[data-theme="light"] .pm-xp-track { background: rgba(0,0,0,0.08); }
.pm-xp-fill {
  height: 100%;
  border-radius: 8px;
  background: linear-gradient(90deg, #f0a500, #ffcd5a, #ffe08a);
  width: 0%;
  transition: width 700ms cubic-bezier(0.4,0,0.2,1);
  position: relative;
  overflow: hidden;
}
.pm-xp-fill::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.25) 50%, transparent 100%);
  animation: pm-sheen 2s ease 0.8s infinite;
}
@keyframes pm-sheen {
  0%   { transform: translateX(-100%); }
  100% { transform: translateX(200%); }
}
.pm-xp-sub {
  font-size: 0.67rem; color: var(--text-muted);
  font-family: var(--font-mono); letter-spacing: 0.04em;
  text-align: right;
}

/* ── Level-Up Cinematic Overlay ─────────────────────────────── */
#lu-cinematic {
  position: fixed; inset: 0;
  z-index: 10000;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 0;
  pointer-events: none;
  opacity: 0;
  background: rgba(8, 10, 16, 0.96);
  backdrop-filter: blur(18px) saturate(0.6);
  -webkit-backdrop-filter: blur(18px) saturate(0.6);
  transition: opacity 600ms ease;
}
#lu-cinematic.lu-active {
  opacity: 1;
  pointer-events: all;
}
@keyframes lu-text-in {
  0%   { opacity: 0; transform: scale(0.82) translateY(10px); filter: blur(6px); }
  60%  { opacity: 1; filter: blur(0); }
  100% { opacity: 1; transform: scale(1) translateY(0); }
}
@keyframes lu-img-in {
  0%   { opacity: 0; transform: scale(0.7); }
  70%  { transform: scale(1.04); }
  100% { opacity: 1; transform: scale(1); }
}
@keyframes lu-quote-in {
  0%   { opacity: 0; transform: translateY(14px); }
  100% { opacity: 1; transform: translateY(0); }
}
@keyframes lu-btn-in {
  0%   { opacity: 0; transform: translateY(10px); }
  100% { opacity: 1; transform: translateY(0); }
}
@keyframes lu-glow-pulse {
  0%, 100% { box-shadow: 0 0 32px 8px rgba(240,165,0,0.22), 0 20px 60px rgba(0,0,0,0.6); }
  50%       { box-shadow: 0 0 56px 16px rgba(240,165,0,0.38), 0 20px 60px rgba(0,0,0,0.6); }
}
.lu-big-text {
  font-size: clamp(3rem, 12vw, 7rem);
  font-weight: 900;
  letter-spacing: -0.04em;
  line-height: 0.9;
  background: linear-gradient(135deg, #f0a500 0%, #ffcd5a 40%, #fff5cc 65%, #f0a500 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  animation: lu-text-in 700ms cubic-bezier(0.22,1,0.36,1) forwards;
  opacity: 0;
  margin-bottom: 8px;
  filter: drop-shadow(0 0 24px rgba(240,165,0,0.4));
}
.lu-level-label {
  font-size: 0.8rem;
  font-family: var(--font-mono);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: rgba(240,165,0,0.75);
  text-align: center;
  animation: lu-text-in 700ms 80ms cubic-bezier(0.22,1,0.36,1) forwards;
  opacity: 0;
  margin-bottom: 36px;
}
.lu-avatar-wrap {
  position: relative;
  margin-bottom: 30px;
  animation: lu-img-in 700ms 250ms cubic-bezier(0.22,1,0.36,1) forwards;
  opacity: 0;
}
.lu-avatar-img {
  width: 110px; height: 110px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(240,165,0,0.6);
  display: block;
  animation: lu-glow-pulse 2.6s ease 0.9s infinite;
  box-shadow: 0 0 32px 8px rgba(240,165,0,0.22), 0 20px 60px rgba(0,0,0,0.6);
}
.lu-quote {
  font-size: 0.9rem;
  color: rgba(255,255,255,0.55);
  font-style: italic;
  letter-spacing: 0.01em;
  text-align: center;
  max-width: 320px;
  line-height: 1.6;
  animation: lu-quote-in 600ms 600ms ease forwards;
  opacity: 0;
  margin-bottom: 40px;
  padding: 0 24px;
}
.lu-continue-btn {
  background: rgba(240,165,0,0.12);
  border: 1px solid rgba(240,165,0,0.4);
  color: var(--accent-amber);
  border-radius: 10px;
  padding: 11px 32px;
  font-size: 0.88rem;
  font-family: var(--font-ui);
  letter-spacing: 0.02em;
  cursor: pointer;
  animation: lu-btn-in 400ms ease forwards;
  opacity: 0;
  transition: background 180ms, box-shadow 180ms;
}
.lu-continue-btn:hover {
  background: rgba(240,165,0,0.22);
  box-shadow: 0 0 18px rgba(240,165,0,0.25);
}

/* === NEW ADDITION END === */

</style>
</head>
<body>
<!-- === NEW ADDITION START === -->
<div id="uf-backdrop" role="dialog" aria-modal="true" aria-labelledby="uf-title">
  <div id="uf-box">
    <h3 id="uf-title">Did you understand this topic?</h3>
    <div id="uf-content"></div>
  </div>
</div>
<!-- === NEW ADDITION END === -->
<!-- === NEW ADDITION START === -->
<!-- Profile Modal -->
<div id="profile-modal-backdrop" aria-modal="true" role="dialog" aria-labelledby="pm-username-el">
  <div id="profile-modal-box">
    <button class="pm-close" id="pm-close-btn" aria-label="Close profile">✕</button>
    <img src="3.jpeg" alt="User avatar" class="pm-avatar-large">
    <div class="pm-username" id="pm-username-el">User07</div>
    <div class="pm-level-badge" id="pm-level-badge">Lvl 1 · Beginner</div>
    <div class="pm-xp-label">
      <span class="pm-xp-text" id="pm-xp-text">0 / 90 XP</span>
      <span class="pm-xp-pct" id="pm-xp-pct">0%</span>
    </div>
    <div class="pm-xp-track"><div class="pm-xp-fill" id="pm-xp-fill"></div></div>
    <div class="pm-xp-sub" id="pm-xp-sub">0% of Level 1 completed</div>
  </div>
</div>
<!-- Level-Up Cinematic Overlay -->
<div id="lu-cinematic" aria-live="assertive">
  <div class="lu-big-text" id="lu-big-text">LEVEL UP</div>
  <div class="lu-level-label" id="lu-level-label">Level 2 — Learner</div>
  <div class="lu-avatar-wrap">
    <img src="4.jpeg" alt="Achievement" class="lu-avatar-img">
  </div>
  <div class="lu-quote" id="lu-quote">"Growth begins where comfort ends."</div>
  <button class="lu-continue-btn" id="lu-continue-btn" style="display:none">Continue Learning</button>
</div>
<!-- === NEW ADDITION END === -->
<!-- Scroll progress (kept from original) -->
<div id="scroll-progress"></div>

<!-- Original header hidden, original XP bar hidden via CSS -->
<header class="site-header" role="banner">
  <div class="header-inner">
    <div class="header-brand">
      <h1>⚡ JS Advanced Concepts</h1>
      <span>ES5 → ES6 · Callbacks · Promises · Closures</span>
    </div>
    <div class="header-actions">
      <span class="session-stat" id="session-stat" title="Topics studied this session">
        <span class="ss-num" id="ss-num">0</span> this session
      </span>
      <div class="daily-goal-wrap" id="daily-goal-wrap" title="Daily goal: 3 topics">
        <svg class="daily-ring" viewBox="0 0 22 22" aria-hidden="true">
          <circle class="dr-bg" cx="11" cy="11" r="9"/>
          <circle class="dr-fill" id="dr-fill" cx="11" cy="11" r="9"/>
        </svg>
        <div class="daily-goal-text">
          <strong id="daily-done">0/3</strong>daily goal
        </div>
      </div>
      <span class="streak-pill" id="streak-pill" title="Session streak">
        <span id="streak-count">1</span>d streak
      </span>
      <span class="progress-badge" id="progress-badge">0 / 33 topics</span>
      <button class="btn-theme" id="theme-toggle" aria-label="Toggle theme">
        <span id="theme-icon">☀️</span>
        <span id="theme-label">Light</span>
      </button>
    </div>
  </div>
</header>
<div class="xp-bar-wrap" id="xp-bar-wrap">
  <div class="xp-label">
    <span class="xp-level-badge" id="xp-level-txt">Lvl 1</span>
    XP
  </div>
  <div class="xp-track">
    <div class="xp-fill" id="xp-fill"></div>
  </div>
  <div class="xp-pts" id="xp-pts">0 XP</div>
</div>

<!-- ============================================================
     WAP OS TOP BAR
     ============================================================ -->
<div class="wapos-topbar">
  <!-- Brand -->
  <div class="wapos-brand">
    <button class="sidebar-toggle-btn" id="sidebar-toggle" title="Toggle Sidebar">☰</button>
    <img src="2.jpeg" alt="WAP OS" class="wapos-logo">
    <span class="wapos-name">WAP OS</span>
  </div>
  
  <div class="wapos-divider"></div>
  
  <!-- Center: primary search navigation -->
  <div class="wapos-topbar-center" id="topbar-search-area">
    <div class="wapos-xp-wrap" style="display:none">
      <span class="xp-level-badge" id="wapos-level-txt">Lvl 1</span>
      <div class="wapos-xp-track">
        <div class="wapos-xp-fill" id="wapos-xp-fill"></div>
      </div>
      <span class="wapos-xp-pts" id="wapos-xp-pts">0 XP</span>
    </div>
    <div class="topbar-search-container" id="topbar-search-container">
      <div class="topbar-search-wrap" id="topbar-search-wrap">
        <span class="topbar-search-icon">⌕</span>
        <input
          type="text"
          class="topbar-search-input"
          id="search-input"
          placeholder="Search or navigate topics… (Press /)"
          autocomplete="off"
          aria-label="Search topics"
          aria-haspopup="listbox"
          aria-expanded="false"
        >
        <kbd class="topbar-search-kbd">/</kbd>
      </div>
      <!-- Discovery dropdown -->
      <div class="topbar-discovery" id="topbar-discovery" role="listbox">
        <div class="td-search-results" id="search-results" role="listbox"></div>
        <div class="td-sections" id="td-sections">
          <div class="td-label">Navigate by Section</div>
          <div class="td-section-list" id="td-section-list">
            <button class="td-section-btn" data-section="0">
              <span class="td-s-num">01</span>
              <span class="td-s-name">ES5 vs ES6 Fundamentals</span>
              <span class="td-s-count">13 topics</span>
            </button>
            <button class="td-section-btn" data-section="1">
              <span class="td-s-num">02</span>
              <span class="td-s-name">Array Methods + Timers</span>
              <span class="td-s-count">8 topics</span>
            </button>
            <button class="td-section-btn" data-section="2">
              <span class="td-s-num">03</span>
              <span class="td-s-name">Advanced Concepts</span>
              <span class="td-s-count">9 topics</span>
            </button>
            <button class="td-section-btn" data-section="3">
              <span class="td-s-num">04</span>
              <span class="td-s-name">Promises &amp; Async</span>
              <span class="td-s-count">4 topics</span>
            </button>
          </div>
          <div class="td-topics-panel" id="td-topics-panel" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Right: controls -->
  <div class="wapos-topbar-right">
    <span class="progress-badge" id="wapos-progress-badge">0 / 33</span>
    <div class="streak-pill" id="streak-pill2" title="Session streak" style="border:1px solid rgba(255,255,255,0.07);color:rgba(255,255,255,0.28);font-size:0.6rem;padding:3px 8px;border-radius:4px;font-family:var(--font-mono);letter-spacing:0.06em">
      <span id="streak-count2">1</span>d
    </div>
    <button class="btn-theme" id="theme-toggle2" aria-label="Toggle theme">
      <span id="theme-icon2">☀️</span>
    </button>
  </div>
</div>

<!-- ============================================================
     THREE-PANEL WORKSPACE
     ============================================================ -->
<div class="wapos-workspace">

  <!-- LEFT SIDEBAR -->
  <aside class="wapos-sidebar" id="wapos-sidebar" aria-label="Topic Navigation">
    <!-- === NEW ADDITION START === -->
    <div class="profile-card" id="profile-card" role="button" tabindex="0" aria-label="Open profile">
      <img src="3.jpeg" alt="User avatar" class="profile-avatar" id="profile-avatar-sm">
      <div class="profile-info">
        <div class="profile-username">User07</div>
        <div class="profile-level-txt" id="profile-level-txt">Lvl 1 · Beginner</div>
        <div class="profile-mini-bar-wrap">
          <div class="profile-mini-bar" id="profile-mini-bar"></div>
        </div>
      </div>
    </div>
    <!-- === NEW ADDITION END === -->
    <div class="sidebar-header">
      <div style="font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.22);font-family:var(--font-mono);margin-bottom:8px;">Important Topics</div>
      <div class="sidebar-progress-label" id="sb-prog-label" style="color: #f29b9b;">0 / 33 marked</div>
      <div class="sidebar-progress-bar">
        <div class="sidebar-progress-fill" id="sb-prog-fill"></div>
      </div>
    </div>
    
    
    <nav class="sidebar-nav" id="sidebar-nav" aria-label="Important Topics">
      <!-- Important topics rendered dynamically by JS -->
      <div class="imp-empty-state" id="imp-empty-state">
        <div class="imp-empty-icon">☆</div>
        <div class="imp-empty-text">No important topics yet.</div>
        <div class="imp-empty-sub">Star any topic while reading to add it here.</div>
      </div>
      <div id="imp-topics-list"></div>
    </nav>
    
    <div class="sidebar-footer">
      <div style="font-size:0.58rem;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.2);margin-bottom:4px;font-family:var(--font-mono)">
        Star topics in any opened topic
      </div>
    </div>
  </aside>

  <!-- CENTER CONTENT -->
  <main class="wapos-center" id="wapos-center" role="main">
<section class="hero">
  <div class="hero-eyebrow" style="color: #f29b9b;">
    <span>📚</span> Complete Learning Guide · BY BRAK &amp; Krish Kothari
  </div>
  <h2>Master <span class="hl">JavaScript</span><br>the Right Way</h2>
  <p>33 topics with side-by-side comparisons, Hinglish &amp; English explanations, and real code examples.</p>

  <div class="hero-stats">
    <div class="stat-item"><span class="num">33</span><span class="lbl">Topics</span></div>
    <div class="stat-divider"></div>
    <div class="stat-item"><span class="num">4</span><span class="lbl">Sections</span></div>
    <div class="stat-divider"></div>
    <div class="stat-item"><span class="num">2x</span><span class="lbl">Explained in Languages</span></div>
    <div class="stat-divider"></div>
    <div class="mastery-ring-wrap stat-item" id="mastery-wrap">
      <svg class="mastery-ring" viewBox="0 0 40 40" aria-hidden="true">
        <circle class="ring-bg" cx="20" cy="20" r="18"/>
        <circle class="ring-fill" id="mastery-ring-fill" cx="20" cy="20" r="18"/>
      </svg>
      <div class="mastery-text">
        <div class="mastery-pct" id="mastery-pct">0%</div>
        <div class="mastery-sub">Mastered</div>
      </div>
    </div>
  </div>
</section>
<section class="toc-section" role="main">

  <!-- Recall banner — shows last studied topic on return visit -->
  <div class="recall-banner" id="recall-banner">
    <span style="font-size:1.3rem">📖</span>
    <div class="rb-text">
      <strong id="rb-title">Continue where you left off</strong><br>
      Last studied: <span id="rb-topic-name">—</span>
    </div>
    <button class="rb-resume" id="rb-resume">Resume →</button>
    <button class="rb-dismiss" id="rb-dismiss" aria-label="Dismiss">✕</button>
  </div>

  <!-- Section 1 -->
  <div class="section-label">ES5 vs ES6 Fundamentals <span class="s-done" id="sdone-0" style="display:none">✓ Complete</span></div>
  <div class="toc-grid reveal" id="toc-s1">
    <div class="toc-card">
      <div class="toc-card-label"><span class="dot"></span> Basics</div>
      <a class="toc-link" href="#topic-0" data-topic="0"><span class="num">00</span> Array Filter Method<span class="diff-dot diff-easy" title="Beginner"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-1" data-topic="1"><span class="num">01</span> Object Destructuring<span class="diff-dot diff-easy" title="Beginner"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-2" data-topic="2"><span class="num">02</span> Destructuring with Renaming<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-3" data-topic="3"><span class="num">03</span> Default Values<span class="diff-dot diff-easy" title="Beginner"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-4" data-topic="4"><span class="num">04</span> Function Parameters Destructuring<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
    </div>
    <div class="toc-card">
      <div class="toc-card-label"><span class="dot"></span> Arrays &amp; Spread</div>
      <a class="toc-link" href="#topic-5" data-topic="5"><span class="num">05</span> Array Destructuring<span class="diff-dot diff-easy" title="Beginner"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-6" data-topic="6"><span class="num">06</span> Spread Syntax — Arrays<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-7" data-topic="7"><span class="num">07</span> Spread Syntax — Objects<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-8" data-topic="8"><span class="num">08</span> Spread in Function Calls<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
    </div>
    <div class="toc-card">
      <div class="toc-card-label"><span class="dot"></span> Rest Syntax</div>
      <a class="toc-link" href="#topic-9"  data-topic="9"><span class="num">09</span> Rest Syntax — Arrays<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-10" data-topic="10"><span class="num">10</span> Rest Syntax — Objects<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-11" data-topic="11"><span class="num">11</span> Rest Parameters in Functions<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-12" data-topic="12"><span class="num">12</span> Rest vs Spread<span class="chk">✓</span></a>
    </div>
  </div>

  <br>
  <!-- Section 2 -->
  <div class="section-label">Array Methods + Timers <span class="s-done" id="sdone-1" style="display:none">✓ Complete</span></div>
  <div class="toc-grid reveal" id="toc-s2">
    <div class="toc-card">
      <div class="toc-card-label"><span class="dot" style="background:var(--accent-green)"></span> Array Methods</div>
      <a class="toc-link" href="#topic-13" data-topic="13"><span class="num">13</span> forEach Method<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-14" data-topic="14"><span class="num">14</span> map Method<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-15" data-topic="15"><span class="num">15</span> find Method<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-16" data-topic="16"><span class="num">16</span> sort Method<span class="chk">✓</span></a>
    </div>
    <div class="toc-card">
      <div class="toc-card-label"><span class="dot" style="background:var(--accent-green)"></span> Timers</div>
      <a class="toc-link" href="#topic-17" data-topic="17"><span class="num">17</span> setTimeout — Basics<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-18" data-topic="18"><span class="num">18</span> clearTimeout<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-19" data-topic="19"><span class="num">19</span> setInterval<span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-20" data-topic="20"><span class="num">20</span> clearInterval<span class="chk">✓</span></a>
    </div>
  </div>

  <br>
  <!-- Section 3 -->
  <div class="section-label">Advanced Concepts <span class="s-done" id="sdone-2" style="display:none">✓ Complete</span></div>
  <div class="toc-grid reveal" id="toc-s3">
    <div class="toc-card">
      <div class="toc-card-label"><span class="dot" style="background:var(--accent-amber)"></span> Callbacks &amp; HOF</div>
      <a class="toc-link" href="#topic-21" data-topic="21"><span class="num">21</span> Understanding Callbacks<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-22" data-topic="22"><span class="num">22</span> Callbacks with Parameters<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-23" data-topic="23"><span class="num">23</span> Higher-Order Functions<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-24" data-topic="24"><span class="num">24</span> Building Custom Filter<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
    </div>
    <div class="toc-card">
      <div class="toc-card-label"><span class="dot" style="background:var(--accent-amber)"></span> Factory &amp; Closures</div>
      <a class="toc-link" href="#topic-25" data-topic="25"><span class="num">25</span> Factory Functions — Greetings<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-26" data-topic="26"><span class="num">26</span> Factory Pattern — Multipliers<span class="diff-dot diff-medium" title="Intermediate"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-27" data-topic="27"><span class="num">27</span> Understanding Closures<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-28" data-topic="28"><span class="num">28</span> Closure Deep Dive<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-29" data-topic="29"><span class="num">29</span> Closure Complete Summary 🎓<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
    </div>
  </div>

  <br>
  <!-- Section 4 -->
  <div class="section-label">Promises &amp; Async Patterns <span class="s-done" id="sdone-3" style="display:none">✓ Complete</span></div>
  <div class="toc-grid reveal" id="toc-s4">
    <div class="toc-card">
      <div class="toc-card-label"><span class="dot" style="background:var(--accent-purple)"></span> Promises</div>
      <a class="toc-link" href="#topic-30" data-topic="30"><span class="num">30</span> Callbacks vs Promises — greet()<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-31" data-topic="31"><span class="num">31</span> Callback Hell vs Promise Chain<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-32" data-topic="32"><span class="num">32</span> Promise Chaining — ronaldoPromise 🏆<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
      <a class="toc-link" href="#topic-33" data-topic="33"><span class="num">33</span> Fetch API Flow — Real World Async 🌐<span class="diff-dot diff-hard" title="Advanced"></span><span class="chk">✓</span></a>
    </div>
  </div>


  <div class="kbd-hint" style="margin-top: var(--sp-6);">
    Press <kbd>Esc</kbd> to close any topic · <kbd>←</kbd> <kbd>→</kbd> to navigate
  </div>

  <!-- ── Fetch API Interactive Teaching Section ─────────────── -->
  <div class="fetch-section" id="fetch-teaching-section">
    <div class="fetch-section-header" id="fetch-header" role="button" tabindex="0" aria-expanded="false">
      <span class="fetch-section-title">
        🌐 Understanding Fetch API Flow
        <span class="fetch-badge">NEW</span>
      </span>
      <span class="fetch-chevron" id="fetch-chevron">▼</span>
    </div>
    <div class="fetch-body" id="fetch-body">
      <div class="fetch-lang-tabs">
        <div class="fetch-tab active" data-tab="en">🇬🇧 English</div>
        <div class="fetch-tab" data-tab="hi">🇮🇳 Hinglish</div>
      </div>

      <!-- English tab -->
      <div class="fetch-tab-content active" data-content="en">
        <pre><code>// Explanation of fetch flow:
//
// 1. fetch(url)
//    - Performs an HTTP GET request and returns a promise resolving to a Response object.
//
// 2. .then(response => ...)
//    - First promise callback receives the Response.
//    - Check response.ok to make sure HTTP status is 2xx; if not, throw an error.
//    - Call response.json() to parse and return another promise with the body data.
//
// 3. .then(data => ...)
//    - Receives parsed JSON from the previous step.
//    - Log a success message and output the data.
//
// 4. .catch(error => ...)
//    - Handles any network errors, status errors, or JSON parsing issues.
//
// This structure ensures proper error handling by validating the response before attempting to use the data.</code></pre>
        <div class="fetch-note">
          <strong>Why two <code>.then()</code> calls?</strong> <code>fetch()</code> returns the HTTP <em>envelope</em> (headers, status). <code>response.json()</code> opens the envelope and parses the body — it returns its own Promise. This two-step pattern ensures you validate the response before attempting to read data.
        </div>
      </div>

      <!-- Hinglish tab -->
      <div class="fetch-tab-content" data-content="hi">
        <pre><code>// Fetch ka flow samjho:
//
// 1. fetch(url)
//    - Ye ek HTTP GET request bhejta hai aur ek promise return karta hai jo Response object deta hai.
//
// 2. .then(response => ...)
//    - Pehla promise callback Response ko receive karta hai.
//    - response.ok check karte hain taaki confirm ho ki status 2xx hai.
//    - Agar nahi hai toh error throw karte hain.
//    - response.json() call karte hain jo body ko parse karke next promise return karta hai.
//
// 3. .then(data => ...)
//    - Yahan parsed JSON data milta hai.
//    - Success message aur data console me log karte hain.
//
// 4. .catch(error => ...)
//    - Network error, status error ya parsing issue sab yahan handle hote hain.
//
// Is structure se pehle response validate hota hai, phir data use hota hai.
// Isliye proper error handling hoti hai.</code></pre>
        <div class="fetch-note">
          <strong>Do .then() kyun lagte hain?</strong> Pehla <code>.then()</code> HTTP response ka "lifafa" (envelope) deta hai — status aur headers. Doosra step (<code>response.json()</code>) us lifafe ko kholke JSON data deta hai. Yeh ek alag Promise hai isliye dono steps alag hain. Aur <code>.catch()</code> dono steps ke errors pakad leta hai! 🎯
        </div>
      </div>

      <!-- Runnable example -->
      <div class="fetch-runnable">
        <div class="fetch-runnable-label">▶ Runnable Example — Try it in the compiler</div>
        <pre id="fetch-example-code"><code>fetch("https://uselessfacts.jsph.pl/api/v2/facts/random?category=careers")
  .then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok");
    }
    return response.json();
  })
  .then((data) => {
    console.log("Data fetched successfully");
    console.log(data);
  })
  .catch((error) => {
    console.error("Error fetching data:", error);
  });</code></pre>
        <button class="fetch-try-btn" id="fetch-try-btn">
          ▶ Open in Compiler
        </button>
      </div>
    </div>
  </div>
</section>

  </main>
  <!-- END CENTER -->

  <!-- RIGHT UTILITY PANEL -->
  <aside class="wapos-right" id="wapos-right" aria-label="Study Tools">
    <div class="right-panel-header">Study Tools</div>
    <div class="right-panel-body">
      
      <!-- Quick Stats -->
      <div class="right-panel-section">
        <div class="rp-label">Session Stats</div>
        <div class="rp-stat-row">
          <span class="rp-stat-label">Est. read time</span>
          <span class="rp-stat-val">~45 min</span>
        </div>
        <div class="rp-stat-row">
          <span class="rp-stat-label">Topics done</span>
          <span class="rp-stat-val" id="rp-done-count">0 / 33</span>
        </div>
        <div class="rp-stat-row">
          <span class="rp-stat-label">XP earned</span>
          <span class="rp-stat-val" id="rp-xp-display">0 XP</span>
        </div>
      </div>
      
      
      <!-- Mark as Completed Toggle (UI only) -->
      <!-- <div class="right-panel-section">
        <div class="rp-label">Topic Status</div>
        <div class="rp-complete-toggle" id="rp-complete-toggle" onclick="this.querySelector('.rp-toggle-switch').classList.toggle('on')">
          <div class="rp-toggle-switch">
            <div class="rp-toggle-thumb"></div>
          </div>
          <span class="rp-toggle-label">Mark session complete</span>
        </div>
      </div> -->
      
      <!-- JS Compiler Card -->
      <div class="right-panel-section rp-compiler-section">
        <div class="rp-compiler-card" id="rp-compiler-card" role="button" tabindex="0" aria-label="Open JavaScript Compiler">
          <div class="rp-compiler-label">JavaScript Compiler</div>
          <div class="rp-compiler-preview"><span class="rpc-obj">console</span><span class="rpc-dot">.</span><span class="rpc-fn">log</span><span class="rpc-paren">(</span><span class="rpc-str">"Cristiano Ronaldo is the GOAT"/span><span class="rpc-paren">)</span><span class="rpc-semi">;</span></div>
          <div class="rp-compiler-hint">Click to open →</div>
        </div>
      </div>

      <!-- Back to top -->
      <!-- <div class="right-panel-section">
        <button class="rp-back-top" onclick="document.getElementById('wapos-center').scrollTop=0">
          ↑ Back to Top
        </button>
      </div> -->
      
    </div><!-- end right-panel-body -->
  </aside>
  <!-- END RIGHT PANEL -->

</div>
<!-- END WORKSPACE -->
<!-- ============================================================
     HIDDEN TOPIC CONTENT (shown in modal)
     ============================================================ -->

        <!-- ALL TOPIC CONTENT – HIDDEN, shown in modal (FULL ORIGINAL EXAMPLES) -->
        <div class="content">
            <!-- 0. Array Filter Method -->
            <div class="comparison" id="topic-0">
                <h2 class="topic-title">0. Array Filter Method (Array se elements filter karna)</h2>
                <div class="old-syntax">
                    <h3>❌ Wrong Syntax</h3>
                    <pre><code><span style="color: #5cb85c;">// WRONG - Brackets instead of parentheses</span>
filter[<span style="color: #c678dd;">1</span>,<span style="color: #c678dd;">2</span>,<span style="color: #c678dd;">3</span>,<span style="color: #c678dd;">4</span>,<span style="color: #c678dd;">5</span>], x <span style="color: #ffffff;">=></span> x % <span style="color: #c678dd;">2</span> == <span style="color: #c678dd;">0</span>

<span style="color: #5cb85c;">// WRONG - Arrow misplaced</span>
<span style="color: #d19a66;">let</span> arr = [<span style="color: #c678dd;">10</span>,<span style="color: #c678dd;">20</span>,<span style="color: #c678dd;">30</span>,<span style="color: #c678dd;">50</span>,<span style="color: #c678dd;">70</span>];
arr.<span style="color: #e5c07b;">filter</span>(x) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> ( x > <span style="color: #c678dd;">10</span> ) {
        <span style="color: #d19a66;">return</span> true;
    } <span style="color: #d19a66;">else</span> {
        <span style="color: #d19a66;">return</span> false;
    }
}</code></pre>
                    <div class="note">
                        <strong>Mistakes:</strong>
                        <br>1. filter[...] - Wrong! Use filter(...)
                        <br>2. arr.filter(x) => - Wrong! Arrow should be x =>
                        <br>3. Result store nahi kiya
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Correct Syntax</h3>
                    <pre><code><span style="color: #5cb85c;">// Correct way - filter is an array method</span>
<span style="color: #d19a66;">let</span> numbers = [<span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">4</span>, <span style="color: #c678dd;">5</span>];
<span style="color: #d19a66;">let</span> evens = numbers.<span style="color: #e5c07b;">filter</span>(x <span style="color: #ffffff;">=></span> x % <span style="color: #c678dd;">2</span> == <span style="color: #c678dd;">0</span>);

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(evens); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">4</span>]</span>

<span style="color: #5cb85c;">// Correct way - with explicit return</span>
<span style="color: #d19a66;">let</span> arr = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">70</span>];
<span style="color: #d19a66;">let</span> result = arr.<span style="color: #e5c07b;">filter</span>(x <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (x > <span style="color: #c678dd;">10</span>) {
        <span style="color: #d19a66;">return</span> true;
    } <span style="color: #d19a66;">else</span> {
        <span style="color: #d19a66;">return</span> false;
    }
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(result); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">70</span>]</span>

<span style="color: #5cb85c;">// BEST WAY - Simplified (no need for if-else)</span>
<span style="color: #d19a66;">let</span> simplified = arr.<span style="color: #e5c07b;">filter</span>(x <span style="color: #ffffff;">=></span> x > <span style="color: #c678dd;">10</span>);

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(simplified); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">70</span>]</span>

<span style="color: #5cb85c;">// Example 3: Filtering objects based on properties</span>
<span style="color: #d19a66;">let</span> arr2 = [
    { name: <span style="color: #98c379;">"messi"</span>, isGoat: false },
    { name: <span style="color: #98c379;">"ronaldo"</span>, isGoat: true },
    { name: <span style="color: #98c379;">"pique"</span>, isGoat: false },
    { name: <span style="color: #98c379;">"neymar"</span>, isGoat: true }
];

<span style="color: #5cb85c;">// Long way with if-else</span>
<span style="color: #d19a66;">let</span> anss = arr2.<span style="color: #e5c07b;">filter</span>((x) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (x.isGoat === true) {
        <span style="color: #d19a66;">return</span> true;
    } <span style="color: #d19a66;">else</span> {
        <span style="color: #d19a66;">return</span> false;
    }
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(anss);
<span style="color: #5cb85c;">// [{ name: "ronaldo", isGoat: true }, { name: "neymar", isGoat: true }]</span>

<span style="color: #5cb85c;">// BEST WAY - Simplified</span>
<span style="color: #d19a66;">let</span> goats = arr2.<span style="color: #e5c07b;">filter</span>(x <span style="color: #ffffff;">=></span> x.isGoat === true);
<span style="color: #5cb85c;">// Even shorter:</span>
<span style="color: #d19a66;">let</span> goats2 = arr2.<span style="color: #e5c07b;">filter</span>(x <span style="color: #ffffff;">=></span> x.isGoat);

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(goats);
<span style="color: #5cb85c;">// [{ name: "ronaldo", isGoat: true }, { name: "neymar", isGoat: true }]</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> filter() array ke har element pe callback function chalata hai. Agar callback true return kare, element result mein aata hai. Objects ke saath filter karte time, property access karne ke liye dot notation use karo (x.isGoat).
                        <br><br>
                        <strong>🇬🇧 English:</strong> filter() runs a callback function on every element of the array. If the callback returns true, the element is included in the result. When filtering with objects, use dot notation to access properties (x.isGoat).
                    </div>
                </div>
            </div>
            
            <!-- 1. Object Destructuring -->
            <div class="comparison" id="topic-1">
                <h2 class="topic-title">1. Object Destructuring (Object se values nikalna)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> user = {
    id: <span style="color: #c678dd;">7</span>,
    name: <span style="color: #98c379;">"ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>,
    role: <span style="color: #98c379;">"LW"</span>,
    isGoat: true,
}

<span style="color: #5cb85c;">// Har property ko manually nikalna padta tha</span>
<span style="color: #d19a66;">let</span> id = user.id;
<span style="color: #d19a66;">let</span> name = user.name;
<span style="color: #d19a66;">let</span> role = user.role;
<span style="color: #d19a66;">let</span> age = user.age;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(id);    <span style="color: #5cb85c;">// <span style="color: #c678dd;">7</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(name);  <span style="color: #5cb85c;">// <span style="color: #98c379;">"ronaldo"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(role);  <span style="color: #5cb85c;">// <span style="color: #98c379;">"LW"</span></span></code></pre>
                    <div class="note">
                        <strong>Problem:</strong> Har property ke liye alag line likhni padti thi. Zyada code aur repetitive.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> user = {
    id: <span style="color: #c678dd;">7</span>,
    name: <span style="color: #98c379;">"ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>,
    role: <span style="color: #98c379;">"LW"</span>,
    isGoat: true,
}

<span style="color: #5cb85c;">// Destructuring - ek line mein saari values nikal lo</span>
<span style="color: #d19a66;">let</span> { id, name, age, isGoat, role } = user;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(id);     <span style="color: #5cb85c;">// <span style="color: #c678dd;">7</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(name);   <span style="color: #5cb85c;">// <span style="color: #98c379;">"ronaldo"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(age);    <span style="color: #5cb85c;">// <span style="color: #c678dd;">40</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(isGoat); <span style="color: #5cb85c;">// true</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(role);   <span style="color: #5cb85c;">// <span style="color: #98c379;">"LW"</span></span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Destructuring se ek hi line mein multiple properties extract kar sakte ho. Clean aur readable code.
                        <br><br>
                        <strong>🇬🇧 English:</strong> With destructuring, you can extract multiple properties in a single line. Clean and readable code.
                    </div>
                </div>
            </div>
            
            <!-- 2. Destructuring with Renaming -->
            <div class="comparison" id="topic-2">
                <h2 class="topic-title">2. Destructuring with Renaming (Variable ka naam change karna)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> user = {
    name: <span style="color: #98c379;">"ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>,
    isGoat: true,
}

<span style="color: #5cb85c;">// Manually rename karna padta tha</span>
<span style="color: #d19a66;">let</span> username = user.name;
<span style="color: #d19a66;">let</span> goatAge = user.age;
<span style="color: #d19a66;">let</span> alwaysTheGoat = user.isGoat;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(username);      <span style="color: #5cb85c;">// <span style="color: #98c379;">"ronaldo"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(goatAge);       <span style="color: #5cb85c;">// <span style="color: #c678dd;">40</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(alwaysTheGoat); <span style="color: #5cb85c;">// true</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> user = {
    name: <span style="color: #98c379;">"ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>,
    isGoat: true,
}

<span style="color: #5cb85c;">// Destructuring ke saath rename kar sakte ho</span>
<span style="color: #d19a66;">let</span> { name: username, age: goatAge, isGoat: alwaysTheGoat } = user;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(username);      <span style="color: #5cb85c;">// <span style="color: #98c379;">"ronaldo"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(goatAge);       <span style="color: #5cb85c;">// <span style="color: #c678dd;">40</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(alwaysTheGoat); <span style="color: #5cb85c;">// true</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Syntax: { propertyName: newVariableName } = object. Ek hi step mein extract aur rename!
                        <br><br>
                        <strong>🇬🇧 English:</strong> Syntax: { propertyName: newVariableName } = object. Extract and rename in one step!
                    </div>
                </div>
            </div>
            
            <!-- 3. Default Values -->
            <div class="comparison" id="topic-3">
                <h2 class="topic-title">3. Default Values (Agar property exist na kare)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> user = {
    name: <span style="color: #98c379;">"ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>,
}

<span style="color: #5cb85c;">// Ternary operator se check karna padta tha</span>
<span style="color: #d19a66;">let</span> country = user.country === undefined ? <span style="color: #98c379;">"Portugal"</span> : user.country;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(country); <span style="color: #5cb85c;">// <span style="color: #98c379;">"Portugal"</span></span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> user = {
    name: <span style="color: #98c379;">"ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>,
}

<span style="color: #5cb85c;">// Default value directly de sakte ho</span>
<span style="color: #d19a66;">let</span> { country = <span style="color: #98c379;">"Portugal"</span> } = user;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(country); <span style="color: #5cb85c;">// <span style="color: #98c379;">"Portugal"</span></span>

<span style="color: #5cb85c;">// Rename + Default value dono ek saath</span>
<span style="color: #d19a66;">let</span> { country: myCountry = <span style="color: #98c379;">"Portugal"</span> } = user;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(myCountry); <span style="color: #5cb85c;">// <span style="color: #98c379;">"Portugal"</span></span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Pehle object mein 'country' dhoondhega, nahi mila toh "Portugal" use karega.
                        <br><br>
                        <strong>🇬🇧 English:</strong> First it searches for 'country' in the object, if not found then uses "Portugal".
                    </div>
                </div>
            </div>
            
            <!-- 4. Function Parameters Destructuring -->
            <div class="comparison" id="topic-4">
                <h2 class="topic-title">4. Function Parameters Destructuring</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">greet</span>(obj) {
<span style="color: #5cb85c;">    // Function ke andar destructure karna padta tha</span>
    <span style="color: #d19a66;">let</span> name = obj.name;
    <span style="color: #d19a66;">let</span> age = obj.age;
    
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Name: "</span> + name + <span style="color: #98c379;">" | Age: "</span> + age);
}

<span style="color: #d19a66;">let</span> user = {
    name: <span style="color: #98c379;">"ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>
}

<span style="color: #e5c07b;">greet</span>(user); <span style="color: #5cb85c;">// Name: ronaldo | Age: <span style="color: #c678dd;">40</span></span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #5cb85c;">// Parameter mein hi destructure kar sakte ho</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">greet</span>({name, age}) {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`Name: ${name} | Age: ${age}`</span>);
}

<span style="color: #d19a66;">let</span> user = {
    name: <span style="color: #98c379;">"ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>
}

<span style="color: #e5c07b;">greet</span>(user); <span style="color: #5cb85c;">// Name: ronaldo | Age: <span style="color: #c678dd;">40</span></span>

<span style="color: #5cb85c;">// Rename bhi kar sakte ho</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">greet2</span>({name, age: myAge}) {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`Name: ${name} | Age: ${myAge}`</span>);
}

<span style="color: #e5c07b;">greet2</span>(user); <span style="color: #5cb85c;">// Name: ronaldo | Age: <span style="color: #c678dd;">40</span></span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Function definition mein hi clear ho jata hai ki kaunsi properties chahiye.
                        <br><br>
                        <strong>🇬🇧 English:</strong> The function definition makes it clear which properties are needed.
                    </div>
                </div>
            </div>
            
            <!-- 5. Array Destructuring -->
            <div class="comparison" id="topic-5">
                <h2 class="topic-title">5. Array Destructuring (Array se values nikalna)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> names = [<span style="color: #98c379;">"Neymar"</span>, <span style="color: #98c379;">"Messi"</span>, <span style="color: #98c379;">"Andrew"</span>];

<span style="color: #5cb85c;">// Index se manually access karna padta tha</span>
<span style="color: #d19a66;">let</span> prince = names[<span style="color: #c678dd;">0</span>];
<span style="color: #d19a66;">let</span> humble = names[<span style="color: #c678dd;">1</span>];
<span style="color: #d19a66;">let</span> spiderman = names[<span style="color: #c678dd;">2</span>];

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(prince);     <span style="color: #5cb85c;">// <span style="color: #98c379;">"Neymar"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(humble);     <span style="color: #5cb85c;">// <span style="color: #98c379;">"Messi"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(spiderman);  <span style="color: #5cb85c;">// <span style="color: #98c379;">"Andrew"</span></span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> names = [<span style="color: #98c379;">"Neymar"</span>, <span style="color: #98c379;">"Messi"</span>, <span style="color: #98c379;">"Andrew"</span>];

<span style="color: #5cb85c;">// Ek line mein saare nikal lo</span>
<span style="color: #d19a66;">let</span> [prince, humble, spiderman] = names;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(prince);     <span style="color: #5cb85c;">// <span style="color: #98c379;">"Neymar"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(humble);     <span style="color: #5cb85c;">// <span style="color: #98c379;">"Messi"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(spiderman);  <span style="color: #5cb85c;">// <span style="color: #98c379;">"Andrew"</span></span>

<span style="color: #5cb85c;">// Kuch skip bhi kar sakte ho (comma se)</span>
<span style="color: #d19a66;">let</span> [first, , third] = names;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(first);  <span style="color: #5cb85c;">// <span style="color: #98c379;">"Neymar"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(third);  <span style="color: #5cb85c;">// <span style="color: #98c379;">"Andrew"</span></span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Comma laga ke elements skip kar sakte ho! Position-based extraction hai.
                        <br><br>
                        <strong>🇬🇧 English:</strong> You can skip elements using commas! It's position-based extraction.
                    </div>
                </div>
            </div>
            
            <!-- 6. Spread Syntax - Arrays -->
            <div class="comparison" id="topic-6">
                <h2 class="topic-title">6. Spread Syntax - Arrays (... three dots)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> arr1 = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">70</span>];
<span style="color: #d19a66;">let</span> arr2 = [<span style="color: #c678dd;">100</span>, <span style="color: #c678dd;">200</span>, <span style="color: #c678dd;">300</span>];

<span style="color: #5cb85c;">// Loop se ek-ek karke add karna padta tha</span>
<span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> item <span style="color: #d19a66;">of</span> arr1) {
    arr2.<span style="color: #e5c07b;">push</span>(item);
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(arr2); 
<span style="color: #5cb85c;">// [100, 200, 300, 10, 20, 30, 70]</span>

<span style="color: #5cb85c;">// Copying ke liye</span>
<span style="color: #d19a66;">let</span> arr3 = [];
<span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> item <span style="color: #d19a66;">of</span> arr1) {
    arr3.<span style="color: #e5c07b;">push</span>(item);
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(arr3); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">70</span>]</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> arr1 = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">70</span>];
<span style="color: #d19a66;">let</span> arr2 = [<span style="color: #c678dd;">100</span>, <span style="color: #c678dd;">200</span>, <span style="color: #c678dd;">300</span>];

<span style="color: #5cb85c;">// Spread operator (...) - array ko expand kar deta hai</span>
<span style="color: #d19a66;">let</span> combined = [<span style="color: #c678dd;">100</span>, <span style="color: #c678dd;">200</span>, <span style="color: #c678dd;">300</span>, ...arr1, <span style="color: #c678dd;">900</span>];

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(combined); 
<span style="color: #5cb85c;">// [100, 200, 300, 10, 20, 30, 70, 900]</span>

<span style="color: #5cb85c;">// Copying - ek line mein!</span>
<span style="color: #d19a66;">let</span> arr3 = [...arr1];

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(arr3); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">70</span>]</span>

<span style="color: #5cb85c;">// Merging multiple arrays</span>
<span style="color: #d19a66;">let</span> arr4 = [<span style="color: #c678dd;">100</span>, <span style="color: #c678dd;">300</span>, <span style="color: #c678dd;">500</span>, <span style="color: #c678dd;">700</span>];
<span style="color: #d19a66;">let</span> arr5 = [<span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">5</span>, <span style="color: #c678dd;">7</span>];
<span style="color: #d19a66;">let</span> arr6 = [...arr4, ...arr5];

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(arr6); 
<span style="color: #5cb85c;">// [100, 300, 500, 700, 3, 5, 7]</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> ...arr1 matlab array ke saare elements ko individually nikal diya. [10, 20, 30, 70] ban gaya 10, 20, 30, 70
                        <br><br>
                        <strong>🇬🇧 English:</strong> ...arr1 means extracting all array elements individually. [10, 20, 30, 70] becomes 10, 20, 30, 70
                    </div>
                </div>
            </div>
            
            <!-- 7. Spread Syntax - Objects -->
            <div class="comparison" id="topic-7">
                <h2 class="topic-title">7. Spread Syntax - Objects</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> obj1 = {
    name: <span style="color: #98c379;">"elBicho"</span>,
    isGoat: true
}

<span style="color: #5cb85c;">// Manually properties copy karni padti thi</span>
<span style="color: #d19a66;">let</span> obj2 = {
    country: <span style="color: #98c379;">"portugal"</span>,
    name: obj1.name,
    isGoat: obj1.isGoat
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(obj2);
<span style="color: #5cb85c;">// { country: "portugal", name: "elBicho", isGoat: true }</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> obj1 = {
    name: <span style="color: #98c379;">"elBicho"</span>,
    isGoat: true
}

<span style="color: #5cb85c;">// Spread se saari properties copy ho jaayengi</span>
<span style="color: #d19a66;">let</span> obj2 = {
    country: <span style="color: #98c379;">"portugal"</span>,
    ...obj1,
    name: <span style="color: #98c379;">"Ronnie"</span> <span style="color: #5cb85c;">// Override kar sakte ho</span>
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(obj2);
<span style="color: #5cb85c;">// { country: "portugal", name: "Ronnie", isGoat: true }</span>

<span style="color: #5cb85c;">// IMPORTANT: Order matter karta hai!</span>
<span style="color: #d19a66;">let</span> obj3 = {
    country: <span style="color: #98c379;">"portugal"</span>,
    name: <span style="color: #98c379;">"Ronnie"</span>,  <span style="color: #5cb85c;">// Pehle yeh</span>
    ...obj1          <span style="color: #5cb85c;">// Baad mein spread, toh obj1 ka name override karega</span>
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(obj3);
<span style="color: #5cb85c;">// { country: "portugal", name: "elBicho", isGoat: true }</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Jo baad mein aata hai, woh override karta hai. Spread ke baad name likha toh woh final hoga.
                        <br><br>
                        <strong>🇬🇧 English:</strong> What comes later overrides. If you write name after spread, that will be final.
                    </div>
                </div>
            </div>
            
            <!-- 8. Spread in Function Calls -->
            <div class="comparison" id="topic-8">
                <h2 class="topic-title">8. Spread in Function Calls (Function arguments mein)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">max</span>(a, b, c, d) {
    <span style="color: #d19a66;">return</span> Math.<span style="color: #e5c07b;">max</span>(a, b, c, d);
}

<span style="color: #d19a66;">let</span> arr7 = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">70</span>];

<span style="color: #5cb85c;">// Har element ko manually pass karna padta tha</span>
<span style="color: #d19a66;">let</span> result = <span style="color: #e5c07b;">max</span>(arr7[<span style="color: #c678dd;">0</span>], arr7[<span style="color: #c678dd;">1</span>], arr7[<span style="color: #c678dd;">2</span>], arr7[<span style="color: #c678dd;">3</span>]);

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(result); <span style="color: #5cb85c;">// <span style="color: #c678dd;">70</span></span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">max</span>(a, b, c, d) {
    <span style="color: #d19a66;">return</span> Math.<span style="color: #e5c07b;">max</span>(a, b, c, d);
}

<span style="color: #d19a66;">let</span> arr7 = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">70</span>];

<span style="color: #5cb85c;">// Spread operator se array ko arguments mein convert kar do</span>
<span style="color: #d19a66;">let</span> result = <span style="color: #e5c07b;">max</span>(...arr7);

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(result); <span style="color: #5cb85c;">// <span style="color: #c678dd;">70</span></span>

<span style="color: #5cb85c;">// ...arr7 matlab:</span>
<span style="color: #5cb85c;">// max(10, 20, 50, 70)</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> ...arr7 array ko individual arguments mein expand kar deta hai!
                        <br><br>
                        <strong>🇬🇧 English:</strong> ...arr7 expands the array into individual arguments!
                    </div>
                </div>
            </div>
            
            <!-- 9. Rest Syntax - Arrays -->
            <div class="comparison" id="topic-9">
                <h2 class="topic-title">9. Rest Syntax - Arrays (Baaki sab collect karna)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> arr8 = [<span style="color: #c678dd;">100</span>, <span style="color: #c678dd;">200</span>, <span style="color: #c678dd;">300</span>];

<span style="color: #d19a66;">let</span> first = arr8[<span style="color: #c678dd;">0</span>];
<span style="color: #5cb85c;">// Baaki elements ke liye loop ya slice</span>
<span style="color: #d19a66;">let</span> rest = arr8.<span style="color: #e5c07b;">slice</span>(<span style="color: #c678dd;">1</span>);

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(first); <span style="color: #5cb85c;">// <span style="color: #c678dd;">100</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(rest);  <span style="color: #5cb85c;">// [<span style="color: #c678dd;">200</span>, <span style="color: #c678dd;">300</span>]</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> arr8 = [<span style="color: #c678dd;">100</span>, <span style="color: #c678dd;">200</span>, <span style="color: #c678dd;">300</span>];

<span style="color: #5cb85c;">// Rest operator - pehla element 'first' mein, baaki saare 'rest' array mein</span>
<span style="color: #d19a66;">let</span> [first, ...rest] = arr8;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(first); <span style="color: #5cb85c;">// <span style="color: #c678dd;">100</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(rest);  <span style="color: #5cb85c;">// [<span style="color: #c678dd;">200</span>, <span style="color: #c678dd;">300</span>]</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Spread (...) expand karta hai, Rest (...) collect karta hai! Same syntax, different context.
                        <br><br>
                        <strong>🇬🇧 English:</strong> Spread (...) expands, Rest (...) collects! Same syntax, different context.
                    </div>
                </div>
            </div>
            
            <!-- 10. Rest Syntax - Objects -->
            <div class="comparison" id="topic-10">
                <h2 class="topic-title">10. Rest Syntax - Objects (Baaki properties collect karna)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> obj4 = {
    name: <span style="color: #98c379;">"Ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>,
    isGoatForSure: true
}

<span style="color: #d19a66;">let</span> name = obj4.name;

<span style="color: #5cb85c;">// Baaki properties manually nikalni padti thi</span>
<span style="color: #d19a66;">let</span> rest = {
    age: obj4.age,
    isGoatForSure: obj4.isGoatForSure
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(name); <span style="color: #5cb85c;">// <span style="color: #98c379;">"Ronaldo"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(rest); <span style="color: #5cb85c;">// { age: <span style="color: #c678dd;">40</span>, isGoatForSure: true }</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #d19a66;">let</span> obj4 = {
    name: <span style="color: #98c379;">"Ronaldo"</span>,
    age: <span style="color: #c678dd;">40</span>,
    isGoatForSure: true
}

<span style="color: #5cb85c;">// 'name' ko alag nikala, baaki properties 'rest' object mein</span>
<span style="color: #d19a66;">let</span> { name, ...rest } = obj4;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(name); <span style="color: #5cb85c;">// <span style="color: #98c379;">"Ronaldo"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(rest); <span style="color: #5cb85c;">// { age: <span style="color: #c678dd;">40</span>, isGoatForSure: true }</span>

<span style="color: #5cb85c;">// Rename kar ke bhi collect kar sakte ho</span>
<span style="color: #d19a66;">let</span> { name: playerName, ...remaining } = obj4;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(playerName); <span style="color: #5cb85c;">// <span style="color: #98c379;">"Ronaldo"</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(remaining);  <span style="color: #5cb85c;">// { age: <span style="color: #c678dd;">40</span>, isGoatForSure: true }</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Jab ek property ko exclude karke baaki sab chahiye, tab rest operator use karo.
                        <br><br>
                        <strong>🇬🇧 English:</strong> When you want to exclude one property and keep all others, use the rest operator.
                    </div>
                </div>
            </div>
            
            <!-- 11. Rest Parameters in Functions -->
            <div class="comparison" id="topic-11">
                <h2 class="topic-title">11. Rest Parameters (Variable number of arguments)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Syntax (ES5)</h3>
                    <pre><code><span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">sum</span>() {
<span style="color: #5cb85c;">    // 'arguments' object use karna padta tha</span>
<span style="color: #5cb85c;">    // Yeh real array nahi hai</span>
    <span style="color: #d19a66;">let</span> total = <span style="color: #c678dd;">0</span>;
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < arguments.length; i++) {
        total += arguments[i];
    }
    <span style="color: #d19a66;">return</span> total;
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">sum</span>(<span style="color: #c678dd;">1</span>));              <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">sum</span>(<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>));     <span style="color: #5cb85c;">// <span style="color: #c678dd;">60</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">sum</span>(<span style="color: #c678dd;">40</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">60</span>, <span style="color: #c678dd;">70</span>)); <span style="color: #5cb85c;">// <span style="color: #c678dd;">220</span></span></code></pre>
                    <div class="note">
                        <strong>Problem:</strong> 'arguments' ek array-like object hai, real array nahi. Array methods nahi use kar sakte directly.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ New Syntax (ES6)</h3>
                    <pre><code><span style="color: #5cb85c;">// Rest parameter - saare arguments ek array mein aayenge</span>
<span style="color: #d19a66;">let</span> sum = (...rest) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(rest); <span style="color: #5cb85c;">// Real array hai!</span>
    
<span style="color: #5cb85c;">    // Array methods use kar sakte ho</span>
    <span style="color: #d19a66;">return</span> rest.<span style="color: #e5c07b;">reduce</span>((acc, num) <span style="color: #ffffff;">=></span> acc + num, <span style="color: #c678dd;">0</span>);
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">sum</span>(<span style="color: #c678dd;">1</span>));                    <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">sum</span>(<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>));           <span style="color: #5cb85c;">// <span style="color: #c678dd;">60</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">sum</span>(<span style="color: #c678dd;">40</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">60</span>, <span style="color: #c678dd;">70</span>, <span style="color: #c678dd;">80</span>));   <span style="color: #5cb85c;">// <span style="color: #c678dd;">300</span></span>

<span style="color: #5cb85c;">// Example with mixed parameters</span>
<span style="color: #d19a66;">let</span> greetAll = (greeting, ...names) <span style="color: #ffffff;">=></span> {
    names.<span style="color: #e5c07b;">forEach</span>(name <span style="color: #ffffff;">=></span> {
        <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`${greeting}, ${name}!`</span>);
    });
}

<span style="color: #e5c07b;">greetAll</span>(<span style="color: #98c379;">"Hello"</span>, <span style="color: #98c379;">"Ronaldo"</span>, <span style="color: #98c379;">"Messi"</span>, <span style="color: #98c379;">"Neymar"</span>);
<span style="color: #5cb85c;">// Hello, Ronaldo!</span>
<span style="color: #5cb85c;">// Hello, Messi!</span>
<span style="color: #5cb85c;">// Hello, Neymar!</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Rest parameter hamesha last mein hona chahiye. (...rest, name) - ❌ Wrong! Real array milta hai toh saare array methods use kar sakte ho.
                        <br><br>
                        <strong>🇬🇧 English:</strong> Rest parameter must always be last. (...rest, name) - ❌ Wrong! You get a real array so you can use all array methods.
                    </div>
                </div>
            </div>
            
            <!-- 12. Rest vs Spread (Key Differences) -->
            <div class="comparison" id="topic-12">
                <h2 class="topic-title">12. Rest vs Spread (Key Differences)</h2>
                <div class="old-syntax">
                    <h3>❌ Confusion: Same syntax, different meaning</h3>
                    <pre><code><span style="color: #5cb85c;">// Dono mein ... lagta hai – confusion hoti hai</span>
<span style="color: #5cb85c;">// Spread: ... array ko expand karta hai</span>
<span style="color: #5cb85c;">// Rest  : ... remaining values ko collect karta hai</span>

<span style="color: #5cb85c;">// WRONG: Rest ko right side use nahi kar sakte</span>
<span style="color: #d19a66;">let</span> wrong = [<span style="color: #c678dd;">1</span>, ...rest];  <span style="color: #5cb85c;">// ❌ 'rest' is not defined</span>

<span style="color: #5cb85c;">// WRONG: Spread ko assignment left side use nahi kar sakte</span>
<span style="color: #d19a66;">let</span> [...spread] = [<span style="color: #c678dd;">1</span>,<span style="color: #c678dd;">2</span>,<span style="color: #c678dd;">3</span>]; <span style="color: #5cb85c;">// ❌ This is REST, not spread</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ Clear Difference</h3>
                    <pre><code><span style="color: #5cb85c;">/* ========= SPREAD ========= */</span>
<span style="color: #5cb85c;">// SPREAD expands an array/object into individual elements</span>
<span style="color: #5cb85c;">// Uses: Right side of = , function calls, array/object literals</span>
<span style="color: #d19a66;">let</span> arr = [<span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">3</span>];
<span style="color: #d19a66;">let</span> copy = [...arr];          <span style="color: #5cb85c;">// ✅ Spread: arr expands to 1,2,3</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(...arr);          <span style="color: #5cb85c;">// ✅ Spread in function call</span>

<span style="color: #5cb85c;">/* ========= REST ========= */</span>
<span style="color: #5cb85c;">// REST collects remaining items into a single array/object</span>
<span style="color: #5cb85c;">// Uses: Left side of = (destructuring), function parameters</span>
<span style="color: #d19a66;">let</span> [first, ...remaining] = arr;  <span style="color: #5cb85c;">// ✅ REST: remaining = [2,3]</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">test</span>(a, ...rest) {}      <span style="color: #5cb85c;">// ✅ REST parameters</span>

<span style="color: #5cb85c;">/* ========= QUICK RULE ========= */</span>
<span style="color: #5cb85c;">// ✅ Spread = expands / unpacks</span>
<span style="color: #5cb85c;">// ✅ Rest   = collects / packs</span>
<span style="color: #5cb85c;">// Spread is the 'giver', Rest is the 'taker'</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Spread (...) array/object ko element-wise expand karta hai (bikharta hai). Rest (...) elements/properties ko ikattha karta hai (collect karta hai). Spread right side pe, Rest left side pe ya function parameter mein.
                        <br><br>
                        <strong>🇬🇧 English:</strong> Spread (...) expands an array/object into individual elements. Rest (...) collects multiple elements/properties into one. Spread is used on the right side of = or in values; Rest is used in destructuring (left side) or function parameters.
                    </div>
                </div>
            </div>
            
            <!-- 13. forEach Method -->
            <div class="comparison" id="topic-13">
                <h2 class="topic-title">13. forEach Method (Array ke har element pe operation karna)</h2>
                <div class="old-syntax">
                    <h3>❌ Old Way (Manual Loop)</h3>
                    <pre><code><span style="color: #5cb85c;">// For loop se manually iterate karna</span>
<span style="color: #d19a66;">let</span> arr = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">70</span>];

<span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < arr.length; i++) {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(arr[i]);
}
<span style="color: #5cb85c;">// Output: 10, 30, 50, 70</span>

<span style="color: #5cb85c;">// For...of loop</span>
<span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> item <span style="color: #d19a66;">of</span> arr) {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(item);
}
<span style="color: #5cb85c;">// Output: 10, 30, 50, 70</span></code></pre>
                    <div class="note">
                        <strong>Problem:</strong> Har baar loop likhna padta hai. forEach cleaner aur more readable hai.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Using forEach Method</h3>
                    <pre><code><span style="color: #5cb85c;">// Built-in forEach method</span>
<span style="color: #d19a66;">let</span> arr = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">70</span>];

arr.<span style="color: #e5c07b;">forEach</span>((element) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(element);
});
<span style="color: #5cb85c;">// Output: 10, 30, 50, 70</span>

<span style="color: #5cb85c;">// forEach provides element, index, and array</span>
arr.<span style="color: #e5c07b;">forEach</span>((element, index, array) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`Index ${index}: ${element}`</span>);
});
<span style="color: #5cb85c;">// Output:</span>
<span style="color: #5cb85c;">// Index 0: 10</span>
<span style="color: #5cb85c;">// Index 1: 30</span>
<span style="color: #5cb85c;">// Index 2: 50</span>
<span style="color: #5cb85c;">// Index 3: 70</span>

<span style="color: #5cb85c;">// Example: Extract first names</span>
<span style="color: #d19a66;">let</span> players = [<span style="color: #98c379;">"Cristiano Ronaldo"</span>, <span style="color: #98c379;">"Leo Messi"</span>, <span style="color: #98c379;">"Neymar Jr"</span>, <span style="color: #98c379;">"Mesut Ozil"</span>];

players.<span style="color: #e5c07b;">forEach</span>((fullName) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">let</span> firstName = fullName.<span style="color: #e5c07b;">split</span>(<span style="color: #98c379;">" "</span>)[<span style="color: #c678dd;">0</span>];
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(firstName);
});
<span style="color: #5cb85c;">// Output: Cristiano, Leo, Neymar, Mesut</span>

<span style="color: #5cb85c;">// Creating Custom forEach</span>
<span style="color: #d19a66;">let</span> customForEach = (arr, callback) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < arr.length; i++) {
        <span style="color: #e5c07b;">callback</span>(arr[i], i, arr);
    }
};

<span style="color: #5cb85c;">// Using custom forEach</span>
<span style="color: #e5c07b;">customForEach</span>([<span style="color: #c678dd;">5</span>, <span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">15</span>], (element, index) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`Element: ${element}, Index: ${index}`</span>);
});
<span style="color: #5cb85c;">// Output:</span>
<span style="color: #5cb85c;">// Element: 5, Index: 0</span>
<span style="color: #5cb85c;">// Element: 10, Index: 1</span>
<span style="color: #5cb85c;">// Element: 15, Index: 2</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> forEach array ke har element pe callback function run karta hai. Return value nahi hota, sirf side effects ke liye use hota hai (like console.log, DOM manipulation). Callback ko 3 arguments milte hain: element, index, aur pura array.
                        <br><br>
                        <strong>🇬🇧 English:</strong> forEach runs a callback function on each element of the array. It doesn't return a value, it's used only for side effects (like console.log, DOM manipulation). The callback receives 3 arguments: element, index, and the full array.
                    </div>
                </div>
            </div>
            
            <!-- 14. map Method -->
            <div class="comparison" id="topic-14">
                <h2 class="topic-title">14. map Method (Har element ko transform karke naya array banana)</h2>
                <div class="old-syntax">
                    <h3>❌ Manual Transformation</h3>
                    <pre><code><span style="color: #5cb85c;">// Loop se manually naya array banana</span>
<span style="color: #d19a66;">let</span> numbers = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">40</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">60</span>, <span style="color: #c678dd;">70</span>];
<span style="color: #d19a66;">let</span> areas = [];

<span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < numbers.length; i++) {
    areas.<span style="color: #e5c07b;">push</span>(<span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * numbers[i] * numbers[i]);
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(areas);
<span style="color: #5cb85c;">// [314, 1256, 2826, 5024, 7850, 11304, 15386]</span>

<span style="color: #5cb85c;">// String lengths</span>
<span style="color: #d19a66;">let</span> heroes = [<span style="color: #98c379;">"Batman"</span>, <span style="color: #98c379;">"Superman"</span>, <span style="color: #98c379;">"Flash"</span>, <span style="color: #98c379;">"Darkseid"</span>, <span style="color: #98c379;">"Wonder woman"</span>];
<span style="color: #d19a66;">let</span> lengths = [];

<span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < heroes.length; i++) {
    lengths.<span style="color: #e5c07b;">push</span>(heroes[i].length);
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(lengths); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">6</span>, <span style="color: #c678dd;">8</span>, <span style="color: #c678dd;">5</span>, <span style="color: #c678dd;">8</span>, <span style="color: #c678dd;">12</span>]</span></code></pre>
                    <div class="note">
                        <strong>Problem:</strong> Har transformation ke liye manually loop aur empty array banana padta hai.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Using map Method</h3>
                    <pre><code><span style="color: #5cb85c;">// Built-in map method - calculates areas</span>
<span style="color: #d19a66;">let</span> numbers = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">40</span>, <span style="color: #c678dd;">50</span>, <span style="color: #c678dd;">60</span>, <span style="color: #c678dd;">70</span>];

<span style="color: #d19a66;">let</span> areas = numbers.<span style="color: #e5c07b;">map</span>((radius) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> <span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * radius * radius;
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(areas);
<span style="color: #5cb85c;">// [314, 1256, 2826, 5024, 7850, 11304, 15386]</span>

<span style="color: #5cb85c;">// Shorter version</span>
<span style="color: #d19a66;">let</span> areas2 = numbers.<span style="color: #e5c07b;">map</span>(r <span style="color: #ffffff;">=></span> <span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * r * r);

<span style="color: #5cb85c;">// String lengths</span>
<span style="color: #d19a66;">let</span> heroes = [<span style="color: #98c379;">"Batman"</span>, <span style="color: #98c379;">"Superman"</span>, <span style="color: #98c379;">"Flash"</span>, <span style="color: #98c379;">"Darkseid"</span>, <span style="color: #98c379;">"Wonder woman"</span>];

<span style="color: #d19a66;">let</span> lengths = heroes.<span style="color: #e5c07b;">map</span>((hero) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> hero.length;
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(lengths); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">6</span>, <span style="color: #c678dd;">8</span>, <span style="color: #c678dd;">5</span>, <span style="color: #c678dd;">8</span>, <span style="color: #c678dd;">12</span>]</span>

<span style="color: #5cb85c;">// Even shorter</span>
<span style="color: #d19a66;">let</span> lengths2 = heroes.<span style="color: #e5c07b;">map</span>(h <span style="color: #ffffff;">=></span> h.length);

<span style="color: #5cb85c;">// Extract names from objects</span>
<span style="color: #d19a66;">let</span> players = [
    {name: <span style="color: #98c379;">"messi"</span>, isGoat: false},
    {name: <span style="color: #98c379;">"ronnie"</span>, isGoat: true},
    {name: <span style="color: #98c379;">"dumfries"</span>, isGoat: true},
];

<span style="color: #d19a66;">let</span> names = players.<span style="color: #e5c07b;">map</span>((player) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> player.name;
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(names); <span style="color: #5cb85c;">// [<span style="color: #98c379;">"messi"</span>, <span style="color: #98c379;">"ronnie"</span>, <span style="color: #98c379;">"dumfries"</span>]</span>

<span style="color: #5cb85c;">// Shortest version</span>
<span style="color: #d19a66;">let</span> names2 = players.<span style="color: #e5c07b;">map</span>(p <span style="color: #ffffff;">=></span> p.name);

<span style="color: #5cb85c;">// Creating Custom map</span>
<span style="color: #d19a66;">let</span> customMap = (arr, callback) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">let</span> result = [];
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < arr.length; i++) {
        result.<span style="color: #e5c07b;">push</span>(<span style="color: #e5c07b;">callback</span>(arr[i], i, arr));
    }
    <span style="color: #d19a66;">return</span> result;
};

<span style="color: #5cb85c;">// Using custom map</span>
<span style="color: #d19a66;">let</span> doubled = <span style="color: #e5c07b;">customMap</span>([<span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">4</span>], x <span style="color: #ffffff;">=></span> x * <span style="color: #c678dd;">2</span>);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(doubled); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">4</span>, <span style="color: #c678dd;">6</span>, <span style="color: #c678dd;">8</span>]</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> map() ek naya array return karta hai jisme har element transform ho chuka hota hai. Original array same rehta hai. Callback se jo return hoga, woh naye array mein push ho jayega. React mein bahut use hota hai!
                        <br><br>
                        <strong>🇬🇧 English:</strong> map() returns a new array where each element has been transformed. The original array stays the same. Whatever the callback returns gets pushed into the new array. Very commonly used in React!
                    </div>
                </div>
            </div>
            
            <!-- 15. find Method -->
            <div class="comparison" id="topic-15">
                <h2 class="topic-title">15. find Method (Pehla matching element dhoondhna)</h2>
                <div class="old-syntax">
                    <h3>❌ Manual Search with Loop</h3>
                    <pre><code><span style="color: #5cb85c;">// Loop se pehla element dhoondhna</span>
<span style="color: #d19a66;">let</span> numbers = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">11</span>, <span style="color: #c678dd;">7</span>, <span style="color: #c678dd;">9</span>];
<span style="color: #d19a66;">let</span> result;

<span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < numbers.length; i++) {
    <span style="color: #d19a66;">if</span> (numbers[i] < <span style="color: #c678dd;">8</span>) {
        result = numbers[i];
        <span style="color: #d19a66;">break</span>; <span style="color: #5cb85c;">// Pehla mil gaya toh stop</span>
    }
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(result); <span style="color: #5cb85c;">// <span style="color: #c678dd;">7</span></span>

<span style="color: #5cb85c;">// Object array mein search</span>
<span style="color: #d19a66;">let</span> players = [
    {name: <span style="color: #98c379;">"messi"</span>, isOwner: false},
    {name: <span style="color: #98c379;">"ronnie"</span>, isOwner: true},
    {name: <span style="color: #98c379;">"dumfries"</span>, isOwner: true},
];

<span style="color: #d19a66;">let</span> owner;
<span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < players.length; i++) {
    <span style="color: #d19a66;">if</span> (players[i].isOwner === true) {
        owner = players[i];
        <span style="color: #d19a66;">break</span>;
    }
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(owner); <span style="color: #5cb85c;">// {name: <span style="color: #98c379;">"ronnie"</span>, isOwner: true}</span></code></pre>
                    <div class="note">
                        <strong>Problem:</strong> Manually loop likhna, condition check karna, aur break statement yaad rakhna padta hai.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Using find Method</h3>
                    <pre><code><span style="color: #5cb85c;">// Built-in find method</span>
<span style="color: #d19a66;">let</span> numbers = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">11</span>, <span style="color: #c678dd;">7</span>, <span style="color: #c678dd;">9</span>];

<span style="color: #d19a66;">let</span> result = numbers.<span style="color: #e5c07b;">find</span>((x) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (x < <span style="color: #c678dd;">8</span>) {
        <span style="color: #d19a66;">return</span> true;
    } <span style="color: #d19a66;">else</span> {
        <span style="color: #d19a66;">return</span> false;
    }
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(result); <span style="color: #5cb85c;">// <span style="color: #c678dd;">7</span></span>

<span style="color: #5cb85c;">// Shorter version</span>
<span style="color: #d19a66;">let</span> result2 = numbers.<span style="color: #e5c07b;">find</span>(x <span style="color: #ffffff;">=></span> x < <span style="color: #c678dd;">8</span>);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(result2); <span style="color: #5cb85c;">// <span style="color: #c678dd;">7</span></span>

<span style="color: #5cb85c;">// Finding in object array</span>
<span style="color: #d19a66;">let</span> players = [
    {name: <span style="color: #98c379;">"messi"</span>, isOwner: false},
    {name: <span style="color: #98c379;">"ronnie"</span>, isOwner: true},
    {name: <span style="color: #98c379;">"dumfries"</span>, isOwner: true},
];

<span style="color: #d19a66;">let</span> owner = players.<span style="color: #e5c07b;">find</span>((player) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> player.isOwner === true;
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(owner); <span style="color: #5cb85c;">// {name: <span style="color: #98c379;">"ronnie"</span>, isOwner: true}</span>

<span style="color: #5cb85c;">// Shortest version</span>
<span style="color: #d19a66;">let</span> owner2 = players.<span style="color: #e5c07b;">find</span>(p <span style="color: #ffffff;">=></span> p.isOwner);

<span style="color: #5cb85c;">// If not found, returns undefined</span>
<span style="color: #d19a66;">let</span> notFound = numbers.<span style="color: #e5c07b;">find</span>(x <span style="color: #ffffff;">=></span> x > <span style="color: #c678dd;">100</span>);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(notFound); <span style="color: #5cb85c;">// undefined</span>

<span style="color: #5cb85c;">// Creating Custom find using filter</span>
<span style="color: #d19a66;">let</span> customFind = (arr, callback) <span style="color: #ffffff;">=></span> {
<span style="color: #5cb85c;">    // filter se pehla element return kar do</span>
    <span style="color: #d19a66;">return</span> arr.<span style="color: #e5c07b;">filter</span>(callback)[<span style="color: #c678dd;">0</span>];
};

<span style="color: #5cb85c;">// Better custom find</span>
<span style="color: #d19a66;">let</span> customFind2 = (arr, callback) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < arr.length; i++) {
        <span style="color: #d19a66;">if</span> (<span style="color: #e5c07b;">callback</span>(arr[i], i, arr)) {
            <span style="color: #d19a66;">return</span> arr[i]; <span style="color: #5cb85c;">// Pehla match milte hi return</span>
        }
    }
    <span style="color: #d19a66;">return</span> undefined; <span style="color: #5cb85c;">// Kuch nahi mila</span>
};

<span style="color: #5cb85c;">// Using custom find</span>
<span style="color: #d19a66;">let</span> found = <span style="color: #e5c07b;">customFind2</span>([<span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">5</span>, <span style="color: #c678dd;">8</span>, <span style="color: #c678dd;">12</span>], x <span style="color: #ffffff;">=></span> x > <span style="color: #c678dd;">7</span>);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(found); <span style="color: #5cb85c;">// <span style="color: #c678dd;">8</span></span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> find() pehla element return karta hai jo condition ko satisfy kare. Agar koi element nahi mila toh undefined return hota hai. Sirf pehla element chahiye toh find() use karo, saare chahiye toh filter() use karo.
                        <br><br>
                        <strong>🇬🇧 English:</strong> find() returns the first element that satisfies the condition. If no element is found, it returns undefined. Use find() when you need only the first element, use filter() when you need all matching elements.
                    </div>
                </div>
            </div>
            
            <!-- 16. sort Method -->
            <div class="comparison" id="topic-16">
                <h2 class="topic-title">16. sort Method (Array ko sort karna)</h2>
                <div class="old-syntax">
                    <h3>❌ Default Sorting Issues</h3>
                    <pre><code><span style="color: #5cb85c;">// String array - works fine</span>
<span style="color: #d19a66;">let</span> fruits = [<span style="color: #98c379;">"banana"</span>, <span style="color: #98c379;">"apple"</span>, <span style="color: #98c379;">"mango"</span>, <span style="color: #98c379;">"kiwi"</span>];
fruits.<span style="color: #e5c07b;">sort</span>();
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(fruits);
<span style="color: #5cb85c;">// ["apple", "banana", "kiwi", "mango"] ✅</span>

<span style="color: #5cb85c;">// Number array - WRONG RESULTS!</span>
<span style="color: #d19a66;">let</span> numbers = [<span style="color: #98c379;">"<span style="color: #c678dd;">1</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">2</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">10</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">20</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">3</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">7</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">60</span>"</span>];
numbers.<span style="color: #e5c07b;">sort</span>();
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(numbers);
<span style="color: #5cb85c;">// ["1", "10", "2", "20", "3", "60", "7"] ❌</span>
<span style="color: #5cb85c;">// Yeh alphabetically sort kar raha hai, numerically nahi!</span>

<span style="color: #5cb85c;">// Actual numbers bhi string ki tarah sort hote hain</span>
<span style="color: #d19a66;">let</span> nums = [<span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">7</span>, <span style="color: #c678dd;">60</span>];
nums.<span style="color: #e5c07b;">sort</span>();
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(nums);
<span style="color: #5cb85c;">// [1, 10, 2, 20, 3, 60, 7] ❌ Wrong!</span>

<span style="color: #5cb85c;">// WHY? Default sort converts everything to STRING</span>
<span style="color: #5cb85c;">// Then compares DIGIT BY DIGIT (character by character)</span>

<span style="color: #5cb85c;">// Example: Why "10" comes before "2"?</span>
<span style="color: #5cb85c;">// "1" vs "2" → "1" < "2" → so "10" comes first!</span>
<span style="color: #5cb85c;">// "10" = "1" + "0"</span>
<span style="color: #5cb85c;">// "2" = "2"</span>
<span style="color: #5cb85c;">// Compare: "1" vs "2" → "1" wins!</span>

<span style="color: #5cb85c;">// Another example: Why "60" comes before "7"?</span>
<span style="color: #5cb85c;">// "6" vs "7" → "6" < "7" → so "60" comes first!</span>

<span style="color: #5cb85c;">// IMPORTANT: No argument = String conversion + digit-wise comparison!</span>
<span style="color: #d19a66;">let</span> mixed = [<span style="color: #c678dd;">100</span>, <span style="color: #c678dd;">21</span>, <span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">45</span>, <span style="color: #c678dd;">7</span>];
mixed.<span style="color: #e5c07b;">sort</span>(); <span style="color: #5cb85c;">// NO COMPARATOR!</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(mixed);
<span style="color: #5cb85c;">// [100, 21, 3, 45, 7]</span>
<span style="color: #5cb85c;">// Why? "1" < "2" < "3" < "4" < "7"</span>
<span style="color: #5cb85c;">// "100" starts with "1"</span>
<span style="color: #5cb85c;">// "21" starts with "2" </span>
<span style="color: #5cb85c;">// "3" starts with "3"</span>
<span style="color: #5cb85c;">// "45" starts with "4"</span>
<span style="color: #5cb85c;">// "7" starts with "7"</span></code></pre>
                    <div class="note">
                        <strong>Problem:</strong> sort() by default sab kuch string mein convert karta hai aur DIGIT-WISE (character-by-character) compare karta hai, numerical comparison nahi! Numbers ke liye comparator function MUST chahiye!
                        <br><br>
                        <strong>Default Behavior:</strong>
                        <br>1. Har element ko string mein convert karo
                        <br>2. Pehla character compare karo
                        <br>3. Agar same hai toh next character compare karo
                        <br>4. Unicode value se comparison hoti hai
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Correct Sorting with Comparator</h3>
                    <pre><code><span style="color: #5cb85c;">// DEFAULT BEHAVIOR (NO COMPARATOR):</span>
<span style="color: #5cb85c;">// sort() converts to string and compares character-by-character</span>

<span style="color: #5cb85c;">// Example to understand default behavior:</span>
<span style="color: #d19a66;">let</span> test = [<span style="color: #c678dd;">100</span>, <span style="color: #c678dd;">21</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">4</span>];
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(test.<span style="color: #e5c07b;">sort</span>()); 
<span style="color: #5cb85c;">// [100, 21, 30, 4]</span>
<span style="color: #5cb85c;">// "1" < "2" < "3" < "4"</span>

<span style="color: #5cb85c;">// Step-by-step comparison:</span>
<span style="color: #5cb85c;">// "100" vs "21" → Compare "1" vs "2" → "1" < "2" → "100" first</span>
<span style="color: #5cb85c;">// "21" vs "30" → Compare "2" vs "3" → "2" < "3" → "21" first  </span>
<span style="color: #5cb85c;">// "30" vs "4" → Compare "3" vs "4" → "3" < "4" → "30" first</span>

<span style="color: #5cb85c;">// ============================================</span>
<span style="color: #5cb85c;">// COMPARATOR FUNCTION - How it works:</span>
<span style="color: #5cb85c;">// ============================================</span>
<span style="color: #5cb85c;">// sort() ka comparator function 3 values return kar sakta hai:</span>
<span style="color: #5cb85c;">// Negative (-1): a ko b se pehle rakho (a, b)</span>
<span style="color: #5cb85c;">// Positive (+1): b ko a se pehle rakho (b, a)</span>
<span style="color: #5cb85c;">// Zero (0): order same rakho (a, b)</span>

<span style="color: #5cb85c;">// Correct numeric sorting</span>
<span style="color: #d19a66;">let</span> numbers = [<span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">7</span>, <span style="color: #c678dd;">60</span>];

numbers.<span style="color: #e5c07b;">sort</span>((a, b) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (a < b) <span style="color: #d19a66;">return</span> -<span style="color: #c678dd;">1</span>;  <span style="color: #5cb85c;">// a pehle</span>
    <span style="color: #d19a66;">if</span> (a > b) <span style="color: #d19a66;">return</span> +<span style="color: #c678dd;">1</span>;  <span style="color: #5cb85c;">// b pehle</span>
    <span style="color: #d19a66;">return</span> <span style="color: #c678dd;">0</span>;              <span style="color: #5cb85c;">// same</span>
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(numbers);
<span style="color: #5cb85c;">// [1, 2, 3, 7, 10, 20, 60] ✅ Correct!</span>

<span style="color: #5cb85c;">// Shortcut for numbers (ascending)</span>
numbers.<span style="color: #e5c07b;">sort</span>((a, b) <span style="color: #ffffff;">=></span> a - b);
<span style="color: #5cb85c;">// How it works:</span>
<span style="color: #5cb85c;">// If a = 3, b = 7 → 3 - 7 = -4 (negative) → a first</span>
<span style="color: #5cb85c;">// If a = 10, b = 5 → 10 - 5 = 5 (positive) → b first</span>
<span style="color: #5cb85c;">// If a = 5, b = 5 → 5 - 5 = 0 → same order</span>

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(numbers); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">7</span>, <span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">60</span>]</span>

<span style="color: #5cb85c;">// Descending order</span>
numbers.<span style="color: #e5c07b;">sort</span>((a, b) <span style="color: #ffffff;">=></span> b - a);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(numbers); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">60</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">7</span>, <span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">1</span>]</span>

<span style="color: #5cb85c;">// String array with numbers</span>
<span style="color: #d19a66;">let</span> strNumbers = [<span style="color: #98c379;">"<span style="color: #c678dd;">1</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">2</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">10</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">20</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">3</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">7</span>"</span>, <span style="color: #98c379;">"<span style="color: #c678dd;">60</span>"</span>];

strNumbers.<span style="color: #e5c07b;">sort</span>((a, b) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (<span style="color: #e5c07b;">Number</span>(a) < <span style="color: #e5c07b;">Number</span>(b)) <span style="color: #d19a66;">return</span> -<span style="color: #c678dd;">1</span>;
    <span style="color: #d19a66;">if</span> (<span style="color: #e5c07b;">Number</span>(a) > <span style="color: #e5c07b;">Number</span>(b)) <span style="color: #d19a66;">return</span> +<span style="color: #c678dd;">1</span>;
    <span style="color: #d19a66;">return</span> <span style="color: #c678dd;">0</span>;
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(strNumbers);
<span style="color: #5cb85c;">// ["1", "2", "3", "7", "10", "20", "60"] ✅</span>

<span style="color: #5cb85c;">// Sorting objects by property</span>
<span style="color: #d19a66;">let</span> players = [
    {name: <span style="color: #98c379;">"Ronaldo"</span>, goals: <span style="color: #c678dd;">900</span>},
    {name: <span style="color: #98c379;">"Messi"</span>, goals: <span style="color: #c678dd;">850</span>},
    {name: <span style="color: #98c379;">"Pele"</span>, goals: <span style="color: #c678dd;">757</span>}
];

<span style="color: #5cb85c;">// Sort by goals (ascending)</span>
players.<span style="color: #e5c07b;">sort</span>((a, b) <span style="color: #ffffff;">=></span> a.goals - b.goals);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(players);
<span style="color: #5cb85c;">// [{Pele: 757}, {Messi: 850}, {Ronaldo: 900}]</span>

<span style="color: #5cb85c;">// Sort by goals (descending)</span>
players.<span style="color: #e5c07b;">sort</span>((a, b) <span style="color: #ffffff;">=></span> b.goals - a.goals);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(players);
<span style="color: #5cb85c;">// [{Ronaldo: 900}, {Messi: 850}, {Pele: 757}]</span>

<span style="color: #5cb85c;">// Sort by name (alphabetically)</span>
players.<span style="color: #e5c07b;">sort</span>((a, b) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (a.name < b.name) <span style="color: #d19a66;">return</span> -<span style="color: #c678dd;">1</span>;
    <span style="color: #d19a66;">if</span> (a.name > b.name) <span style="color: #d19a66;">return</span> +<span style="color: #c678dd;">1</span>;
    <span style="color: #d19a66;">return</span> <span style="color: #c678dd;">0</span>;
});

<span style="color: #5cb85c;">// IMPORTANT: sort() modifies original array!</span>
<span style="color: #d19a66;">let</span> original = [<span style="color: #c678dd;">3</span>, <span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">2</span>];
original.<span style="color: #e5c07b;">sort</span>((a, b) <span style="color: #ffffff;">=></span> a - b);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(original); <span style="color: #5cb85c;">// [<span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">3</span>] - original changed!</span>

<span style="color: #5cb85c;">// ============================================</span>
<span style="color: #5cb85c;">// KEY POINTS SUMMARY:</span>
<span style="color: #5cb85c;">// ============================================</span>
<span style="color: #5cb85c;">// ❌ NO COMPARATOR → String conversion → Digit-wise</span>
<span style="color: #5cb85c;">// ✅ WITH COMPARATOR → Custom logic → Proper sorting</span>
<span style="color: #5cb85c;">// </span>
<span style="color: #5cb85c;">// For Numbers:</span>
<span style="color: #5cb85c;">// • Ascending: (a, b) => a - b</span>
<span style="color: #5cb85c;">// • Descending: (a, b) => b - a</span>
<span style="color: #5cb85c;">// </span>
<span style="color: #5cb85c;">// For Strings:</span>
<span style="color: #5cb85c;">// • Default sort() works fine!</span>
<span style="color: #5cb85c;">// </span>
<span style="color: #5cb85c;">// For Objects:</span>
<span style="color: #5cb85c;">// • Use comparator to compare properties</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> BINA COMPARATOR ke sort() sab kuch string mein convert karke digit-by-digit compare karta hai. "10" aur "2" ko compare kare toh "1" vs "2" dekhega, isliye "10" pehle aa jata hai! Numbers ke liye HAMESHA comparator use karo: (a, b) => a - b for ascending. sort() original array ko modify karta hai!
                        <br><br>
                        <strong>🇬🇧 English:</strong> WITHOUT a comparator, sort() converts everything to strings and compares digit-by-digit (character-by-character). When comparing "10" and "2", it looks at "1" vs "2", so "10" comes first! For numbers, ALWAYS use a comparator: (a, b) => a - b for ascending. sort() modifies the original array!
                    </div>
                </div>
            </div>
            
            <!-- 17. setTimeout - basics (Hinglish + English) -->
            <div class="comparison" id="topic-17">
                <h2 class="topic-title">17. setTimeout - basics</h2>
                <div class="old-syntax">
                    <h3>❌ Confusion: args, optional third arg</h3>
                    <pre><code><span style="color: #5cb85c;">// setTimeout(                         // teen args jayenge third arg is optional</span>
<span style="color: #5cb85c;">//     ()=>{console.log("Hello from setTimeout!"); },</span>
<span style="color: #5cb85c;">//     5000,</span>
<span style="color: #5cb85c;">// )</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ setTimeout - correct usage</h3>
                    <pre><code><span style="color: #5cb85c;">// setTimeout(                                         //this is asynchronous code</span>
<span style="color: #5cb85c;">//     ()=>{console.log("chai peelo"); },</span>
<span style="color: #5cb85c;">//     5000</span>
<span style="color: #5cb85c;">// )</span>
<span style="color: #5cb85c;">// console.log("tissues")</span>
<span style="color: #5cb85c;">// console.log("tissues")</span>
<span style="color: #5cb85c;">// console.log("tissues")</span>
<span style="color: #5cb85c;">// console.log("tissues")</span>
<span style="color: #5cb85c;">// console.log("tissues")</span>

<span style="color: #5cb85c;">// let value=setTimeout(</span>
<span style="color: #5cb85c;">//     ()=>{console.log("Hello from setTimeout!"); },</span>
<span style="color: #5cb85c;">//     5000,</span>
<span style="color: #5cb85c;">// )</span>
<span style="color: #5cb85c;">// console.log(value)   //it will give us the id of the setTimeout function which is 1 in this case because it is the first setTimeout function in our code. if we have multiple setTimeout functions then it will give us the id of the last setTimeout function which is 2 in this case because it is the second setTimeout function in our code.</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> setTimeout ek aisa function hai jo callback ko specified delay ke baad ek baar execute karta hai. Yeh asynchronous code hai – matlab yeh code block nahi karta, aage ka code pehle chalta hai. Isko do arguments chahiye: callback function aur delay milliseconds mein. Teesra optional argument hota hai jo callback mein pass hota hai. setTimeout ek unique timer ID return karta hai, jisse hum baad mein clearTimeout se cancel kar sakte hain. Agar multiple timers ho to har ek ki alag ID hoti hai.
                        <br><br>
                        <strong>🇬🇧 English:</strong> setTimeout is a function that executes a callback once after a specified delay. It is asynchronous – it does not block the execution of subsequent code. It takes two required arguments: a callback function and a delay in milliseconds. An optional third argument can be passed to the callback. setTimeout returns a unique timer ID which can be used later with clearTimeout to cancel the timer. If there are multiple timers, each gets its own distinct ID.
                    </div>
                </div>
            </div>
            
            <!-- 18. clearTimeout (Hinglish + English) -->
            <div class="comparison" id="topic-18">
                <h2 class="topic-title">18. clearTimeout</h2>
                <div class="old-syntax">
                    <h3>❌ Not storing ID</h3>
                    <pre><code><span style="color: #5cb85c;">// clear nahi kar sakte, ID nahi hai</span>
<span style="color: #5cb85c;">// let value=setTimeout(</span>
<span style="color: #5cb85c;">//     ()=>{console.log("Hello from setTimeout!"); },</span>
<span style="color: #5cb85c;">//     5000,</span>
<span style="color: #5cb85c;">// )</span>
<span style="color: #5cb85c;">// clearTimeout(value)   //it will clear the setTimeout function with the id of value which is 1</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ clearTimeout - cancel scheduled</h3>
                    <pre><code><span style="color: #5cb85c;">// let value=setTimeout(</span>
<span style="color: #5cb85c;">//         ()=>{console.log("chai peelo"); },</span>
<span style="color: #5cb85c;">//         5000,</span>
<span style="color: #5cb85c;">//     )</span>
<span style="color: #5cb85c;">// let p=confirm("Do you want chai peelo?")</span>
<span style="color: #5cb85c;">// if (p){</span>
<span style="color: #5cb85c;">//     console.log("chai will be given in 5 seconds")</span>
<span style="color: #5cb85c;">// }else{</span>
<span style="color: #5cb85c;">//     clearTimeout(value)</span>
<span style="color: #5cb85c;">// }</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> clearTimeout wo function hai jo setTimeout ko cancel kar deta hai. Iske liye hume setTimeout ki ID store karni padti hai. Jab hum clearTimeout mein woh ID pass karte hain, to woh scheduled task queue se remove ho jata hai aur kabhi execute nahi hota. Yeh bahut useful hai jab user kisi action ko cancel kare – jaise confirm box mein "Cancel" dabaye. Agar ID store nahi kari to clearTimeout kaam nahi karega.
                        <br><br>
                        <strong>🇬🇧 English:</strong> clearTimeout is the function that cancels a setTimeout. To use it, you must store the ID returned by setTimeout. When you pass that ID to clearTimeout, the scheduled task is removed from the task queue and will never execute. This is very useful when a user cancels an action – for example, if they click "Cancel" on a confirm box. If you don't store the ID, you cannot clear the timeout.
                    </div>
                </div>
            </div>
            
            <!-- 19. setInterval (Hinglish + English) -->
            <div class="comparison" id="topic-19">
                <h2 class="topic-title">19. setInterval</h2>
                <div class="old-syntax">
                    <h3>❌ Infinite without stop</h3>
                    <pre><code><span style="color: #5cb85c;">// setInterval()       // it will execute the function every 2 seconds until we clear it with clearInterval() function. it is also asynchronous code because it will not block the execution of the code and it will execute the function after every 2 seconds until we clear it with clearInterval() function.</span>

<span style="color: #5cb85c;">// setInterval()       // teen args jayenge third arg is optional</span>

<span style="color: #5cb85c;">// let value=setInterval(</span>
<span style="color: #5cb85c;">//     ()=>{console.log("kyu nhi ho rahi padhai?")},</span>
<span style="color: #5cb85c;">//     2000</span>
<span style="color: #5cb85c;">// )</span>
<span style="color: #5cb85c;">// clearInterval(value)   //it will clear the setInterval function with the id of value</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ setInterval with control</h3>
                    <pre><code><span style="color: #5cb85c;">// let value=setInterval(</span>
<span style="color: #5cb85c;">//     ()=>{console.log("kyu nhi ho rahi padhai?")},</span>
<span style="color: #5cb85c;">//     2000</span>
<span style="color: #5cb85c;">// )</span>
<span style="color: #5cb85c;">// console.log(value)  //it will give us the id of the setInterval function which is 1</span>

<span style="color: #5cb85c;">// stop after 6 times it is executed</span>
<span style="color: #5cb85c;">// let count=0</span>
<span style="color: #5cb85c;">// let value=setInterval(</span>
<span style="color: #5cb85c;">//     ()=>{</span>
<span style="color: #5cb85c;">//         console.log("kyu nhi ho rahi padhai?")</span>
<span style="color: #5cb85c;">//         count++</span>
<span style="color: #5cb85c;">//         if (count===6){</span>
<span style="color: #5cb85c;">//             clearInterval(value)</span>
<span style="color: #5cb85c;">//         }</span>
<span style="color: #5cb85c;">//     },</span>
<span style="color: #5cb85c;">//     2000</span>
<span style="color: #5cb85c;">// )</span>

<span style="color: #5cb85c;">// setInterval(</span>
<span style="color: #5cb85c;">//     ()=>console.log(Math.random()),</span>
<span style="color: #5cb85c;">//     2000</span>
<span style="color: #5cb85c;">// )</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> setInterval setTimeout ki tarah hi hai, farak sirf itna ki yeh callback ko ek baar nahi balki har specified delay ke baad baar-baar execute karta hai, jab tak hum clearInterval se ise rok nahi dete. Yeh bhi asynchronous hai. setInterval bhi ek unique ID return karta hai. Agar hume fixed number of executions ke baad rokna hai, to hum ek counter rakh sakte hain aur condition true hone par clearInterval call kar sakte hain. Agar clearInterval nahi karenge to interval chalta rahega, memory leak ho sakti hai.
                        <br><br>
                        <strong>🇬🇧 English:</strong> setInterval is similar to setTimeout, but instead of executing the callback once, it executes it repeatedly at every specified delay interval until it is stopped with clearInterval. It is also asynchronous. setInterval returns a unique ID. If you need to stop it after a fixed number of executions, you can maintain a counter and call clearInterval when the condition is met. If you don't call clearInterval, the interval will run forever, which can lead to memory leaks.
                    </div>
                </div>
            </div>
            
            <!-- 20. clearInterval (Hinglish + English) -->
            <div class="comparison" id="topic-20">
                <h2 class="topic-title">20. clearInterval</h2>
                <div class="old-syntax">
                    <h3>❌ No clear → memory leak</h3>
                    <pre><code><span style="color: #5cb85c;">// Interval chalega hi chalega</span>
<span style="color: #5cb85c;">// let value=setInterval(</span>
<span style="color: #5cb85c;">//     ()=>{console.log("kyu nhi ho rahi padhai?")},</span>
<span style="color: #5cb85c;">//     2000</span>
<span style="color: #5cb85c;">// )</span></code></pre>
                </div>
                <div class="new-syntax">
                    <h3>✅ clearInterval stops it</h3>
                    <pre><code><span style="color: #5cb85c;">// let value=setInterval(</span>
<span style="color: #5cb85c;">//     ()=>{console.log("kyu nhi ho rahi padhai?")},</span>
<span style="color: #5cb85c;">//     2000</span>
<span style="color: #5cb85c;">// )</span>
<span style="color: #5cb85c;">// clearInterval(value)   //it will clear the setInterval function with the id of value which is 1 in this case</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> clearInterval setInterval ko permanently rok deta hai. Iske liye setInterval ki ID store karni padti hai. Agar hum interval ko rokna chahte hain – chahe condition ke baad ya user action ke baad – tab clearInterval call karte hain. setInterval ke saath clearInterval use karna bahut important hai, nahi to interval background mein chalega, resources consume karega aur memory leak ho sakti hai. Ek baar clearInterval ho jane ke baad woh interval dubara shuru nahi hota.
                        <br><br>
                        <strong>🇬🇧 English:</strong> clearInterval permanently stops a setInterval from executing further. To use it, you must store the ID returned by setInterval. Whenever you want to stop the interval – whether after a condition or a user action – you call clearInterval with that ID. It is very important to use clearInterval with setInterval; otherwise, the interval will continue to run in the background, consume resources, and may cause memory leaks. Once cleared, the interval cannot be restarted.
                    </div>
                </div>
            </div>
            
            <!-- 21. Understanding Callbacks -->
            <div class="comparison" id="topic-21">
                <h2 class="topic-title">21. Understanding Callbacks (Function ko argument mein pass karna)</h2>
                <div class="old-syntax">
                    <h3>❌ Common Mistakes</h3>
                    <pre><code><span style="color: #5cb85c;">// MISTAKE 1: Function ko call kar diya instead of pass</span>
<span style="color: #d19a66;">let</span> fn = (x) <span style="color: #ffffff;">=></span> {
    <span style="color: #e5c07b;">x</span>();
}

<span style="color: #d19a66;">let</span> greet = () <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Hello, I am Cristiano Ronaldo!"</span>);
}

<span style="color: #5cb85c;">// ❌ WRONG - Function call kar rahe ho</span>
<span style="color: #e5c07b;">fn</span>(<span style="color: #e5c07b;">greet</span>());  <span style="color: #5cb85c;">// Error! greet() execute ho gaya</span>

<span style="color: #5cb85c;">// MISTAKE 2: Primitive value pass karna</span>
<span style="color: #d19a66;">let</span> a = <span style="color: #c678dd;">10</span>;
<span style="color: #e5c07b;">fn</span>(a);  <span style="color: #5cb85c;">// Error! Number ko function ki tarah call nahi kar sakte</span></code></pre>
                    <div class="note">
                        <strong>Problems:</strong>
                        <br>1. greet() means execute the function immediately
                        <br>2. We need to pass the function reference, not its result
                        <br>3. Primitives (numbers, strings) are not callable
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Correct Way</h3>
                    <pre><code><span style="color: #5cb85c;">// Callback function example</span>
<span style="color: #d19a66;">let</span> fn = (callbackFunction) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"About to execute callback..."</span>);
    <span style="color: #e5c07b;">callbackFunction</span>();  <span style="color: #5cb85c;">// Function ko yahan call kiya</span>
}

<span style="color: #5cb85c;">// Method 1: Named function pass karna</span>
<span style="color: #d19a66;">let</span> greet = () <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Hello, I am Cristiano Ronaldo!"</span>);
}

<span style="color: #e5c07b;">fn</span>(greet);  <span style="color: #5cb85c;">// ✅ Function reference pass kiya (no parentheses!)</span>

<span style="color: #5cb85c;">// Method 2: Anonymous function directly pass karna</span>
<span style="color: #e5c07b;">fn</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Hello, I am Cristiano Ronaldo!"</span>);
});

<span style="color: #5cb85c;">// Output:</span>
<span style="color: #5cb85c;">// About to execute callback...</span>
<span style="color: #5cb85c;">// Hello, I am Cristiano Ronaldo!</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Callback ek function hai jo dusre function ko argument ki tarah pass hota hai. greet aur greet() mein fark hai - greet is function reference, greet() is function execution!
                        <br><br>
                        <strong>🇬🇧 English:</strong> A callback is a function that is passed as an argument to another function. There's a difference between greet and greet() - greet is a function reference, while greet() is function execution!
                    </div>
                </div>
            </div>
            
            <!-- 22. Callbacks with Parameters -->
            <div class="comparison" id="topic-22">
                <h2 class="topic-title">22. Callbacks with Parameters (Parameters ke saath callbacks)</h2>
                <div class="old-syntax">
                    <h3>❌ Without Understanding</h3>
                    <pre><code><span style="color: #5cb85c;">// Confusing code - kya ho raha hai samajh nahi aa raha</span>
<span style="color: #d19a66;">let</span> fnc = (logic) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">let</span> c = <span style="color: #c678dd;">15</span>;
    <span style="color: #d19a66;">let</span> d = <span style="color: #c678dd;">26</span>;
    <span style="color: #e5c07b;">logic</span>(c, d);
}

<span style="color: #e5c07b;">fnc</span>((c, d) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(c + d);
});

<span style="color: #5cb85c;">// Output: 41</span>
<span style="color: #5cb85c;">// But WHY? Kaise kaam kar raha hai?</span></code></pre>
                    <div class="note">
                        <strong>Confusion:</strong> Parameters kaise pass ho rahe hain? Callback ka execution kab ho raha hai? Process clear nahi hai.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ With Clear Understanding</h3>
                    <pre><code><span style="color: #5cb85c;">// STEP-BY-STEP BREAKDOWN</span>

<span style="color: #5cb85c;">// Function jo do numbers provide karta hai aur callback ko call karta hai</span>
<span style="color: #d19a66;">let</span> processNumbers = (callback) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">let</span> num1 = <span style="color: #c678dd;">15</span>;
    <span style="color: #d19a66;">let</span> num2 = <span style="color: #c678dd;">26</span>;
    
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Numbers ready:"</span>, num1, num2);
    
<span style="color: #5cb85c;">    // Callback function ko call karo with numbers as arguments</span>
    <span style="color: #e5c07b;">callback</span>(num1, num2);
}

<span style="color: #5cb85c;">// Different callbacks pass kar sakte ho</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"--- Addition ---"</span>);
<span style="color: #e5c07b;">processNumbers</span>((a, b) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Sum:"</span>, a + b);
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"--- Multiplication ---"</span>);
<span style="color: #e5c07b;">processNumbers</span>((a, b) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Product:"</span>, a * b);
});

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"--- Subtraction ---"</span>);
<span style="color: #e5c07b;">processNumbers</span>((a, b) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Difference:"</span>, a - b);
});

<span style="color: #5cb85c;">/* Output:</span>
--- Addition ---
Numbers ready: <span style="color: #c678dd;">15</span> <span style="color: #c678dd;">26</span>
Sum: <span style="color: #c678dd;">41</span>
--- Multiplication ---
Numbers ready: <span style="color: #c678dd;">15</span> <span style="color: #c678dd;">26</span>
Product: <span style="color: #c678dd;">390</span>
--- Subtraction ---
Numbers ready: <span style="color: #c678dd;">15</span> <span style="color: #c678dd;">26</span>
Difference: -<span style="color: #c678dd;">11</span>
<span style="color: #5cb85c;">*/</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> processNumbers function data provide karta hai (15, 26) aur callback decide karta hai ki us data ka kya karna hai - add, multiply, ya subtract. Callback ko parameters automatically mil jaate hain jab main function usse call karta hai!
                        <br><br>
                        <strong>🇬🇧 English:</strong> The processNumbers function provides data (15, 26) and the callback decides what to do with that data - add, multiply, or subtract. The callback automatically receives parameters when the main function calls it!
                    </div>
                </div>
            </div>
            
            <!-- 23. Higher-Order Functions -->
            <div class="comparison" id="topic-23">
                <h2 class="topic-title">23. Higher-Order Functions (Arrays ke saath operations)</h2>
                <div class="old-syntax">
                    <h3>❌ Repetitive Code</h3>
                    <pre><code><span style="color: #5cb85c;">// Har operation ke liye alag function likhna padta hai</span>
<span style="color: #d19a66;">let</span> radius = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">70</span>];

<span style="color: #5cb85c;">// Area calculate karna</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">calculateArea</span>() {
    <span style="color: #d19a66;">let</span> output = [];
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < radius.length; i++) {
        output.<span style="color: #e5c07b;">push</span>(<span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * radius[i] * radius[i]);
    }
    <span style="color: #d19a66;">return</span> output;
}

<span style="color: #5cb85c;">// Circumference calculate karna</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">calculateCircumference</span>() {
    <span style="color: #d19a66;">let</span> output = [];
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < radius.length; i++) {
        output.<span style="color: #e5c07b;">push</span>(<span style="color: #c678dd;">2</span> * <span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * radius[i]);
    }
    <span style="color: #d19a66;">return</span> output;
}

<span style="color: #5cb85c;">// Diameter calculate karna</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">calculateDiameter</span>() {
    <span style="color: #d19a66;">let</span> output = [];
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < radius.length; i++) {
        output.<span style="color: #e5c07b;">push</span>(<span style="color: #c678dd;">2</span> * radius[i]);
    }
    <span style="color: #d19a66;">return</span> output;
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">calculateArea</span>());
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">calculateCircumference</span>());
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">calculateDiameter</span>());</code></pre>
                    <div class="note">
                        <strong>Problem:</strong> Bahut zyada code repetition. Har calculation ke liye poora loop dobara likhna pad raha hai.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Higher-Order Function Approach</h3>
                    <pre><code><span style="color: #5cb85c;">// Ek reusable function jo kisi bhi calculation ko perform kar sake</span>
<span style="color: #d19a66;">let</span> calculate = (radiusArray, calculationLogic) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">let</span> output = [];
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < radiusArray.length; i++) {
        output.<span style="color: #e5c07b;">push</span>(<span style="color: #e5c07b;">calculationLogic</span>(radiusArray[i]));
    }
    <span style="color: #d19a66;">return</span> output;
}

<span style="color: #d19a66;">let</span> radius = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">70</span>];

<span style="color: #5cb85c;">// Area calculation</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Areas:"</span>, <span style="color: #e5c07b;">calculate</span>(radius, r <span style="color: #ffffff;">=></span> <span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * r * r));
<span style="color: #5cb85c;">// Output: Areas: [314, 1256, 15386]</span>

<span style="color: #5cb85c;">// Circumference calculation</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Circumferences:"</span>, <span style="color: #e5c07b;">calculate</span>(radius, r <span style="color: #ffffff;">=></span> <span style="color: #c678dd;">2</span> * <span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * r));
<span style="color: #5cb85c;">// Output: Circumferences: [62.8, 125.6, 439.6]</span>

<span style="color: #5cb85c;">// Diameter calculation</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Diameters:"</span>, <span style="color: #e5c07b;">calculate</span>(radius, r <span style="color: #ffffff;">=></span> <span style="color: #c678dd;">2</span> * r));
<span style="color: #5cb85c;">// Output: Diameters: [20, 40, 140]</span>

<span style="color: #5cb85c;">// Named callback functions bhi use kar sakte ho</span>
<span style="color: #d19a66;">const</span> area = (r) <span style="color: #ffffff;">=></span> <span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * r * r;
<span style="color: #d19a66;">const</span> circumference = (r) <span style="color: #ffffff;">=></span> <span style="color: #c678dd;">2</span> * <span style="color: #c678dd;">3</span>.<span style="color: #c678dd;">14</span> * r;
<span style="color: #d19a66;">const</span> diameter = (r) <span style="color: #ffffff;">=></span> <span style="color: #c678dd;">2</span> * r;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">calculate</span>(radius, area));
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">calculate</span>(radius, circumference));
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">calculate</span>(radius, diameter));</code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Higher-Order Function woh function hai jo dusre function ko accept karta hai ya return karta hai. Yahan calculate() ek higher-order function hai kyunki yeh calculationLogic (callback) accept kar raha hai. Ek hi function se different calculations kar sakte hain!
                        <br><br>
                        <strong>🇬🇧 English:</strong> A Higher-Order Function is a function that either accepts another function as an argument or returns a function. Here calculate() is a higher-order function because it accepts calculationLogic (callback) as an argument. You can perform different calculations with the same function!
                    </div>
                </div>
            </div>
            
            <!-- 24. Building Custom Filter -->
            <div class="comparison" id="topic-24">
                <h2 class="topic-title">24. Building Custom Filter (Apna filter function banana)</h2>
                <div class="old-syntax">
                    <h3>❌ Incomplete/Wrong Attempts</h3>
                    <pre><code><span style="color: #5cb85c;">// ATTEMPT 1: Undefined check (Wrong logic!)</span>
<span style="color: #d19a66;">let</span> arra = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">40</span>, <span style="color: #c678dd;">5</span>, <span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">7</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">8</span>, <span style="color: #c678dd;">9</span>];

<span style="color: #d19a66;">let</span> filter = (arra, logics) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">let</span> outputs = [];
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> i = <span style="color: #c678dd;">0</span>; i < arra.length; i++) {
<span style="color: #5cb85c;">        // ❌ Wrong! undefined check nahi karna chahiye</span>
        <span style="color: #d19a66;">if</span> (<span style="color: #e5c07b;">logics</span>(arra[i]) !== undefined) {
            outputs.<span style="color: #e5c07b;">push</span>(arra[i]);
        }
    }
    <span style="color: #d19a66;">return</span> outputs;
}

<span style="color: #5cb85c;">// Yeh galat results dega</span>
<span style="color: #e5c07b;">filter</span>(arra, (e) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (e % <span style="color: #c678dd;">2</span> == <span style="color: #c678dd;">0</span>) {
        <span style="color: #d19a66;">return</span> true;
    } <span style="color: #d19a66;">else</span> {
        <span style="color: #d19a66;">return</span> false;
    }
});

<span style="color: #5cb85c;">// ATTEMPT 2: Repetitive code</span>
<span style="color: #e5c07b;">filter</span>(arra, (e) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (e % <span style="color: #c678dd;">2</span> != <span style="color: #c678dd;">0</span>) <span style="color: #d19a66;">return</span> true;
    <span style="color: #d19a66;">else</span> <span style="color: #d19a66;">return</span> false;
});

<span style="color: #e5c07b;">filter</span>(arra, (e) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (e % <span style="color: #c678dd;">5</span> == <span style="color: #c678dd;">0</span>) <span style="color: #d19a66;">return</span> true;
    <span style="color: #d19a66;">else</span> <span style="color: #d19a66;">return</span> false;
});</code></pre>
                    <div class="note">
                        <strong>Problems:</strong>
                        <br>1. undefined check unnecessary hai
                        <br>2. if-else bahut verbose hai
                        <br>3. Logic clearer ho sakta hai
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Correct Filter Implementation</h3>
                    <pre><code><span style="color: #5cb85c;">// Perfect filter implementation</span>
<span style="color: #d19a66;">let</span> customFilter = (arr, testFunction) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">let</span> result = [];
    <span style="color: #d19a66;">for</span> (<span style="color: #d19a66;">let</span> item <span style="color: #d19a66;">of</span> arr) {
<span style="color: #5cb85c;">        // Agar test pass ho jaye, item ko result mein add karo</span>
        <span style="color: #d19a66;">if</span> (<span style="color: #e5c07b;">testFunction</span>(item)) {
            result.<span style="color: #e5c07b;">push</span>(item);
        }
    }
    <span style="color: #d19a66;">return</span> result;
}

<span style="color: #d19a66;">let</span> numbers = [<span style="color: #c678dd;">10</span>, <span style="color: #c678dd;">20</span>, <span style="color: #c678dd;">30</span>, <span style="color: #c678dd;">40</span>, <span style="color: #c678dd;">5</span>, <span style="color: #c678dd;">1</span>, <span style="color: #c678dd;">7</span>, <span style="color: #c678dd;">2</span>, <span style="color: #c678dd;">8</span>, <span style="color: #c678dd;">9</span>];

<span style="color: #5cb85c;">// Even numbers</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Even:"</span>, <span style="color: #e5c07b;">customFilter</span>(numbers, x <span style="color: #ffffff;">=></span> x % <span style="color: #c678dd;">2</span> === <span style="color: #c678dd;">0</span>));
<span style="color: #5cb85c;">// Output: Even: [10, 20, 30, 40, 2, 8]</span>

<span style="color: #5cb85c;">// Odd numbers</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Odd:"</span>, <span style="color: #e5c07b;">customFilter</span>(numbers, x <span style="color: #ffffff;">=></span> x % <span style="color: #c678dd;">2</span> !== <span style="color: #c678dd;">0</span>));
<span style="color: #5cb85c;">// Output: Odd: [5, 1, 7, 9]</span>

<span style="color: #5cb85c;">// Divisible by 5</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Div by <span style="color: #c678dd;">5</span>:"</span>, <span style="color: #e5c07b;">customFilter</span>(numbers, x <span style="color: #ffffff;">=></span> x % <span style="color: #c678dd;">5</span> === <span style="color: #c678dd;">0</span>));
<span style="color: #5cb85c;">// Output: Div by 5: [10, 20, 30, 40, 5]</span>

<span style="color: #5cb85c;">// Greater than 10</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"><span style="color: #c678dd;">10</span>:"</span>, <span style="color: #e5c07b;">customFilter</span>(numbers, x <span style="color: #ffffff;">=></span> x > <span style="color: #c678dd;">10</span>));
<span style="color: #5cb85c;">// Output: >10: [20, 30, 40]</span>

<span style="color: #5cb85c;">// Complex condition</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Even & ><span style="color: #c678dd;">5</span>:"</span>, <span style="color: #e5c07b;">customFilter</span>(numbers, x <span style="color: #ffffff;">=></span> x % <span style="color: #c678dd;">2</span> === <span style="color: #c678dd;">0</span> && x > <span style="color: #c678dd;">5</span>));
<span style="color: #5cb85c;">// Output: Even & >5: [10, 20, 30, 40, 8]</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Filter function ka kaam hai array ke har element ko test karna. Agar testFunction true return kare, element result mein aata hai, warna skip ho jata hai. Callback mein sirf condition likhni hai, filtering logic filter function handle karega!
                        <br><br>
                        <strong>🇬🇧 English:</strong> The job of the filter function is to test each element of the array. If the testFunction returns true, the element is included in the result; otherwise, it gets skipped. You only need to write the condition in the callback - the filter function handles the filtering logic!
                    </div>
                </div>
            </div>
            
            <!-- 25. Factory Functions - Greetings -->
            <div class="comparison" id="topic-25">
                <h2 class="topic-title">25. Factory Functions (Functions banane wale functions)</h2>
                <div class="old-syntax">
                    <h3>❌ Repetitive Greeting Functions</h3>
                    <pre><code><span style="color: #5cb85c;">// Har greeting ke liye alag function</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">greetHello</span>(name) {
    <span style="color: #d19a66;">return</span> <span style="color: #98c379;">"Hello, my name is "</span> + name;
}

<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">greetHola</span>(name) {
    <span style="color: #d19a66;">return</span> <span style="color: #98c379;">"Hola, my name is "</span> + name;
}

<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">greetNamaste</span>(name) {
    <span style="color: #d19a66;">return</span> <span style="color: #98c379;">"Namaste, my name is "</span> + name;
}

<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">greetBonjour</span>(name) {
    <span style="color: #d19a66;">return</span> <span style="color: #98c379;">"Bonjour, my name is "</span> + name;
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetHello</span>(<span style="color: #98c379;">"Ronaldo"</span>));
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetHola</span>(<span style="color: #98c379;">"Messi"</span>));
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetNamaste</span>(<span style="color: #98c379;">"Virat"</span>));
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetBonjour</span>(<span style="color: #98c379;">"Mbappe"</span>));

<span style="color: #5cb85c;">// Problem: Naya greeting add karna ho toh naya function banana padega!</span></code></pre>
                    <div class="note">
                        <strong>Problem:</strong> Code repetitive hai. Har greeting type ke liye manually function likhna pad raha hai.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Factory Function Approach</h3>
                    <pre><code><span style="color: #5cb85c;">// Factory function jo greeting functions banata hai</span>
<span style="color: #d19a66;">let</span> createGreeting = (prefix) <span style="color: #ffffff;">=></span> {
<span style="color: #5cb85c;">    // Yeh inner function return ho raha hai</span>
    <span style="color: #d19a66;">return</span> (name) <span style="color: #ffffff;">=></span> {
        <span style="color: #d19a66;">return</span> <span style="color: #98c379;">`${prefix}, my name is ${name}`</span>;
    }
}

<span style="color: #5cb85c;">// Different greetings create karo</span>
<span style="color: #d19a66;">let</span> greetHello = <span style="color: #e5c07b;">createGreeting</span>(<span style="color: #98c379;">"Hello"</span>);
<span style="color: #d19a66;">let</span> greetHola = <span style="color: #e5c07b;">createGreeting</span>(<span style="color: #98c379;">"Hola"</span>);
<span style="color: #d19a66;">let</span> greetNamaste = <span style="color: #e5c07b;">createGreeting</span>(<span style="color: #98c379;">"Namaste"</span>);
<span style="color: #d19a66;">let</span> greetBonjour = <span style="color: #e5c07b;">createGreeting</span>(<span style="color: #98c379;">"Bonjour"</span>);
<span style="color: #d19a66;">let</span> greetCiao = <span style="color: #e5c07b;">createGreeting</span>(<span style="color: #98c379;">"Ciao"</span>);
<span style="color: #d19a66;">let</span> greetKonichiwa = <span style="color: #e5c07b;">createGreeting</span>(<span style="color: #98c379;">"Konichiwa"</span>);

<span style="color: #5cb85c;">// Ab use karo</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetHello</span>(<span style="color: #98c379;">"Ronaldo"</span>));
<span style="color: #5cb85c;">// Output: Hello, my name is Ronaldo</span>

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetHola</span>(<span style="color: #98c379;">"Messi"</span>));
<span style="color: #5cb85c;">// Output: Hola, my name is Messi</span>

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetNamaste</span>(<span style="color: #98c379;">"Virat"</span>));
<span style="color: #5cb85c;">// Output: Namaste, my name is Virat</span>

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetBonjour</span>(<span style="color: #98c379;">"Mbappe"</span>));
<span style="color: #5cb85c;">// Output: Bonjour, my name is Mbappe</span>

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetCiao</span>(<span style="color: #98c379;">"Pirlo"</span>));
<span style="color: #5cb85c;">// Output: Ciao, my name is Pirlo</span>

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">greetKonichiwa</span>(<span style="color: #98c379;">"Kagawa"</span>));
<span style="color: #5cb85c;">// Output: Konichiwa, my name is Kagawa</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Factory function ek function hai jo dusre customized functions banata hai. createGreeting() ek factory hai - isko prefix do, woh tumhare liye ek greeting function bana dega. Har greeting function apna prefix yaad rakhta hai (closure ki wajah se)!
                        <br><br>
                        <strong>🇬🇧 English:</strong> A factory function is a function that creates other customized functions. createGreeting() is a factory - give it a prefix, and it will create a greeting function for you. Each greeting function remembers its own prefix (thanks to closures)!
                    </div>
                </div>
            </div>
            
            <!-- 26. Factory Pattern - Multipliers -->
            <div class="comparison" id="topic-26">
                <h2 class="topic-title">26. Factory Pattern - Multipliers (Numbers multiply karne wale functions)</h2>
                <div class="old-syntax">
                    <h3>❌ Conditional Factory (Complicated)</h3>
                    <pre><code><span style="color: #5cb85c;">// Confusing approach with if-else</span>
<span style="color: #d19a66;">let</span> createMultiplier = (type) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (type === <span style="color: #98c379;">"double"</span>) {
        <span style="color: #d19a66;">return</span> double;
    } <span style="color: #d19a66;">else</span> <span style="color: #d19a66;">if</span> (type === <span style="color: #98c379;">"triple"</span>) {
        <span style="color: #d19a66;">return</span> triple;
    } <span style="color: #d19a66;">else</span> <span style="color: #d19a66;">if</span> (type === <span style="color: #98c379;">"quadruple"</span>) {
        <span style="color: #d19a66;">return</span> quadruple;
    }
}

<span style="color: #5cb85c;">// Pehle saare functions define karne padte hain</span>
<span style="color: #d19a66;">let</span> double = (n) <span style="color: #ffffff;">=></span> n * <span style="color: #c678dd;">2</span>;
<span style="color: #d19a66;">let</span> triple = (n) <span style="color: #ffffff;">=></span> n * <span style="color: #c678dd;">3</span>;
<span style="color: #d19a66;">let</span> quadruple = (n) <span style="color: #ffffff;">=></span> n * <span style="color: #c678dd;">4</span>;

<span style="color: #5cb85c;">// Problem: Limited options, agar times10 chahiye toh?</span></code></pre>
                    <div class="note">
                        <strong>Problems:</strong>
                        <br>1. Predefined functions ki zaroorat hai
                        <br>2. Limited to specific multipliers
                        <br>3. New multiplier add karna mushkil
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Dynamic Factory Function</h3>
                    <pre><code><span style="color: #5cb85c;">// Factory function jo kisi bhi multiplier ka function bana sake</span>
<span style="color: #d19a66;">let</span> createMultiplier = (multiplier) <span style="color: #ffffff;">=></span> {
<span style="color: #5cb85c;">    // Inner function return ho raha hai jo number ko multiply karega</span>
    <span style="color: #d19a66;">return</span> (number) <span style="color: #ffffff;">=></span> {
        <span style="color: #d19a66;">return</span> number * multiplier;
    }
}

<span style="color: #5cb85c;">// Ab unlimited multipliers create kar sakte ho!</span>
<span style="color: #d19a66;">let</span> double = <span style="color: #e5c07b;">createMultiplier</span>(<span style="color: #c678dd;">2</span>);
<span style="color: #d19a66;">let</span> triple = <span style="color: #e5c07b;">createMultiplier</span>(<span style="color: #c678dd;">3</span>);
<span style="color: #d19a66;">let</span> quadruple = <span style="color: #e5c07b;">createMultiplier</span>(<span style="color: #c678dd;">4</span>);
<span style="color: #d19a66;">let</span> times10 = <span style="color: #e5c07b;">createMultiplier</span>(<span style="color: #c678dd;">10</span>);
<span style="color: #d19a66;">let</span> times50 = <span style="color: #e5c07b;">createMultiplier</span>(<span style="color: #c678dd;">50</span>);
<span style="color: #d19a66;">let</span> times100 = <span style="color: #e5c07b;">createMultiplier</span>(<span style="color: #c678dd;">100</span>);

<span style="color: #5cb85c;">// Use them</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Double <span style="color: #c678dd;">5</span>:"</span>, <span style="color: #e5c07b;">double</span>(<span style="color: #c678dd;">5</span>));       <span style="color: #5cb85c;">// <span style="color: #c678dd;">10</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Triple <span style="color: #c678dd;">5</span>:"</span>, <span style="color: #e5c07b;">triple</span>(<span style="color: #c678dd;">5</span>));       <span style="color: #5cb85c;">// <span style="color: #c678dd;">15</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Quad <span style="color: #c678dd;">5</span>:"</span>, <span style="color: #e5c07b;">quadruple</span>(<span style="color: #c678dd;">5</span>));      <span style="color: #5cb85c;">// <span style="color: #c678dd;">20</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"10x of <span style="color: #c678dd;">5</span>:"</span>, <span style="color: #e5c07b;">times10</span>(<span style="color: #c678dd;">5</span>));      <span style="color: #5cb85c;">// <span style="color: #c678dd;">50</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"50x of <span style="color: #c678dd;">5</span>:"</span>, <span style="color: #e5c07b;">times50</span>(<span style="color: #c678dd;">5</span>));      <span style="color: #5cb85c;">// <span style="color: #c678dd;">250</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"100x of <span style="color: #c678dd;">5</span>:"</span>, <span style="color: #e5c07b;">times100</span>(<span style="color: #c678dd;">5</span>));    <span style="color: #5cb85c;">// <span style="color: #c678dd;">500</span></span>

<span style="color: #5cb85c;">// Directly bhi use kar sakte ho</span>
<span style="color: #d19a66;">let</span> times7 = <span style="color: #e5c07b;">createMultiplier</span>(<span style="color: #c678dd;">7</span>);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"7x of <span style="color: #c678dd;">9</span>:"</span>, <span style="color: #e5c07b;">times7</span>(<span style="color: #c678dd;">9</span>));        <span style="color: #5cb85c;">// <span style="color: #c678dd;">63</span></span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Yeh ek perfect factory pattern hai! createMultiplier() ko koi bhi number do (2, 3, 10, 50, 100), aur woh us number se multiply karne wala function bana dega. Har function apna multiplier value yaad rakhta hai closure ke through!
                        <br><br>
                        <strong>🇬🇧 English:</strong> This is a perfect factory pattern! Give createMultiplier() any number (2, 3, 10, 50, 100), and it will create a function that multiplies by that number. Each function remembers its own multiplier value through closures!
                    </div>
                </div>
            </div>
            
            <!-- 27. Understanding Closures -->
            <div class="comparison" id="topic-27">
                <h2 class="topic-title">27. Understanding Closures (Closure kya hai aur kaise kaam karta hai)</h2>
                <div class="old-syntax">
                    <h3>❌ Global Variable Problem</h3>
                    <pre><code><span style="color: #5cb85c;">// Global variable - unsafe!</span>
<span style="color: #d19a66;">let</span> count = <span style="color: #c678dd;">1</span>;

<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">counter</span>() {
    <span style="color: #d19a66;">return</span> count++;
}

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">2</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">3</span></span>

<span style="color: #5cb85c;">// DANGER! Koi bhi count ko change kar sakta hai</span>
count = <span style="color: #c678dd;">100</span>;

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">100</span> (unexpected!)</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">101</span></span>

<span style="color: #5cb85c;">// Another problem</span>
count = <span style="color: #98c379;">"hacked"</span>;
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #98c379;">"hacked1"</span> (Type error!)</span></code></pre>
                    <div class="note">
                        <strong>Problems:</strong>
                        <br>1. count ko koi bhi modify kar sakta hai
                        <br>2. Accidental changes se bugs aa sakte hain
                        <br>3. Type safety nahi hai
                        <br>4. Multiple counters nahi bana sakte
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Closure Solution (Safe & Private)</h3>
                    <pre><code><span style="color: #5cb85c;">// Closure approach - count is PRIVATE</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">createCounter</span>() {
    <span style="color: #d19a66;">let</span> count = <span style="color: #c678dd;">0</span>;  <span style="color: #5cb85c;">// Private variable</span>
    
<span style="color: #5cb85c;">    // Inner function return ho raha hai</span>
    <span style="color: #d19a66;">return</span> <span style="color: #d19a66;">function</span>() {
        count++;
        <span style="color: #d19a66;">return</span> count;
    }
}

<span style="color: #5cb85c;">// Counter create karo</span>
<span style="color: #d19a66;">let</span> counter = <span style="color: #e5c07b;">createCounter</span>();

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">2</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">3</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">4</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">5</span></span>

<span style="color: #5cb85c;">// count ko directly access nahi kar sakte - SAFE!</span>
<span style="color: #5cb85c;">// console.log(count);  // Error: count is not defined</span>

<span style="color: #5cb85c;">// Multiple independent counters bana sakte ho</span>
<span style="color: #d19a66;">let</span> counter1 = <span style="color: #e5c07b;">createCounter</span>();
<span style="color: #d19a66;">let</span> counter2 = <span style="color: #e5c07b;">createCounter</span>();

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Counter1:"</span>, <span style="color: #e5c07b;">counter1</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Counter1:"</span>, <span style="color: #e5c07b;">counter1</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">2</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Counter2:"</span>, <span style="color: #e5c07b;">counter2</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span> (apna separate count!)</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Counter1:"</span>, <span style="color: #e5c07b;">counter1</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">3</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Counter2:"</span>, <span style="color: #e5c07b;">counter2</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">2</span></span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Closure ka magic yeh hai ki inner function apne parent ke variables ko access kar sakta hai, chahe parent function execute ho chuka ho! Yahan count variable private hai - sirf returned function hi isse access kar sakta hai. Bahar se koi count ko touch nahi kar sakta. Har createCounter() call apna alag count variable banata hai!
                        <br><br>
                        <strong>🇬🇧 English:</strong> The magic of closures is that the inner function can access its parent's variables, even after the parent function has finished executing! Here the count variable is private - only the returned function can access it. Nobody from outside can touch count. Each createCounter() call creates its own separate count variable!
                    </div>
                </div>
            </div>
            
            <!-- 28. Closure Deep Dive -->
            <div class="comparison" id="topic-28">
                <h2 class="topic-title">28. Closure Deep Dive (Complete Understanding)</h2>
                <div class="old-syntax">
                    <h3>🤔 The Mystery</h3>
                    <pre><code><span style="color: #5cb85c;">// Yeh code kaise kaam kar raha hai?</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">counter</span>() {
    <span style="color: #d19a66;">let</span> count = <span style="color: #c678dd;">0</span>;
    <span style="color: #d19a66;">return</span> () <span style="color: #ffffff;">=></span> {
        count++;
        <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(count);
    }
}

<span style="color: #d19a66;">let</span> callFunc = <span style="color: #e5c07b;">counter</span>();

<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span></span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// <span style="color: #c678dd;">2</span></span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// <span style="color: #c678dd;">3</span></span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// <span style="color: #c678dd;">4</span></span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// <span style="color: #c678dd;">5</span></span>

<span style="color: #5cb85c;">// Questions:</span>
<span style="color: #5cb85c;">// 1. counter() toh execute ho gaya, phir count variable</span>
<span style="color: #5cb85c;">//    destroy kyun nahi hua?</span>
<span style="color: #5cb85c;">// 2. callFunc kaise count ko access kar raha hai?</span>
<span style="color: #5cb85c;">// 3. Har call pe count ki value kaise persist kar rahi hai?</span>
<span style="color: #5cb85c;">// 4. count kahan stored hai?</span></code></pre>
                    <div class="note">
                        <strong>Mystery:</strong> Normally jab function execute hota hai, uske local variables destroy ho jaate hain. But yahan count alive kaise hai?
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Complete Explanation</h3>
                    <pre><code><span style="color: #5cb85c;">// CLOSURE = Function + Its Lexical Environment</span>

<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">counter</span>() {
    <span style="color: #d19a66;">let</span> count = <span style="color: #c678dd;">0</span>;  <span style="color: #5cb85c;">// Yeh variable closure mein save hoga</span>
    
<span style="color: #5cb85c;">    // Inner function parent ka variable access kar raha hai</span>
    <span style="color: #d19a66;">return</span> () <span style="color: #ffffff;">=></span> {
        count++;
        <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(count);
    }
}

<span style="color: #5cb85c;">// Jab counter() execute hota hai:</span>
<span style="color: #5cb85c;">// 1. count = 0 create hota hai</span>
<span style="color: #5cb85c;">// 2. Arrow function create hota hai</span>
<span style="color: #5cb85c;">// 3. Arrow function return hota hai WITH count variable</span>
<span style="color: #5cb85c;">//    (yeh hai CLOSURE!)</span>

<span style="color: #d19a66;">let</span> callFunc = <span style="color: #e5c07b;">counter</span>();

<span style="color: #5cb85c;">// Ab callFunc kya hai?</span>
<span style="color: #5cb85c;">// callFunc = {</span>
<span style="color: #5cb85c;">//   function: () => { count++; console.log(count); },</span>
<span style="color: #5cb85c;">//   environment: { count: 0 }</span>
<span style="color: #5cb85c;">// }</span>

<span style="color: #5cb85c;">// Har baar callFunc() call karne pe:</span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// count = <span style="color: #c678dd;">1</span> (closure mein stored)</span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// count = <span style="color: #c678dd;">2</span> (same closure)</span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// count = <span style="color: #c678dd;">3</span> (same closure)</span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// count = <span style="color: #c678dd;">4</span> (same closure)</span>
<span style="color: #e5c07b;">callFunc</span>();  <span style="color: #5cb85c;">// count = <span style="color: #c678dd;">5</span> (same closure)</span>

<span style="color: #5cb85c;">// count destroy NAHI hua kyunki:</span>
<span style="color: #5cb85c;">// Inner function ne count ko "close over" kar liya hai!</span>

<span style="color: #5cb85c;">/* </span>
VISUAL REPRESENTATION:

<span style="color: #e5c07b;">counter</span>() executes
    ↓
Creates: <span style="color: #d19a66;">let</span> count = <span style="color: #c678dd;">0</span>
Creates: () <span style="color: #ffffff;">=></span> { count++ }
    ↓
Returns arrow <span style="color: #d19a66;">function</span>
    ↓
callFunc = [Function + {count: <span style="color: #c678dd;">0</span>}]
           ↑
           This is CLOSURE!
    ↓
<span style="color: #e5c07b;">callFunc</span>() → count becomes <span style="color: #c678dd;">1</span>
<span style="color: #e5c07b;">callFunc</span>() → count becomes <span style="color: #c678dd;">2</span>
<span style="color: #e5c07b;">callFunc</span>() → count becomes <span style="color: #c678dd;">3</span>
<span style="color: #5cb85c;">*/</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong>
                        <br><strong>Closure Definition:</strong> "A closure is a function bundled together with references to its surrounding state (lexical environment)."
                        <br><br>
                        <strong>Simple words mein:</strong> Closure ek aisa function hai jo apne parent function ke variables ko yaad rakhta hai, chahe parent function execute ho chuka ho! Jab inner function return hota hai, woh sirf function code nahi leta, balki apne surrounding variables ka reference bhi saath le jaata hai. Isliye count variable alive rehta hai aur har call pe increment hota rehta hai!
                        <br><br>
                        <strong>🇬🇧 English:</strong> A closure is a function that remembers the variables from its parent function, even after the parent function has finished executing! When the inner function is returned, it doesn't just take the function code - it also takes references to its surrounding variables. That's why the count variable stays alive and keeps incrementing with each call!
                    </div>
                </div>
            </div>
            
            <!-- 29. Closure Complete Summary -->
            <div class="comparison" style="grid-template-columns: 1fr;" id="topic-29">
                <h2 class="topic-title">29. Closure Complete Summary 🎓</h2>
                <div class="new-syntax">
                    <h3>📝 Everything About Closures</h3>
                    <pre><code><span style="color: #5cb85c;">/* </span>
===========================================
CLOSURE - COMPLETE DEFINITION
===========================================

<span style="color: #98c379;">"A closure is nothing but just a function that has 
 access to its parent's variables even after the 
 parent function has finished executing."

===========================================
CLOSURE KAB BANTA HAI?
===========================================
<span style="color: #5cb85c;">*/</span>

<span style="color: #5cb85c;">// Jab ek function dusre function ke andar define ho</span>
<span style="color: #5cb85c;">// AUR woh inner function parent ke variables use kare</span>

<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">outer</span>() {
    <span style="color: #d19a66;">let</span> secret = <span style="color: #98c379;">"I am private"</span>;  <span style="color: #5cb85c;">// Parent variable</span>
    
    <span style="color: #d19a66;">return</span> <span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">inner</span>() {
        <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(secret);  <span style="color: #5cb85c;">// Accessing parent variable</span>
    }
}

<span style="color: #d19a66;">let</span> revealSecret = <span style="color: #e5c07b;">outer</span>();
<span style="color: #5cb85c;">// outer() execute ho gaya but 'secret' still accessible!</span>

<span style="color: #e5c07b;">revealSecret</span>();  <span style="color: #5cb85c;">// <span style="color: #98c379;">"I am private"</span></span>
<span style="color: #5cb85c;">// This is CLOSURE!</span>

<span style="color: #5cb85c;">/* </span>
===========================================
CLOSURE KYUN USE KARTE HAIN?
===========================================

<span style="color: #c678dd;">1</span>. DATA <span style="color: #e5c07b;">PRIVACY</span>(Private variables)
<span style="color: #c678dd;">2</span>. STATE MAINTAIN karne ke liye
<span style="color: #c678dd;">3</span>. FACTORY FUNCTIONS banane ke liye
<span style="color: #c678dd;">4</span>. EVENT HANDLERS & CALLBACKS mein
<span style="color: #c678dd;">5</span>. ENCAPSULATION
<span style="color: #5cb85c;">*/</span>

<span style="color: #5cb85c;">// Example 1: Data Privacy</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">createBankAccount</span>(initialBalance) {
    <span style="color: #d19a66;">let</span> balance = initialBalance;  <span style="color: #5cb85c;">// Private!</span>
    
    <span style="color: #d19a66;">return</span> {
        deposit: (amount) <span style="color: #ffffff;">=></span> {
            balance += amount;
            <span style="color: #d19a66;">return</span> balance;
        },
        withdraw: (amount) <span style="color: #ffffff;">=></span> {
            <span style="color: #d19a66;">if</span> (amount <= balance) {
                balance -= amount;
                <span style="color: #d19a66;">return</span> balance;
            }
            <span style="color: #d19a66;">return</span> <span style="color: #98c379;">"Insufficient funds"</span>;
        },
        getBalance: () <span style="color: #ffffff;">=></span> balance
    }
}

<span style="color: #d19a66;">let</span> myAccount = <span style="color: #e5c07b;">createBankAccount</span>(<span style="color: #c678dd;">1000</span>);
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(myAccount.<span style="color: #e5c07b;">deposit</span>(<span style="color: #c678dd;">500</span>));     <span style="color: #5cb85c;">// <span style="color: #c678dd;">1500</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(myAccount.<span style="color: #e5c07b;">withdraw</span>(<span style="color: #c678dd;">200</span>));    <span style="color: #5cb85c;">// <span style="color: #c678dd;">1300</span></span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(myAccount.<span style="color: #e5c07b;">getBalance</span>());     <span style="color: #5cb85c;">// <span style="color: #c678dd;">1300</span></span>
<span style="color: #5cb85c;">// console.log(myAccount.balance);       // undefined (Private!)</span>

<span style="color: #5cb85c;">// Example 2: Multiple Independent Closures</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">createCounter</span>() {
    <span style="color: #d19a66;">let</span> count = <span style="color: #c678dd;">0</span>;
    <span style="color: #d19a66;">return</span> () <span style="color: #ffffff;">=></span> ++count;
}

<span style="color: #d19a66;">let</span> counter1 = <span style="color: #e5c07b;">createCounter</span>();  <span style="color: #5cb85c;">// Own closure with count = <span style="color: #c678dd;">0</span></span>
<span style="color: #d19a66;">let</span> counter2 = <span style="color: #e5c07b;">createCounter</span>();  <span style="color: #5cb85c;">// Different closure with count = <span style="color: #c678dd;">0</span></span>

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter1</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span> (counter1's count)</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter1</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">2</span> (counter1's count)</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter2</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">1</span> (counter2's count - independent!)</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter1</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">3</span> (counter1's count)</span>
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #e5c07b;">counter2</span>());  <span style="color: #5cb85c;">// <span style="color: #c678dd;">2</span> (counter2's count)</span>

<span style="color: #5cb85c;">/* </span>
===========================================
KEY POINTS TO REMEMBER
===========================================

✅ Closure = Function + Lexical Environment
✅ Inner <span style="color: #d19a66;">function</span> can access parent's variables
✅ Parent ke variables alive rehte hain even after execution
✅ Har <span style="color: #d19a66;">function</span> call apna separate closure banata hai
✅ Closures provide data privacy
✅ Useful <span style="color: #d19a66;">for</span> factory patterns, callbacks, event handlers

===========================================
VISUAL DIAGRAM
===========================================

Global Scope
    ↓
Outer <span style="color: #e5c07b;">Function</span>(has variables)
    ↓
Inner <span style="color: #e5c07b;">Function</span>(can access outer variables)
    ↓
CLOSURE = Inner Function + Outer Variables
    ↓
Even <span style="color: #d19a66;">if</span> Outer Function finishes,
Inner Function still has access!
<span style="color: #5cb85c;">*/</span>

<span style="color: #5cb85c;">/* </span>
===========================================
FINAL <span style="color: #e5c07b;">DEFINITION</span>(<span style="color: #c678dd;">2</span> LANGUAGES)
===========================================

🇬🇧 ENGLISH:
<span style="color: #98c379;">"A closure is a function that remembers and can 
 access variables from its outer (parent) function's 
 scope, even after the outer function has finished 
 executing."

🇮🇳 HINGLISH:
<span style="color: #98c379;">"Closure ek aisa function hai jo apne parent function 
 ke variables ko yaad rakhta hai aur unhe access kar 
 sakta hai, chahe parent function execute ho chuka ho."

===========================================
ONE-LINE DEFINITION
===========================================

<span style="color: #98c379;">"Closure is nothing but just a function that has 
 access to its lexical scope!" 🚀
<span style="color: #5cb85c;">*/</span></code></pre>
                    <div class="explanation">
                        <strong>🎯 Remember:</strong>
                        <br><br>
                        1️⃣ Closure = Function + Memory of surrounding variables
                        <br>2️⃣ Inner function "closes over" parent variables
                        <br>3️⃣ Parent variables don't get garbage collected
                        <br>4️⃣ Each closure is independent
                        <br>5️⃣ Perfect for data privacy and factory patterns
                        <br><br>
                        <strong style="color: #d32f2f;">⚠️ Common Misconception:</strong>
                        <br>Closure sirf "function inside function" nahi hai!
                        <br>Closure tab banta hai jab inner function parent ke variables ko USE kare!
                    </div>
                </div>
            </div>

            <!-- 30. Callbacks vs Promises - greet() -->
            <div class="comparison" id="topic-30">
                <h2 class="topic-title">30. Callbacks vs Promises — greet() Example</h2>
                <div class="old-syntax">
                    <h3>❌ Callback Style</h3>
                    <pre><code><span style="color: #5cb85c;">// greet() ek callback leta hai</span>
<span style="color: #5cb85c;">// 3 seconds baad "Hello world" print karega, phir callback run karega</span>
<span style="color: #d19a66;">function</span> <span style="color: #e5c07b;">greet</span>(cb) {
  <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
      <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Hello world"</span>)
      <span style="color: #e5c07b;">cb</span>();
    }, <span style="color: #c678dd;">3000</span>)
}

greet(() <span style="color: #ffffff;">=></span> {
  <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Hello"</span>)
})</code></pre>
                    <div class="note">
                        <strong>🇮🇳 Hinglish:</strong> Yahan greet function ko ek callback pass kar rahe hain. 3 seconds baad pehle "Hello world" aayega, phir callback chalega aur "Hello" print hoga. Problem yeh hai ki jaise-jaise kaam badhega, callbacks nest hote jayenge — isse Callback Hell kehte hain!
                        <br><br>
                        <strong>🇬🇧 English:</strong> Here we pass a callback to greet. After 3 seconds "Hello world" prints, then the callback runs and prints "Hello". The problem is as tasks grow, callbacks keep nesting inside each other — this is called Callback Hell!
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Promise Style</h3>
                    <pre><code><span style="color: #5cb85c;">// Promise bana rahe hain — ek IOU (I Owe You) ki tarah</span>
<span style="color: #5cb85c;">// resolve() = kaam ho gaya ✅, reject() = kuch gadbad ho gayi ❌</span>
<span style="color: #d19a66;">let</span> fathersPromise = <span style="color: #d19a66;">new</span> <span style="color: #e5c07b;">Promise</span>((resolve, reject) <span style="color: #ffffff;">=></span> {
  <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Hello world"</span>)
    <span style="color: #e5c07b;">resolve</span>();
  }, <span style="color: #c678dd;">3000</span>)
})

<span style="color: #5cb85c;">// .then() — promise fulfill hone ke baad kya karna hai</span>
<span style="color: #5cb85c;">// .catch() — reject hone par kya karna hai</span>
fathersPromise.<span style="color: #e5c07b;">then</span>(() <span style="color: #ffffff;">=></span> {
  <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Hello"</span>)
}).<span style="color: #e5c07b;">catch</span>(() <span style="color: #ffffff;">=></span> {
  <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"cryyinnnnnng...."</span>)
})

<span style="color: #5cb85c;">// resolve ke saath data bhi bhej sakte ho!</span>
<span style="color: #d19a66;">let</span> fathersPromise2 = <span style="color: #d19a66;">new</span> <span style="color: #e5c07b;">Promise</span>((resolve, reject) <span style="color: #ffffff;">=></span> {
  <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #5cb85c;">// resolve("🧸");     — toy mila</span>
    <span style="color: #e5c07b;">reject</span>(<span style="color: #98c379;">"Shop was closed..."</span>)  <span style="color: #5cb85c;">// dukaan band thi</span>
  }, <span style="color: #c678dd;">3000</span>)
})

fathersPromise2.<span style="color: #e5c07b;">then</span>((data) <span style="color: #ffffff;">=></span> {
  <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`Playing with the toy : ${data}`</span>)
}).<span style="color: #e5c07b;">catch</span>((error) <span style="color: #ffffff;">=></span> {
  <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`cryyinnnnnng.... ${error}`</span>)
}).<span style="color: #e5c07b;">finally</span>(() <span style="color: #ffffff;">=></span> {
  <span style="color: #5cb85c;">// finally hamesha chalta hai — chahe resolve ho ya reject</span>
  <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Eating dinner...."</span>)
})</code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Promise ek tarah ka agreement hai — "Main yeh kaam karunga, aur jab ho jaye toh bataunga." Teen states hoti hain: <b>pending</b> (kaam chal raha hai), <b>fulfilled</b> (resolve hua), <b>rejected</b> (reject hua). <code>.then()</code> tab chalta hai jab resolve ho, <code>.catch()</code> tab jab reject ho, aur <code>.finally()</code> dono cases mein chalta hai — dinner toh khaana hi hai! 🍽️
                        <br><br>
                        <strong>🇬🇧 English:</strong> A Promise is like an agreement — "I will do this task and let you know when it's done." It has three states: <b>pending</b> (work in progress), <b>fulfilled</b> (resolved successfully), <b>rejected</b> (something went wrong). <code>.then()</code> runs on resolve, <code>.catch()</code> runs on reject, and <code>.finally()</code> runs in both cases — dinner has to be eaten regardless! 🍽️
                    </div>
                </div>
            </div>

            <!-- 31. Callback Hell vs Promise Chain - Image Upload -->
            <div class="comparison" id="topic-31">
                <h2 class="topic-title">31. Callback Hell vs Promise Chain — Image Upload Example</h2>
                <div class="old-syntax">
                    <h3>❌ Callback Hell (Pyramid of Doom)</h3>
                    <pre><code><span style="color: #5cb85c;">// Teen functions — uploadImage → compressImage → saveImage</span>
<span style="color: #5cb85c;">// Har function pehle wale ka result leta hai aur callback se aage bhejta hai</span>

<span style="color: #d19a66;">let</span> uploadImage = (cb) <span style="color: #ffffff;">=></span> {
  <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Image uploaded -> File A"</span>)
    <span style="color: #e5c07b;">cb</span>(<span style="color: #98c379;">"File A"</span>)
  }, <span style="color: #c678dd;">5000</span>)
}

<span style="color: #d19a66;">let</span> compressImage = (uploadedImage, cb) <span style="color: #ffffff;">=></span> {
  <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`${uploadedImage} image compressed -> File B`</span>)
    <span style="color: #e5c07b;">cb</span>(<span style="color: #98c379;">"File B"</span>)
  }, <span style="color: #c678dd;">2000</span>)
}

<span style="color: #d19a66;">let</span> saveImage = (compressedImage) <span style="color: #ffffff;">=></span> {
  <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`${compressedImage} saved -> File C`</span>)
  }, <span style="color: #c678dd;">3000</span>)
}

<span style="color: #5cb85c;">// Nested callbacks — andar se andar ghusna padta hai</span>
<span style="color: #5cb85c;">// Jitne zyada steps, utna gehra nesting — "Pyramid of Doom" 😱</span>
<span style="color: #e5c07b;">uploadImage</span>((uploadedFile) <span style="color: #ffffff;">=></span> {
  <span style="color: #e5c07b;">compressImage</span>(uploadedFile, (compressedFile) <span style="color: #ffffff;">=></span> {
    <span style="color: #e5c07b;">saveImage</span>(compressedFile)
  });  
});</code></pre>
                    <div class="note">
                        <strong>🇮🇳 Hinglish:</strong> Dekho kitna andar ghus gaye! Pehle upload, phir compress, phir save — har step pichle step ke callback ke andar hai. Agar 5-6 steps ho toh code bilkul pyramid jaisa dikhega aur padhna mushkil ho jayega. Isse hi <b>Callback Hell</b> ya <b>Pyramid of Doom</b> kehte hain! 😱
                        <br><br>
                        <strong>🇬🇧 English:</strong> See how deeply nested it gets! Upload, then compress, then save — each step is inside the previous step's callback. With 5-6 steps the code looks like a pyramid and becomes very hard to read. This is called <b>Callback Hell</b> or <b>Pyramid of Doom</b>! 😱
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Promise Chain (Flat &amp; Clean)</h3>
                    <pre><code><span style="color: #5cb85c;">// Same kaam — ab Promises se, seedha aur saaf</span>
<span style="color: #5cb85c;">// Har function Promise return karta hai</span>

<span style="color: #d19a66;">let</span> uploadImage = () <span style="color: #ffffff;">=></span> {
  <span style="color: #d19a66;">return</span> <span style="color: #d19a66;">new</span> <span style="color: #e5c07b;">Promise</span>((resolve, reject) <span style="color: #ffffff;">=></span> {
    <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
      <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Image uploaded -> File A"</span>)
      <span style="color: #e5c07b;">resolve</span>(<span style="color: #98c379;">"File A"</span>)
    }, <span style="color: #c678dd;">5000</span>)
  })  
}

<span style="color: #d19a66;">let</span> compressImage = (uploadedImage) <span style="color: #ffffff;">=></span> {
  <span style="color: #d19a66;">return</span> <span style="color: #d19a66;">new</span> <span style="color: #e5c07b;">Promise</span>((resolve, reject) <span style="color: #ffffff;">=></span> {
    <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
      <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`${uploadedImage} image compressed -> File B`</span>)
      <span style="color: #e5c07b;">resolve</span>(<span style="color: #98c379;">"File B"</span>)
    }, <span style="color: #c678dd;">2000</span>)
  })
}

<span style="color: #d19a66;">let</span> saveImage = (compressedImage) <span style="color: #ffffff;">=></span> {
  <span style="color: #e5c07b;">setTimeout</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`${compressedImage} saved -> File C`</span>)
  }, <span style="color: #c678dd;">3000</span>)
}

<span style="color: #5cb85c;">// .then() chain — flat aur readable! Aur jitne steps chahiye add karo</span>
<span style="color: #e5c07b;">uploadImage</span>()
  .<span style="color: #e5c07b;">then</span>((uploadedFile) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> <span style="color: #e5c07b;">compressImage</span>(uploadedFile)
  })
  .<span style="color: #e5c07b;">then</span>((compressedFile) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> <span style="color: #e5c07b;">saveImage</span>(compressedFile)
  })
  .<span style="color: #e5c07b;">then</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> <span style="color: #e5c07b;">fn4</span>()  <span style="color: #5cb85c;">// aur step chahiye? bas ek aur .then() lagao!</span>
  })
  .<span style="color: #e5c07b;">then</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> <span style="color: #e5c07b;">fn5</span>()
  })
  .<span style="color: #e5c07b;">then</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">return</span> <span style="color: #e5c07b;">fn6</span>()
  })</code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> Promise chain mein har <code>.then()</code> ke andar jo value <code>return</code> karoge, woh next <code>.then()</code> ko mil jaati hai. Code seedha upar se neeche padha jaata hai — koi nesting nahi! Jitne steps chahiye utne <code>.then()</code> lagao. Yahi Promise ka asli fayda hai. ⛓️
                        <br><br>
                        <strong>🇬🇧 English:</strong> In a Promise chain, whatever value you <code>return</code> inside a <code>.then()</code>, it automatically flows into the next <code>.then()</code>. The code reads top to bottom — no nesting! Add as many steps as needed with more <code>.then()</code> calls. This is the real power of Promises. ⛓️
                    </div>
                </div>
            </div>

            <!-- 32. Promise Chaining - ronaldoPromise -->
            <div class="comparison" id="topic-32">
                <h2 class="topic-title">32. Promise Chaining — ronaldoPromise 🏆</h2>
                <div class="old-syntax">
                    <h3>🔍 Verbose Promise Consuming</h3>
                    <pre><code><span style="color: #5cb85c;">// fathersPromise — Promise consuming ka full example</span>
<span style="color: #5cb85c;">// creating a promise</span>
<span style="color: #d19a66;">let</span> herPromise = <span style="color: #d19a66;">new</span> <span style="color: #e5c07b;">Promise</span>((resolve, reject) <span style="color: #ffffff;">=></span> {
    <span style="color: #5cb85c;">// Parameters ka naam kuch bhi ho sakta hai (a, b) par convention yeh hai:</span>
    <span style="color: #5cb85c;">// pehla = resolve (fulfill karne ke liye), doosra = reject (fail karne ke liye)</span>
    <span style="color: #e5c07b;">resolve</span>(<span style="color: #98c379;">"💻"</span>); <span style="color: #5cb85c;">// fulfilled state</span>
    <span style="color: #5cb85c;">// reject("Shop was closed"); // rejected state</span>
});
<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(herPromise)  <span style="color: #5cb85c;">// Promise {&lt;fulfilled&gt;: '💻'}</span>

<span style="color: #5cb85c;">// consuming a promise</span>
herPromise.<span style="color: #e5c07b;">then</span>((data) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`Playing FC26 on PS5...${data}`</span>) <span style="color: #5cb85c;">// promise fulfilled → .then runs</span>
}).<span style="color: #e5c07b;">catch</span>((error) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">`you made me cry...${error}`</span>)
    <span style="color: #5cb85c;">// promise rejected → .catch runs</span>
}).<span style="color: #e5c07b;">finally</span>(() <span style="color: #ffffff;">=></span> {
    <span style="color: #5cb85c;">// finally dono mein chalta hai — .then ho ya .catch</span>
    <span style="color: #5cb85c;">// Library use karte time mostly creating nahi, consuming karoge</span>
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Hala Madrid Y Nada Mas"</span>)
})

<span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Watching Ronaldo Highlights!"</span>)</code></pre>
                    <div class="note">
                        <strong>🇮🇳 Hinglish:</strong> Yaad raho: <code>console.log("Watching Ronaldo Highlights!")</code> seedha run hoga — Promise ka wait nahi karega! JavaScript single-threaded hai, toh async kaam peeche chala jaata hai aur baki code aage badh jaata hai.
                        <br><br>
                        <strong>🇬🇧 English:</strong> Remember: <code>console.log("Watching Ronaldo Highlights!")</code> will run immediately — it won't wait for the Promise! JavaScript is single-threaded, so async work goes to the background while the rest of the code continues.
                    </div>
                </div>
                <div class="new-syntax">
                    <h3>✅ Promise Chaining — Short &amp; Powerful</h3>
                    <pre><code><span style="color: #5cb85c;">// ronaldoPromise — chaining ka concept</span>
<span style="color: #5cb85c;">// .then() se jo bhi return hota hai, next .then() ko milta hai as data</span>
<span style="color: #d19a66;">let</span> ronaldoPromise = <span style="color: #d19a66;">new</span> <span style="color: #e5c07b;">Promise</span>((resolve, reject) <span style="color: #ffffff;">=></span> {
    <span style="color: #e5c07b;">resolve</span>(<span style="color: #c678dd;">10</span>);
})

<span style="color: #5cb85c;">// Verbose version (samajhne ke liye):</span>
<span style="color: #5cb85c;">// ronaldoPromise.then((data) => {  // data = 10</span>
<span style="color: #5cb85c;">//     return 20                    // 20 next .then ko milega</span>
<span style="color: #5cb85c;">// }).then((data)=> {               // data = 20</span>
<span style="color: #5cb85c;">//     return data * 7              // 140 next ko milega</span>
<span style="color: #5cb85c;">// }).then((data) => {              // data = 140</span>
<span style="color: #5cb85c;">//     return data + 5              // 145</span>
<span style="color: #5cb85c;">// })</span>

<span style="color: #5cb85c;">// Arrow function shorthand — ek line mein same kaam!</span>
<span style="color: #5cb85c;">// Jab arrow function mein sirf ek expression ho, return implicit hota hai</span>
ronaldoPromise
.<span style="color: #e5c07b;">then</span>((data) <span style="color: #ffffff;">=></span> <span style="color: #c678dd;">20</span>)        <span style="color: #5cb85c;">// data=10, return 20 (initial data ignore, 20 return)</span>
.<span style="color: #e5c07b;">then</span>((data) <span style="color: #ffffff;">=></span> data * <span style="color: #c678dd;">10</span>)  <span style="color: #5cb85c;">// data=20, return 200</span>
.<span style="color: #e5c07b;">then</span>((data) <span style="color: #ffffff;">=></span> data + <span style="color: #c678dd;">5</span>)   <span style="color: #5cb85c;">// data=200, return 205 (final value)</span></code></pre>
                    <div class="explanation">
                        <strong>🇮🇳 Hinglish:</strong> <b>Key insight:</b> Jab tum <code>.then()</code> mein kuch return karte ho, JavaScript automatically ek naya resolved Promise bana deta hai us value ke saath. Isliye next <code>.then()</code> ko woh value <code>data</code> ke roop mein milti hai. Arrow function ka shorthand yeh hai ki curly braces na ho toh return automatic hota hai — <code>(data) =&gt; data * 10</code> same hai <code>(data) =&gt; { return data * 10 }</code> ke. ⚡
                        <br><br>
                        <strong>🇬🇧 English:</strong> <b>Key insight:</b> When you return something from a <code>.then()</code>, JavaScript automatically wraps it in a new resolved Promise with that value. That's why the next <code>.then()</code> receives it as <code>data</code>. Arrow function shorthand: without curly braces, return is implicit — <code>(data) =&gt; data * 10</code> is the same as <code>(data) =&gt; { return data * 10 }</code>. ⚡
                    </div>
                </div>
            </div>

            <!-- 33. Fetch API Flow — Real World Async -->
            <div class="comparison" style="grid-template-columns: 1fr;" id="topic-33">
                <h2 class="topic-title">33. Fetch API Flow — Real World Async 🌐</h2>
                <div class="new-syntax">
                    <h3>▶ Fetch API — Runnable Example</h3>
                    <pre><code><span style="color: #d19a66;">fetch</span>(<span style="color: #98c379;">"https://uselessfacts.jsph.pl/api/v2/facts/random?category=careers"</span>)
  .<span style="color: #e5c07b;">then</span>((response) <span style="color: #ffffff;">=></span> {
    <span style="color: #d19a66;">if</span> (!response.<span style="color: #e5c07b;">ok</span>) {
      <span style="color: #d19a66;">throw</span> <span style="color: #d19a66;">new</span> <span style="color: #e5c07b;">Error</span>(<span style="color: #98c379;">"Network response was not ok"</span>);
    }
    <span style="color: #d19a66;">return</span> response.<span style="color: #e5c07b;">json</span>();
  })
  .<span style="color: #e5c07b;">then</span>((data) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(<span style="color: #98c379;">"Data fetched successfully"</span>);
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">log</span>(data);
  })
  .<span style="color: #e5c07b;">catch</span>((error) <span style="color: #ffffff;">=></span> {
    <span style="color: #56b6c2;">console</span>.<span style="color: #e5c07b;">error</span>(<span style="color: #98c379;">"Error fetching data:"</span>, error);
  });</code></pre>
                    <div class="insight-row fetch-explain">
                        <div class="insight-box hi">
                            <span class="tag">🇮🇳 Hinglish</span>
                            <pre style="background:none;padding:0;margin:0;font-size:0.8rem;line-height:1.75;white-space:pre-wrap;color:inherit;font-family:var(--font-mono);">// Fetch ka flow samjho:
//
// 1. fetch(url)
//    - Ye ek HTTP GET request bhejta hai aur ek promise
//      return karta hai jo Response object deta hai.
//
// 2. .then(response => ...)
//    - Pehla promise callback Response ko receive karta hai.
//    - response.ok check karte hain taaki confirm ho ki
//      status 2xx hai.
//    - Agar nahi hai toh error throw karte hain.
//    - response.json() call karte hain jo body ko parse
//      karke next promise return karta hai.
//
// 3. .then(data => ...)
//    - Yahan parsed JSON data milta hai.
//    - Success message aur data console me log karte hain.
//
// 4. .catch(error => ...)
//    - Network error, status error ya parsing issue
//      sab yahan handle hote hain.
//
// Is structure se pehle response validate hota hai,
// phir data use hota hai.
// Isliye proper error handling hoti hai.</pre>
                        </div>
                        <div class="insight-box en">
                            <span class="tag">🇬🇧 English</span>
                            <pre style="background:none;padding:0;margin:0;font-size:0.8rem;line-height:1.75;white-space:pre-wrap;color:inherit;font-family:var(--font-mono);">// Explanation of fetch flow:
//
// 1. fetch(url)
//    - Performs an HTTP GET request and returns a promise
//      resolving to a Response object.
//
// 2. .then(response => ...)
//    - First promise callback receives the Response.
//    - Check response.ok to make sure HTTP status is 2xx;
//      if not, throw an error.
//    - Call response.json() to parse and return another
//      promise with the body data.
//
// 3. .then(data => ...)
//    - Receives parsed JSON from the previous step.
//    - Log a success message and output the data.
//
// 4. .catch(error => ...)
//    - Handles any network errors, status errors, or
//      JSON parsing issues.
//
// This structure ensures proper error handling by
// validating the response before attempting to use
// the data.</pre>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- end .content -->

<!-- ============================================================
     MODAL CONTAINER
     ============================================================ -->
<div id="modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-label="Topic viewer">
  <div class="modal-box" id="modal-box">
    <div class="modal-progress-strip"><div class="modal-progress-fill" id="modal-prog-fill"></div></div>
    <div class="modal-header" id="modal-header">
      <div class="modal-crumb">
        <span>📖 Topic</span>
        <span>›</span>
        <strong id="modal-topic-title">—</strong>
        <span class="read-time-badge" id="read-time-badge">⏱ ~2 min</span>
      </div>
      <span class="modal-topic-counter" id="modal-topic-counter"></span>
      <button class="modal-close-btn" id="modal-close-btn" aria-label="Close">✕ Close</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- ============================================================
     FOOTER
     ============================================================ -->
<footer class="site-footer">
  <p style="color: lightcyan;">⚡ JavaScript Advanced Concepts · <strong style="color: red;">Made by codebrak07 &amp; krish-kothari</strong></p>
  <p style="margin-top: 6px; color: lightcyan;">ES5 → ES6 · Callbacks · Promises · Closures · Higher-Order Functions</p>
</footer>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<!-- Toast notification container -->
<div id="toast-wrap"></div>
<!-- Confetti container (spawned dynamically) -->

<!-- Completion screen overlay (injected into modal body via JS) -->
<template id="completion-tpl">
  <div class="completion-screen">
    <div class="cs-icon" id="cs-icon">🎯</div>
    <div class="cs-title" id="cs-title">Topic Mastered!</div>
    <div class="cs-sub" id="cs-sub">You just levelled up your JavaScript skills.</div>
    <div class="cs-xp-badge" id="cs-xp-badge">+30 XP earned</div>
    <div class="cs-progress-line">
      <span id="cs-prog-txt">0 / 33 complete</span>
      <div class="csp-bar"><div class="csp-fill" id="csp-fill"></div></div>
      <span id="cs-pct">0%</span>
    </div>
    <div class="cs-actions">
      <button class="cs-btn-next" id="cs-btn-next">Next Topic →</button>
      <button class="cs-btn-back" id="cs-btn-back">← Back to Index</button>
    </div>
  </div>
</template>

<!-- COMMAND PALETTE (Cmd+Shift+P) -->
<div id="wap-palette-overlay" role="dialog" aria-modal="true" aria-label="Command Palette">
  <div id="wap-palette">
    <input id="wap-palette-input" type="text" placeholder="Type a command…" autocomplete="off" spellcheck="false" />
    <ul id="wap-palette-list"></ul>
    <div id="wap-palette-empty" style="display:none">No commands match</div>
  </div>
</div>

<!-- TOPIC SEARCH (Cmd+K) -->
<div id="wap-search-overlay" role="dialog" aria-modal="true" aria-label="Topic Search">
  <div id="wap-search-box">
    <input id="wap-search-input" type="text" placeholder="Search topics…" autocomplete="off" spellcheck="false" />
    <ul id="wap-search-results"></ul>
  </div>
</div>

<!-- JS COMPILER FULLSCREEN OVERLAY -->
<div id="jsc-overlay" role="dialog" aria-modal="true" aria-label="JavaScript Compiler">
  <div class="jsc-bar">
    <div class="jsc-bar-left">
      <button class="jsc-btn-close" id="jsc-btn-close">✕ Close</button>
      <span class="jsc-bar-title">JavaScript Compiler</span>
      <span class="wap-runtime-badge" id="wap-runtime-badge"></span>
    </div>
    <div class="jsc-bar-right">
      <button class="jsc-btn-clear" id="jsc-btn-clear">Clear</button>
      <button class="jsc-btn-run" id="jsc-btn-run">▶ Run</button>
    </div>
  </div>
  <div class="jsc-workspace">
    <div class="jsc-editor-pane">
      <div class="jsc-pane-label">editor</div>
      <!-- MODIFIED: Monaco Editor container replaces textarea -->
      <div id="jsc-editor"></div>
    </div>
    <div class="jsc-output-pane">
      <div class="jsc-pane-label">output</div>
      <div class="wap-runtime-status" id="wap-runtime-status">
        <span class="wap-rs-dot idle" id="wap-rs-dot"></span>
        <span class="wap-rs-label" id="wap-rs-label">Idle</span>
        <span class="wap-rs-time" id="wap-rs-time"></span>
      </div>
      <div id="jsc-output">
        <span class="jsc-line jsc-line-empty">// Run your code to see output</span>
      </div>
    </div>
  </div><!-- /.jsc-workspace -->

  <!-- ═══════════════════════════════════════════════════════════
       FETCH API TEACHING PANEL — lives inside #jsc-overlay
       ─ Class names follow the brief: .fetch-section / .fetch-header / .fetch-body
       ─ IDs prefixed jsc-fetch- (no collision with main-page panel)
       ─ Collapsed by default; body animates via max-height in CSS
       ═══════════════════════════════════════════════════════════ -->
  <div class="fetch-section" id="jsc-fetch-section">

    <!-- Toggle header — always visible -->
    <div class="fetch-header" id="jsc-fetch-header"
         role="button" tabindex="0"
         aria-expanded="false" aria-controls="jsc-fetch-body">
      <span class="fetch-header-title">
        🌐&nbsp; Understanding Fetch API Flow
        <span class="fetch-header-badge">guide</span>
      </span>
      <span class="fetch-chevron" id="jsc-fetch-chevron" aria-hidden="true">▼</span>
    </div>

    <!-- Collapsible body — max-height:0 → max-height:430px via CSS .open -->
    <div class="fetch-body" id="jsc-fetch-body">
      <div class="fetch-body-inner">

        <!-- Language tabs -->
        <div class="fetch-lang-tabs">
          <div class="fetch-tab active" data-lang="en">🇬🇧 English</div>
          <div class="fetch-tab"        data-lang="hi">🇮🇳 Hinglish</div>
        </div>

        <!-- ── English pane ──────────────────────────────────── -->
        <div class="fetch-tab-content active" data-content="en">
          <pre><code>// Explanation of fetch flow:
//
// 1. fetch(url)
//    - Performs an HTTP GET request and returns a promise
//      resolving to a Response object.
//
// 2. .then(response => ...)
//    - First promise callback receives the Response.
//    - Check response.ok to make sure HTTP status is 2xx;
//      if not, throw an error.
//    - Call response.json() to parse and return another
//      promise with the body data.
//
// 3. .then(data => ...)
//    - Receives parsed JSON from the previous step.
//    - Log a success message and output the data.
//
// 4. .catch(error => ...)
//    - Handles any network errors, status errors, or
//      JSON parsing issues.
//
// This structure ensures proper error handling by validating
// the response before attempting to use the data.</code></pre>
          <div class="fetch-note">
            <strong>Why two <code>.then()</code> calls?</strong>
            <code>fetch()</code> returns the HTTP <em>envelope</em> — headers and status.
            <code>response.json()</code> opens it and parses the body,
            returning its <em>own</em> Promise. Always check
            <code>response.ok</code> <em>before</em> calling <code>.json()</code>
            — fetch never rejects on 4xx/5xx, only on network failure.
          </div>
        </div>

        <!-- ── Hinglish pane ─────────────────────────────────── -->
        <div class="fetch-tab-content" data-content="hi">
          <pre><code>// Fetch ka flow samjho:
//
// 1. fetch(url)
//    - Ye ek HTTP GET request bhejta hai aur ek promise
//      return karta hai jo Response object deta hai.
//
// 2. .then(response => ...)
//    - Pehla promise callback Response ko receive karta hai.
//    - response.ok check karte hain taaki confirm ho ki
//      status 2xx hai.
//    - Agar nahi hai toh error throw karte hain.
//    - response.json() call karte hain jo body ko parse
//      karke next promise return karta hai.
//
// 3. .then(data => ...)
//    - Yahan parsed JSON data milta hai.
//    - Success message aur data console me log karte hain.
//
// 4. .catch(error => ...)
//    - Network error, status error ya parsing issue sab
//      yahan handle hote hain.
//
// Is structure se pehle response validate hota hai,
// phir data use hota hai. Isliye proper error handling
// hoti hai.</code></pre>
          <div class="fetch-note">
            <strong>Do <code>.then()</code> kyun lagte hain?</strong>
            Pehla <code>.then()</code> HTTP response ka "lifafa" deta hai —
            status aur headers. Doosra step (<code>response.json()</code>)
            us lifafe ko kholke JSON data deta hai — yeh apna alag Promise
            return karta hai. <code>.catch()</code> dono steps ke errors
            pakad leta hai! 🎯
          </div>
        </div>

        <!-- ── Runnable example ──────────────────────────────── -->
        <div class="fetch-runnable">
          <div class="fetch-runnable-label">▶ Runnable Example</div>
          <pre><code>fetch("https://uselessfacts.jsph.pl/api/v2/facts/random?category=careers")
  .then((response) => {
    if (!response.ok) {
      throw new Error("Network response was not ok");
    }
    return response.json();
  })
  .then((data) => {
    console.log("Data fetched successfully");
    console.log(data);
  })
  .catch((error) => {
    console.error("Error fetching data:", error);
  });</code></pre>
          <button class="fetch-run-btn" id="jsc-fetch-run-btn"
                  type="button">▶ Run in Editor</button>
        </div>

      </div><!-- /.fetch-body-inner -->
    </div><!-- /.fetch-body -->

  </div><!-- /.fetch-section #jsc-fetch-section -->

</div><!-- /#jsc-overlay -->

<!-- MASTERY VALIDATION OVERLAY -->
<div id="mastery-overlay" role="dialog" aria-modal="true" aria-label="Validation Question">
  <div class="mastery-dialog" id="mastery-dialog">
    <div class="mq-label">Validate Understanding</div>
    <div class="mq-topic-ref" id="mq-topic-ref">Topic — </div>
    <div class="mq-question" id="mq-question">Loading question…</div>
    <div class="mq-choices" id="mq-choices"></div>
    <button class="mq-submit" id="mq-submit" disabled>Check Answer</button>
    <div class="mq-result" id="mq-result">
      <div id="mq-result-text"></div>
      <div class="mq-quote" id="mq-quote"></div>
    </div>
    <div class="mq-actions" id="mq-actions" style="display:none">
      <button class="mq-btn-dismiss" id="mq-dismiss">Close</button>
      <button class="mq-btn-retry" id="mq-retry" style="display:none">Try Again</button>
    </div>
  </div>
</div>

<script>
"use strict";

/* ============================================================
   DATA & STATE
   ============================================================ */

// EN: All topic titles for search and navigation
// HI-EN: Saare topics ke naam — search aur navigation dono mein use hote hain
const TOPIC_TITLES = [
  "Array Filter Method",
  "Object Destructuring",
  "Destructuring with Renaming",
  "Default Values",
  "Function Parameters Destructuring",
  "Array Destructuring",
  "Spread Syntax - Arrays",
  "Spread Syntax - Objects",
  "Spread in Function Calls",
  "Rest Syntax - Arrays",
  "Rest Syntax - Objects",
  "Rest Parameters in Functions",
  "Rest vs Spread (Key Differences)",
  "forEach Method",
  "map Method",
  "find Method",
  "sort Method",
  "setTimeout - basics",
  "clearTimeout",
  "setInterval",
  "clearInterval",
  "Understanding Callbacks",
  "Callbacks with Parameters",
  "Higher-Order Functions",
  "Building Custom Filter",
  "Factory Functions - Greetings",
  "Factory Pattern - Multipliers",
  "Understanding Closures",
  "Closure Deep Dive",
  "Closure Complete Summary",
  "Callbacks vs Promises - greet()",
  "Callback Hell vs Promise Chain - Image Upload",
  "Promise Chaining - ronaldoPromise",
  "Fetch API Flow - Real World Async"
];

const TOTAL = TOPIC_TITLES.length;
window._WAP_TOPIC_TITLES = TOPIC_TITLES; // expose for search

// EN: Track viewed topics using a Set for O(1) lookups
// HI-EN: Set mein visited topics track karte hain taaki progress count ho
const viewedTopics = new Set();

// Mastery tracking — separate from viewed. Only mastered = green.
const masteredTopics = new Set();

/* ============================================================
   GLOBAL VALIDATION LOCK — hoisted early for all references
   ============================================================ */
var validationLock = {
  active: false,
  topicId: null
};

/* ============================================================
   VALIDATION QUESTIONS — one per topic
   Format: { q: string, choices: string[], answer: number (0-indexed) }
   ============================================================ */
const VALIDATION_QS = [
  // 0 Array Filter
  { questions: [
    { q: "What does Array.filter() return when no elements match?", choices: ["undefined","null","An empty array","false"], answer: 2 },
    { q: "Array.filter() mutates the original array?", choices: ["Yes, always","No, it returns a new array","Only when using arrow functions","Depends on the callback"], answer: 1 },
    { q: "Which is the correct filter syntax?", choices: ["arr.filter[x => x > 0]","filter(arr, x => x > 0)","arr.filter(x => x > 0)","arr.filter(x, x > 0)"], answer: 2 },
  ]},
  // 1 Object Destructuring
  { questions: [
    { q: "const { name } = { name: 'Ronaldo', age: 39 }. What is name?", choices: ["undefined","'Ronaldo'","{ name: 'Ronaldo' }","39"], answer: 1 },
    { q: "Object destructuring extracts values by:", choices: ["Position (index)","Property name","Data type","Order of definition"], answer: 1 },
    { q: "What does const { x, y } = obj create?", choices: ["An array [x, y]","Two variables x and y","One variable xy","A copy of obj"], answer: 1 },
  ]},
  // 2 Destructuring with Renaming
  { questions: [
    { q: "const { name: n } = { name: 'CR7' }. What variable is created?", choices: ["name","n","cr7","both name and n"], answer: 1 },
    { q: "In { name: alias } destructuring, what does 'alias' become?", choices: ["The property name","The new variable name","Both","A string value"], answer: 1 },
    { q: "After const { a: b } = { a: 5 }, accessing 'a' gives:", choices: ["5","undefined (a not declared)","ReferenceError","null"], answer: 1 },
  ]},
  // 3 Default Values
  { questions: [
    { q: "const { x = 10 } = {}. What is x?", choices: ["undefined","null","10","0"], answer: 2 },
    { q: "Default value in destructuring applies when the property is:", choices: ["null","false","undefined or missing","0"], answer: 2 },
    { q: "const { a = 5 } = { a: null }. What is a?", choices: ["5","null","undefined","0"], answer: 1 },
  ]},
  // 4 Function Parameters Destructuring
  { questions: [
    { q: "function f({ a, b }) {} — what argument type does f expect?", choices: ["Two numbers","An array","An object","A string"], answer: 2 },
    { q: "Parameter destructuring lets you:", choices: ["Accept unlimited args","Name specific properties inline","Convert arrays to objects","Avoid using return"], answer: 1 },
    { q: "function greet({ name = 'Guest' }) — what if called as greet({})?", choices: ["Error","name = undefined","name = 'Guest'","name = null"], answer: 2 },
  ]},
  // 5 Array Destructuring
  { questions: [
    { q: "const [a, , c] = [1, 2, 3]. What is c?", choices: ["1","2","3","undefined"], answer: 2 },
    { q: "Array destructuring matches values by:", choices: ["Property name","Position (index)","Data type","Alphabetical order"], answer: 1 },
    { q: "const [first] = [10, 20, 30]. What is first?", choices: ["30","20","10","[10,20,30]"], answer: 2 },
  ]},
  // 6 Spread — Arrays
  { questions: [
    { q: "const b = [...a, 4]. If a = [1,2,3], what is b?", choices: ["[1,2,3]","[1,2,3,4]","[4,1,2,3]","[...a,4]"], answer: 1 },
    { q: "Spread on an array creates:", choices: ["A reference to the same array","A shallow copy","A deep copy","A function"], answer: 1 },
    { q: "[...arr1, ...arr2] combines arrays by:", choices: ["Nesting them","Merging into a new flat array","Sorting them","Removing duplicates"], answer: 1 },
  ]},
  // 7 Spread — Objects
  { questions: [
    { q: "const c = {...a, x:9}. If a has x:1, what is c.x?", choices: ["1","9","undefined","Error"], answer: 1 },
    { q: "Object spread copies properties by:", choices: ["Deep cloning","Shallow reference","Mutation of original","Prototype chain only"], answer: 1 },
    { q: "Later properties in {...a, key:val} override earlier ones?", choices: ["No, first wins","Yes, last wins","Only if same type","Never"], answer: 1 },
  ]},
  // 8 Spread in Function Calls
  { questions: [
    { q: "Math.max(...[3,1,4,1,5]) returns:", choices: ["3","5","1","NaN"], answer: 1 },
    { q: "fn(...arr) passes array elements as:", choices: ["A single array argument","Individual arguments","An object","A string"], answer: 1 },
    { q: "Without spread, Math.max([1,2,3]) returns:", choices: ["3","NaN","1","[1,2,3]"], answer: 1 },
  ]},
  // 9 Rest — Arrays
  { questions: [
    { q: "const [first, ...rest] = [10,20,30]. What is rest?", choices: ["[10]","[20,30]","20","[10,20,30]"], answer: 1 },
    { q: "Rest in array destructuring collects:", choices: ["First element","All remaining elements into an array","Nothing","The last element only"], answer: 1 },
    { q: "Can rest appear in the middle of destructuring like [a, ...b, c]?", choices: ["Yes","No — rest must be last","Only in arrays","Only in objects"], answer: 1 },
  ]},
  // 10 Rest — Objects
  { questions: [
    { q: "const {a, ...others} = {a:1,b:2,c:3}. What is others?", choices: ["{a:1}","{b:2,c:3}","{a:1,b:2,c:3}","undefined"], answer: 1 },
    { q: "Object rest collects:", choices: ["All properties","Remaining undestructured properties","Only numeric keys","Prototype properties"], answer: 1 },
    { q: "After const { x, ...rest } = { x:1, y:2 }, rest contains:", choices: ["{ x:1 }","{ y:2 }","{ x:1, y:2 }","{}"], answer: 1 },
  ]},
  // 11 Rest Parameters
  { questions: [
    { q: "function f(x, ...args){} called as f(1,2,3). What is args?", choices: ["1","[1,2,3]","[2,3]","undefined"], answer: 2 },
    { q: "Rest parameters must be:", choices: ["First","In the middle","Last","Any position"], answer: 2 },
    { q: "typeof args in function f(...args) is always:", choices: ["'arguments'","'array'","'object' (real Array)","'rest'"], answer: 2 },
  ]},
  // 12 Rest vs Spread
  { questions: [
    { q: "Which syntax collects remaining elements into an array?", choices: ["Spread (...)","Rest (...)","Both","Neither"], answer: 1 },
    { q: "Spread is used in:", choices: ["Function definitions (collecting args)","Function calls and array literals (expanding)","Both equally","Only with objects"], answer: 1 },
    { q: "Rest creates an array. Spread expands one. True?", choices: ["True","False — they do opposite","Both create arrays","Both expand"], answer: 0 },
  ]},
  // 13 forEach
  { questions: [
    { q: "What does forEach return?", choices: ["A new array","undefined","The original array","A promise"], answer: 1 },
    { q: "forEach cannot be stopped early with break?", choices: ["False — break works","True — use for...of instead","Only in async","Only in strict mode"], answer: 1 },
    { q: "[1,2,3].forEach(x => x*2) gives:", choices: ["[2,4,6]","undefined","[1,2,3]","6"], answer: 1 },
  ]},
  // 14 map
  { questions: [
    { q: "[1,2,3].map(x => x*2) returns:", choices: ["6","[1,2,3]","[2,4,6]","undefined"], answer: 2 },
    { q: "map always returns:", choices: ["undefined","A new array of same length","A filtered array","The original array"], answer: 1 },
    { q: ".map() transforms each element. Does it change the original?", choices: ["Yes","No — returns a new array","Sometimes","Only in strict mode"], answer: 1 },
  ]},
  // 15 find
  { questions: [
    { q: "[5,10,15].find(x => x > 8) returns:", choices: ["[10,15]","10","true","undefined"], answer: 1 },
    { q: "find() returns:", choices: ["All matching elements","The first matching element","A boolean","The index"], answer: 1 },
    { q: "If no element matches, find() returns:", choices: ["null","false","undefined","[]"], answer: 2 },
  ]},
  // 16 sort
  { questions: [
    { q: "[10,1,5].sort() without a comparator gives:", choices: ["[1,5,10]","[10,5,1]","['1','10','5'] (string sort)","Error"], answer: 2 },
    { q: "To sort numbers ascending, the comparator should return:", choices: ["a - b","b - a","a + b","1 always"], answer: 0 },
    { q: ".sort() mutates the original array?", choices: ["No","Yes — it modifies in place","Only ascending sort","Only with comparator"], answer: 1 },
  ]},
  // 17 setTimeout
  { questions: [
    { q: "setTimeout(fn, 1000) executes fn:", choices: ["Immediately","After exactly 1 second (minimum)","Before other code","Never"], answer: 1 },
    { q: "setTimeout executes the callback:", choices: ["Synchronously","After the call stack is clear + delay","In a worker thread","Before paint"], answer: 1 },
    { q: "setTimeout returns:", choices: ["A promise","A timeout ID (number)","The callback result","undefined"], answer: 1 },
  ]},
  // 18 clearTimeout
  { questions: [
    { q: "clearTimeout(id) — when must it be called to prevent execution?", choices: ["After fn runs","Before the timeout fires","Anytime","It cannot"], answer: 1 },
    { q: "clearTimeout cancels using:", choices: ["The callback reference","The timeout ID returned by setTimeout","Any number","The delay value"], answer: 1 },
    { q: "Calling clearTimeout after the callback ran:", choices: ["Throws an error","Has no effect — already ran","Runs it again","Clears memory"], answer: 1 },
  ]},
  // 19 setInterval
  { questions: [
    { q: "setInterval(fn, 500) calls fn:", choices: ["Once after 500ms","Every 500ms until cleared","500 times","Every second"], answer: 1 },
    { q: "setInterval calls the callback:", choices: ["Once","Repeatedly at fixed intervals","On every frame","When the tab is active"], answer: 1 },
    { q: "setInterval is stopped with:", choices: ["stopInterval()","clearInterval(id)","interval.stop()","clearTimeout(id)"], answer: 1 },
  ]},
  // 20 clearInterval
  { questions: [
    { q: "What stops a setInterval from repeating?", choices: ["return false","clearTimeout()","clearInterval(id)","break"], answer: 2 },
    { q: "The correct way to store an interval for later clearing is:", choices: ["setInterval alone","const id = setInterval(...)","Just use setTimeout","window.interval = true"], answer: 1 },
    { q: "If you lose the interval ID, you:", choices: ["Can still clear it","Cannot clear it programmatically","It auto-stops after 10s","Call reset()"], answer: 1 },
  ]},
  // 21 Callbacks
  { questions: [
    { q: "A callback is:", choices: ["A function that returns a promise","A function passed as an argument","An async function","A named function only"], answer: 1 },
    { q: "Callbacks execute:", choices: ["Immediately when defined","When called by the receiving function","Before the outer function","Always asynchronously"], answer: 1 },
    { q: "Which is a valid callback usage?", choices: ["arr.map(fn)","fn.callback = arr","arr = callback(fn)","callback.arr.fn()"], answer: 0 },
  ]},
  // 22 Callbacks with Params
  { questions: [
    { q: "If cb is a callback, how do you pass data to it?", choices: ["cb(data)","cb.call(data)","cb.receive(data)","return cb"], answer: 0 },
    { q: "To pass extra args to a callback inside .forEach, you:", choices: ["Can't","Pass them in the callback closure or wrapper","Use cb.args","Add them after the callback"], answer: 1 },
    { q: "cb(a, b) calls the callback with:", choices: ["One argument: [a,b]","Two arguments: a and b","An object {a,b}","No arguments"], answer: 1 },
  ]},
  // 23 Higher Order Functions
  { questions: [
    { q: "A higher-order function:", choices: ["Only works with arrays","Takes or returns a function","Runs asynchronously","Is always named 'higher'"], answer: 1 },
    { q: "Which built-in is a higher-order function?", choices: ["parseInt","Array.isArray","Array.prototype.map","Math.round"], answer: 2 },
    { q: "Returning a function from a function is:", choices: ["Invalid JS","A higher-order pattern","Only possible in ES6+","A side effect"], answer: 1 },
  ]},
  // 24 Custom Filter
  { questions: [
    { q: "A custom filter function should:", choices: ["Mutate the original array","Return elements where predicate is true","Return a count","Always use sort()"], answer: 1 },
    { q: "Custom filter pushes elements to result when:", choices: ["Always","Predicate returns truthy","Index is even","Array is sorted"], answer: 1 },
    { q: "The predicate function in filter receives:", choices: ["Only the index","Element, index, array","Just the element","Nothing"], answer: 1 },
  ]},
  // 25 Factory Functions
  { questions: [
    { q: "Factory functions create objects:", choices: ["Using 'new' keyword","Without 'new', via return","Only with classes","Using prototypes only"], answer: 1 },
    { q: "The main advantage of factory functions over classes:", choices: ["Faster execution","No 'new', no 'this' complexity","Better inheritance","Access to DOM"], answer: 1 },
    { q: "Factory function returns:", choices: ["A class","A plain object (or function)","A prototype","undefined"], answer: 1 },
  ]},
  // 26 Factory — Multipliers
  { questions: [
    { q: "function multiplier(x){ return n => n*x }. multiplier(3)(4) =", choices: ["7","12","34","undefined"], answer: 1 },
    { q: "multiplier(5) returns:", choices: ["5","undefined","A function that multiplies by 5","NaN"], answer: 2 },
    { q: "Calling multiplier(2)(10) gives:", choices: ["12","20","2","10"], answer: 1 },
  ]},
  // 27 Closures
  { questions: [
    { q: "A closure allows a function to:", choices: ["Run in a worker","Access its outer scope after it returns","Call itself recursively","Avoid using 'this'"], answer: 1 },
    { q: "Closures are created when:", choices: ["You use 'new'","A function references variables from an outer scope","You use async/await","Arrays are nested"], answer: 1 },
    { q: "The inner function in a closure can access outer variables:", choices: ["Only at creation time","Forever via live reference","Only if they're const","Only in strict mode"], answer: 1 },
  ]},
  // 28 Closure Deep Dive
  { questions: [
    { q: "Closures capture variables by:", choices: ["Value at creation","Reference (live binding)","Copy","None of these"], answer: 1 },
    { q: "Why does count persist across calls in a counter closure?", choices: ["It's global","It's captured in the closure scope","It's stored in DOM","It's a constant"], answer: 1 },
    { q: "Outside code cannot access the closure variable directly?", choices: ["False — it can via window","True — it's encapsulated","Only in modules","Depends on browser"], answer: 1 },
  ]},
  // 29 Closure Summary
  { questions: [
    { q: "Which pattern uses closures to create private state?", choices: ["Prototype chain","IIFE / module pattern","Class syntax only","Arrow functions only"], answer: 1 },
    { q: "An IIFE (Immediately Invoked Function Expression) creates:", choices: ["A global variable","A private scope via closure","A class instance","An async context"], answer: 1 },
    { q: "Module pattern hides implementation using:", choices: ["TypeScript","Closures + returned public API","Prototypes only","Getters/setters only"], answer: 1 },
  ]},
  // 30 Callbacks vs Promises
  { questions: [
    { q: "Promises over callbacks primarily solve:", choices: ["Speed","Callback hell / nesting","Memory usage","Syntax errors"], answer: 1 },
    { q: "A Promise represents:", choices: ["A finished async operation","A value that will be available in the future","A callback wrapper","An error handler"], answer: 1 },
    { q: "Promise states: pending → fulfilled OR pending → ?", choices: ["done","cancelled","rejected","resolved"], answer: 2 },
  ]},
  // 31 Callback Hell vs Promise Chain
  { questions: [
    { q: "promise.then(a).then(b).then(c) — what is this pattern called?", choices: ["Callback nesting","Promise chaining","Async/await","Event loop"], answer: 1 },
    { q: "Callback hell is characterized by:", choices: ["Flat async code","Deeply nested callbacks (pyramid of doom)","Promise chains","try/catch blocks"], answer: 1 },
    { q: ".catch() at the end of a chain handles:", choices: ["Only the last .then","All rejections in the chain","Nothing","Only synchronous errors"], answer: 1 },
  ]},
  // 32 Promise Chaining
  { questions: [
    { q: "What does .then() return?", choices: ["The same promise","A new promise","undefined","The resolved value directly"], answer: 1 },
    { q: "Returning a value from .then() makes it available in:", choices: ["The same .then","The next .then in the chain","All subsequent .then","The .catch only"], answer: 1 },
    { q: "Promise.resolve(5).then(x => x * 2).then(x => x + 1) resolves to:", choices: ["5","10","11","undefined"], answer: 2 },
  ]},
  // 33 Fetch API Flow
  { questions: [
    { q: "fetch() returns:", choices: ["The JSON data directly","A Promise resolving to a Response","An XMLHttpRequest object","An error by default"], answer: 1 },
    { q: "Why call response.json() inside .then()?", choices: ["To stringify the response","To parse the body as JSON (returns a Promise)","To check HTTP status","To close the connection"], answer: 1 },
    { q: "response.ok is true when the HTTP status is:", choices: ["Any status code","200 only","2xx range (200–299)","Only 201"], answer: 2 },
  ]},
  // 34 Understanding Fetch API Flow
  { questions: [
    { q: "What does the first .then() in a fetch chain receive?", choices: ["The parsed JSON data","The Response object","An error object","The request URL"], answer: 1 },
    { q: ".catch() at the end of a fetch chain handles:", choices: ["Only network errors","Only JSON parsing errors","Network errors, status errors, and JSON parsing issues","Only HTTP 4xx errors"], answer: 2 },
    { q: "Why must you check response.ok manually?", choices: ["fetch() rejects on all errors","fetch() only rejects on network failure, not HTTP errors like 404","response.ok is always true","It improves performance"], answer: 1 },
  ]},
  // 35 Understanding Fetch API Flow - Section 5
  { questions: [
    { q: "What does fetch() return?", choices: ["JSON data","A Response object directly","A Promise resolving to a Response","undefined"], answer: 2 },
    { q: "Which method parses the response body as JSON?", choices: ["response.text()","response.parse()","response.json()","response.data()"], answer: 2 },
    { q: "When is .catch() triggered in a fetch chain?", choices: ["Only on 404 errors","Only on network failure","On network errors, thrown errors, or JSON parsing failures","Never automatically"], answer: 2 },
  ]},
];



const QUOTES_CORRECT = [
  "Champions are made when no one is watching.",
  "Talent is nothing. Hard work is everything.",
  "Winning is a habit. Keep building it.",
  "The best never stop improving.",
  "Pressure creates diamonds. You just proved it.",
  "Excellence is not a destination — it is a standard.",
];
const QUOTES_WRONG = [
  "A loss is just data. Adapt and go again.",
  "The only failure is stopping. Try again.",
  "Every expert was once a beginner who refused to quit.",
  "Training reveals weaknesses. Now you know. Fix it.",
  "Mistakes sharpen the blade. Review and return.",
];

let currentTopic = -1;

/* ============================================================
   THEME SYSTEM
   ============================================================ */

// EN: Apply theme to <html> and update button label
// HI-EN: Theme change karte time html attribute update karo aur button text bhi
function applyTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
  const icon  = document.getElementById("theme-icon");
  const label = document.getElementById("theme-label");
  if (theme === "dark") { icon.textContent = "☀️"; label.textContent = "Light"; }
  else                  { icon.textContent = "🌙"; label.textContent = "Dark";  }
}

// EN: Saves theme preference so it persists after reload
// HI-EN: Yeh theme choice browser mein save karta hai taaki refresh ke baad bhi same rahe
function toggleTheme() {
  const current = document.documentElement.getAttribute("data-theme") || "dark";
  const next    = current === "dark" ? "light" : "dark";
  localStorage.setItem("theme", next);
  applyTheme(next);
}

// EN: Load saved theme on page start (or default to dark)
// HI-EN: Page load pe pehle saved theme check karo, nahi mila toh dark
(function initTheme() {
  const saved = localStorage.getItem("theme") || "dark";
  applyTheme(saved);
})();

document.getElementById("theme-toggle").addEventListener("click", toggleTheme);

/* ============================================================
   SCROLL PROGRESS
   ============================================================ */

// EN: Updates the progress bar width based on scroll position
// HI-EN: Scroll ke hisaab se top bar ki width update hoti hai
const progressBar = document.getElementById("scroll-progress");
window.addEventListener("scroll", function () {
  const scrollTop  = window.scrollY;
  const docHeight  = document.documentElement.scrollHeight - window.innerHeight;
  const pct        = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
  progressBar.style.width = pct + "%";
}, { passive: true });

/* ============================================================
   REVEAL ANIMATIONS (IntersectionObserver)
   ============================================================ */

// EN: Detects when .reveal elements enter viewport and animates them
// HI-EN: Yeh check karta hai kab element screen mein aata hai, phir animate karta hai
const revealObserver = new IntersectionObserver(
  function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        entry.target.classList.add("visible");
        revealObserver.unobserve(entry.target);
      }
    });
  },
  { threshold: 0.1 }
);

document.querySelectorAll(".reveal").forEach(function (el) {
  revealObserver.observe(el);
});

/* ============================================================
   MODAL SYSTEM
   ============================================================ */

const overlay    = document.getElementById("modal-overlay");
const modalBody  = document.getElementById("modal-body");
const modalTitle = document.getElementById("modal-topic-title");

// EN: Transforms raw comparison div into premium two-panel layout
// HI-EN: Old boring comparison div ko naye premium panel layout mein convert karta hai
function transformComparison(compEl) {
  const wrapper = document.createElement("div");
  wrapper.className = "comparison";

  // Topic title
  const titleEl = compEl.querySelector(".topic-title");
  if (titleEl) {
    const h = document.createElement("h2");
    h.className = "topic-title";
    h.innerHTML = titleEl.innerHTML;
    wrapper.appendChild(h);
  }

  // Get old and new panels
  const oldPanel = compEl.querySelector(".old-syntax");
  const newPanel = compEl.querySelector(".new-syntax");

  if (oldPanel && newPanel) {
    // Two-column grid
    const grid = document.createElement("div");
    grid.className = "comparison-grid";

    grid.appendChild(buildPanel(oldPanel, "old"));
    grid.appendChild(buildPanel(newPanel, "new"));
    wrapper.appendChild(grid);
  } else if (oldPanel || newPanel) {
    // Single panel (some topics have just one)
    const single = oldPanel || newPanel;
    wrapper.appendChild(buildPanel(single, "new"));
  }

  return wrapper;
}

// EN: Builds a styled panel from a syntax div, with copy button
// HI-EN: Ek syntax div ko styled panel mein convert karta hai, copy button ke saath
function buildPanel(panelEl, type) {
  const panel = document.createElement("div");
  panel.className = "panel panel-" + type;

  // Header
  const header = document.createElement("div");
  header.className = "panel-header";

  const h3 = document.createElement("h3");
  const origH3 = panelEl.querySelector("h3");
  h3.innerHTML = origH3 ? origH3.innerHTML : (type === "old" ? "❌ Before" : "✅ After");
  header.appendChild(h3);

  // Copy button
  const pre = panelEl.querySelector("pre");
  if (pre) {
    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "copy";
    copyBtn.setAttribute("aria-label", "Copy code");

    // EN: Copies code text to clipboard and shows feedback
    // HI-EN: Code copy karta hai aur 2 second ke liye "copied!" dikhata hai
    copyBtn.addEventListener("click", function () {
      const codeEl = pre.querySelector("code");
      const text   = codeEl ? codeEl.innerText : pre.innerText;
      navigator.clipboard.writeText(text).then(function () {
        copyBtn.textContent = "copied!";
        copyBtn.classList.add("copied");
        setTimeout(function () {
          copyBtn.textContent = "copy";
          copyBtn.classList.remove("copied");
        }, 2000);
      }).catch(function() {
        copyBtn.textContent = "copy";
      });
    });

    header.appendChild(copyBtn);
  }
  panel.appendChild(header);

  // Code block
  if (pre) {
    panel.appendChild(pre.cloneNode(true));
  }

  // Notes and explanations
  const note = panelEl.querySelector(".note");
  const expl = panelEl.querySelector(".explanation");

  if (note) {
    panel.appendChild(transformBox(note, "note"));
  }

  if (expl) {
    panel.appendChild(transformInsight(expl));
  }

  // Also clone any direct insight-row (e.g. fetch-explain) present in the panel
  const directInsight = panelEl.querySelector(".fetch-explain");
  if (directInsight) {
    panel.appendChild(directInsight.cloneNode(true));
  }

  return panel;
}

// EN: Clones a note div cleanly
// HI-EN: Note box ko clone karke return karta hai
function transformBox(el, cls) {
  const box = document.createElement("div");
  box.className = cls;
  box.innerHTML = el.innerHTML;
  return box;
}

// EN: Splits Hinglish/English explanation into two styled insight boxes
// HI-EN: Explanation div ko do alag boxes mein split karta hai — ek Hinglish, ek English
function transformInsight(expl) {
  const raw = expl.innerHTML;

  // Check if it has Hinglish and English sections
  const hasHI = raw.includes("🇮🇳") || raw.includes("Hinglish");
  const hasEN = raw.includes("🇬🇧") || raw.includes("English:");

  if (!hasHI && !hasEN) {
    const box = document.createElement("div");
    box.className = "explanation";
    box.innerHTML = raw;
    return box;
  }

  const row = document.createElement("div");
  row.className = "insight-row";

  // Parse Hinglish part
  if (hasHI) {
    const hiBox = document.createElement("div");
    hiBox.className = "insight-box hi";

    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = "🇮🇳 Hinglish";
    hiBox.appendChild(tag);

    // Extract hinglish text (between Hinglish: and English:)
    const hiMatch = raw.match(/Hinglish[^:]*:\s*([\s\S]*?)(?=🇬🇧|English:|$)/i);
    if (hiMatch) {
      const p = document.createElement("span");
      p.innerHTML = hiMatch[1].replace(/<br\s*\/?>/gi, " ").trim();
      hiBox.appendChild(p);
    }
    row.appendChild(hiBox);
  }

  // Parse English part
  if (hasEN) {
    const enBox = document.createElement("div");
    enBox.className = "insight-box en";

    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = "🇬🇧 English";
    enBox.appendChild(tag);

    const enMatch = raw.match(/🇬🇧[^:]*:\s*([\s\S]*?)(?=$)/i) ||
                    raw.match(/English[^:]*:\s*([\s\S]*?)(?=$)/i);
    if (enMatch) {
      const p = document.createElement("span");
      p.innerHTML = enMatch[1].replace(/<br\s*\/?>/gi, " ").trim();
      enBox.appendChild(p);
    }
    row.appendChild(enBox);
  }

  return row;
}

// EN: Builds nav footer with next topic buttons
// HI-EN: Modal ke bottom mein next topics ke buttons banata hai
function buildNavFooter(topicNum) {
  const footer = document.createElement("div");
  footer.className = "nav-footer";

  const title = document.createElement("div");
  title.className = "nav-footer-title";
  title.textContent = "Continue Learning";
  footer.appendChild(title);

  const buttons = document.createElement("div");
  buttons.className = "nav-buttons";

  for (let i = 1; i <= 3; i++) {
    const next = topicNum + i;
    if (next < TOTAL) {
      const btn = document.createElement("button");
      btn.className = "nav-btn";
      btn.innerHTML = '<span class="arrow">→</span>' + next + ". " + TOPIC_TITLES[next];
      btn.addEventListener("click", function () { openTopic(next); });
      buttons.appendChild(btn);
    }
  }
  footer.appendChild(buttons);

  const backBtn = document.createElement("button");
  backBtn.className = "nav-btn-back";
  backBtn.innerHTML = "← Back to Index";
  backBtn.addEventListener("click", closeTopic);
  footer.appendChild(backBtn);

  return footer;
}

// EN: Opens modal for a topic by number
// HI-EN: Topic number se modal kholta hai aur content inject karta hai
function openTopic(num) {
  const sourceEl = document.getElementById("topic-" + num);
  if (!sourceEl) return;

  currentTopic = num;

  // Mark as viewed
  viewedTopics.add(num);
  updateProgressBadge();

  // Set modal title
  modalTitle.textContent = num + ". " + TOPIC_TITLES[num];

  // Build content
  modalBody.innerHTML = "";
  const transformed = transformComparison(sourceEl);
  modalBody.appendChild(transformed);
  modalBody.appendChild(buildNavFooter(num));

  // Show overlay
  overlay.classList.add("active");
  document.body.style.overflow = "hidden";

  // Bounce entrance animation for modal content
  modalBody.classList.remove("modal-body-anim");
  void modalBody.offsetWidth; // reflow
  modalBody.classList.add("modal-body-anim");
  setTimeout(function() { modalBody.classList.remove("modal-body-anim"); }, 320);

  // EN: Scroll modal to top after content injection
  // HI-EN: Content inject hone ke baad modal ko top pe scroll karo
  overlay.scrollTop = 0;
  document.getElementById("modal-box").scrollTop = 0;
}

function closeTopic() {
  // HARD BLOCK: If validation lock is active, show validation instead of closing
  if (validationLock.active) {
    _shakeValidationOverlay();
    return;
  }
  overlay.classList.remove("active");
  document.body.style.overflow = "";
  currentTopic = -1;
}

// EN: Update the "X / 33 topics" badge in the header
// HI-EN: Header mein viewed topics ka count update karta hai
function updateProgressBadge() {
  document.getElementById("progress-badge").textContent =
    viewedTopics.size + " / " + TOTAL + " topics";
}

// EN: Load saved viewed topics from localStorage on page start
// HI-EN: Page load pe pehle saved progress restore karo
(function restoreProgress() {
  try {
    const saved = JSON.parse(localStorage.getItem("viewedTopics") || "[]");
    saved.forEach(function(n) { viewedTopics.add(n); });
    updateProgressBadge();
  } catch(e) {}
  try {
    const savedM = JSON.parse(localStorage.getItem("masteredTopics") || "[]");
    savedM.forEach(function(n) { masteredTopics.add(n); });
  } catch(e) {}
})();

// EN: Save progress whenever a topic is viewed
// HI-EN: Har topic dekhe pe localStorage mein save karo
function saveProgress() {
  try {
    localStorage.setItem("viewedTopics", JSON.stringify([...viewedTopics]));
  } catch(e) {}
}

/* ============================================================
   EVENT DELEGATION FOR TOC LINKS
   ============================================================ */

// EN: Single listener handles all topic link clicks (efficient delegation)
// HI-EN: Ek hi listener se saare topic links handle hote hain — efficient hai
document.addEventListener("click", function (e) {
  const link = e.target.closest("[data-topic]");
  if (link) {
    e.preventDefault();
    const num = parseInt(link.getAttribute("data-topic"), 10);
    openTopic(num);
    saveProgress();
  }

  // Close button — blocked during validation lock
  if (e.target.closest("#modal-close-btn")) {
    if (validationLock.active) {
      _shakeValidationOverlay();
      openMasteryOverlay(validationLock.topicId);
    } else {
      closeTopic();
    }
  }

  // Click outside modal box to close — blocked during validation lock
  if (e.target === overlay) {
    if (validationLock.active) {
      _shakeValidationOverlay();
    } else {
      closeTopic();
    }
  }
});

/* ============================================================
   KEYBOARD NAVIGATION
   ============================================================ */

// EN: Keyboard shortcuts: Escape to close, arrows to navigate topics
// HI-EN: Esc se modal band, left/right arrows se topics navigate karo
document.addEventListener("keydown", function (e) {
  if (!overlay.classList.contains("active")) return;

  if (e.key === "Escape") {
    if (validationLock.active) {
      // Cannot escape modal when lock is active
      _shakeValidationOverlay();
    } else {
      closeTopic();
    }
  } else if (e.key === "ArrowRight" && currentTopic < TOTAL - 1) {
    if (validationLock.active) { _shakeValidationOverlay(); return; }
    openTopic(currentTopic + 1);
    saveProgress();
  } else if (e.key === "ArrowLeft" && currentTopic > 0) {
    if (validationLock.active) { _shakeValidationOverlay(); return; }
    openTopic(currentTopic - 1);
    saveProgress();
  }
});

/* ============================================================
   SEARCH SYSTEM
   ============================================================ */

const searchInput   = document.getElementById("search-input");
const searchResults = document.getElementById("search-results");

// EN: Filter topics by search query and show dropdown results
// HI-EN: User ke type karne par matching topics dropdown mein dikhata hai
searchInput.addEventListener("input", function () {
  const q = this.value.trim().toLowerCase();

  if (!q) { searchResults.classList.remove("open"); return; }

  const matches = TOPIC_TITLES
    .map(function(title, i) { return { i, title }; })
    .filter(function(t) { return t.title.toLowerCase().includes(q); });

  if (!matches.length) { searchResults.classList.remove("open"); return; }

  searchResults.innerHTML = "";
  matches.slice(0, 8).forEach(function(t) {
    const item = document.createElement("div");
    item.className = "search-result-item";
    item.setAttribute("role", "option");
    item.innerHTML = '<span class="ri">' + String(t.i).padStart(2,"0") + '</span>' +
                     '<span>' + t.title + '</span>';
    item.addEventListener("click", function () {
      searchInput.value = "";
      searchResults.classList.remove("open");
      openTopic(t.i);
      saveProgress();
    });
    searchResults.appendChild(item);
  });
  searchResults.classList.add("open");
});

// EN: Close search dropdown when clicking elsewhere
// HI-EN: Search box ke bahar click karne se dropdown band ho jaata hai
document.addEventListener("click", function (e) {
  if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
    searchResults.classList.remove("open");
  }
});

// EN: Allow keyboard navigation inside search results
// HI-EN: Search dropdown mein Enter se topic kholta hai
searchInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    const first = searchResults.querySelector(".search-result-item");
    if (first) first.click();
  }
  if (e.key === "Escape") {
    searchResults.classList.remove("open");
    searchInput.value = "";
  }
});
/* ============================================================
   XP / LEVEL / MASTERY SYSTEM
   ============================================================ */

// EN: XP config — each topic = 30 XP, levels defined by thresholds
// HI-EN: Har topic 30 XP deta hai; level thresholds se level decide hota hai
const XP_PER_TOPIC = 30;
const LEVELS = [
  { lvl:1, min:0,   label:"Lvl 1",   title:"Beginner"    },
  { lvl:2, min:90,  label:"Lvl 2",   title:"Learner"     },
  { lvl:3, min:210, label:"Lvl 3",   title:"Explorer"    },
  { lvl:4, min:390, label:"Lvl 4",   title:"Developer"   },
  { lvl:5, min:600, label:"Lvl 5",   title:"Advanced"    },
  { lvl:6, min:870, label:"Lvl 6",   title:"Pro Dev"     },
  { lvl:7, min:990, label:"MAX",     title:"JS Master 🏆"},
];

function getLevelInfo(xp) {
  let cur = LEVELS[0], next = LEVELS[1];
  for (let i = 0; i < LEVELS.length; i++) {
    if (xp >= LEVELS[i].min) { cur = LEVELS[i]; next = LEVELS[i+1] || null; }
  }
  return { cur, next };
}

// EN: Renders XP bar, level badge, and mastery ring based on MASTERED count (not just viewed)
// HI-EN: Sirf mastered topics ke hisaab se XP bar, level, aur ring update karta hai
let _lastRenderedXP = 0;
function renderXP() {
  const xp    = masteredTopics.size * XP_PER_TOPIC;  // XP only from mastered topics
  const pct   = Math.round((masteredTopics.size / TOTAL) * 100);
  const info  = getLevelInfo(xp);
  const nextXP = info.next ? info.next.min : xp;
  const prevXP = info.cur.min;
  const segPct = info.next
    ? Math.min(100, ((xp - prevXP) / (nextXP - prevXP)) * 100)
    : 100;

  const didEarn = xp > _lastRenderedXP;
  _lastRenderedXP = xp;

  // XP bar fill
  document.getElementById("xp-fill").style.width = segPct + "%";
  document.getElementById("xp-pts").textContent   = xp + " XP";
  document.getElementById("xp-level-txt").textContent = info.cur.label;

  // Mastery ring (circumference = 2π×18 ≈ 113)
  const offset = 113 - (113 * pct / 100);
  document.getElementById("mastery-ring-fill").style.strokeDashoffset = offset;
  document.getElementById("mastery-pct").textContent = pct + "%";

  // Progress badge
  document.getElementById("progress-badge").textContent =
    viewedTopics.size + " / " + TOTAL + " topics";

  // Micro-animation: mastery earn feedback (green glow)
  if (didEarn) {
    function flashMastery(id) {
      var el = document.getElementById(id);
      if (!el) return;
      el.classList.remove("mastery-earn");
      void el.offsetWidth;
      el.classList.add("mastery-earn");
      setTimeout(function() { el.classList.remove("mastery-earn"); }, 900);
    }
    flashMastery("xp-fill");
    flashMastery("xp-pts");
    flashMastery("wapos-xp-fill");
    flashMastery("wapos-xp-pts");
  }
}

/* ============================================================
   STREAK SYSTEM
   ============================================================ */

// EN: Tracks daily visits; increments streak if gap < 2 days
// HI-EN: Roz visit track karta hai — ek din gap aane pe streak maintain, zyada gap pe reset
(function initStreak() {
  try {
    const today    = new Date().toDateString();
    const lastDay  = localStorage.getItem("lastVisitDay") || "";
    const streak   = parseInt(localStorage.getItem("streak") || "1", 10);
    const yesterday = new Date(Date.now() - 86400000).toDateString();

    let newStreak = 1;
    if (lastDay === today) {
      newStreak = streak;
    } else if (lastDay === yesterday) {
      newStreak = streak + 1;
    }

    localStorage.setItem("lastVisitDay", today);
    localStorage.setItem("streak", newStreak);
    document.getElementById("streak-count").textContent = newStreak;
  } catch(e) {}
})();

/* ============================================================
   TOAST NOTIFICATION SYSTEM
   ============================================================ */

const toastWrap = document.getElementById("toast-wrap");

// EN: Shows a toast message with auto-dismiss after delay
// HI-EN: Toast popup dikhata hai, kuch seconds baad automatic band ho jaata hai
function showToast(icon, title, msg, delay) {
  const t = document.createElement("div");
  t.className = "toast";
  t.innerHTML = '<span class="t-icon">' + icon + '</span>' +
    '<div class="t-msg"><strong>' + title + '</strong>' + msg + '</div>';
  toastWrap.appendChild(t);
  setTimeout(function () {
    t.classList.add("t-out");
    setTimeout(function() { t.remove(); }, 320);
  }, delay || 3000);
}

/* ============================================================
   CONFETTI BURST
   ============================================================ */

const CONFETTI_COLORS = ["#4f9eff","#3dd68c","#ff6b6b","#f0a500","#a78bfa","#ffd700"];

// EN: Spawns a row of colored squares that fall from top — section completion reward
// HI-EN: Colorful squares screen ke upar se girte hain — section complete hone ka reward
function burstConfetti() {
  const wrap = document.createElement("div");
  wrap.className = "confetti-burst";
  for (let i = 0; i < 14; i++) {
    const s = document.createElement("span");
    s.style.cssText =
      "background:" + CONFETTI_COLORS[i % CONFETTI_COLORS.length] + ";" +
      "animation-delay:" + (i * 55) + "ms;" +
      "animation-duration:" + (700 + Math.random() * 400) + "ms;" +
      "transform: translateX(" + (Math.random() * 40 - 20) + "px)";
    wrap.appendChild(s);
  }
  document.body.appendChild(wrap);
  setTimeout(function() { wrap.remove(); }, 1400);
}

/* ============================================================
   SECTION COMPLETION DETECTION
   ============================================================ */

// EN: Section topic ranges — used to detect full section completion
// HI-EN: Har section ke topics define hain — section complete hone pe reward milega
const SECTIONS = [
  { topics: [0,1,2,3,4,5,6,7,8,9,10,11,12], doneId: "sdone-0", name: "ES5 vs ES6" },
  { topics: [13,14,15,16,17,18,19,20],       doneId: "sdone-1", name: "Array Methods + Timers" },
  { topics: [21,22,23,24,25,26,27,28,29],    doneId: "sdone-2", name: "Advanced Concepts" },
  { topics: [30,31,32,33],                      doneId: "sdone-3", name: "Promises & Async" },
];

// EN: Check if a section is fully mastered and fire celebration if so
// HI-EN: Agar section ke saare topics master ho gaye toh toast dikhao
function checkSectionCompletion(sectionIdx) {
  const sec = SECTIONS[sectionIdx];
  if (!sec) return;
  const allDone = sec.topics.every(function(n) { return masteredTopics.has(n); });
  const badge   = document.getElementById(sec.doneId);
  if (allDone && badge) {
    if (badge.style.display === "none") {
      badge.style.display = "";
      showToast("", "Section mastered.", sec.name + " — all topics validated.", 2500);
    }
  }
}

function checkAllSections() {
  SECTIONS.forEach(function(_, i) { checkSectionCompletion(i); });
}

/* ============================================================
   TOC CHECKMARK RENDERER
   ============================================================ */

// EN: Marks each viewed topic link with .viewed or .mastered class
// HI-EN: Dekhe gaye topics pe .viewed class, mastered pe .mastered class lagate hain
function renderTOCChecks() {
  viewedTopics.forEach(function(num) {
    const link = document.querySelector('[data-topic="' + num + '"]');
    if (link) {
      link.classList.add("viewed");
      if (masteredTopics.has(num)) {
        link.classList.add("mastered");
        link.classList.add("done"); // keep backward compat
      } else {
        link.classList.remove("mastered");
        link.classList.add("done"); // viewed = done for nav purposes
      }
    }
  });
}

/* ============================================================
   LAST SESSION RECALL BANNER
   ============================================================ */

// EN: Shows "continue where you left off" if user visited before
// HI-EN: Agar pehle visit kar chuke ho toh last topic yaad dilata hai
(function initRecall() {
  try {
    const lastTopic = parseInt(localStorage.getItem("lastTopic") || "-1", 10);
    if (lastTopic >= 0 && lastTopic < TOTAL) {
      const banner   = document.getElementById("recall-banner");
      const topicNameEl = document.getElementById("rb-topic-name");
      if (banner && topicNameEl) {
        topicNameEl.textContent = lastTopic + ". " + TOPIC_TITLES[lastTopic];
        banner.classList.add("show");

        document.getElementById("rb-resume").addEventListener("click", function () {
          if (validationLock && validationLock.active) {
            _shakeValidationOverlay();
            return;
          }
          banner.classList.remove("show");
          openTopic(lastTopic);
          saveProgress();
        });

        document.getElementById("rb-dismiss").addEventListener("click", function () {
          banner.classList.remove("show");
        });
      }
    }
  } catch(e) {}
})();

/* ============================================================
   MOTIVATIONAL TOAST MILESTONES
   ============================================================ */

const MILESTONE_MSGS = {
  1:  ["", "Topic 01 complete.", "Progress recorded."],
  5:  ["", "5 topics logged.",   "Consistent progress."],
  10: ["", "10 topics done.",    "Significant coverage."],
  16: ["", "Halfway point.",     "16 of 33 modules complete."],
  25: ["", "25 topics.",         "8 remaining."],
  33: ["", "All 33 complete.",   "Full curriculum covered."],
};

// EN: Fires milestone toast when specific view counts are hit
// HI-EN: Kuch khaas counts pe motivational toast dikhata hai
function checkMilestone(count) {
  if (MILESTONE_MSGS[count]) {
    const m = MILESTONE_MSGS[count];
    setTimeout(function() {
      showToast(m[0], m[1], m[2], 2000);
    }, 600);
  }
}

/* ============================================================
   PATCH openTopic TO WIRE ALL NEW SYSTEMS
   ============================================================ */

// EN: Store original openTopic so we can extend it non-destructively
// HI-EN: Purana openTopic save karte hain taaki naye features add kar sakein bina todey
const _origOpenTopic = openTopic;

openTopic = function(num) {
  // MANDATORY VALIDATION LOCK — block all topic navigation until question answered
  if (validationLock.active && num !== validationLock.topicId) {
    _shakeValidationOverlay();
    if (typeof showToast !== 'undefined') {
      showToast("", "Answer the question first.", "Navigation is locked until validated.", 1800);
    }
    return;
  }

  const prevSize = viewedTopics.size;
  _origOpenTopic(num);
  /* === NEW ADDITION START === */
  // Reset validation-passed flag for each newly opened topic
  window._topicValidationPassed = false;
  /* === NEW ADDITION END === */

  // Save last topic for recall
  try { localStorage.setItem("lastTopic", num); } catch(e) {}

  // Update all UI systems (XP only updates when masteredTopics grows, not viewedTopics)
  renderXP();
  renderTOCChecks();
  checkAllSections();

  // Modal progress strip and counter (based on viewed for navigation context)
  const pct = ((num + 1) / TOTAL) * 100;
  const fill = document.getElementById("modal-prog-fill");
  if (fill) fill.style.width = pct + "%";

  const counter = document.getElementById("modal-topic-counter");
  if (counter) counter.textContent = (num + 1) + " / " + TOTAL;

  // Mark this link as viewed
  const link = document.querySelector('[data-topic="' + num + '"]');
  if (link) {
    link.classList.add("done", "viewed");
    if (masteredTopics.has(num)) link.classList.add("mastered");
  }
};

/* ============================================================
   SMART "RECOMMENDED NEXT" — inject rec badge into nav footer
   ============================================================ */

// EN: Wraps the first next-topic button with a "Recommended" badge
// HI-EN: Pehle next button ko "Recommended" badge deta hai — algorithmic lagta hai
const _origBuildNavFooter = buildNavFooter;
buildNavFooter = function(topicNum) {
  const footer = _origBuildNavFooter(topicNum);
  const firstBtn = footer.querySelector(".nav-btn");
  if (firstBtn) {
    const badge = document.createElement("div");
    badge.className = "rec-badge";
    badge.innerHTML = "✦ Recommended Next";
    firstBtn.parentNode.insertBefore(badge, firstBtn);
    firstBtn.classList.add("nav-btn-rec");
  }
  return footer;
};

/* ============================================================
   INIT ALL SYSTEMS ON PAGE LOAD
   ============================================================ */

// EN: Run all rendering systems once on load using restored progress
// HI-EN: Page load pe ek baar sab systems ko restore karo aur render karo
renderXP();
renderTOCChecks();
checkAllSections();

/* ============================================================
   V3 UPGRADE 1 — XP POP FLOAT
   Shows "+30 XP" floating from the XP bar when a topic is opened
   ============================================================ */

// EN: Spawns a "+30 XP" float near the XP bar for instant reward feedback
// HI-EN: Topic kholne pe XP bar ke paas "+30 XP" float karke dikhata hai
function spawnXPPop(amount) {
  const bar = document.getElementById("xp-bar-wrap");
  if (!bar) return;
  const rect = bar.getBoundingClientRect();
  const pop  = document.createElement("div");
  pop.className = "xp-pop";
  pop.textContent = "+" + amount + " XP";
  pop.style.cssText =
    "left:" + (rect.right - 70) + "px;" +
    "top:" + (rect.top + window.scrollY - 4) + "px;";
  document.body.appendChild(pop);
  setTimeout(function() { pop.remove(); }, 1200);
}

/* ============================================================
   V3 UPGRADE 2 — LEVEL-UP CELEBRATION OVERLAY
   Full-screen moment when a new level is reached
   ============================================================ */

// EN: Tracks last level so we can detect when user crosses a threshold
// HI-EN: Pichla level yaad rakhta hai taaki level-up detect kar sakein
let _lastLevel = 1;

// EN: Shows epic full-screen level-up animation
// HI-EN: Level up hone pe full screen flash aur title dikhata hai
function showLevelUp(levelLabel, levelTitle) {
  const el = document.createElement("div");
  el.className = "levelup-flash";
  el.innerHTML =
    '<div class="levelup-inner">' +
      '<div class="lu-label">Level</div>' +
      '<div class="lu-title">' + levelLabel + '</div>' +
      '<div class="lu-sub">' + levelTitle + '</div>' +
    '</div>';
  document.body.appendChild(el);
  setTimeout(function() { el.remove(); }, 1300);
}

/* ============================================================
   V3 UPGRADE 3 — ESTIMATED READ TIME in modal
   Sets expectations and signals a curated, thoughtful experience
   ============================================================ */

// EN: Estimates read time from code block character count
// HI-EN: Code block ke characters se reading time calculate karta hai
function estimateReadTime(topicEl) {
  const text = topicEl ? (topicEl.innerText || topicEl.textContent || "") : "";
  const words = text.trim().split(/\s+/).length;
  const mins  = Math.max(1, Math.round(words / 200));
  return mins;
}

/* ============================================================
   V3 UPGRADE 4 — MOUSE-TRACKED AMBIENT GLOW on TOC cards
   Premium material feel — card reacts to where your cursor is
   ============================================================ */

// EN: Updates CSS custom property with mouse position for radial gradient tracking
// HI-EN: Mouse position se CSS variable update karta hai taaki glow follow kare
document.querySelectorAll(".toc-card").forEach(function(card) {
  card.addEventListener("mousemove", function(e) {
    const r = card.getBoundingClientRect();
    const x = ((e.clientX - r.left) / r.width)  * 100;
    const y = ((e.clientY - r.top)  / r.height) * 100;
    card.style.setProperty("--mx", x + "%");
    card.style.setProperty("--my", y + "%");
  });
});

/* ============================================================
   V3 UPGRADE 5 — "NEXT UP" INDICATOR on TOC
   Always highlights the logical next unvisited topic
   ============================================================ */

// EN: Finds first unvisited topic and marks it as "next up" with a pulse arrow
// HI-EN: Pehla unvisited topic dhundh ke usse "next up" arrow se highlight karta hai
function markNextUp() {
  document.querySelectorAll(".toc-link.next-up").forEach(function(el) {
    el.classList.remove("next-up");
    const arr = el.querySelector(".next-up-arrow");
    if (arr) arr.remove();
  });

  for (let i = 0; i < TOTAL; i++) {
    if (!viewedTopics.has(i)) {
      const link = document.querySelector('[data-topic="' + i + '"]');
      if (link && !link.classList.contains("done")) {
        link.classList.add("next-up");
        const arrow = document.createElement("span");
        arrow.className = "next-up-arrow";
        arrow.textContent = "←";
        link.appendChild(arrow);
      }
      break;
    }
  }
}

// FAB removed — Continue Learning component removed

/* ============================================================
   V3 UPGRADE 7 — HERO STAT COUNT-UP ANIMATION
   Counted numbers feel alive — creates perceived system activity
   ============================================================ */

// EN: Animates a number from 0 to target over duration ms
// HI-EN: Number ko 0 se target tak animate karta hai
function countUp(el, target, duration) {
  if (!el) return;
  const start = Date.now();
  const initial = parseInt(el.textContent, 10) || 0;
  function tick() {
    const elapsed = Date.now() - start;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    el.textContent = Math.round(initial + (target - initial) * eased);
    if (progress < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

// EN: Runs count-up on the "33 Topics" and "4 Sections" hero stats
// HI-EN: Hero section ke stats ko count-up animation se animate karta hai
(function initCountUp() {
  const nums = document.querySelectorAll(".hero .stat-item .num");
  nums.forEach(function(el) {
    const val = parseInt(el.textContent, 10);
    if (!isNaN(val)) {
      el.textContent = "0";
      setTimeout(function() { countUp(el, val, 900); }, 400);
    }
  });
})();

/* ============================================================
   V3 PATCH — Wire new systems into existing openTopic patch
   ============================================================ */

// EN: Extends existing patched openTopic with v3 features
// HI-EN: Pehle se patched openTopic mein v3 features add karte hain
const _v2OpenTopic = openTopic;

openTopic = function(num) {
  const prevLevel = getLevelInfo(masteredTopics.size * XP_PER_TOPIC).cur.lvl;

  _v2OpenTopic(num);

  const newLevel = getLevelInfo(masteredTopics.size * XP_PER_TOPIC).cur;

  // Level-up celebration (only if mastery grew)
  if (newLevel.lvl > prevLevel && newLevel.lvl !== _lastLevel) {
    _lastLevel = newLevel.lvl;
    setTimeout(function() { showLevelUp(newLevel.label, newLevel.title); }, 400);
  }

  // Update read time badge
  const sourceEl = document.getElementById("topic-" + num);
  const mins     = estimateReadTime(sourceEl);
  const badge    = document.getElementById("read-time-badge");
  if (badge) badge.textContent = "⏱ ~" + mins + " min";

  // Update "next up" indicator
  markNextUp();
};

// EN: Re-show FAB 2s after modal closes if topics remain
// HI-EN: Modal band hone ke 2s baad FAB wapas dikhata hai agar topics baaki hain
const _origCloseTopic = closeTopic;
closeTopic = function() {
  // Lock guard (also in base, but explicit here for chain safety)
  if (validationLock && validationLock.active) {
    _shakeValidationOverlay();
    return;
  }
  _origCloseTopic();
  // Reset search state so sections show on next focus (not cached results)
  setTimeout(function() {
    var searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.value = '';
    }
    // Clear any open search results and reset to section-show mode
    var searchResults = document.getElementById('search-results');
    if (searchResults) {
      searchResults.innerHTML = '';
      searchResults.style.display = 'none';
      searchResults.classList && searchResults.classList.remove('open');
    }
    // Reset section panel — close topics panel, show sections
    var topicsPanel = document.getElementById('td-topics-panel');
    var sectionList = document.getElementById('td-section-list');
    var discovery = document.getElementById('topbar-discovery');
    if (topicsPanel) { topicsPanel.style.display = 'none'; }
    if (sectionList) { sectionList.style.display = ''; sectionList.style.opacity = '1'; }
    if (discovery) { discovery.classList.remove('open'); }
    // Reset active section button states
    document.querySelectorAll('.td-section-btn').forEach(function(b) { b.classList.remove('active'); });
    // Restore sections visibility
    var sectionsEl = document.getElementById('td-sections');
    if (sectionsEl) sectionsEl.style.display = '';
  }, 50);
};

/* ============================================================
   V4 INIT BLOCK — all new systems
   ============================================================ */

/* --- SESSION COUNTER ---
   EN: Tracks how many topics were opened in this browser session
   HI-EN: Is session mein kitne topics dekhe — session memory mein store hota hai */
let sessionCount = 0;
const DAILY_GOAL = 3;

function updateSessionStat() {
  const el = document.getElementById("ss-num");
  if (!el) return;
  const prev = parseInt(el.textContent, 10) || 0;
  el.textContent = sessionCount;
  if (sessionCount > prev) {
    const delta = document.createElement("span");
    delta.className = "ss-delta";
    delta.textContent = "+1";
    el.parentNode.style.position = "relative";
    el.parentNode.appendChild(delta);
    setTimeout(function() { delta.remove(); }, 750);
  }
}

/* --- DAILY GOAL RING ---
   EN: Reads today's session count and fills the daily ring toward goal of 3
   HI-EN: Aaj ke topics count karke ring ko goal tak fill karta hai */
function updateDailyRing(count) {
  const pct  = Math.min(count / DAILY_GOAL, 1);
  const circ = 63; // 2π×10 (r=10 at viewBox 22)
  const fill = document.getElementById("dr-fill");
  const txt  = document.getElementById("daily-done");
  if (fill) fill.style.strokeDashoffset = circ - circ * pct;
  if (txt)  txt.textContent = Math.min(count, DAILY_GOAL) + "/" + DAILY_GOAL;
}

// EN: Restore today's session count from localStorage
// HI-EN: Aaj kitne topics dekhe the woh localStorage se wapas laate hain
(function initDailyRing() {
  try {
    const today   = new Date().toDateString();
    const stored  = JSON.parse(localStorage.getItem("dailyActivity") || "{}");
    const todayN  = stored[today] || 0;
    updateDailyRing(todayN);
  } catch(e) {}
})();

function recordDailyActivity() {
  try {
    const today  = new Date().toDateString();
    const stored = JSON.parse(localStorage.getItem("dailyActivity") || "{}");
    stored[today] = (stored[today] || 0) + 1;
    localStorage.setItem("dailyActivity", JSON.stringify(stored));
    updateDailyRing(stored[today]);
    if (stored[today] === DAILY_GOAL) {
      setTimeout(function() { showToast("", "Daily target reached.", DAILY_GOAL + " topics logged today.", 2000); }, 500);
    }
  } catch(e) {}
}

/* --- MASTERY HEATMAP ---
   EN: Renders 28 daily cells shaded by how many topics were studied each day
   HI-EN: 28 din ka grid banata hai — jis din zyada topics dekhe, cell zyada green hogi */
(function buildHeatmap() {
  const grid = document.getElementById("heatmap-grid");
  if (!grid) return;
  try {
    const stored = JSON.parse(localStorage.getItem("dailyActivity") || "{}");
    const today  = new Date();
    for (let i = 27; i >= 0; i--) {
      const d    = new Date(today.getTime() - i * 86400000);
      const key  = d.toDateString();
      const val  = stored[key] || 0;
      const cell = document.createElement("div");
      cell.className = "hm-cell" +
        (val === 0 ? "" : val === 1 ? " hm-1" : val <= 2 ? " hm-2" : val <= 4 ? " hm-3" : " hm-4") +
        (i === 0 ? " hm-today" : "");
      cell.title = key + (val ? ": " + val + " topic" + (val > 1 ? "s" : "") : ": no activity");
      grid.appendChild(cell);
    }
  } catch(e) {}
})();

// Insight ticker removed

/* --- COMPLETION SCREEN ---
   EN: After reading topic content, user can click "Got It" to see a completion moment
   HI-EN: Topic padhne ke baad "Got It" pe click karo — ek satisfying completion screen aata hai */
const COMPLETION_TITLES = [
  "Topic complete.", "Module logged.", "Concept recorded.",
  "Progress updated.", "Topic covered.", "Entry complete."
];
const COMPLETION_SUBS = [
  "Next topic available below.",
  "Module added to completion record.",
  "Concept logged. Continue when ready.",
  "Topic marked complete.",
  "Progress saved.",
];

// EN: Injects a "Mark as Complete" button at the bottom of the modal nav footer
// HI-EN: Nav footer mein "Mark as Complete" button inject karta hai — validation trigger
function injectGotItButton(topicNum) {
  const footer = document.getElementById("modal-body").querySelector(".nav-footer");
  if (!footer || footer.querySelector(".got-it-btn")) return;

  const btn = document.createElement("button");
  btn.className = "cs-btn-next got-it-btn";
  btn.style.cssText = [
    "margin-bottom:var(--sp-4)",
    "width:100%",
    "font-size:0.95rem",
    "padding:13px",
    "transition:transform 200ms cubic-bezier(.34,1.56,.64,1), box-shadow 200ms"
  ].join(";");
  btn.innerHTML = "✓ Mark as Complete";

  // Pulse entrance
  btn.style.transform = "scale(0.96)";
  btn.style.opacity = "0";
  setTimeout(function() {
    btn.style.transform = "scale(1)";
    btn.style.opacity = "1";
    btn.style.transition = "transform 300ms cubic-bezier(.34,1.56,.64,1), opacity 200ms ease";
  }, 20);

  // Hover micro-lift
  btn.addEventListener("mouseenter", function() {
    this.style.transform = "scale(1.02) translateY(-1px)";
    this.style.boxShadow = "0 4px 18px rgba(79,158,255,0.2)";
  });
  btn.addEventListener("mouseleave", function() {
    this.style.transform = "scale(1)";
    this.style.boxShadow = "";
  });

  btn.addEventListener("click", function() { triggerMasteryValidation(topicNum); });
  footer.insertBefore(btn, footer.firstChild);
}

// EN: Marks topic as viewed (white state), then launches validation question overlay
// HI-EN: Topic ko viewed (white) mark karta hai, phir validation question dikhata hai
function triggerMasteryValidation(topicNum) {
  // Mark as viewed (not yet mastered) — white state
  viewedTopics.add(topicNum);
  saveProgress();
  renderTOCChecks();

  // LOCK NAVIGATION — mandatory, blocks all navigation
  validationLock.active = true;
  validationLock.topicId = topicNum;

  // Show visual lock indicator on the close button
  var closeBtn = document.getElementById('modal-close-btn');
  if (closeBtn) {
    closeBtn.setAttribute('title', 'Answer the validation question to continue');
    closeBtn.style.opacity = '0.3';
    closeBtn.style.cursor = 'not-allowed';
    closeBtn.classList.add('locked');
  }

  // Mark toc-link as viewed
  const tocLink = document.querySelector('[data-topic="' + topicNum + '"]');
  if (tocLink) {
    tocLink.classList.add("viewed", "done");
    tocLink.classList.remove("mastered");
  }

  // Update the Got It button to show validated state
  const gotItBtn = document.querySelector(".got-it-btn");
  if (gotItBtn) {
    gotItBtn.textContent = "✓ Studied — Validate →";
    gotItBtn.disabled = true;
    gotItBtn.style.opacity = "0.5";
  }

  // Launch validation overlay
  openMasteryOverlay(topicNum);
}

/* ============================================================
   MASTERY VALIDATION OVERLAY SYSTEM
   ============================================================ */

let _masteryCurrentTopic = -1;
let _masteryAnswered = false;

// ============================================================
// GLOBAL VALIDATION LOCK — declared early (above), references here for docs
// ============================================================
// validationLock already declared at top of script

// Backwards compat aliases (for existing checks)
Object.defineProperty(window, '_navLocked', {
  get: function() { return validationLock.active; },
  set: function(v) { validationLock.active = v; }
});
Object.defineProperty(window, '_navLockedForTopic', {
  get: function() { return validationLock.topicId !== null ? validationLock.topicId : -1; },
  set: function(v) { validationLock.topicId = v >= 0 ? v : null; }
});

// Shake animation for blocked navigation
function _shakeValidationOverlay() {
  var dialog = document.getElementById('mastery-dialog');
  var ov = document.getElementById('mastery-overlay');
  // Ensure overlay is open
  if (ov && !ov.classList.contains('active')) {
    openMasteryOverlay(validationLock.topicId);
    // Add lock pulse after dialog animates in
    setTimeout(function() {
      if (dialog) {
        dialog.classList.remove('vl-shake', 'lock-active');
        void dialog.offsetWidth;
        dialog.classList.add('vl-shake', 'lock-active');
        setTimeout(function() { dialog.classList.remove('vl-shake', 'lock-active'); }, 1000);
      }
    }, 260);
    return;
  }
  if (!dialog) return;
  dialog.classList.remove('vl-shake', 'lock-active');
  void dialog.offsetWidth;
  dialog.classList.add('vl-shake', 'lock-active');
  setTimeout(function() { dialog.classList.remove('vl-shake', 'lock-active'); }, 1000);
  // Also shake the topbar / any blocked navigation elements
  var topbar = document.querySelector('.wapos-topbar-center');
  if (topbar) {
    topbar.classList.remove('nav-block-shake');
    void topbar.offsetWidth;
    topbar.classList.add('nav-block-shake');
    setTimeout(function() { topbar.classList.remove('nav-block-shake'); }, 320);
  }
  // Auto-focus first un-answered choice
  var firstChoice = document.querySelector('.mq-choice:not(:disabled):not(.selected)');
  if (firstChoice) firstChoice.focus();
}

/* --- Multi-Question Rotation System --- */
function _getNextQuestion(topicNum) {
  var qSet = VALIDATION_QS[topicNum];
  if (!qSet || !qSet.questions || !qSet.questions.length) return null;
  var qs = qSet.questions;
  var storageKey = 'mq-used-' + topicNum;
  var usedStr = '';
  try { usedStr = localStorage.getItem(storageKey) || ''; } catch(e) {}
  var used = usedStr ? usedStr.split(',').map(Number) : [];
  // Filter unused
  var available = qs.map(function(_, i) { return i; }).filter(function(i) { return used.indexOf(i) === -1; });
  // If all used, reset rotation
  if (!available.length) {
    available = qs.map(function(_, i) { return i; });
    used = [];
  }
  // Pick random from available
  var pick = available[Math.floor(Math.random() * available.length)];
  used.push(pick);
  try { localStorage.setItem(storageKey, used.join(',')); } catch(e) {}
  return { q: qs[pick], idx: pick, total: qs.length };
}

function openMasteryOverlay(topicNum) {
  _masteryCurrentTopic = topicNum;
  _masteryAnswered = false;

  var qData = _getNextQuestion(topicNum);
  if (!qData) { closeMasteryOverlay(); return; }
  var q = qData.q;

  const overlay = document.getElementById("mastery-overlay");
  const topicRef = document.getElementById("mq-topic-ref");
  const question = document.getElementById("mq-question");
  const choices  = document.getElementById("mq-choices");
  const submit   = document.getElementById("mq-submit");
  const result   = document.getElementById("mq-result");
  const actions  = document.getElementById("mq-actions");
  const retry    = document.getElementById("mq-retry");
  var dialog = document.getElementById("mastery-dialog");

  // Add/update lock badge
  var existingBadge = dialog.querySelector('.mq-lock-badge');
  if (!existingBadge) {
    var badge = document.createElement('div');
    badge.className = 'mq-lock-badge';
    badge.innerHTML = '⚡ Validation Required — Answer to Continue';
    dialog.insertBefore(badge, dialog.firstChild);
  }

  // Add question counter
  var counterEl = dialog.querySelector('.mq-q-counter');
  if (!counterEl) {
    counterEl = document.createElement('div');
    counterEl.className = 'mq-q-counter';
    var topicRefEl = dialog.querySelector('.mq-topic-ref');
    if (topicRefEl) dialog.insertBefore(counterEl, topicRefEl.nextSibling);
  }
  counterEl.textContent = 'Question ' + (qData.idx + 1) + ' of ' + qData.total;

  // Reset state
  result.classList.remove("show", "correct-r", "wrong-r");
  result.querySelector("#mq-result-text").textContent = "";
  result.querySelector("#mq-quote").textContent = "";
  actions.style.display = "none";
  retry.style.display = "none";
  submit.disabled = true;
  submit.textContent = "Check Answer";
  submit.className = "mq-submit";

  // Populate
  topicRef.textContent = topicNum + ". " + TOPIC_TITLES[topicNum];
  question.textContent = q.q;
  choices.innerHTML = "";

  q.choices.forEach(function(text, idx) {
    const btn = document.createElement("button");
    btn.className = "mq-choice";
    btn.textContent = text;
    btn.setAttribute("data-idx", idx);
    // Stagger animation
    btn.style.animationDelay = (idx * 40) + "ms";
    btn.addEventListener("click", function() {
      choices.querySelectorAll(".mq-choice").forEach(function(b) { b.classList.remove("selected"); });
      btn.classList.add("selected");
      submit.disabled = false;
    });
    choices.appendChild(btn);
  });

  // Submit handler
  submit.onclick = function() {
    if (_masteryAnswered) return;
    _masteryAnswered = true;
    submit.disabled = true;

    const selected = choices.querySelector(".mq-choice.selected");
    if (!selected) return;
    const selectedIdx = parseInt(selected.getAttribute("data-idx"), 10);
    const correct = selectedIdx === q.answer;

    // Disable all choices
    choices.querySelectorAll(".mq-choice").forEach(function(b, i) {
      b.disabled = true;
      if (i === q.answer) b.classList.add("correct");
      else if (b === selected && !correct) b.classList.add("wrong");
    });

    const resultEl   = document.getElementById("mq-result");
    const resultText = document.getElementById("mq-result-text");
    const quoteEl    = document.getElementById("mq-quote");
    const actionsEl  = document.getElementById("mq-actions");
    const retryEl    = document.getElementById("mq-retry");
    const dismissEl  = document.getElementById("mq-dismiss");

    if (correct) {
      // ✅ MASTERED — mark green, UNLOCK navigation
      masteredTopics.add(topicNum);
      validationLock.active = false;
      validationLock.topicId = null;
      /* === NEW ADDITION START === */
      // Flag: this topic passed full validation — skip understanding popup on close
      window._topicValidationPassed = true;
      /* === NEW ADDITION END === */

      // Success animation on submit btn
      submit.textContent = "✓ Correct!";
      submit.className = "mq-submit success-state";

      // Spawn particles
      _spawnResultParticles(resultEl, true);

      // Restore close button
      var closeBtn = document.getElementById('modal-close-btn');
      if (closeBtn) {
        closeBtn.removeAttribute('title');
        closeBtn.style.opacity = '';
        closeBtn.style.cursor = '';
        closeBtn.classList.remove('locked');
      }
      try { localStorage.setItem("masteredTopics", JSON.stringify([...masteredTopics])); } catch(e){}

      const tocLinkM = document.querySelector('[data-topic="' + topicNum + '"]');
      if (tocLinkM) { tocLinkM.classList.add("mastered", "viewed", "done"); }

      // Update sidebar
      const sidebarLink = document.querySelector('.sidebar-topic-link[data-stopic="' + topicNum + '"]');
      if (sidebarLink) { sidebarLink.classList.add("mastered-item", "done-item"); }

      // XP reward
      renderXP();
      checkMilestone(masteredTopics.size);

      // Spawn XP float
      spawnXPPop(XP_PER_TOPIC);
      // Mastery ring glow
      var ringEl = document.querySelector('.mastery-ring');
      if (ringEl) {
        ringEl.classList.remove('earned');
        void ringEl.offsetWidth;
        ringEl.classList.add('earned');
        setTimeout(function() { ringEl.classList.remove('earned'); }, 750);
      }

      resultEl.className = "mq-result show correct-r";
      resultText.textContent = "Correct. Topic mastered.";
      const quote = QUOTES_CORRECT[Math.floor(Math.random() * QUOTES_CORRECT.length)];
      quoteEl.textContent = "— " + quote;

      actionsEl.style.display = "flex";
      retryEl.style.display = "none";
      dismissEl.textContent = "Continue ✓";
    } else {
      // ❌ NOT MASTERED — stays white, shake feedback
      resultEl.className = "mq-result show wrong-r";
      resultText.textContent = "Incorrect. Review and try again.";
      const quote = QUOTES_WRONG[Math.floor(Math.random() * QUOTES_WRONG.length)];
      quoteEl.textContent = "— " + quote;

      // Wrong shake on all wrong choices + submit
      choices.querySelectorAll(".mq-choice.wrong").forEach(function(b) {
        b.classList.remove("wrong-shake");
        void b.offsetWidth;
        b.classList.add("wrong-shake");
        setTimeout(function() { b.classList.remove("wrong-shake"); }, 440);
      });
      var submitEl = document.getElementById("mq-submit");
      if (submitEl) {
        submitEl.classList.remove("wrong-shake");
        void submitEl.offsetWidth;
        submitEl.classList.add("wrong-shake");
        setTimeout(function() { submitEl.classList.remove("wrong-shake"); }, 360);
      }

      // Particles (red)
      _spawnResultParticles(resultEl, false);

      // Re-focus first choice after shake
      setTimeout(function() {
        var firstChoice = choices.querySelector('.mq-choice:not(:disabled)');
        if (firstChoice) firstChoice.focus();
      }, 450);

      actionsEl.style.display = "flex";
      retryEl.style.display = "flex";
      dismissEl.textContent = "Close";
    }
  };

  // Dismiss
  document.getElementById("mq-dismiss").onclick = function() {
    // If answered correctly, lock is already cleared. If dismissed wrong, close but keep lock.
    closeMasteryOverlay();
    // If lock still active (wrong answer was dismissed), re-enable the got-it btn for retry
    if (validationLock.active) {
      var gotItBtn = document.querySelector(".got-it-btn");
      if (gotItBtn) {
        gotItBtn.disabled = false;
        gotItBtn.style.opacity = "1";
        gotItBtn.textContent = "↺ Try Validation Again";
      }
    }
  };

  // Retry
  document.getElementById("mq-retry").onclick = function() {
    _masteryAnswered = false;
    openMasteryOverlay(topicNum);
  };

  overlay.classList.add("active");
  document.body.style.overflow = "hidden";
}

function closeMasteryOverlay() {
  const overlay = document.getElementById("mastery-overlay");
  overlay.classList.remove("active");
  document.body.style.overflow = "";
  // Restore close button if lock is no longer active
  if (!validationLock.active) {
    var closeBtn = document.getElementById('modal-close-btn');
    if (closeBtn) {
      closeBtn.removeAttribute('title');
      closeBtn.style.opacity = '';
      closeBtn.style.cursor = '';
      closeBtn.classList.remove('locked');
    }
  }
}

/* --- Particle spawner for answer feedback --- */
function _spawnResultParticles(anchorEl, isCorrect) {
  if (!anchorEl) return;
  var rect = anchorEl.getBoundingClientRect();
  var colors = isCorrect
    ? ['#3dd68c','#4f9eff','#a78bfa','#ffd700']
    : ['#ff6b6b','#f0a500','#ff9a9a'];
  for (var i = 0; i < (isCorrect ? 10 : 6); i++) {
    var dot = document.createElement('div');
    dot.className = 'mq-particle';
    dot.style.cssText =
      'left:' + (rect.left + Math.random() * rect.width) + 'px;' +
      'top:' + (rect.top + window.scrollY + rect.height/2) + 'px;' +
      'background:' + colors[Math.floor(Math.random() * colors.length)] + ';' +
      'animation-delay:' + (i * 45) + 'ms;' +
      'animation-duration:' + (500 + Math.random() * 250) + 'ms;';
    document.body.appendChild(dot);
    setTimeout(function(d) { return function() { d.remove(); }; }(dot), 900);
  }
}

// Close mastery overlay on background click — ONLY when not locked
document.getElementById("mastery-overlay").addEventListener("click", function(e) {
  if (e.target === this) {
    if (validationLock.active) {
      // Shake — cannot dismiss until answered
      var dialog = document.getElementById('mastery-dialog');
      if (dialog) {
        dialog.classList.remove('vl-shake', 'lock-active');
        void dialog.offsetWidth;
        dialog.classList.add('vl-shake', 'lock-active');
        setTimeout(function() { dialog.classList.remove('vl-shake', 'lock-active'); }, 1000);
      }
    } else {
      closeMasteryOverlay();
    }
  }
});

// Old showCompletionScreen stub — no longer used but kept to avoid errors
function showCompletionScreen(topicNum) {
  triggerMasteryValidation(topicNum);
}

/* --- PANEL HEARTBEAT on open ---
   EN: Makes the "new syntax" panel pulse once when modal first opens
   HI-EN: Modal kholne pe green panel ek baar subtle glow karta hai */
function pulseNewPanel() {
  const panel = document.getElementById("modal-body").querySelector(".panel-new");
  if (!panel) return;
  panel.classList.remove("pulse-once");
  void panel.offsetWidth; // reflow to restart animation
  panel.classList.add("pulse-once");
  setTimeout(function() { panel.classList.remove("pulse-once"); }, 900);
}

/* --- V4 PATCH openTopic ---
   EN: Extends existing patch chain with v4 session tracking and UI triggers
   HI-EN: Existing patch mein v4 features add karte hain — session count, daily ring, heartbeat */
const _v3OpenTopic = openTopic;
openTopic = function(num) {
  const wasNew = !viewedTopics.has(num);
  _v3OpenTopic(num);

  if (wasNew) {
    sessionCount++;
    updateSessionStat();
    recordDailyActivity();
    // Refresh heatmap today cell
    try {
      const cells = document.querySelectorAll(".hm-cell.hm-today");
      const today = new Date().toDateString();
      const stored = JSON.parse(localStorage.getItem("dailyActivity") || "{}");
      const val = stored[today] || 0;
      cells.forEach(function(c) {
        c.className = "hm-cell hm-today" + (val >= 5 ? " hm-4" : val >= 3 ? " hm-3" : val >= 2 ? " hm-2" : " hm-1");
      });
    } catch(e) {}
  }

  // Small delay then inject "Got It" + heartbeat
  setTimeout(function() {
    injectGotItButton(num);
    pulseNewPanel();
  }, 350);
};

/* ============================================================
   FINAL INIT — run all systems on page load
   ============================================================ */
// EN: V3 systems need one-time init after all patches are wired
// HI-EN: Sab patches ke baad V3 aur V4 systems ek baar init karo
markNextUp();
_lastLevel = getLevelInfo(viewedTopics.size * XP_PER_TOPIC).cur.lvl;
updateSessionStat();

</script>

<script>
/* ============================================================
   WAP OS — PANEL SYSTEM & SIDEBAR SYNC
   ============================================================ */

// Sidebar toggle
(function() {
  var btn = document.getElementById('sidebar-toggle');
  var sidebar = document.getElementById('wapos-sidebar');
  if (btn && sidebar) {
    btn.addEventListener('click', function() {
      sidebar.classList.toggle('collapsed');
      btn.textContent = sidebar.classList.contains('collapsed') ? '☰' : '☰';
    });
  }
})();

// Theme toggle sync (mirror the original)
(function() {
  var btn2 = document.getElementById('theme-toggle2');
  var btn1 = document.getElementById('theme-toggle');
  if (btn2 && btn1) {
    btn2.addEventListener('click', function() {
      btn1.click(); // Trigger original toggle
      // Sync icon
      setTimeout(function() {
        var icon1 = document.getElementById('theme-icon');
        var icon2 = document.getElementById('theme-icon2');
        if (icon1 && icon2) icon2.textContent = icon1.textContent;
      }, 50);
    });
  }
})();

// Sidebar search removed — Important Topics system replaces filter nav

// Reading progress removed

// Sidebar completion marks sync - poll every 2s
(function syncSidebarDone() {
  function update() {
    document.querySelectorAll('.sidebar-topic-link').forEach(function(link) {
      var num = parseInt(link.getAttribute('data-stopic'), 10);
      if (viewedTopics.has(num)) {
        link.classList.add('done-item', 'viewed-item');
      }
      if (masteredTopics.has(num)) {
        link.classList.add('done-item', 'viewed-item', 'mastered-item');
      }
    });
    // Update sidebar progress
    var done = document.querySelectorAll('.sidebar-topic-link.done-item').length;
    var total = 33;
    var fill = document.getElementById('sb-prog-fill');
    var label = document.getElementById('sb-prog-label');
    if (fill) fill.style.width = ((done/total)*100) + '%';
    if (label) label.textContent = done + ' of ' + total + ' topics';
    
    // Sync wapos progress badge
    var badge = document.getElementById('wapos-progress-badge');
    var origBadge = document.getElementById('progress-badge');
    if (badge && origBadge) badge.textContent = origBadge.textContent;
    
    // Sync done count in right panel
    var rpDone = document.getElementById('rp-done-count');
    if (rpDone) rpDone.textContent = done + ' / ' + total;
    
    // Sync XP display
    var rpXP = document.getElementById('rp-xp-display');
    var origXP = document.getElementById('xp-pts');
    if (rpXP && origXP) rpXP.textContent = origXP.textContent;
    
    // Sync wapos XP bar
    var wapFill = document.getElementById('wapos-xp-fill');
    var origFill = document.getElementById('xp-fill');
    if (wapFill && origFill) wapFill.style.width = origFill.style.width;
    
    var wapPts = document.getElementById('wapos-xp-pts');
    var origPts = document.getElementById('xp-pts');
    if (wapPts && origPts) wapPts.textContent = origPts.textContent;
    
    var wapLvl = document.getElementById('wapos-level-txt');
    var origLvl = document.getElementById('xp-level-txt');
    if (wapLvl && origLvl) wapLvl.textContent = origLvl.textContent;
    
    // Sync session count
    var ss2 = document.getElementById('ss-num2');
    var ss1 = document.getElementById('ss-num');
    if (ss2 && ss1) ss2.textContent = ss1.textContent;
    
    // Sync streak
    var sc2 = document.getElementById('streak-count2');
    var sc1 = document.getElementById('streak-count');
    if (sc2 && sc1) sc2.textContent = sc1.textContent;
    
    // Highlight active sidebar link based on what's been clicked
    // (keep current active from most recent topic opened)
  }
  
  // Run initially and hook into openTopic if it exists later
  setTimeout(update, 500);
  setInterval(update, 1500);
})();

// Highlight active sidebar link when topic opens
(function() {
  function hookOpenTopic() {
    if (typeof openTopic !== 'undefined') {
      var orig = openTopic;
      openTopic = function(num) {
        orig(num);
        // Highlight sidebar
        document.querySelectorAll('.sidebar-topic-link').forEach(function(l) {
          l.classList.remove('active');
        });
        var active = document.querySelector('.sidebar-topic-link[data-stopic="' + num + '"]');
        if (active) {
          active.classList.add('active');
          // Scroll sidebar to show it
          var nav = document.getElementById('sidebar-nav');
          if (nav) {
            var top = active.offsetTop - nav.offsetTop - nav.clientHeight/2 + active.clientHeight/2;
            nav.scrollTop = top;
          }
        }
        return;
      };
    } else {
      setTimeout(hookOpenTopic, 200);
    }
  }
  setTimeout(hookOpenTopic, 300);
})();

// Wire sidebar topic links to call openTopic
(function() {
  function wireLinks() {
    if (typeof openTopic !== 'undefined') {
      document.querySelectorAll('.sidebar-topic-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          var num = parseInt(this.getAttribute('data-stopic'), 10);
          if (!isNaN(num)) openTopic(num);
        });
      });
    } else {
      setTimeout(wireLinks, 300);
    }
  }
  setTimeout(wireLinks, 400);
})();

// Notes persistence
(function() {
  var notes = document.getElementById('rp-notes');
  if (!notes) return;
  try { notes.value = localStorage.getItem('wapos-notes') || ''; } catch(e) {}
  notes.addEventListener('input', function() {
    try { localStorage.setItem('wapos-notes', this.value); } catch(e) {}
  });
})();

// FAB removed

/* ============================================================
   TOPBAR SEARCH + DISCOVERY DROPDOWN SYSTEM
   ============================================================ */
(function() {
  var input      = document.getElementById('search-input');
  var discovery  = document.getElementById('topbar-discovery');
  var resultsWrap= document.getElementById('search-results');
  var sectionsEl = document.getElementById('td-sections');
  var topicsPanel= document.getElementById('td-topics-panel');
  var sectionList= document.getElementById('td-section-list');
  if (!input || !discovery) return;

  // Section → topic mapping (mirrors SECTIONS in main JS)
  var SECTION_DATA = [
    { name: 'ES5 vs ES6 Fundamentals', topics: [0,1,2,3,4,5,6,7,8,9,10,11,12] },
    { name: 'Array Methods + Timers',  topics: [13,14,15,16,17,18,19,20] },
    { name: 'Advanced Concepts',       topics: [21,22,23,24,25,26,27,28,29] },
    { name: 'Promises & Async',        topics: [30,31,32,33] },
  ];

  var TOPIC_NAMES = [
    'Array Filter Method','Object Destructuring','Destructuring with Renaming',
    'Default Values','Function Parameters Destructuring','Array Destructuring',
    'Spread Syntax — Arrays','Spread Syntax — Objects','Spread in Function Calls',
    'Rest Syntax — Arrays','Rest Syntax — Objects','Rest Parameters in Functions',
    'Rest vs Spread','forEach Method','map Method','find Method','sort Method',
    'setTimeout — Basics','clearTimeout','setInterval','clearInterval',
    'Understanding Callbacks','Callbacks with Parameters','Higher-Order Functions',
    'Building Custom Filter','Factory Functions — Greetings','Factory Pattern — Multipliers',
    'Understanding Closures','Closure Deep Dive','Closure Complete Summary',
    'Callbacks vs Promises — greet()','Callback Hell vs Promise Chain','Promise Chaining — ronaldoPromise',
    'Fetch API Flow — Real World Async'
  ];

  function openDiscovery() {
    if (!discovery.classList.contains('open')) {
      discovery.style.opacity = '0';
      discovery.style.transform = 'translateY(-6px)';
      discovery.classList.add('open');
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          discovery.style.transition = 'opacity 200ms cubic-bezier(0.22,1,0.36,1), transform 200ms cubic-bezier(0.22,1,0.36,1)';
          discovery.style.opacity = '1';
          discovery.style.transform = 'translateY(0)';
        });
      });
    }
    input.setAttribute('aria-expanded', 'true');
    // ALWAYS: if input empty → show sections, not topics
    var q = input.value.trim();
    if (!q) {
      resultsWrap.innerHTML = '';
      resultsWrap.style.display = 'none';
      // Always reset to section list when empty
      topicsPanel.style.display = 'none';
      topicsPanel.style.opacity = '0';
      sectionList.style.display = '';
      sectionList.style.opacity = '1';
      sectionsEl.style.display = '';
      document.querySelectorAll('.td-section-btn').forEach(function(b) {
        b.classList.remove('active');
        // Re-trigger stagger animation
        b.style.animation = 'none';
        void b.offsetWidth;
        b.style.animation = '';
      });
    }
  }

  function closeDiscovery() {
    discovery.style.transition = 'opacity 160ms cubic-bezier(0.4,0,0.2,1), transform 160ms cubic-bezier(0.4,0,0.2,1)';
    discovery.style.opacity = '0';
    discovery.style.transform = 'translateY(-4px)';
    setTimeout(function() {
      discovery.classList.remove('open');
      discovery.style.transition = '';
      discovery.style.transform = '';
    }, 165);
    input.setAttribute('aria-expanded', 'false');
  }

  // Open on focus — check lock state
  input.addEventListener('focus', function() {
    if (validationLock.active) {
      input.blur();
      _shakeValidationOverlay();
      return;
    }
    openDiscovery();
  });
  // Also handle click on input
  input.addEventListener('click', function() {
    if (validationLock.active) {
      _shakeValidationOverlay();
      return;
    }
    openDiscovery();
  });

  // Search logic (reimplemented to show in discovery panel)
  input.addEventListener('input', function() {
    var q = this.value.trim().toLowerCase();
    if (!q) {
      resultsWrap.innerHTML = '';
      resultsWrap.style.display = 'none';
      sectionsEl.style.display = '';
      topicsPanel.style.display = 'none';
      openDiscovery();
      return;
    }

    // Filter topics
    var matches = TOPIC_NAMES
      .map(function(t, i) { return { i: i, title: t }; })
      .filter(function(t) { return t.title.toLowerCase().includes(q); });

    resultsWrap.innerHTML = '';
    if (matches.length) {
      var label = document.createElement('div');
      label.className = 'td-label';
      label.textContent = 'Search Results';
      resultsWrap.appendChild(label);
      matches.slice(0, 8).forEach(function(t) {
        var item = document.createElement('div');
        item.className = 'search-result-item';
        var stateStr = '';
        if (typeof masteredTopics !== 'undefined' && masteredTopics.has(t.i)) {
          stateStr = '<span class="td-t-state mastered">mastered</span>';
        } else if (typeof viewedTopics !== 'undefined' && viewedTopics.has(t.i)) {
          stateStr = '<span class="td-t-state viewed">studied</span>';
        }
        item.innerHTML = '<span class="ri" style="font-family:var(--font-mono);font-size:0.6rem;color:rgba(255,255,255,0.25);min-width:24px">' +
          String(t.i).padStart(2,'0') + '</span>' +
          '<span style="flex:1;font-family:var(--font-mono);font-size:0.8rem">' + t.title + '</span>' + stateStr;
        item.addEventListener('click', function() {
          if (validationLock && validationLock.active) {
            _shakeValidationOverlay();
            return;
          }
          input.value = '';
          closeDiscovery();
          if (typeof openTopic !== 'undefined') {
            openTopic(t.i);
            if (typeof saveProgress !== 'undefined') saveProgress();
          }
        });
        resultsWrap.appendChild(item);
      });
      resultsWrap.style.display = '';
      sectionsEl.style.display = 'none';
    } else {
      var noEl = document.createElement('div');
      noEl.style.cssText = 'padding:14px;font-size:0.75rem;color:rgba(255,255,255,0.2);font-family:var(--font-mono);text-align:center';
      noEl.textContent = 'No topics match "' + q + '"';
      resultsWrap.appendChild(noEl);
      resultsWrap.style.display = '';
      sectionsEl.style.display = 'none';
    }
    openDiscovery();
  });

  // Section buttons — show topics in that section
  document.querySelectorAll('.td-section-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var idx = parseInt(this.getAttribute('data-section'), 10);
      var sec = SECTION_DATA[idx];
      if (!sec) return;

      topicsPanel.innerHTML = '';
      topicsPanel.style.display = '';
      topicsPanel.style.opacity = '0';
      topicsPanel.style.transform = 'translateY(-4px)';

      // Header with back button
      var header = document.createElement('div');
      header.className = 'td-section-header';
      header.innerHTML = '<button class="td-back-btn" id="td-back">← Back</button>' +
        '<span class="td-section-title-sm">' + sec.name + '</span>';
      topicsPanel.appendChild(header);

      sec.topics.forEach(function(tIdx) {
        var tBtn = document.createElement('button');
        tBtn.className = 'td-topic-btn';
        var state = '';
        if (typeof masteredTopics !== 'undefined' && masteredTopics.has(tIdx)) {
          state = '<span class="td-t-state mastered">✓</span>';
        } else if (typeof viewedTopics !== 'undefined' && viewedTopics.has(tIdx)) {
          state = '<span class="td-t-state viewed">·</span>';
        }
        tBtn.innerHTML = '<span class="td-t-num">' + String(tIdx).padStart(2,'0') + '</span>' +
          '<span class="td-t-name">' + TOPIC_NAMES[tIdx] + '</span>' + state;
        tBtn.addEventListener('click', function() {
          if (validationLock && validationLock.active) {
            _shakeValidationOverlay();
            closeDiscovery();
            return;
          }
          closeDiscovery();
          input.value = '';
          if (typeof openTopic !== 'undefined') {
            openTopic(tIdx);
            if (typeof saveProgress !== 'undefined') saveProgress();
          }
        });
        topicsPanel.appendChild(tBtn);
      });

      sectionList.style.display = 'none';
      document.querySelectorAll('.td-section-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');

      // Animate topics panel in
      requestAnimationFrame(function() {
        requestAnimationFrame(function() {
          topicsPanel.style.transition = 'opacity 200ms cubic-bezier(0.4,0,0.2,1), transform 200ms cubic-bezier(0.4,0,0.2,1)';
          topicsPanel.style.opacity = '1';
          topicsPanel.style.transform = 'translateY(0)';
        });
      });

      document.getElementById('td-back').addEventListener('click', function() {
        topicsPanel.style.transition = 'opacity 160ms cubic-bezier(0.4,0,0.2,1), transform 160ms cubic-bezier(0.4,0,0.2,1)';
        topicsPanel.style.opacity = '0';
        topicsPanel.style.transform = 'translateY(-4px)';
        setTimeout(function() {
          topicsPanel.style.display = 'none';
          topicsPanel.style.transition = '';
          sectionList.style.display = '';
          sectionList.style.opacity = '0';
          requestAnimationFrame(function() {
            requestAnimationFrame(function() {
              sectionList.style.transition = 'opacity 180ms cubic-bezier(0.4,0,0.2,1)';
              sectionList.style.opacity = '1';
              setTimeout(function() { sectionList.style.transition = ''; }, 200);
            });
          });
        }, 165);
        document.querySelectorAll('.td-section-btn').forEach(function(b) { b.classList.remove('active'); });
      });
    });
  });

  // Close when clicking outside
  document.addEventListener('click', function(e) {
    var container = document.getElementById('topbar-search-container');
    if (container && !container.contains(e.target)) {
      closeDiscovery();
    }
  });

  // Keyboard: Escape closes, Enter selects first result
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeDiscovery();
      input.blur();
    } else if (e.key === 'Enter') {
      var first = resultsWrap.querySelector('.search-result-item');
      if (first) first.click();
    }
  });

  // Global "/" shortcut to focus search — blocked during validation lock
  document.addEventListener('keydown', function(e) {
    if (validationLock.active) return;
    if ((e.key === '/' || e.key === 'k' && (e.metaKey || e.ctrlKey)) &&
        document.activeElement !== input &&
        !document.getElementById('mastery-overlay').classList.contains('active')) {
      e.preventDefault();
      input.focus();
      openDiscovery();
    }
  });
})();

/* ============================================================
   IMPORTANT TOPICS SYSTEM
   ============================================================ */
(function() {
  var importantTopics = new Set();
  var STORAGE_KEY = 'wapos-important-topics';

  // Load from localStorage
  try {
    var saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    saved.forEach(function(n) { importantTopics.add(n); });
  } catch(e) {}

  var TOPIC_NAMES_LOCAL = [
    'Array Filter Method','Object Destructuring','Destructuring with Renaming',
    'Default Values','Function Parameters Destructuring','Array Destructuring',
    'Spread Syntax — Arrays','Spread Syntax — Objects','Spread in Function Calls',
    'Rest Syntax — Arrays','Rest Syntax — Objects','Rest Parameters in Functions',
    'Rest vs Spread','forEach Method','map Method','find Method','sort Method',
    'setTimeout — Basics','clearTimeout','setInterval','clearInterval',
    'Understanding Callbacks','Callbacks with Parameters','Higher-Order Functions',
    'Building Custom Filter','Factory Functions — Greetings','Factory Pattern — Multipliers',
    'Understanding Closures','Closure Deep Dive','Closure Complete Summary',
    'Callbacks vs Promises — greet()','Callback Hell vs Promise Chain','Promise Chaining — ronaldoPromise',
    'Fetch API Flow — Real World Async'
  ];

  function saveImportant() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify([...importantTopics])); } catch(e) {}
  }

  function renderImportantSidebar() {
    var list = document.getElementById('imp-topics-list');
    var empty = document.getElementById('imp-empty-state');
    var label = document.getElementById('sb-prog-label');
    if (!list) return;

    list.innerHTML = '';
    var total = 33;

    if (label) label.textContent = importantTopics.size + ' / ' + total + ' marked';

    // Update progress bar
    var fill = document.getElementById('sb-prog-fill');
    if (fill) fill.style.width = ((importantTopics.size / total) * 100) + '%';

    if (importantTopics.size === 0) {
      if (empty) empty.style.display = '';
      return;
    }
    if (empty) empty.style.display = 'none';

    // Sort numerically
    var sorted = [...importantTopics].sort(function(a, b) { return a - b; });
    sorted.forEach(function(num) {
      var item = document.createElement('div');
      item.className = 'imp-topic-item';
      item.innerHTML =
        '<span class="imp-t-star">★</span>' +
        '<span class="imp-t-num">' + String(num).padStart(2,'0') + '</span>' +
        '<span class="imp-t-name">' + (TOPIC_NAMES_LOCAL[num] || 'Topic ' + num) + '</span>' +
        '<button class="imp-t-remove" title="Remove" data-remove="' + num + '">✕</button>';

      // Click to open topic
      item.addEventListener('click', function(e) {
        if (e.target.classList.contains('imp-t-remove')) return;
        if (validationLock && validationLock.active) {
          // Shake sidebar
          var sidebar = document.getElementById('wapos-sidebar');
          if (sidebar) {
            sidebar.classList.remove('nav-block-shake');
            void sidebar.offsetWidth;
            sidebar.classList.add('nav-block-shake');
            setTimeout(function() { sidebar.classList.remove('nav-block-shake'); }, 320);
          }
          _shakeValidationOverlay();
          return;
        }
        if (typeof openTopic !== 'undefined') {
          openTopic(num);
          if (typeof saveProgress !== 'undefined') saveProgress();
        }
      });

      // Remove button
      item.querySelector('.imp-t-remove').addEventListener('click', function(e) {
        e.stopPropagation();
        importantTopics.delete(num);
        saveImportant();
        renderImportantSidebar();
        updateModalStarBtn(num);
      });

      list.appendChild(item);
    });
  }

  function updateModalStarBtn(topicNum) {
    var btn = document.getElementById('modal-star-btn');
    if (!btn) return;
    var currentTopic = parseInt(btn.getAttribute('data-topic'), 10);
    if (currentTopic !== topicNum && topicNum !== undefined) return;
    var isStarred = importantTopics.has(currentTopic);
    btn.classList.toggle('starred', isStarred);
    btn.innerHTML = (isStarred ? '★' : '☆') + ' ' + (isStarred ? 'Starred' : 'Star');
  }

  function injectStarButton(topicNum) {
    // Find the modal header — inject star button next to title
    var modalHeader = document.getElementById('modal-header');
    if (!modalHeader) {
      // Try to find via class
      modalHeader = document.querySelector('.modal-header');
    }

    // Remove existing star btn
    var existing = document.getElementById('modal-star-btn');
    if (existing) existing.remove();

    if (!modalHeader) return;

    var btn = document.createElement('button');
    btn.className = 'modal-star-btn' + (importantTopics.has(topicNum) ? ' starred' : '');
    btn.id = 'modal-star-btn';
    btn.setAttribute('data-topic', topicNum);
    btn.innerHTML = (importantTopics.has(topicNum) ? '★' : '☆') + ' ' + (importantTopics.has(topicNum) ? 'Starred' : 'Star');
    btn.title = 'Toggle important';

    btn.addEventListener('click', function() {
      var n = parseInt(btn.getAttribute('data-topic'), 10);
      if (importantTopics.has(n)) {
        importantTopics.delete(n);
      } else {
        importantTopics.add(n);
      }
      saveImportant();
      renderImportantSidebar();
      updateModalStarBtn();
      // Star pop animation
      btn.classList.remove('star-anim');
      void btn.offsetWidth;
      btn.classList.add('star-anim');
      setTimeout(function() { btn.classList.remove('star-anim'); }, 450);
    });

    // Insert before close button (better positioning)
    var closeBtn = modalHeader.querySelector('.modal-close-btn, #modal-close-btn');
    if (closeBtn) {
      modalHeader.insertBefore(btn, closeBtn);
    } else {
      modalHeader.appendChild(btn);
    }
  }

  // Expose globally
  window._importantTopicsSystem = {
    injectStarButton: injectStarButton,
    render: renderImportantSidebar,
    importantTopics: importantTopics,
  };

  // Hook into openTopic to inject star button
  setTimeout(function() {
    if (typeof openTopic !== 'undefined') {
      var _origOT = openTopic;
      openTopic = function(num) {
        _origOT(num);
        setTimeout(function() { injectStarButton(num); }, 400);
      };
    }
  }, 800);

  // Initial render
  renderImportantSidebar();
})();
</script>

<script>
/* ================================================================
   WAP OS — JS COMPILER  v4.0
   ================================================================
   ARCHITECTURE (all inlined into this single script tag):

   /editor-core
     snippets.js          – teaching snippet library (lazy)
     language-config.js   – TS/JS service, bracket rules, 3 providers
     theme.js             – wap-dark Monaco theme
     create-editor.js     – editor instantiation & all options
     index.js             – orchestrates load → theme → lang → create

   /runtime-engine
     sandbox.js           – interval/timeout tracking, safe execution,
                            console capture, stacked-run prevention

   /education-engine
     index.js             – attaches via WapEditor public API only,
                            dispatches wap:codeAnalysis CustomEvent,
                            exposes showHint / clearHints

   /ui-overlays
     command-palette.js   – Cmd+Shift+P mini command palette
     topic-search.js      – Cmd+K topic search

   window.WapEditor       – frozen public API (only allowed surface
                            for all external code)
   ================================================================ */
(function () {
  'use strict';

  /* ── DOM refs ─────────────────────────────────────────────── */
  var overlay     = document.getElementById('jsc-overlay');
  var card        = document.getElementById('rp-compiler-card');
  var btnClose    = document.getElementById('jsc-btn-close');
  var btnRun      = document.getElementById('jsc-btn-run');
  var btnClear    = document.getElementById('jsc-btn-clear');
  var editorEl    = document.getElementById('jsc-editor');
  var outputEl    = document.getElementById('jsc-output');
  var badgeEl     = document.getElementById('wap-runtime-badge');

  if (!overlay || !card || !editorEl || !outputEl) return;

  var _open     = false;
  var _closeRaf = null;

  /* ──────────────────────────────────────────────────────────
     /editor-core/monaco-instance.js
     ────────────────────────────────────────────────────────── */
  var _monaco      = null;
  var _monacoReady = false;

  /* ──────────────────────────────────────────────────────────
     /editor-core/snippets.js
     Teaching-oriented snippet library. Lazy-initialised.
     Each entry: { trigger, label, detail, doc, snippet, ghost }
     ────────────────────────────────────────────────────────── */
  var _snippetLib = null;

  function getSnippetLib() {
    if (_snippetLib) return _snippetLib;
    _snippetLib = [
      /* ── Variables ──────────────────────────────────────── */
      { trigger:'let',
        label:'let — variable', detail:'📦 Changes over time',
        doc:'`let` creates a block-scoped variable whose value can change.',
        snippet:'let ${1:name} = ${2:value};', ghost:'let name = value;' },
      { trigger:'const',
        label:'const — constant', detail:'🔒 Never reassigned',
        doc:'`const` creates a block-scoped binding that cannot be reassigned.',
        snippet:'const ${1:name} = ${2:value};', ghost:'const name = value;' },
      { trigger:'var',
        label:'var — legacy', detail:'⚠️ Prefer let/const',
        doc:'`var` is function-scoped and hoisted. Prefer `let` or `const`.',
        snippet:'var ${1:name} = ${2:value};', ghost:'var name = value;' },

      /* ── Console ─────────────────────────────────────────── */
      { trigger:'con',
        label:'console.log()', detail:'🖨️ Print value',
        doc:'Prints values to the browser DevTools console.',
        snippet:'console.log(${1:value});', ghost:'console.log(value);' },
      { trigger:'clog',
        label:'console.log()', detail:'🖨️ Print value',
        doc:'Alias for console.log.',
        snippet:'console.log(${1:value});', ghost:'console.log(value);' },
      { trigger:'cl',
        label:'console.log()', detail:'🖨️ Print value',
        doc:'Short alias for console.log.',
        snippet:'console.log(${1:value});', ghost:'console.log(value);' },
      { trigger:'log',
        label:'console.log()', detail:'🖨️ Print value',
        doc:'Prints values to the browser DevTools console.',
        snippet:'console.log(${1:value});', ghost:'console.log(value);' },
      { trigger:'cerr',
        label:'console.error()', detail:'🔴 Log error',
        doc:'Logs a red error message to the console.',
        snippet:'console.error(${1:message});', ghost:'console.error(message);' },
      { trigger:'cwarn',
        label:'console.warn()', detail:'🟡 Log warning',
        doc:'Logs a yellow warning message to the console.',
        snippet:'console.warn(${1:message});', ghost:'console.warn(message);' },

      /* ── Functions ───────────────────────────────────────── */
      { trigger:'fn',
        label:'function — declaration', detail:'🔧 Named function',
        doc:'A named function declaration. Call it anywhere in its scope.',
        snippet:'function ${1:name}(${2:params}) {\n\t${3:// code}\n}',
        ghost:'function name(params) {\n\t// code\n}' },
      { trigger:'fne',
        label:'function expression', detail:'🔧 Assigned to variable',
        doc:'A function stored in a variable. Must be defined before calling.',
        snippet:'const ${1:name} = function (${2:params}) {\n\t${3:// code}\n};',
        ghost:'const name = function(params) {\n\t// code\n};' },
      { trigger:'afn',
        label:'arrow function', detail:'➡️ Modern syntax',
        doc:'Arrow functions are concise and do not bind their own `this`.',
        snippet:'const ${1:name} = (${2:params}) => {\n\t${3:// code}\n};',
        ghost:'const name = (params) => {\n\t// code\n};' },
      { trigger:'asyncfn',
        label:'async function', detail:'⏳ Async declaration',
        doc:'An async function always returns a Promise.',
        snippet:'async function ${1:name}(${2:params}) {\n\ttry {\n\t\tconst ${3:result} = await ${4:asyncCall()};\n\t\tconsole.log(${3:result});\n\t} catch (${5:err}) {\n\t\tconsole.error(${5:err});\n\t}\n}',
        ghost:'async function name(params) { const result = await ...; }' },
      { trigger:'asyncafn',
        label:'async arrow function', detail:'⏳➡️ Async arrow',
        doc:'An async arrow function — does not bind `this`.',
        snippet:'const ${1:name} = async (${2:params}) => {\n\ttry {\n\t\tconst ${3:result} = await ${4:asyncCall()};\n\t\tconsole.log(${3:result});\n\t} catch (${5:err}) {\n\t\tconsole.error(${5:err});\n\t}\n};',
        ghost:'const name = async (params) => { const result = await ...; };' },
      { trigger:'iife',
        label:'IIFE', detail:'🔁 Self-invoking function',
        doc:'Immediately Invoked Function Expression — runs as soon as it is defined.',
        snippet:'(function () {\n\t${1:// code}\n})();',
        ghost:'(function () { })();' },
      { trigger:'anon',
        label:'anonymous arrow fn', detail:'➡️ Inline callback',
        doc:'Inline anonymous arrow function, perfect as a callback.',
        snippet:'(${1:params}) => ${2:expression}',
        ghost:'(params) => expression' },

      /* ── Control flow ────────────────────────────────────── */
      { trigger:'if',
        label:'if statement', detail:'🔀 Conditional',
        doc:'Executes a block only when the condition is truthy.',
        snippet:'if (${1:condition}) {\n\t${2:// true branch}\n}',
        ghost:'if (condition) {\n\t// true branch\n}' },
      { trigger:'ife',
        label:'if / else', detail:'🔀 Two branches',
        doc:'Runs one block when true, another when false.',
        snippet:'if (${1:condition}) {\n\t${2:// true}\n} else {\n\t${3:// false}\n}',
        ghost:'if (condition) {\n\t// true\n} else {\n\t// false\n}' },
      { trigger:'sw',
        label:'switch statement', detail:'🔀 Multi-branch',
        doc:'Matches a value against multiple cases.',
        snippet:'switch (${1:value}) {\n\tcase ${2:a}:\n\t\t${3:// code}\n\t\tbreak;\n\tdefault:\n\t\t${4:// default}\n}',
        ghost:'switch (value) { case a: break; default: }' },

      /* ── Loops ───────────────────────────────────────────── */
      { trigger:'for',
        label:'for loop', detail:'🔁 Count iterations',
        doc:'Runs a block a fixed number of times.',
        snippet:'for (let ${1:i} = 0; ${1:i} < ${2:10}; ${1:i}++) {\n\tconsole.log(${1:i});\n}',
        ghost:'for (let i = 0; i < 10; i++) { console.log(i); }' },
      { trigger:'forin',
        label:'for...in', detail:'🔁 Object keys',
        doc:'Iterates over enumerable property keys of an object.',
        snippet:'for (const ${1:key} in ${2:object}) {\n\tconsole.log(${1:key}, ${2:object}[${1:key}]);\n}',
        ghost:'for (const key in object) { console.log(key); }' },
      { trigger:'forof',
        label:'for...of', detail:'🔁 Array values',
        doc:'Iterates over values in any iterable.',
        snippet:'for (const ${1:item} of ${2:array}) {\n\tconsole.log(${1:item});\n}',
        ghost:'for (const item of array) { console.log(item); }' },
      { trigger:'wh',
        label:'while loop', detail:'🔁 Loop while true',
        doc:'Runs as long as the condition stays truthy.',
        snippet:'while (${1:condition}) {\n\t${2:// code}\n}',
        ghost:'while (condition) {\n\t// code\n}' },
      { trigger:'dowh',
        label:'do...while loop', detail:'🔁 Run at least once',
        doc:'Runs the block first, then checks the condition.',
        snippet:'do {\n\t${1:// code}\n} while (${2:condition});',
        ghost:'do { // code } while (condition);' },

      /* ── Array HOF ───────────────────────────────────────── */
      { trigger:'map',
        label:'Array.map()', detail:'🗺️ Transform items',
        doc:'Creates a new array by transforming each element.',
        snippet:'${1:array}.map((${2:item}) => {\n\treturn ${3:item};\n});',
        ghost:'array.map((item) => { return item; });' },
      { trigger:'filter',
        label:'Array.filter()', detail:'🔍 Keep matching',
        doc:'Returns items where the callback returns true.',
        snippet:'${1:array}.filter((${2:item}) => {\n\treturn ${3:true};\n});',
        ghost:'array.filter((item) => { return true; });' },
      { trigger:'reduce',
        label:'Array.reduce()', detail:'➕ Fold to value',
        doc:'Processes every element and accumulates a single result.',
        snippet:'${1:array}.reduce((${2:acc}, ${3:item}) => {\n\treturn ${2:acc} + ${3:item};\n}, ${4:0});',
        ghost:'array.reduce((acc, item) => acc + item, 0);' },
      { trigger:'foreach',
        label:'Array.forEach()', detail:'🔁 Each item',
        doc:'Calls a function for each element. Returns undefined.',
        snippet:'${1:array}.forEach((${2:item}) => {\n\tconsole.log(${2:item});\n});',
        ghost:'array.forEach((item) => { console.log(item); });' },
      { trigger:'find',
        label:'Array.find()', detail:'🔍 First match',
        doc:'Returns the first element satisfying the test.',
        snippet:'${1:array}.find((${2:item}) => ${3:item} === ${4:value});',
        ghost:'array.find((item) => item === value);' },

      /* ── Async ───────────────────────────────────────────── */
      { trigger:'promise',
        label:'new Promise()', detail:'⏳ Async work',
        doc:'Represents future async work. Use `.then()` for success, `.catch()` for errors.',
        snippet:'const ${1:myPromise} = new Promise((resolve, reject) => {\n\tconst ok = ${2:true};\n\tif (ok) resolve(${3:"Done!"});\n\telse    reject(${4:"Failed"});\n});\n\n${1:myPromise}\n\t.then(r  => console.log(r))\n\t.catch(e => console.error(e));',
        ghost:'new Promise((resolve, reject) => { resolve("Done!"); })' },
      { trigger:'async',
        label:'async function', detail:'⏳ Async/await',
        doc:'Always returns a Promise. Use `await` inside.',
        snippet:'async function ${1:name}() {\n\ttry {\n\t\tconst ${2:result} = await ${3:asyncCall()};\n\t\tconsole.log(${2:result});\n\t} catch (${4:err}) {\n\t\tconsole.error(${4:err});\n\t}\n}',
        ghost:'async function name() { const result = await ...; }' },
      { trigger:'await',
        label:'await expression', detail:'⏳ Wait for promise',
        doc:'Pauses the async function until the Promise settles.',
        snippet:'const ${1:result} = await ${2:asyncFunction()};',
        ghost:'const result = await asyncFunction();' },
      { trigger:'fetch',
        label:'fetch() request', detail:'🌐 HTTP / API call',
        doc:'Loads data from a URL. Returns a Promise.',
        snippet:'const ${1:res}  = await fetch(${2:"https://api.example.com"});\nconst ${3:data} = await ${1:res}.json();\nconsole.log(${3:data});',
        ghost:'const res = await fetch(url); const data = await res.json();' },

      /* ── Error handling ──────────────────────────────────── */
      { trigger:'try',
        label:'try / catch', detail:'🛡️ Catch errors',
        doc:'Runs risky code safely. Catch fires on error.',
        snippet:'try {\n\t${1:// risky code}\n} catch (${2:err}) {\n\tconsole.error(${2:err}.message);\n}',
        ghost:'try {\n\t// risky code\n} catch (err) { console.error(err.message); }' },
      { trigger:'tc',
        label:'try / catch (short)', detail:'🛡️ Quick wrap',
        doc:'Compact try/catch for quick use.',
        snippet:'try {\n\t${1:// code}\n} catch (${2:e}) {\n\tconsole.error(${2:e});\n}',
        ghost:'try { } catch (e) { console.error(e); }' },

      /* ── Classes ─────────────────────────────────────────── */
      { trigger:'cls',
        label:'class definition', detail:'🏗️ Blueprint',
        doc:'A class is a template for creating objects.',
        snippet:'class ${1:ClassName} {\n\tconstructor(${2:params}) {\n\t\t${3:// init}\n\t}\n\n\t${4:method}() {\n\t\t${5:// code}\n\t}\n}',
        ghost:'class ClassName { constructor() {} method() {} }' },
      { trigger:'class',
        label:'class definition', detail:'🏗️ Blueprint',
        doc:'A class is a template for creating objects with shared properties and methods.',
        snippet:'class ${1:MyClass} {\n\tconstructor(${2:params}) {\n\t\tthis.${3:prop} = ${2:params};\n\t}\n\n\t${4:method}() {\n\t\t${5:// code}\n\t}\n}',
        ghost:'class MyClass { constructor() {} method() {} }' },

      /* ── Timers ──────────────────────────────────────────── */
      { trigger:'set',
        label:'setTimeout()', detail:'⏰ Delay once',
        doc:'Runs code once after a delay in milliseconds.',
        snippet:'setTimeout(() => {\n\t${1:// code}\n}, ${2:1000});',
        ghost:'setTimeout(() => { }, 1000);' },
      { trigger:'sint',
        label:'setInterval()', detail:'🔄 Repeat',
        doc:'Repeatedly runs code at a fixed interval. Remember to clearInterval().',
        snippet:'const ${1:timer} = setInterval(() => {\n\t${2:// code}\n}, ${3:1000});\n\n// To stop: clearInterval(${1:timer});',
        ghost:'const timer = setInterval(() => { }, 1000);' },

      /* ── DOM ─────────────────────────────────────────────── */
      { trigger:'qs',
        label:'querySelector()', detail:'🔍 Find element',
        doc:'Finds the first DOM element matching a CSS selector.',
        snippet:'const ${1:el} = document.querySelector(${2:"#id"});',
        ghost:'const el = document.querySelector("#id");' },
      { trigger:'qsa',
        label:'querySelectorAll()', detail:'🔍 Find all',
        doc:'Returns all matching elements as a NodeList.',
        snippet:'const ${1:els} = document.querySelectorAll(${2:".class"});',
        ghost:'const els = document.querySelectorAll(".class");' },
      { trigger:'addev',
        label:'addEventListener()', detail:'👂 Event listener',
        doc:'Calls a function whenever an event fires on an element.',
        snippet:'${1:element}.addEventListener(${2:"click"}, function (${3:e}) {\n\t${4:// handle}\n});',
        ghost:'element.addEventListener("click", function(e) { });' },
      { trigger:'gi',
        label:'getElementById()', detail:'🔍 Get by ID',
        doc:'Returns the single element whose ID matches.',
        snippet:'const ${1:el} = document.getElementById(${2:"myId"});',
        ghost:'const el = document.getElementById("myId");' },

      /* ── Objects & Misc ──────────────────────────────────── */
      { trigger:'obj',
        label:'object literal', detail:'📦 Key-value store',
        doc:'Objects store named values (properties).',
        snippet:'const ${1:obj} = {\n\t${2:key}: ${3:value},\n};',
        ghost:'const obj = { key: value };' },
      { trigger:'imp',
        label:'import', detail:'📥 ES Module import',
        doc:'Imports exported values from another JS module.',
        snippet:'import ${1:name} from ${2:"./module"};',
        ghost:'import name from "./module";' },
      { trigger:'exp',
        label:'export', detail:'📤 ES Module export',
        doc:'Makes a value available to other modules.',
        snippet:'export const ${1:name} = ${2:value};',
        ghost:'export const name = value;' },
      { trigger:'ret',
        label:'return', detail:'↩️ Return value',
        doc:'Exits a function and optionally returns a value.',
        snippet:'return ${1:value};', ghost:'return value;' },
    ];
    return _snippetLib;
  }

  function _findSnippet(word) {
    if (!word || word.length < 2) return null;
    var lib = getSnippetLib();
    for (var i = 0; i < lib.length; i++) {
      if (lib[i].trigger === word) return lib[i];
    }
    for (var j = 0; j < lib.length; j++) {
      if (lib[j].trigger.startsWith(word)) return lib[j];
    }
    return null;
  }

  /* ──────────────────────────────────────────────────────────
     /editor-core/language-config.js
     TypeScript/JS language service + bracket rules + 3 providers
     ────────────────────────────────────────────────────────── */
  function _configureLanguage() {

    monaco.languages.typescript.javascriptDefaults.setCompilerOptions({
      target: monaco.languages.typescript.ScriptTarget.ESNext,
      module: monaco.languages.typescript.ModuleKind.ESNext,
      allowNonTsExtensions: true,
      allowJs: true, checkJs: false, noLib: false,
    });
    monaco.languages.typescript.javascriptDefaults.setEagerModelSync(true);
    monaco.languages.typescript.javascriptDefaults.setDiagnosticsOptions({
      noSemanticValidation: false,
      noSyntaxValidation:   false,
    });

    monaco.languages.setLanguageConfiguration('javascript', {
      brackets: [['(',')'],['{','}'],['[',']']],
      autoClosingPairs: [
        { open:'(', close:')' }, { open:'{', close:'}' }, { open:'[', close:']' },
        { open:'"', close:'"', notIn:['string'] },
        { open:"'", close:"'", notIn:['string','comment'] },
        { open:'`', close:'`', notIn:['string'] },
      ],
      surroundingPairs: [
        { open:'(', close:')' }, { open:'{', close:'}' }, { open:'[', close:']' },
        { open:'"', close:'"' }, { open:"'", close:"'" }, { open:'`', close:'`' },
      ],
      onEnterRules: [
        { beforeText:/^\s*\{[^}]*$/, action:{ indentAction: monaco.languages.IndentAction.Indent } },
        { beforeText:/^\s*\}$/,      action:{ indentAction: monaco.languages.IndentAction.Outdent } },
      ],
    });

    /* ── Provider 1: Teaching snippets (IntelliSense dropdown) ── */
    monaco.languages.registerCompletionItemProvider('javascript', {
      triggerCharacters: ['.'],
      provideCompletionItems: function (model, position) {
        var line   = model.getLineContent(position.lineNumber);
        var before = line.substring(0, position.column - 1);
        var wm     = before.match(/[\w]+$/);
        if (!wm) return { suggestions: [] };

        var word    = wm[0];
        var lib     = getSnippetLib();
        var CIK     = monaco.languages.CompletionItemKind;
        var ITR     = monaco.languages.CompletionItemInsertTextRule;
        var wRange  = new monaco.Range(
          position.lineNumber, position.column - word.length,
          position.lineNumber, position.column
        );
        var results = [];
        for (var i = 0; i < lib.length; i++) {
          var s = lib[i];
          if (!s.trigger.startsWith(word)) continue;
          results.push({
            label:           { label: s.label, description: s.detail },
            kind:            CIK.Snippet,
            detail:          s.detail,
            documentation:   { value: '**\uD83D\uDCA1 Teaching Tip**\n\n' + s.doc },
            insertText:      s.snippet,
            insertTextRules: ITR.InsertAsSnippet,
            range:           wRange,
            sortText:        '000' + s.trigger,
            filterText:      s.trigger,
            preselect:       true,
          });
        }
        return { suggestions: results };
      },
    });

    /* ── Provider 2: Arrow function auto-complete ── */
    monaco.languages.registerCompletionItemProvider('javascript', {
      triggerCharacters: ['>'],
      provideCompletionItems: function (model, position) {
        var line    = model.getLineContent(position.lineNumber);
        var before  = line.substring(0, position.column - 1);
        var arrowOk = /[=:,\(]\s*\(.*\)\s*$/.test(before) || /\)\s*$/.test(before);
        if (!arrowOk) return { suggestions: [] };
        return {
          suggestions: [{
            label:           '=> { } \u2014 arrow function body',
            kind:            monaco.languages.CompletionItemKind.Snippet,
            detail:          '\u27A1\uFE0F Complete arrow function',
            documentation:   { value: '**Arrow function**\n\nCompletes `(params) => { }` with cursor inside.' },
            insertText:      '=> {\n\t${1:// code}\n}',
            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
            range:           new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
            sortText:        '000', preselect: true,
          }],
        };
      },
    });

    /* ── Provider 3: Inline ghost text (Copilot-style) ── */
    var _ghostCache = { word: null, items: [] };
    monaco.languages.registerInlineCompletionsProvider('javascript', {
      provideInlineCompletions: function (model, position) {
        var line   = model.getLineContent(position.lineNumber);
        var before = line.substring(0, position.column - 1);
        var wm     = before.match(/[\w]+$/);
        if (!wm) { _ghostCache = { word:null, items:[] }; return { items:[] }; }
        var word = wm[0];
        if (word.length < 2) return { items:[] };
        if (_ghostCache.word === word) return { items: _ghostCache.items };
        var snip = _findSnippet(word);
        if (!snip) { _ghostCache = { word:word, items:[] }; return { items:[] }; }
        var items = [{
          insertText: snip.ghost,
          range: new monaco.Range(
            position.lineNumber, position.column - word.length,
            position.lineNumber, position.column
          ),
        }];
        _ghostCache = { word:word, items:items };
        return { items:items };
      },
      freeInlineCompletions: function () {},
    });
  }

  /* ──────────────────────────────────────────────────────────
     /editor-core/theme.js
     ────────────────────────────────────────────────────────── */
  function _defineTheme() {
    monaco.editor.defineTheme('wap-dark', {
      base: 'vs-dark', inherit: true,
      rules: [
        { token:'comment',       foreground:'515d76', fontStyle:'italic' },
        { token:'keyword',       foreground:'a78bfa', fontStyle:'bold'   },
        { token:'string',        foreground:'3dd68c' },
        { token:'string.escape', foreground:'f0a500' },
        { token:'number',        foreground:'f0a500' },
        { token:'regexp',        foreground:'ff6b6b' },
        { token:'delimiter',     foreground:'8b95ab' },
        { token:'type',          foreground:'4f9eff' },
        { token:'identifier',    foreground:'cdd6f4' },
        { token:'function',      foreground:'4f9eff' },
      ],
      colors: {
        'editor.background':                  '#000000',
        'editor.foreground':                  '#cdd6f4',
        'editor.lineHighlightBackground':     '#1a1e2840',
        'editor.selectionBackground':         '#4f9eff33',
        'editor.inactiveSelectionBackground': '#4f9eff1a',
        'editorCursor.foreground':            '#4f9eff',
        'editorLineNumber.foreground':        '#515d76',
        'editorLineNumber.activeForeground':  '#8b95ab',
        'editorInlinesuggest.foreground':     '#515d76',
        'editorSuggestWidget.background':     '#13161d',
        'editorSuggestWidget.border':         '#252a38',
        'editorSuggestWidget.foreground':     '#cdd6f4',
        'editorSuggestWidget.selectedBackground': '#1e2535',
        'editorSuggestWidget.highlightForeground': '#4f9eff',
        'editorBracketMatch.background':      '#4f9eff22',
        'editorBracketMatch.border':          '#4f9eff',
        'scrollbarSlider.background':         '#2a314855',
        'scrollbarSlider.hoverBackground':    '#4f9eff44',
        'scrollbarSlider.activeBackground':   '#4f9eff88',
      },
    });
  }

  /* ──────────────────────────────────────────────────────────
     /editor-core/create-editor.js
     ────────────────────────────────────────────────────────── */
  function _createEditor() {
    _monaco = monaco.editor.create(editorEl, {
      value:    'console.log("Cristiano Ronaldo is the GOAT");',
      language: 'javascript',
      theme:    'wap-dark',
      /* Typography */
      fontSize: 14, fontFamily:"'Courier New', Courier, monospace",
      fontLigatures: true, lineHeight: 22,
      /* Layout */
      minimap: { enabled:false }, scrollBeyondLastLine:false,
      automaticLayout:true, wordWrap:'on',
      padding: { top:18, bottom:18 }, overviewRulerLanes:0,
      hideCursorInOverviewRuler:true,
      scrollbar: { vertical:'auto', horizontal:'auto' },
      renderLineHighlight:'gutter',
      /* Indentation */
      tabSize:2, insertSpaces:true, autoIndent:'full', detectIndentation:false,
      /* Formatting */
      formatOnType:true, formatOnPaste:true,
      /* Brackets */
      autoClosingBrackets:'always', autoClosingQuotes:'always',
      autoSurround:'languageDefined', matchBrackets:'always',
      bracketPairColorization: { enabled:true },
      /* Cursor */
      cursorBlinking:'smooth', cursorSmoothCaretAnimation:'on', cursorStyle:'line',
      /* Suggestions */
      quickSuggestions: { other:true, comments:false, strings:false },
      suggestOnTriggerCharacters:true,
      acceptSuggestionOnEnter:'smart',
      snippetSuggestions:'inline',
      suggest: {
        preview:true, showKeywords:true, showSnippets:true,
        showFunctions:true, showVariables:true, showClasses:true,
        showModules:true, showProperties:true, showEvents:true,
        showOperators:true, showReferences:true,
        filterGraceful:true, localityBonus:true, shareSuggestSelections:true,
      },
      /* Ghost text */
      inlineSuggest: { enabled:true, mode:'prefix', showToolbar:'onHover' },
      /* Performance */
      wordBasedSuggestions:'currentDocument',
      /* Misc */
      renderWhitespace:'none', smoothScrolling:true,
      accessibilitySupport:'off',
    });

    /* Cmd+Enter → Run code */
    _monaco.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runCode);
    return _monaco;
  }

  /* ──────────────────────────────────────────────────────────
     /editor-core/index.js
     ────────────────────────────────────────────────────────── */
  function _initEditorCore() {
    if (typeof require === 'undefined' || typeof require.config === 'undefined') {
      setTimeout(_initEditorCore, 80); return;
    }
    if (_monacoReady) return;
    require.config({
      paths: { 'vs':'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' },
    });
    require(['vs/editor/editor.main'], function () {
      _monacoReady = true;
      _defineTheme();
      _configureLanguage();
      _createEditor();
      _initEducationLayer();
      _initKeyboardSystem();
    });
  }

  /* ──────────────────────────────────────────────────────────
     PUBLIC API — window.WapEditor
     All external code uses ONLY this surface.
     ────────────────────────────────────────────────────────── */
  window.WapEditor = (function () {
    var _api = {
      getValue: function ()    { return _monaco ? _monaco.getValue() : ''; },
      setValue: function (src) { if (_monaco) _monaco.setValue(src); },
      insertAtCursor: function (text) {
        if (!_monaco) return;
        _monaco.executeEdits('wap-edu', [{ range:_monaco.getSelection(), text:text, forceMoveMarkers:true }]);
        _monaco.focus();
      },
      focus:  function () { if (_monaco) { _monaco.layout(); _monaco.focus(); } },
      layout: function () { if (_monaco) _monaco.layout(); },
      onContentChange: function (cb) {
        if (!_monaco) return function(){};
        var d = _monaco.onDidChangeModelContent(function (e) { cb(_monaco.getValue(), e); });
        return function () { d.dispose(); };
      },
      onBlur: function (cb) {
        if (!_monaco) return function(){};
        var d = _monaco.onDidBlurEditorWidget(cb);
        return function () { d.dispose(); };
      },
      onCursorChange: function (cb) {
        if (!_monaco) return function(){};
        var d = _monaco.onDidChangeCursorPosition(cb);
        return function () { d.dispose(); };
      },
      addDecorations: function (decs) {
        if (!_monaco) return [];
        return _monaco.deltaDecorations([], decs);
      },
      clearDecorations: function (ids) {
        if (_monaco && ids && ids.length) _monaco.deltaDecorations(ids, []);
        return [];
      },
      registerCompletionProvider: function (p) {
        return monaco.languages.registerCompletionItemProvider('javascript', p);
      },
      registerInlineProvider: function (p) {
        return monaco.languages.registerInlineCompletionsProvider('javascript', p);
      },
      isReady: function () { return _monacoReady && _monaco !== null; },
      /* Extended by education layer after init */
      showHint:   function () {},
      clearHints: function () {},
    };
    return _api;
  }());

  /* ──────────────────────────────────────────────────────────
     /runtime-engine/sandbox.js  (v2 — full production upgrade)
     ─────────────────────────────────────────────────────────
     NEW in v2:
       • Execution timer (ms precision, live during async)
       • requestAnimationFrame patching + cleanup
       • Line number extraction from stack traces
       • Structured error block display
       • Async-aware: timer stops when async work settles
       • Runtime status row (Idle / Running / Error / Completed)
     ────────────────────────────────────────────────────────── */

  /* Runtime status DOM */
  var _rsDot   = document.getElementById('wap-rs-dot');
  var _rsLabel = document.getElementById('wap-rs-label');
  var _rsTime  = document.getElementById('wap-rs-time');

  /* Global registries — survive across runs */
  window.__wapIntervals = window.__wapIntervals || [];
  window.__wapTimeouts  = window.__wapTimeouts  || [];
  window.__wapRafs      = window.__wapRafs      || [];

  var _isRunning = false;   /* stacked-run guard */
  var _timerInterval = null;
  var _timerStart    = 0;

  /* ── Timer helpers ───────────────────────────────────────── */
  function _startTimer() {
    _timerStart = performance.now();
    if (_timerInterval) _realClearInterval(_timerInterval);
    _timerInterval = _realSetInterval(function () {
      var ms = Math.round(performance.now() - _timerStart);
      if (_rsTime) { _rsTime.textContent = ms + 'ms'; _rsTime.className = 'wap-rs-time active'; }
    }, 50);
  }

  function _stopTimer() {
    if (_timerInterval) { _realClearInterval(_timerInterval); _timerInterval = null; }
    var ms = Math.round(performance.now() - _timerStart);
    if (_rsTime) _rsTime.textContent = ms + 'ms';
    return ms;
  }

  /* ── Status display ─────────────────────────────────────── */
  function _setStatus(state, label) {
    if (_rsDot)   { _rsDot.className   = 'wap-rs-dot ' + state; }
    if (_rsLabel) { _rsLabel.className  = 'wap-rs-label ' + state; _rsLabel.textContent = label; }
    /* Also update the compact badge in toolbar */
    if (badgeEl) {
      badgeEl.className = 'wap-runtime-badge ' + state + ' visible';
      badgeEl.textContent = label;
      if (state !== 'running') {
        _realSetTimeout(function () { badgeEl.classList.remove('visible'); }, 2800);
      }
    }
  }

  function _clearPreviousTimers() {
    window.__wapIntervals.forEach(function (id) { clearInterval(id); });
    window.__wapIntervals = [];
    window.__wapTimeouts.forEach(function (id) { clearTimeout(id); });
    window.__wapTimeouts = [];
    window.__wapRafs.forEach(function (id) { cancelAnimationFrame(id); });
    window.__wapRafs = [];
  }

  function _patchTimers() {
    window.setInterval = function (fn, delay) {
      var id = _realSetInterval(fn, delay);
      window.__wapIntervals.push(id);
      return id;
    };
    window.setTimeout = function (fn, delay) {
      var id = _realSetTimeout(fn, delay);
      window.__wapTimeouts.push(id);
      return id;
    };
    window.requestAnimationFrame = function (fn) {
      var id = _realRaf(fn);
      window.__wapRafs.push(id);
      return id;
    };
  }

  function _restoreTimers() {
    window.setInterval            = _realSetInterval;
    window.setTimeout             = _realSetTimeout;
    window.requestAnimationFrame  = _realRaf;
  }

  var _realSetInterval = window.setInterval;
  var _realSetTimeout  = window.setTimeout;
  var _realClearInterval = window.clearInterval;
  var _realRaf         = window.requestAnimationFrame || function (fn) { return _realSetTimeout(fn, 16); };

  /* ── Extract line number from error stack ────────────────── */
  function _getErrorLine(e) {
    /* Different browsers format stacks differently */
    if (!e || !e.stack) return null;
    /* Match patterns like: at <anonymous>:5:12  or  Function:3:7 */
    var m = e.stack.match(/<anonymous>:(\d+):\d+/) ||
            e.stack.match(/Function:(\d+):\d+/)    ||
            e.stack.match(/:(\d+):\d+\)/);
    if (!m) return null;
    /* Subtract 1 for the "use strict"; line we prepend */
    var line = parseInt(m[1], 10) - 1;
    return line > 0 ? line : null;
  }

  function _captureConsole(lines) {
    var _log  = console.log;
    var _warn = console.warn;
    var _err  = console.error;
    function capture(type) {
      return function () {
        var parts = [];
        for (var i = 0; i < arguments.length; i++) parts.push(_serialize(arguments[i]));
        lines.push({ t: type, v: parts.join(' ') });
        _log.apply(console, arguments);
      };
    }
    console.log   = capture('log');
    console.warn  = capture('warn');
    console.error = capture('error');
    return function restore() { console.log = _log; console.warn = _warn; console.error = _err; };
  }

  function runCode() {
    if (_isRunning) return;
    _isRunning = true;

    /* ── 1. Reset ─────────────────────────────────────────── */
    _clearPreviousTimers();
    outputEl.innerHTML = '';
    _setStatus('running', 'Running…');
    _startTimer();

    /* ── 2. Get code ──────────────────────────────────────── */
    var code  = window.WapEditor ? window.WapEditor.getValue() : '';
    var lines = [];
    var _errorOccurred = false;

    /* ── 3. Capture console ───────────────────────────────── */
    var restoreConsole = _captureConsole(lines);

    /* ── 4. Patch timers + rAF ────────────────────────────── */
    _patchTimers();

    /* ── 5. Execute ───────────────────────────────────────── */
    var _returnedPromise = null;
    try {
      /* eslint-disable-next-line no-new-func */
      var _fn = new Function('"use strict";\n' + code);
      _returnedPromise = _fn();
    } catch (e) {
      _errorOccurred = true;
      var lineNum = _getErrorLine(e);
      lines.push({
        t: 'error-block',
        name: e.name || 'Error',
        msg:  e.message || String(e),
        line: lineNum,
      });
    } finally {
      restoreConsole();
      _restoreTimers();
    }

    /* ── 6. Handle async (Promise returned) ──────────────── */
    if (_returnedPromise && typeof _returnedPromise.then === 'function') {
      /* Re-patch console for async work */
      var restoreAsync = _captureConsole(lines);
      _returnedPromise.then(function () {
        restoreAsync();
        var ms = _stopTimer();
        _isRunning = false;
        _renderOutput(lines);
        _setStatus('success', '✓ Done in ' + ms + 'ms');
        _dispatchRunEvent(code);
      }).catch(function (e) {
        restoreAsync();
        var lineNum = _getErrorLine(e);
        lines.push({
          t: 'error-block',
          name: e.name || 'Error',
          msg:  e.message || String(e),
          line: lineNum,
        });
        var ms = _stopTimer();
        _isRunning = false;
        _renderOutput(lines);
        _setStatus('error', '✗ Error (' + ms + 'ms)');
        _dispatchRunEvent(code);
      });
      /* Show intermediate output immediately */
      _renderOutput(lines);
      return;
    }

    /* ── 7. Sync execution complete ───────────────────────── */
    var ms = _stopTimer();
    _isRunning = false;
    _renderOutput(lines);
    if (_errorOccurred) {
      _setStatus('error', '✗ Error (' + ms + 'ms)');
    } else {
      _setStatus('success', '✓ Done in ' + ms + 'ms');
    }
    _dispatchRunEvent(code);
  }

  function _dispatchRunEvent(code) {
    document.dispatchEvent(new CustomEvent('wap:codeRun', {
      detail: { code: code, lineCount: code.split('\n').length }
    }));
  }

  /* ──────────────────────────────────────────────────────────
     /education-engine/index.js  (PHASE 3)
     Attaches only through WapEditor public API.
     Uses Monaco decorations for hints.
     Dispatches CustomEvents for XP / gamification system.
     ────────────────────────────────────────────────────────── */
  function _initEducationLayer() {
    var api = window.WapEditor;
    if (!api || !api.isReady()) return;

    var _hintIds     = [];
    var _changeTimer = null;

    /* Analytics tracking — survives within session */
    var _analytics = {
      topicTime: {},       /* ms spent per topic */
      mistakes:  {},       /* error count per topic */
      retries:   {},       /* retry count per topic */
      lastCodeLen: 0,
    };

    api.onContentChange(function (code) {
      clearTimeout(_changeTimer);
      _changeTimer = _realSetTimeout(function () { _analyzeCode(code); }, 600);
    });

    api.onBlur(function () {
      clearTimeout(_changeTimer);
      _analyzeCode(api.getValue());
    });

    /* Track when code runs with errors */
    document.addEventListener('wap:codeRun', function (e) {
      /* Retry detection: re-run with similar code = retry */
      var newLen = (e.detail.code || '').length;
      if (Math.abs(newLen - _analytics.lastCodeLen) < 5) {
        var t = window._currentTopic || 0;
        _analytics.retries[t] = (_analytics.retries[t] || 0) + 1;
      }
      _analytics.lastCodeLen = newLen;
    });

    function _analyzeCode(code) {
      _hintIds = api.clearDecorations(_hintIds);
      var lines     = code.split('\n');
      var newDecs   = [];

      /* ── Pattern detection ─────────────────────────────── */
      var analysis = {
        hasConsole:    /console\.log/.test(code),
        hasFunction:   /function\s+\w+|=>\s*\{/.test(code),
        hasLoop:       /for\s*\(|while\s*\(/.test(code),
        hasAsync:      /async\s+function|await\s+/.test(code),
        hasVar:        /\bvar\b/.test(code),
        hasFetch:      /fetch\s*\(/.test(code),
        deepNesting:   _maxNestingDepth(code) > 4,
        longFunctions: _hasLongFunction(lines, 20),
        infiniteRisk:  _hasInfiniteLoopRisk(lines),
        charCount:     code.length,
        lineCount:     lines.length,
      };

      /* ── Code smell: var usage ─────────────────────────── */
      if (analysis.hasVar) {
        lines.forEach(function (ln, i) {
          if (/\bvar\b/.test(ln) && !/\/\//.test(ln.substring(0, ln.indexOf('var')))) {
            newDecs.push({
              range: new monaco.Range(i + 1, 1, i + 1, 1),
              options: {
                isWholeLine: true,
                className:   'wap-info-line',
                hoverMessage: { value:
                  '\u26A0\uFE0F **Code Tip — var smell**\n\n' +
                  'Prefer `const` or `let` over `var`.\n\n' +
                  '`var` is **function-scoped** and **hoisted**, which can lead to bugs ' +
                  'that are hard to trace. Use `const` for values that never change, ' +
                  '`let` for values that do.' },
                overviewRuler: { color:'#f0a50055', position: monaco.editor.OverviewRulerLane.Left },
              },
            });
          }
        });
      }

      /* ── Code smell: deep nesting ──────────────────────── */
      if (analysis.deepNesting) {
        var deepLine = _firstLineWithDepth(lines, 4);
        if (deepLine > 0) {
          newDecs.push({
            range: new monaco.Range(deepLine, 1, deepLine, 1),
            options: {
              isWholeLine: true,
              className:   'wap-info-line',
              hoverMessage: { value:
                '\uD83D\uDCC9 **Code Tip — Deep Nesting**\n\n' +
                'This code has more than 4 levels of indentation.\n\n' +
                'Consider extracting inner logic into named functions to improve readability.' },
              overviewRuler: { color:'#a78bfa44', position: monaco.editor.OverviewRulerLane.Right },
            },
          });
        }
      }

      /* ── Code smell: infinite loop risk ─────────────────── */
      if (analysis.infiniteRisk) {
        var riskLine = _infiniteRiskLine(lines);
        if (riskLine > 0) {
          newDecs.push({
            range: new monaco.Range(riskLine, 1, riskLine, 1),
            options: {
              isWholeLine: true,
              className:   'wap-error-line',
              hoverMessage: { value:
                '\uD83D\uDD34 **Infinite Loop Risk**\n\n' +
                '`while(true)` without a `break` or async yield will **freeze the browser tab**.\n\n' +
                'Make sure your loop has a clear exit condition.' },
              overviewRuler: { color:'#ff6b6b88', position: monaco.editor.OverviewRulerLane.Right },
            },
          });
        }
      }

      /* ── Code smell: fetch without .catch ───────────────── */
      if (analysis.hasFetch && !/.catch\s*\(/.test(code)) {
        var fetchLine = _findLineWith(code, /fetch\s*\(/);
        if (fetchLine > 0) {
          newDecs.push({
            range: new monaco.Range(fetchLine, 1, fetchLine, 1),
            options: {
              isWholeLine: true,
              className:   'wap-hint-line',
              hoverMessage: { value:
                '\uD83D\uDCA1 **Tip — Missing .catch()**\n\n' +
                '`fetch()` can fail due to network errors or bad status codes.\n\n' +
                'Always add `.catch(err => console.error(err))` to handle failures gracefully.' },
              overviewRuler: { color:'#4f9eff44', position: monaco.editor.OverviewRulerLane.Left },
            },
          });
        }
      }

      /* Apply all decorations in one call (efficient) */
      if (newDecs.length) {
        _hintIds = api.addDecorations(newDecs);
      }

      document.dispatchEvent(new CustomEvent('wap:codeAnalysis', { detail: analysis }));
    }

    /* ── Code smell helpers ────────────────────────────────── */
    function _maxNestingDepth(code) {
      var depth = 0; var max = 0;
      for (var i = 0; i < code.length; i++) {
        if (code[i] === '{') { depth++; if (depth > max) max = depth; }
        else if (code[i] === '}') depth--;
      }
      return max;
    }

    function _firstLineWithDepth(lines, threshold) {
      var depth = 0;
      for (var i = 0; i < lines.length; i++) {
        var opens  = (lines[i].match(/\{/g) || []).length;
        var closes = (lines[i].match(/\}/g) || []).length;
        depth += opens - closes;
        if (depth > threshold) return i + 1;
      }
      return 0;
    }

    function _hasLongFunction(lines, maxLines) {
      var inFn = false; var fnStart = 0; var depth = 0;
      for (var i = 0; i < lines.length; i++) {
        if (!inFn && /function\s*[\w(]|=>\s*\{/.test(lines[i])) {
          inFn = true; fnStart = i; depth = 0;
        }
        if (inFn) {
          depth += (lines[i].match(/\{/g)||[]).length - (lines[i].match(/\}/g)||[]).length;
          if (depth <= 0 && i > fnStart) {
            if ((i - fnStart) > maxLines) return true;
            inFn = false;
          }
        }
      }
      return false;
    }

    function _hasInfiniteLoopRisk(lines) {
      return lines.some(function (ln) {
        return /while\s*\(\s*true\s*\)/.test(ln) && !/break/.test(ln);
      });
    }

    function _infiniteRiskLine(lines) {
      for (var i = 0; i < lines.length; i++) {
        if (/while\s*\(\s*true\s*\)/.test(lines[i])) return i + 1;
      }
      return 0;
    }

    function _findLineWith(code, rx) {
      var codeLines = code.split('\n');
      for (var i = 0; i < codeLines.length; i++) {
        if (rx.test(codeLines[i])) return i + 1;
      }
      return 0;
    }

    /* ── Public API extensions ────────────────────────────── */
    api.showHint = function (lineNum, msg, type) {
      if (!api.isReady()) return;
      var cls = type === 'error' ? 'wap-error-line' : 'wap-hint-line';
      _hintIds = api.addDecorations([{
        range: new monaco.Range(lineNum, 1, lineNum, 1),
        options: {
          isWholeLine:  true,
          className:    cls,
          hoverMessage: { value: '\uD83D\uDCA1 ' + msg },
          overviewRuler: { color:'#4f9eff66', position: monaco.editor.OverviewRulerLane.Left },
        },
      }]);
    };
    api.clearHints = function () {
      _hintIds = api.clearDecorations(_hintIds);
    };
    api.getAnalytics = function () { return JSON.parse(JSON.stringify(_analytics)); };
  }

  /* ──────────────────────────────────────────────────────────
     /ui-overlays/command-palette.js  (PHASE 5 — Cmd+Shift+P)
     /ui-overlays/topic-search.js     (PHASE 5 — Cmd+K)
     Fully modular, never interferes with editor typing.
     ────────────────────────────────────────────────────────── */
  function _initKeyboardSystem() {

    /* ── Command Registry ────────────────────────────────── */
    var COMMANDS = [
      { icon:'▶', label:'Run Code',          kbd:'Cmd+Enter',   action: runCode },
      { icon:'⌫', label:'Clear Output',      kbd:'',            action: function () {
          outputEl.innerHTML = '<span class="jsc-line jsc-line-empty">// Cleared</span>';
      }},
      { icon:'📋', label:'Clear Editor',     kbd:'',            action: function () {
          if (window.WapEditor) { window.WapEditor.setValue(''); window.WapEditor.focus(); }
      }},
      { icon:'✕', label:'Close Compiler',    kbd:'Esc',         action: closeCompiler },
      { icon:'🌙', label:'Toggle Theme',     kbd:'',            action: function () {
          var html = document.documentElement;
          html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      }},
      { icon:'↔', label:'Toggle Word Wrap',  kbd:'',            action: function () {
          if (_monaco) {
            var cur = _monaco.getOption(monaco.editor.EditorOption.wordWrap);
            _monaco.updateOptions({ wordWrap: cur === 'on' ? 'off' : 'on' });
          }
      }},
      { icon:'🔍', label:'Search Topics',    kbd:'Cmd+K',       action: function () {
          _closePalette(); _openSearch();
      }},
    ];

    /* ── Command Palette ─────────────────────────────────── */
    var paletteOverlay = document.getElementById('wap-palette-overlay');
    var paletteInput   = document.getElementById('wap-palette-input');
    var paletteList    = document.getElementById('wap-palette-list');
    var paletteEmpty   = document.getElementById('wap-palette-empty');
    var _paletteOpen   = false;
    var _paletteIdx    = 0;

    function _openPalette() {
      if (!paletteOverlay) return;
      _paletteOpen = true;
      paletteOverlay.classList.add('wap-palette-open');
      paletteInput.value = '';
      _renderPalette('');
      _realSetTimeout(function () { paletteInput.focus(); }, 40);
    }
    function _closePalette() {
      if (!paletteOverlay) return;
      _paletteOpen = false;
      paletteOverlay.classList.remove('wap-palette-open');
    }
    function _renderPalette(q) {
      var filtered = COMMANDS.filter(function (c) {
        return !q || c.label.toLowerCase().includes(q.toLowerCase());
      });
      _paletteIdx = 0;
      if (!filtered.length) {
        paletteList.innerHTML = '';
        paletteEmpty.style.display = 'block';
        return;
      }
      paletteEmpty.style.display = 'none';
      paletteList.innerHTML = filtered.map(function (c, i) {
        return '<li class="wap-palette-item' + (i === 0 ? ' wap-palette-active' : '') +
          '" data-idx="' + i + '">' +
          '<span class="wap-palette-item-icon">' + c.icon + '</span>' +
          '<span class="wap-palette-item-label">' + c.label + '</span>' +
          (c.kbd ? '<span class="wap-palette-item-kbd">' + c.kbd + '</span>' : '') +
          '</li>';
      }).join('');
      /* click handler */
      paletteList.querySelectorAll('.wap-palette-item').forEach(function (el, i) {
        el.addEventListener('click', function () {
          _closePalette();
          filtered[i].action();
        });
      });
    }
    if (paletteInput) {
      paletteInput.addEventListener('input', function () { _renderPalette(paletteInput.value); });
      paletteInput.addEventListener('keydown', function (e) {
        var items = paletteList.querySelectorAll('.wap-palette-item');
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          _paletteIdx = Math.min(_paletteIdx + 1, items.length - 1);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          _paletteIdx = Math.max(_paletteIdx - 1, 0);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (items[_paletteIdx]) items[_paletteIdx].click();
        } else if (e.key === 'Escape') {
          e.stopImmediatePropagation(); _closePalette();
        }
        items.forEach(function (el, i) {
          el.classList.toggle('wap-palette-active', i === _paletteIdx);
        });
      });
    }
    if (paletteOverlay) {
      paletteOverlay.addEventListener('click', function (e) {
        if (e.target === paletteOverlay) _closePalette();
      });
    }

    /* ── Topic Search (Cmd+K) ────────────────────────────── */
    var searchOverlay = document.getElementById('wap-search-overlay');
    var searchInput   = document.getElementById('wap-search-input');
    var searchResults = document.getElementById('wap-search-results');
    var _searchOpen   = false;
    var _searchIdx    = 0;

    /* Collect topic names from the existing sidebar nav */
    function _getTopics() {
      var topics = [];
      /* Primary: use TOPIC_TITLES via window reference for reliable, clean names */
      var titles = window._WAP_TOPIC_TITLES || (typeof TOPIC_TITLES !== 'undefined' ? TOPIC_TITLES : null);
      if (titles && titles.length) {
        titles.forEach(function(title, i) {
          topics.push({ num: String(i), name: title });
        });
        return topics;
      }
      /* Fallback: grab from TOC links with data-topic */
      document.querySelectorAll('.toc-link[data-topic]').forEach(function (el) {
        var num  = el.getAttribute('data-topic') || '';
        var name = '';
        el.childNodes.forEach(function(node) {
          if (node.nodeType === 3) name += node.textContent;
          else if (node.classList && !node.classList.contains('num') && !node.classList.contains('chk') && !node.classList.contains('diff-dot')) {
            name += node.textContent;
          }
        });
        name = name.trim().replace(/✓/g, '').trim();
        if (num && name) topics.push({ num: num, name: name });
      });
      /* Last resort: sidebar nav items */
      if (!topics.length) {
        document.querySelectorAll('.nav-item').forEach(function (el) {
          var num = el.getAttribute('data-n') || '';
          var name = el.querySelector('.nav-item-name') ? el.querySelector('.nav-item-name').textContent.trim() : el.textContent.trim();
          if (num) topics.push({ num: num, name: name.slice(0,60) });
        });
      }
      return topics;
    }

    function _openSearch() {
      if (!searchOverlay) return;
      _searchOpen = true;
      searchOverlay.classList.add('wap-search-open');
      searchInput.value = '';
      _renderSearch('');
      _realSetTimeout(function () { searchInput.focus(); }, 40);
    }
    function _closeSearch() {
      if (!searchOverlay) return;
      _searchOpen = false;
      searchOverlay.classList.remove('wap-search-open');
    }
    function _renderSearch(q) {
      var topics = _getTopics();
      var filtered = topics.filter(function (t) {
        return !q || t.name.toLowerCase().includes(q.toLowerCase()) || t.num.includes(q);
      }).slice(0, 20);
      _searchIdx = 0;
      searchResults.innerHTML = filtered.map(function (t, i) {
        return '<li class="wap-search-item' + (i === 0 ? ' active' : '') + '" data-idx="' + i + '">' +
          '<span class="wap-search-num">' + t.num + '</span>' +
          '<span>' + t.name + '</span></li>';
      }).join('');
      searchResults.querySelectorAll('.wap-search-item').forEach(function (el, i) {
        el.addEventListener('click', function () {
          _closeSearch();
          /* Delegate to existing openTopic function if available */
          if (typeof openTopic === 'function') openTopic(parseInt(filtered[i].num));
        });
      });
    }
    if (searchInput) {
      searchInput.addEventListener('input', function () { _renderSearch(searchInput.value); });
      searchInput.addEventListener('keydown', function (e) {
        var items = searchResults.querySelectorAll('.wap-search-item');
        if (e.key === 'ArrowDown') { e.preventDefault(); _searchIdx = Math.min(_searchIdx+1, items.length-1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); _searchIdx = Math.max(_searchIdx-1, 0); }
        else if (e.key === 'Enter') { e.preventDefault(); if (items[_searchIdx]) items[_searchIdx].click(); }
        else if (e.key === 'Escape') { e.stopImmediatePropagation(); _closeSearch(); }
        items.forEach(function (el, i) { el.classList.toggle('active', i === _searchIdx); });
      });
    }
    if (searchOverlay) {
      searchOverlay.addEventListener('click', function (e) {
        if (e.target === searchOverlay) _closeSearch();
      });
    }

    /* ── Global keyboard shortcuts ───────────────────────── */
    document.addEventListener('keydown', function (e) {
      var mod = e.metaKey || e.ctrlKey;
      if (!mod) return;

      /* Cmd+Shift+P → Command Palette */
      if (e.shiftKey && e.key === 'P') {
        e.preventDefault(); e.stopPropagation();
        if (_paletteOpen) { _closePalette(); } else { _openPalette(); }
        return;
      }
      /* Cmd+K → Topic Search */
      if (!e.shiftKey && e.key === 'k') {
        e.preventDefault(); e.stopPropagation();
        if (_searchOpen) { _closeSearch(); } else { _openSearch(); }
        return;
      }
      /* Cmd+Enter → Run (handled by Monaco for editor focus; this covers when editor is blurred) */
      if (e.key === 'Enter' && _open && document.activeElement !== document.querySelector('#jsc-editor .monaco-editor')) {
        e.preventDefault();
        runCode();
        return;
      }
    }, true);
  }

  /* ──────────────────────────────────────────────────────────
     Compiler open / close
     ────────────────────────────────────────────────────────── */
  function openCompiler() {
    if (_open) return;
    _open = true;
    if (_closeRaf) { clearTimeout(_closeRaf); _closeRaf = null; }
    overlay.style.display = 'flex';
    void overlay.offsetWidth;
    overlay.classList.add('jsc-visible');
    document.body.style.overflow = 'hidden';
    _realSetTimeout(function () {
      if (window.WapEditor) window.WapEditor.focus();
    }, 240);
  }

  function closeCompiler() {
    if (!_open) return;
    _open = false;
    overlay.classList.remove('jsc-visible');
    _closeRaf = _realSetTimeout(function () {
      overlay.style.display = 'none';
      var mOverlay = document.getElementById('modal-overlay');
      if (!(mOverlay && mOverlay.classList.contains('active'))) document.body.style.overflow = '';
    }, 210);
  }

  /* ──────────────────────────────────────────────────────────
     Output rendering helpers
     ────────────────────────────────────────────────────────── */
  function _serialize(v) {
    if (v === null)      return 'null';
    if (v === undefined) return 'undefined';
    if (typeof v === 'function') return '[Function: ' + (v.name || 'anonymous') + ']';
    if (typeof v === 'object') { try { return JSON.stringify(v,null,2); } catch(_) { return String(v); } }
    return String(v);
  }

  function _esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function _renderOutput(lines) {
    if (!lines.length) {
      outputEl.innerHTML = '<span class="jsc-line jsc-line-empty">// No output</span>';
      return;
    }
    var html = '<div class="jsc-separator"></div>';
    for (var i = 0; i < lines.length; i++) {
      var l = lines[i];
      if (l.t === 'error-block') {
        /* Structured error display */
        html += '<div class="jsc-error-block">' +
          '<span class="err-type">' + _esc(l.name) + '</span>' +
          '<span class="err-msg">' + _esc(l.msg) + '</span>' +
          (l.line ? '<span class="err-line">↳ Line ' + l.line + '</span>' : '') +
          '</div>';
      } else {
        html += '<span class="jsc-line jsc-line-' + l.t + '">' + _esc(l.v) + '</span>';
      }
    }
    outputEl.innerHTML = html;
    outputEl.scrollTop = outputEl.scrollHeight;
  }

  /* ──────────────────────────────────────────────────────────
     /ui-overlays/fetch-section.js  (inline)
     Collapsible Fetch API teaching panel with tabs + "Open
     in Compiler" button. Fully standalone.
     ────────────────────────────────────────────────────────── */
  (function _initFetchSection() {
    var header  = document.getElementById('fetch-header');
    var body    = document.getElementById('fetch-body');
    var chevron = document.getElementById('fetch-chevron');
    var tryBtn  = document.getElementById('fetch-try-btn');

    if (!header || !body) return;

    /* Toggle open/close */
    function _toggle() {
      var isOpen = body.classList.toggle('open');
      chevron.classList.toggle('open', isOpen);
      header.classList.toggle('open', isOpen);
      header.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    }

    header.addEventListener('click', _toggle);
    header.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); _toggle(); }
    });

    /* Language tabs */
    body.addEventListener('click', function (e) {
      var tab = e.target.closest('.fetch-tab');
      if (!tab) return;
      var lang = tab.getAttribute('data-tab');
      body.querySelectorAll('.fetch-tab').forEach(function (t) {
        t.classList.toggle('active', t.getAttribute('data-tab') === lang);
      });
      body.querySelectorAll('.fetch-tab-content').forEach(function (c) {
        c.classList.toggle('active', c.getAttribute('data-content') === lang);
      });
    });

    /* "Open in Compiler" button */
    if (tryBtn) {
      var FETCH_CODE = [
        'fetch("https://uselessfacts.jsph.pl/api/v2/facts/random?category=careers")',
        '  .then((response) => {',
        '    if (!response.ok) {',
        '      throw new Error("Network response was not ok");',
        '    }',
        '    return response.json();',
        '  })',
        '  .then((data) => {',
        '    console.log("Data fetched successfully");',
        '    console.log(data);',
        '  })',
        '  .catch((error) => {',
        '    console.error("Error fetching data:", error);',
        '  });',
      ].join('\n');

      tryBtn.addEventListener('click', function () {
        if (window.WapEditor) {
          window.WapEditor.setValue(FETCH_CODE);
        }
        openCompiler();
      });
    }
  }());

  /* ══════════════════════════════════════════════════════════════
     /ui-overlays/jsc-fetch-panel.js  (inline)
     ──────────────────────────────────────────────────────────────
     Drives the in-overlay "Understanding Fetch API Flow" panel:
       • Toggle collapse / expand via .open on .fetch-body + chevron
       • Language tab switching  (data-lang / data-content attrs)
       • "Run in Editor" → WapEditor.setValue() + WapEditor.focus()
       • WapEditor.layout() called 310ms post-toggle so Monaco
         correctly recalculates after the CSS transition settles
     All element IDs are prefixed jsc-fetch- (zero collision with
     the main-page fetch-section whose IDs use fetch-* only).
     Uses _realSetTimeout (native, un-patched) from enclosing scope.
     ══════════════════════════════════════════════════════════════ */
  (function _initOverlayFetchPanel() {

    /* ── DOM refs ───────────────────────────────────────────── */
    var _panel   = document.getElementById('jsc-fetch-section');
    var _hdr     = document.getElementById('jsc-fetch-header');
    var _chevron = document.getElementById('jsc-fetch-chevron');
    var _body    = document.getElementById('jsc-fetch-body');
    var _runBtn  = document.getElementById('jsc-fetch-run-btn');

    /* Guard — all four must exist */
    if (!_panel || !_hdr || !_body) return;

    /* ── Collapse / expand ──────────────────────────────────── */
    function _toggle() {
      var isOpen = _body.classList.toggle('open');

      /* Chevron rotation driven by .open class (CSS handles it) */
      _chevron.classList.toggle('open', isOpen);

      /* Update ARIA state for screen readers */
      _hdr.setAttribute('aria-expanded', isOpen ? 'true' : 'false');

      /* After the 300ms CSS transition, nudge Monaco to recalculate
         its dimensions inside the now-resized .jsc-workspace.
         automaticLayout:true fires a ResizeObserver too, but an
         explicit layout() call guarantees correct behaviour across
         all browsers immediately after the transition completes.  */
      _realSetTimeout(function () {
        if (window.WapEditor) window.WapEditor.layout();
      }, 310);
    }

    /* Click */
    _hdr.addEventListener('click', _toggle);

    /* Keyboard (Enter / Space) — ARIA pattern for role="button" */
    _hdr.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        _toggle();
      }
    });

    /* ── Language tab switching ─────────────────────────────── */
    /*  Delegated to _panel so one listener handles both tabs.
        Uses data-lang on tabs and data-content on panes.         */
    _panel.addEventListener('click', function (e) {
      var tab = e.target.closest('[data-lang]');
      if (!tab) return;

      var lang = tab.getAttribute('data-lang');

      /* Activate the clicked tab, deactivate the other */
      _panel.querySelectorAll('[data-lang]').forEach(function (t) {
        t.classList.toggle('active', t.getAttribute('data-lang') === lang);
      });

      /* Show matching pane, hide the other */
      _panel.querySelectorAll('[data-content]').forEach(function (c) {
        c.classList.toggle('active', c.getAttribute('data-content') === lang);
      });
    });

    /* ── "Run in Editor" button ─────────────────────────────── */
    if (!_runBtn) return;

    /* The exact runnable example from the spec — stored as an array
       of strings to keep indentation readable, joined on \n.        */
    var _EXAMPLE_CODE = [
      'fetch("https://uselessfacts.jsph.pl/api/v2/facts/random?category=careers")',
      '  .then((response) => {',
      '    if (!response.ok) {',
      '      throw new Error("Network response was not ok");',
      '    }',
      '    return response.json();',
      '  })',
      '  .then((data) => {',
      '    console.log("Data fetched successfully");',
      '    console.log(data);',
      '  })',
      '  .catch((error) => {',
      '    console.error("Error fetching data:", error);',
      '  });',
    ].join('\n');

    _runBtn.addEventListener('click', function () {
      /* 1. Inject the example code into the Monaco editor */
      if (window.WapEditor) {
        window.WapEditor.setValue(_EXAMPLE_CODE);
        /* 2. Focus editor — WapEditor.focus() also calls _monaco.layout()
              internally, ensuring Monaco is correctly sized after any
              prior panel-toggle transitions.                           */
        window.WapEditor.focus();
      }
    });

  }());

  /* ──────────────────────────────────────────────────────────
     UI event wiring — unchanged surface
     ────────────────────────────────────────────────────────── */
  /* Initialise runtime status to Idle */
  _setStatus('idle', 'Idle');
  if (_rsTime) { _rsTime.textContent = ''; _rsTime.className = 'wap-rs-time'; }

  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape' && _open) { e.stopImmediatePropagation(); closeCompiler(); }
  }, true);

  card.addEventListener('click', openCompiler);
  card.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openCompiler(); }
  });
  btnClose.addEventListener('click', closeCompiler);
  btnRun.addEventListener('click', runCode);
  btnClear.addEventListener('click', function () {
    outputEl.innerHTML = '<span class="jsc-line jsc-line-empty">// Cleared</span>';
    _setStatus('idle', 'Idle');
    if (_rsTime) { _rsTime.textContent = ''; _rsTime.className = 'wap-rs-time'; }
    if (window.WapEditor) { window.WapEditor.setValue(''); window.WapEditor.focus(); }
  });

  /* ──────────────────────────────────────────────────────────
     Lazy-load Monaco from CDN (non-blocking)
     ────────────────────────────────────────────────────────── */
  var _ls = document.createElement('script');
  _ls.src   = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js';
  _ls.async = true;
  _ls.onload = _initEditorCore;
  document.head.appendChild(_ls);

}());
</script>

<script>
/* === NEW ADDITION START ===
   Understanding Flow — intercepts topic modal close (close btn + ESC)
   and shows a comprehension check popup with optional 2-question MCQ.
   Does NOT interfere with internal navigation, validation lock, or XP system.
   Only adds +10 XP as a bonus on perfect quiz score.
   =================================================================== */
(function _initUnderstandingFlow() {

  /* ── State ─────────────────────────────────────────────────── */
  var _ufOpen      = false;   // popup currently visible
  var _ufTopicNum  = -1;      // topic# that triggered the popup
  var _ufTopicName = '';      // displayed topic title

  /* ── DOM refs ───────────────────────────────────────────────── */
  var backdrop = document.getElementById('uf-backdrop');
  var content  = document.getElementById('uf-content');
  var titleEl  = document.getElementById('uf-title');

  if (!backdrop || !content) return; // guard

  /* ── Helpers ────────────────────────────────────────────────── */
  function _showBackdrop() {
    backdrop.classList.add('uf-visible');
    _ufOpen = true;
  }
  function _hideBackdrop() {
    backdrop.classList.remove('uf-visible');
    _ufOpen = false;
    _ufTopicNum  = -1;
    _ufTopicName = '';
  }

  /* Scroll main page to TOC section */
  function _scrollToTOC() {
    var tocEl = document.querySelector('.toc-section');
    if (tocEl) tocEl.scrollIntoView({ behavior: 'smooth' });
  }

  /* Award +10 bonus XP — purely additive, doesn't touch masteredTopics logic */
  function _awardBonusXP() {
    if (typeof spawnXPPop === 'function') spawnXPPop(10);
  }

  /* Mark topic completed (mastered) using the existing system */
  function _markMastered(num) {
    if (typeof masteredTopics === 'undefined' || masteredTopics.has(num)) return;
    masteredTopics.add(num);
    try { localStorage.setItem('masteredTopics', JSON.stringify([...masteredTopics])); } catch(e) {}
    // Update TOC link classes
    var tocLink = document.querySelector('[data-topic="' + num + '"]');
    if (tocLink) tocLink.classList.add('mastered', 'viewed', 'done');
    var sbLink = document.querySelector('.sidebar-topic-link[data-stopic="' + num + '"]');
    if (sbLink) sbLink.classList.add('mastered-item', 'done-item');
    if (typeof renderXP        === 'function') renderXP();
    if (typeof checkMilestone  === 'function') checkMilestone(masteredTopics.size);
    if (typeof renderTOCChecks === 'function') renderTOCChecks();
    if (typeof checkAllSections=== 'function') checkAllSections();
  }

  /* ── Question bank generator ────────────────────────────────── */
  /* Returns 2 questions for a given topic title.
     Questions are generated from a small seeded bank of patterns.
     Each entry: { q: string, choices: [string, string, string, string], ans: 0-based index } */
  function _genQuestions(topicName) {
    var name = topicName || 'this topic';
    // Generic conceptual questions that adapt to topic name
    var bank = [
      {
        q: 'What is the primary purpose of ' + name + '?',
        choices: [
          'To control execution order and manage program flow.',
          'To style HTML elements visually.',
          'To handle network requests exclusively.',
          'To replace CSS animations.'
        ],
        ans: 0
      },
      {
        q: 'Which of the following best describes a core characteristic of ' + name + '?',
        choices: [
          'It is synchronous by default in all environments.',
          'It can be understood and applied independently of other concepts.',
          'It abstracts away complexity and enables cleaner code design.',
          'It only works in browser environments, not Node.js.'
        ],
        ans: 2
      },
      {
        q: 'In the context of ' + name + ', what should a developer be most careful about?',
        choices: [
          'Missing semicolons at the end of statements.',
          'Misunderstanding the underlying execution model and edge cases.',
          'Using too many variables.',
          'Writing long function names.'
        ],
        ans: 1
      },
      {
        q: 'How does ' + name + ' relate to overall code quality?',
        choices: [
          'It has no impact on code maintainability.',
          'It is only relevant for large-scale enterprise applications.',
          'Understanding it helps write more predictable and maintainable code.',
          'It should be avoided in modern JavaScript.'
        ],
        ans: 2
      }
    ];

    // Pick 2 questions using topic name length as a deterministic seed
    var seed  = name.length % bank.length;
    var q1idx = seed;
    var q2idx = (seed + 2) % bank.length;
    return [ bank[q1idx], bank[q2idx] ];
  }

  /* ── Step renderers ─────────────────────────────────────────── */

  /* Step 1 — "Did you understand?" Yes / No */
  function _renderStep1() {
    titleEl.textContent = 'Did you understand this topic?';
    content.innerHTML =
      '<p style="text-align:center;font-size:0.85rem;color:var(--text-secondary);margin-bottom:18px;">' +
        '<em>' + (_ufTopicName || 'Current topic') + '</em>' +
      '</p>' +
      '<div class="uf-btn-row">' +
        '<button class="uf-btn primary" id="uf-yes">✓ Yes</button>' +
        '<button class="uf-btn danger"  id="uf-no" >✕ No</button>' +
      '</div>';

    document.getElementById('uf-yes').onclick = _renderMCQ;
    document.getElementById('uf-no').onclick  = _renderNoFlow;
  }

  /* Step 2a — NO flow */
  function _renderNoFlow() {
    titleEl.textContent = 'No problem — what would you like to do?';
    content.innerHTML =
      '<div class="uf-btn-row" style="flex-direction:column;align-items:center;gap:10px;">' +
        '<button class="uf-btn primary" id="uf-continue">↩ Continue reading this topic</button>' +
        '<button class="uf-btn"         id="uf-showall" >☰ Show all topics</button>' +
      '</div>';

    document.getElementById('uf-continue').onclick = function() {
      _hideBackdrop();
      // stay in modal — do nothing else
    };
    document.getElementById('uf-showall').onclick = function() {
      _hideBackdrop();
      // close topic modal then scroll to TOC
      if (typeof _origCloseTopic === 'function') _origCloseTopic();
      else if (typeof closeTopic === 'function') closeTopic();
      setTimeout(_scrollToTOC, 60);
    };
  }

  /* Step 2b — MCQ questions */
  var _answers   = [-1, -1];   // selected answer index per question
  var _submitted = [false, false];

  function _renderMCQ() {
    var qs = _genQuestions(_ufTopicName);
    titleEl.textContent = 'Quick Check';

    var html = '';
    qs.forEach(function(q, qi) {
      html += '<div class="uf-q-block" id="uf-qblock-' + qi + '">';
      html += '<div class="uf-q-text"><span class="uf-q-num">Q' + (qi+1) + '.</span>' + q.q + '</div>';
      html += '<div class="uf-choices">';
      q.choices.forEach(function(c, ci) {
        html += '<button class="uf-choice" data-qi="' + qi + '" data-ci="' + ci + '">' + c + '</button>';
      });
      html += '</div></div>';
    });
    html += '<hr class="uf-divider"><div id="uf-submit-row" class="uf-btn-row">' +
            '<button class="uf-btn primary" id="uf-submit-quiz">Submit Answers</button>' +
            '</div>';
    content.innerHTML = html;

    // Choice selection
    content.querySelectorAll('.uf-choice').forEach(function(btn) {
      btn.onclick = function() {
        var qi = parseInt(btn.getAttribute('data-qi'));
        var ci = parseInt(btn.getAttribute('data-ci'));
        if (_submitted[qi]) return;
        _answers[qi] = ci;
        // clear siblings
        content.querySelectorAll('.uf-choice[data-qi="' + qi + '"]').forEach(function(b) {
          b.classList.remove('correct-ans', 'wrong-ans');
          b.style.borderColor = '';
        });
        btn.style.borderColor = 'var(--accent-blue)';
        btn.style.color       = 'var(--text-primary)';
      };
    });

    document.getElementById('uf-submit-quiz').onclick = _submitQuiz.bind(null, qs);
  }

  function _submitQuiz(qs) {
    // Validate all answered
    if (_answers[0] === -1 || _answers[1] === -1) {
      if (typeof showToast === 'function') showToast('', 'Please answer both questions.', '', 1500);
      return;
    }

    var score = 0;
    qs.forEach(function(q, qi) {
      _submitted[qi] = true;
      var correct = q.ans;
      var chosen  = _answers[qi];
      var btns    = content.querySelectorAll('.uf-choice[data-qi="' + qi + '"]');
      btns.forEach(function(b) {
        var ci = parseInt(b.getAttribute('data-ci'));
        b.disabled = true;
        b.style.borderColor = '';
        b.style.color = '';
        if (ci === correct)          b.classList.add('correct-ans');
        else if (ci === chosen) b.classList.add('wrong-ans');
      });
      if (chosen === correct) score++;
    });

    // Reset answer state for potential re-use
    _answers    = [-1, -1];
    _submitted  = [false, false];

    _renderResult(score, qs);
  }

  function _renderResult(score, qs) {
    // Remove submit row
    var subRow = document.getElementById('uf-submit-row');
    if (subRow) subRow.remove();

    var resultHtml = '<hr class="uf-divider">';
    if (score === 2) {
      resultHtml +=
        '<div class="uf-score"><span class="uf-score-good">✓ ' + score + '/2 Correct</span></div>' +
        '<div class="uf-msg">Excellent! Topic understanding confirmed.</div>' +
        '<div class="uf-btn-row">' +
          '<button class="uf-btn primary" id="uf-close-done">Close ✓</button>' +
        '</div>';
    } else {
      resultHtml +=
        '<div class="uf-score"><span class="uf-score-bad">' + score + '/2 Correct</span></div>' +
        '<div class="uf-msg">Looks like you should revise once more.</div>' +
        '<div class="uf-btn-row">' +
          '<button class="uf-btn primary" id="uf-revisit">↩ Revisit Topic</button>' +
          '<button class="uf-btn"         id="uf-showall2">☰ Show All Topics</button>' +
        '</div>';
    }

    // Append below questions
    var extra = document.createElement('div');
    extra.innerHTML = resultHtml;
    content.appendChild(extra);

    if (score === 2) {
      // Mark mastered + award bonus XP
      _markMastered(_ufTopicNum);
      _awardBonusXP();

      document.getElementById('uf-close-done').onclick = function() {
        var tNum = _ufTopicNum;
        _hideBackdrop();
        // Close the topic modal
        if (typeof _origCloseTopic === 'function') _origCloseTopic();
        else if (typeof closeTopic === 'function') closeTopic();
      };
    } else {
      document.getElementById('uf-revisit').onclick = function() {
        _hideBackdrop();
        // stay in modal — topic already open
      };
      document.getElementById('uf-showall2').onclick = function() {
        _hideBackdrop();
        if (typeof _origCloseTopic === 'function') _origCloseTopic();
        else if (typeof closeTopic === 'function') closeTopic();
        setTimeout(_scrollToTOC, 60);
      };
    }
  }

  /* ── Main entry — called instead of closeTopic ──────────────── */
  function _interceptClose() {
    // Don't intercept when validation lock is active (existing system handles it)
    if (typeof validationLock !== 'undefined' && validationLock.active) return false;
    // Don't stack if popup already open
    if (_ufOpen) return false;

    /* === NEW ADDITION START === */
    // Case 2: User passed "Mark as Validated" — close directly, no popup
    if (window._topicValidationPassed === true) {
      if (typeof _origCloseTopic === 'function') _origCloseTopic();
      else if (typeof closeTopic === 'function') closeTopic();
      return true; // intercepted (handled), prevent double-close by caller
    }
    /* === NEW ADDITION END === */

    // Capture current topic info
    _ufTopicNum  = (typeof currentTopic !== 'undefined') ? currentTopic : -1;
    var titleNode = document.getElementById('modal-topic-title');
    _ufTopicName = titleNode ? (titleNode.textContent || '').trim() : '';

    // Reset MCQ state
    _answers   = [-1, -1];
    _submitted = [false, false];

    _renderStep1();
    _showBackdrop();
    return true; // intercepted
  }

  /* ── Override close button click ────────────────────────────── */
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#modal-close-btn')) return;
    // validationLock handled by existing listener — only intercept when free
    if (typeof validationLock !== 'undefined' && validationLock.active) return;
    // Check modal is actually open
    var overlayEl = document.getElementById('topic-overlay') ||
                    document.querySelector('.topic-overlay') ||
                    document.querySelector('.modal-overlay.active') ||
                    (function(){ var o=document.querySelector('[class*="overlay"]'); return o && o.classList.contains('active') ? o : null; })();
    if (_interceptClose()) e.stopImmediatePropagation();
  }, true); // capture phase to run before existing listener

  /* ── Override ESC key ───────────────────────────────────────── */
  document.addEventListener('keydown', function(e) {
    // If UF popup is open, ESC dismisses it (continue reading)
    if (e.key === 'Escape' && _ufOpen) {
      e.stopImmediatePropagation();
      _hideBackdrop();
      return;
    }
    if (e.key !== 'Escape') return;
    if (typeof validationLock !== 'undefined' && validationLock.active) return;
    // Check the topic overlay is active
    var topicOverlayActive = false;
    document.querySelectorAll('[class*="overlay"]').forEach(function(el) {
      if (el.classList.contains('active')) topicOverlayActive = true;
    });
    if (!topicOverlayActive) return;
    if (typeof currentTopic !== 'undefined' && currentTopic >= 0) {
      if (_interceptClose()) e.stopImmediatePropagation();
    }
  }, true);

}());
/* === NEW ADDITION END === */
</script>

<script>
/* === NEW ADDITION START ===
   1. Profile sidebar card + modal (open/close, animated XP bar)
   2. checkLevelUp() — hooked into renderXP
   3. Level-Up Cinematic — overrides showLevelUp() for full-screen moment
   ================================================================= */
(function _initProfileAndLevelUp() {

  /* ── Constants ─────────────────────────────────────────────── */
  var QUOTES = [
    "Growth begins where comfort ends.",
    "Progress is the product of persistence.",
    "Every expert was once a beginner.",
    "Discipline is the bridge between goals and achievement.",
    "The best time to level up was yesterday. The second best is now.",
    "Mastery is a habit, not a destination."
  ];

  /* ── DOM refs ───────────────────────────────────────────────── */
  var profileCard     = document.getElementById('profile-card');
  var profileLevelTxt = document.getElementById('profile-level-txt');
  var profileMiniBar  = document.getElementById('profile-mini-bar');

  var pmBackdrop   = document.getElementById('profile-modal-backdrop');
  var pmCloseBtn   = document.getElementById('pm-close-btn');
  var pmLevelBadge = document.getElementById('pm-level-badge');
  var pmXpText     = document.getElementById('pm-xp-text');
  var pmXpPct      = document.getElementById('pm-xp-pct');
  var pmXpFill     = document.getElementById('pm-xp-fill');
  var pmXpSub      = document.getElementById('pm-xp-sub');

  var luCinematic  = document.getElementById('lu-cinematic');
  var luBigText    = document.getElementById('lu-big-text');
  var luLevelLabel = document.getElementById('lu-level-label');
  var luQuote      = document.getElementById('lu-quote');
  var luContinue   = document.getElementById('lu-continue-btn');

  /* ── Helpers ────────────────────────────────────────────────── */
  function _getXPData() {
    // Safely read from globals set by main script
    var mastered = (typeof masteredTopics !== 'undefined') ? masteredTopics.size : 0;
    var perTopic = (typeof XP_PER_TOPIC   !== 'undefined') ? XP_PER_TOPIC       : 30;
    var xp       = mastered * perTopic;
    var info     = (typeof getLevelInfo   !== 'undefined') ? getLevelInfo(xp)   : { cur: {lvl:1,label:'Lvl 1',title:'Beginner',min:0}, next: {lvl:2,min:90} };
    var nextMin  = info.next ? info.next.min : xp;
    var prevMin  = info.cur.min;
    var range    = nextMin - prevMin;
    var segPct   = info.next ? Math.min(100, Math.round(((xp - prevMin) / range) * 100)) : 100;
    return { xp: xp, info: info, segPct: segPct, nextMin: nextMin, prevMin: prevMin };
  }

  /* ── Sidebar profile card updates ───────────────────────────── */
  function updateSidebarProfile() {
    var d = _getXPData();
    if (profileLevelTxt) profileLevelTxt.textContent = d.info.cur.label + ' · ' + d.info.cur.title;
    if (profileMiniBar)  profileMiniBar.style.width  = d.segPct + '%';
  }

  /* ── Profile Modal open / close ─────────────────────────────── */
  function openProfileModal() {
    var d = _getXPData();
    // Populate fields
    if (pmLevelBadge) pmLevelBadge.textContent = d.info.cur.label + ' · ' + d.info.cur.title;
    if (pmXpText)     pmXpText.textContent     = d.xp + ' / ' + d.nextMin + ' XP';
    if (pmXpPct)      pmXpPct.textContent      = d.segPct + '%';
    if (pmXpSub)      pmXpSub.textContent      = d.segPct + '% of ' + d.info.cur.title + ' completed';
    // Reset bar to 0 for animation
    if (pmXpFill) {
      pmXpFill.style.transition = 'none';
      pmXpFill.style.width      = '0%';
    }
    // Show backdrop
    pmBackdrop.classList.add('pm-visible');
    document.body.style.overflow = 'hidden';
    // Animate bar after paint
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        if (pmXpFill) {
          pmXpFill.style.transition = 'width 700ms cubic-bezier(0.4,0,0.2,1)';
          pmXpFill.style.width      = d.segPct + '%';
        }
      });
    });
  }

  function closeProfileModal() {
    pmBackdrop.classList.remove('pm-visible');
    document.body.style.overflow = '';
  }

  // Wiring
  if (profileCard) {
    profileCard.addEventListener('click', openProfileModal);
    profileCard.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openProfileModal(); }
    });
  }
  if (pmCloseBtn)  pmCloseBtn.addEventListener('click', closeProfileModal);
  if (pmBackdrop)  pmBackdrop.addEventListener('click', function(e) {
    if (e.target === pmBackdrop) closeProfileModal();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && pmBackdrop.classList.contains('pm-visible')) {
      closeProfileModal();
    }
  });

  /* ── checkLevelUp ───────────────────────────────────────────── */
  var _lastCheckedLevel = 1;

  // Initialize from saved state
  (function() {
    try {
      var saved = JSON.parse(localStorage.getItem('masteredTopics') || '[]');
      var xp    = saved.length * ((typeof XP_PER_TOPIC !== 'undefined') ? XP_PER_TOPIC : 30);
      if (typeof getLevelInfo !== 'undefined') {
        _lastCheckedLevel = getLevelInfo(xp).cur.lvl;
      }
    } catch(e) {}
  })();

  function checkLevelUp() {
    var d   = _getXPData();
    var cur = d.info.cur.lvl;
    if (cur > _lastCheckedLevel) {
      var crossedLevel = d.info.cur;
      _lastCheckedLevel = cur;
      // Small delay so XP animation settles first
      setTimeout(function() { _showCinematic(crossedLevel); }, 350);
    }
    // Always refresh sidebar card
    updateSidebarProfile();
  }

  /* ── Level-Up Cinematic ─────────────────────────────────────── */
  var _cinematicActive = false;

  function _showCinematic(levelObj) {
    if (_cinematicActive) return;
    _cinematicActive = true;

    // 1. Close any open topic modal
    try {
      if (typeof _origCloseTopic === 'function') _origCloseTopic();
      else if (typeof closeTopic === 'function') closeTopic();
    } catch(e) {}

    // 2. Close mastery overlay if open
    try {
      var mo = document.getElementById('mastery-overlay');
      if (mo && mo.classList.contains('active')) {
        if (typeof closeMasteryOverlay === 'function') closeMasteryOverlay();
        else mo.classList.remove('active');
      }
    } catch(e) {}

    // 3. Close profile modal if open
    closeProfileModal();

    // 4. Populate cinematic content
    var quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
    if (luBigText)    luBigText.textContent    = 'LEVEL UP';
    if (luLevelLabel) luLevelLabel.textContent = (levelObj.label || '') + ' — ' + (levelObj.title || '');
    if (luQuote)      luQuote.textContent      = '\u201C' + quote + '\u201D';
    if (luContinue)   luContinue.style.display = 'none';

    // 5. Reset animations by re-inserting elements (force reflow)
    [luBigText, luLevelLabel, luQuote].forEach(function(el) {
      if (!el) return;
      el.style.animation = 'none';
      void el.offsetWidth;
      el.style.animation = '';
    });

    // 6. Show overlay
    luCinematic.classList.add('lu-active');

    // 7. After 3.5s, show "Continue Learning" button
    setTimeout(function() {
      if (!_cinematicActive) return;
      if (luContinue) {
        luContinue.style.display = 'block';
        luContinue.style.animation = 'lu-btn-in 400ms ease forwards';
      }
    }, 3500);
  }

  function _hideCinematic() {
    luCinematic.classList.remove('lu-active');
    _cinematicActive = false;
    if (luContinue) {
      luContinue.style.display  = 'none';
      luContinue.style.animation = '';
    }
  }

  if (luContinue) {
    luContinue.addEventListener('click', _hideCinematic);
  }

  /* ── Override showLevelUp to use cinematic ───────────────────── */
  // The existing showLevelUp() creates a 1.3s flash. Override it so
  // ALL level-up paths (including openTopic patch) use the cinematic.
  if (typeof window.showLevelUp !== 'undefined') {
    window._origShowLevelUp = window.showLevelUp;
    window.showLevelUp = function(levelLabel, levelTitle) {
      var lvl = { label: levelLabel, title: levelTitle };
      _showCinematic(lvl);
    };
  }

  /* ── Patch renderXP to also call checkLevelUp ────────────────── */
  if (typeof window.renderXP !== 'undefined') {
    var _origRenderXP = window.renderXP;
    window.renderXP = function() {
      _origRenderXP.apply(this, arguments);
      checkLevelUp();
    };
  }

  /* ── Initial sidebar render ──────────────────────────────────── */
  // Defer until DOM + main script data is ready
  setTimeout(updateSidebarProfile, 100);

}());
/* === NEW ADDITION END === */
</script>

</body>
</html>
